cscope 15 $HOME/desktop/work/ucc -q 0000001853 0000274736
	@driver/linux.c

1 
	~<uni¡d.h
>

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~"ucc.h
"

6 
	#_P_WAIT
 0

	)

7 
	#UCCDIR
 "/u¤/loÿl/lib/ucc/"

	)

9 *
	gCPPProg
[] =

13 "-D__sigÃd__=sigÃd", "-D_UCC", "-I" 
UCCDIR
 "include", "$1", "-E", "$2", "-o", "$3", 0

15 *
	gCCProg
[] =

17 
UCCDIR
 "ucl", "-ext:.s", "$1", "$2", 0

19 *
	gASProg
[] =

23 *
	gLDProg
[] =

25 "/u¤/bš/gcc", "-o", "$3", "$1", "$2", 
UCCDIR
 "assert.o", "-lc", "-lm", 0

27 *
	gExtNames
[] = { ".c", ".i", ".s", ".o", ".a;.so", 0 };

29 
	$Execu‹
(**
cmd
)

31 
pid
, 
n
, 
¡©us
;

33 
pid
 = 
	`fÜk
();

34 ià(
pid
 == -1)

36 
	`årštf
(
¡d”r
, "no more…rocesses\n");

39 ià(
pid
 == 0)

41 
	`execv
(
cmd
[0], cmd);

42 
	`³¼Ü
(
cmd
[0]);

43 
	`fæush
(
¡dout
);

44 
	`ex™
(100);

46 (
n
 = 
	`wa™
(&
¡©us
)è!ğ
pid
 &&‚ != -1)

48 ià(
n
 == -1)

49 
¡©us
 = -1;

50 ià(
¡©us
 & 0xff)

52 
	`årštf
(
¡d”r
, "çÈ”rÜ iÀ%s\n", 
cmd
[0]);

53 
¡©us
 |= 0x100;

56  (
¡©us
 >> 8) & 0xff;

57 
	}
}

59 
	$S‘upToŞChaš
()

61 
	}
}

63 
	$InvokeProg¿m
(
oáy³
)

65 
Li¡
 
p
, 

, 
Ş
;

66 *
oâame
;

67 **
cmd
;

68 
¡©us
 = 0;

70 
oáy³
)

72 
PP_FILE
:

73 
p
 = 
O±iÚ
.
cfes
;… !ğ
NULL
;… =…->
Ãxt
)

75 
oâame
 = 
	`FeName
(
p
->
¡r
, ".i");

76 
PPFes
 = 
	`Li¡Aµ’d
(PPFes, 
oâame
);

77 

 = 
	`Li¡Aµ’d
(
NULL
, 
p
->
¡r
);

78 
Ş
 = 
	`Li¡Aµ’d
(
NULL
, 
oâame
);

79 
cmd
 = 
	`BudCommªd
(
CPPProg
, 
O±iÚ
.
pæags
, 

, 
Ş
);

80 
¡©us
 = 
	`Execu‹
(
cmd
);

82 
O±iÚ
.
pfes
 = 
	`Li¡Combše
(O±iÚ.pfes, 
PPFes
);

85 
ASM_FILE
:

86 ià(
O±iÚ
.
pfes
 =ğ
NULL
)

89 
p
 = 
O±iÚ
.
aæags
, O±iÚ.aæag ğ
NULL
;… !ğNULL;… =…->
Ãxt
)

91 
O±iÚ
.
aæags
 = 
	`Li¡Combše
(O±iÚ.aæags, 
	`P¬£O±iÚ
(
p
->
¡r
 + 4));

93 
p
 = 
O±iÚ
.
pfes
;… !ğ
NULL
;… =…->
Ãxt
)

95 
ASMFes
 = 
	`Li¡Aµ’d
(ASMFes, 
	`FeName
(
p
->
¡r
, ".s"));

97 
O±iÚ
.
afes
 = 
	`Li¡Combše
(O±iÚ.afes, 
ASMFes
);

98 
cmd
 = 
	`BudCommªd
(
CCProg
, 
O±iÚ
.
cæags
, O±iÚ.
pfes
, 
ASMFes
);

99 
¡©us
 = 
	`Execu‹
(
cmd
);

102 
OBJ_FILE
:

103 
p
 = 
O±iÚ
.
afes
;… !ğ
NULL
;… =…->
Ãxt
)

105 
oâame
 = 
	`FeName
(
p
->
¡r
, ".o");

106 
OBJFes
 = 
	`Li¡Aµ’d
(OBJFes, 
oâame
);

107 

 = 
	`Li¡Aµ’d
(
NULL
, 
p
->
¡r
);

108 
Ş
 = 
	`Li¡Aµ’d
(
NULL
, 
oâame
);

109 
cmd
 = 
	`BudCommªd
(
ASProg
, 
O±iÚ
.
aæags
, 

, 
Ş
);

110 
¡©us
 = 
	`Execu‹
(
cmd
);

112 
O±iÚ
.
ofes
 = 
	`Li¡Combše
(O±iÚ.ofes, 
OBJFes
);

115 
LIB_FILE
:

118 
EXE_FILE
:

119 ià(
O±iÚ
.
ofes
 =ğ
NULL
)

122 ià(
O±iÚ
.
out
 =ğ
NULL
)

123 
O±iÚ
.
out
 = "a.out";

124 
cmd
 = 
	`BudCommªd
(
LDProg
, 
O±iÚ
.
læags
, O±iÚ.
lšput
, 
	`Li¡Aµ’d
(
NULL
, O±iÚ.
out
));

125 
¡©us
 = 
	`Execu‹
(
cmd
);

129  
¡©us
;

130 
	}
}

	@driver/reg.c

1 
	~<¡dio.h
>

3 
	$´št
(*
a
){

4 
	`´štf
("%d\n",*
a
);

6 (*
a
)++;

7 
	}
}

9 
	$maš
()

11 
a
;

13 
a
 =1;

14 
	`´štf
("%d\n",
a
);

15 
	}
}

	@driver/ucc.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<ùy³.h
>

5 
	~"ucc.h
"

7 **
	gCommªd
;

8 
İtiÚ
 
	gO±iÚ
;

9 
Li¡
 
	gPPFes
;

10 
Li¡
 
	gASMFes
;

11 
Li¡
 
	gOBJFes
;

13 * 
	$AÎoc
(
size
)

15 *
p
 = 
	`m®loc
(
size
);

16 ià(
p
 =ğ
NULL
)

18 
	`årštf
(
¡d”r
, "memoryƒxhausted\n");

19 
	`ex™
(-1);

21  
p
;

22 
	}
}

24 * 
	$FeName
(*
Çme
, *
ext
)

26 *
¡r
;

27 
Ën
;

29 
Ën
 = 
	`¡¾’
(
Çme
);

30 
Çme
[
Ën
 - 1] != '.')

31 
Ën
--;

32 
¡r
 = 
	`AÎoc
(
Ën
 + 
	`¡¾’
(
ext
) + 1);

33 
	`¡ºıy
(
¡r
, 
Çme
, 
Ën
 - 1);

34 
¡r
[
Ën
 - 1] = '\0';

35 
	`¡rÿt
(
¡r
, 
ext
);

37  
¡r
;

38 
	}
}

40 
Li¡
 
	$Li¡Aµ’d
(
Li¡
 
li¡
, *
¡r
)

42 
Li¡
 *

 = &
li¡
;

43 
Li¡
 
p
 = 
li¡
;

45 
p
 !ğ
NULL
)

47 

 = &
p
->
Ãxt
;

48 
p
 =…->
Ãxt
;

50 *

 = 
p
 = 
	`AÎoc
((*p));

51 
p
->
¡r
 = str;

52 
p
->
Ãxt
 = 
NULL
;

54  
li¡
;

55 
	}
}

57 
Li¡
 
	$Li¡Combše
(
Li¡
 
to
, Li¡ 
äom
)

59 
Li¡
 *

 = &
to
;

60 
Li¡
 
p
 = 
to
;

62 
p
 !ğ
NULL
)

64 

 = &
p
->
Ãxt
;

65 
p
 =…->
Ãxt
;

67 *

 = 
äom
;

69  
to
;

70 
	}
}

72 
Li¡
 
	$P¬£O±iÚ
(*
İt
)

74 *
s
, *
t
;

75 *
¡r
;

76 
Li¡
 
p
 = 
NULL
;

78 
s
 = 
İt
;

79 
t
 = 
	`¡rchr
(
s
, ',');

80 
t
 !ğ
NULL
)

82 
¡r
 = 
	`AÎoc
(
t
 - 
s
 + 1);

83 
	`¡ºıy
(
¡r
, 
s
, 
t
 - s);

84 
¡r
[
t
-
s
] = 0;

85 
p
 = 
	`Li¡Aµ’d
Õ, 
¡r
);

86 
s
 = 
t
 + 1;

87 
t
 = 
	`¡rchr
(
s
, ',');

90  
	`Li¡Aµ’d
(
p
, 
s
);

91 
	}
}

93 
	$PrštCommªd
()

95 
i
;

97 ià(
Commªd
[0] !ğ
NULL
)

99 
	`´štf
("%s", 
Commªd
[0]);

100 
i
 = 1; 
Commªd
[i] !ğ
NULL
; ++i)

102 
	`´štf
(" %s", 
Commªd
[
i
]);

104 
	`årštf
(
¡dout
, "\n");

106 
	}
}

108 ** 
	$BudCommªd
(*
cmd
[], 
Li¡
 
æags
, Li¡ 
šfes
, Li¡ 
outfes
)

110 
i
, 
j
;

111 
Li¡
 
li¡s
[3];

112 
Li¡
 
p
;

114 
li¡s
[0] = 
æags
;

115 
li¡s
[1] = 
šfes
;

116 
li¡s
[2] = 
outfes
;

117 
i
 = 
j
 = 0; 
cmd
[i] !ğ
NULL
; i++)

119 *
s
 = 
	`¡rchr
(
cmd
[
i
], '$');

120 ià(
s
 && 
	`isdig™
(s[1]))

122 
d
 = 
s
[1] - '0';

124 ià(
p
 = 
li¡s
[
d
 - 1])

126 
Commªd
[
j
] = 
	`AÎoc
(
	`¡¾’
(
cmd
[
i
]è+ sŒËn(
p
->
¡r
) - 1);

127 
	`¡ºıy
(
Commªd
[
j
], 
cmd
[
i
], 
s
 - cmd[i]);

128 
Commªd
[
j
][
s
 - 
cmd
[
i
]] = '\0';

129 
	`¡rÿt
(
Commªd
[
j
], 
p
->
¡r
);

130 
	`¡rÿt
(
Commªd
[
j
++], 
s
 + 2);

131 
p
 =…->
Ãxt
;

132 
p
 !ğ
NULL
)

134 
Commªd
[
j
++] = 
p
->
¡r
;

135 
p
 =…->
Ãxt
;

141 
Commªd
[
j
++] = 
cmd
[
i
];

144 
Commªd
[
j
] = 
NULL
;

145 ià(
O±iÚ
.
v”bo£
)

147 
	`PrštCommªd
();

149  
Commªd
;

150 
	}
}

152 
	$G‘FeTy³
(*
f’ame
)

154 
i
, 
j
;

155 
Ën
;

157 
Ën
 = 
	`¡¾’
(
f’ame
);

158 
i
 = 
C_FILE
; i <ğ
OBJ_FILE
; ++i)

160 *
s
 = 
ExtNames
[
i
], *
t
;

162 
t
 = 
	`¡rchr
(
s
, ';');

163 
t
 !ğ
NULL
)

165 
j
 = 
t
 - 
s
;

166 ià(
	`¡ºcmp
(&
f’ame
[
Ën
 -
j
], 
s
, j) == 0)

167  
i
;

168 
s
 = 
t
 + 1;

169 
t
 = 
	`¡rchr
(
s
, ';');

171 
j
 = 
	`¡¾’
(
s
);

172 ià(
	`¡ºcmp
(&
f’ame
[
Ën
 - 
j
], 
s
, j) == 0)

173  
i
;

177 
	}
}

179 
	$AddFe
(*
f’ame
)

181 
ty³
 = 
	`G‘FeTy³
(
f’ame
);

183 ià(
	`acûss
(
f’ame
, 4) != 0)

185 
	`årštf
(
¡d”r
, "NØsuch fe: %s\n", 
f’ame
);

189 ià(
ty³
 == -1)

191 
	`årštf
(
¡d”r
, "uÄecognized fe: %s\n", 
f’ame
);

195 
ty³
)

197 
C_FILE
:

198 
O±iÚ
.
cfes
 = 
	`Li¡Aµ’d
(O±iÚ.cfes, 
f’ame
);

201 
PP_FILE
:

202 
O±iÚ
.
pfes
 = 
	`Li¡Aµ’d
(O±iÚ.pfes, 
f’ame
);

205 
ASM_FILE
:

206 
O±iÚ
.
afes
 = 
	`Li¡Aµ’d
(O±iÚ.afes, 
f’ame
);

209 
OBJ_FILE
:

210 
O±iÚ
.
ofes
 = 
	`Li¡Aµ’d
(O±iÚ.ofes, 
f’ame
);

213 
LIB_FILE
:

214 
O±iÚ
.
lfes
 = 
	`Li¡Aµ’d
(O±iÚ.lfes, 
f’ame
);

217 ià(
ty³
 < 
OBJ_FILE
)

219 *
ext
 = 
ExtNames
[
OBJ_FILE
];

220 *
s
 = 
	`¡rchr
(
ext
, ';');

222 ià(
s
 !ğ
NULL
)

224 
buf
[512];

225 
	`¡ºıy
(
buf
, 
ext
, 
s
 -ƒxt);

226 
buf
[
s
 - 
ext
] = '\0';

227 
ext
 = 
buf
;

229 
f’ame
 = 
	`FeName
(f’ame, 
ext
);

231 
O±iÚ
.
lšput
 = 
	`Li¡Aµ’d
(O±iÚ.lšput, 
f’ame
);

232 
	}
}

234 
	$RemoveFes
()

236 
Li¡
 
p
;

238 ià(
O±iÚ
.
oáy³
 > 
PP_FILE
)

240 
p
 = 
PPFes
;… !ğ
NULL
;… =…->
Ãxt
)

242 
	`»move
(
p
->
¡r
);

246 ià(
O±iÚ
.
oáy³
 > 
ASM_FILE
)

248 
p
 = 
ASMFes
;… !ğ
NULL
;… =…->
Ãxt
)

250 
	`»move
(
p
->
¡r
);

254 ià(
O±iÚ
.
oáy³
 > 
OBJ_FILE
)

256 
p
 = 
OBJFes
;… !ğ
NULL
;… =…->
Ãxt
)

258 
	`»move
(
p
->
¡r
);

261 
	}
}

263 
	$ShowH–p
()

265 *
msg
[] =

285 
i
 = 0;

287 
msg
[
i
])

289 
	`´štf
(
msg
[
i
]);

290 
i
++;

292 
	}
}

294 
	$P¬£CmdLše
(
¬gc
, *
¬gv
[])

296 
i
;

298 
i
 = 0; i < 
¬gc
; ++i)

300 ià(
	`¡rcmp
(
¬gv
[
i
], "--dump-ast") == 0 ||

301 
	`¡rcmp
(
¬gv
[
i
], "--dump-IR") == 0)

303 
O±iÚ
.
cæags
 = 
	`Li¡Aµ’d
(O±iÚ.cæags, 
¬gv
[
i
]);

305 ià(
	`¡rcmp
(
¬gv
[
i
], "-E") == 0)

307 
O±iÚ
.
oáy³
 = 
PP_FILE
;

309 ià(
	`¡rcmp
(
¬gv
[
i
], "-S") == 0)

311 
O±iÚ
.
oáy³
 = 
ASM_FILE
;

313 ià(
	`¡rcmp
(
¬gv
[
i
], "-c") == 0)

315 
O±iÚ
.
oáy³
 = 
OBJ_FILE
;

317 ià(
	`¡rcmp
(
¬gv
[
i
], "-o") == 0)

319 
O±iÚ
.
oáy³
 = 
EXE_FILE
;

320 
O±iÚ
.
out
 = 
¬gv
[++
i
];

322 ià(
	`¡ºcmp
(
¬gv
[
i
], "-D", 2) == 0 ||

323 
	`¡ºcmp
(
¬gv
[
i
], "-U", 2) == 0 ||

324 
	`¡ºcmp
(
¬gv
[
i
], "-I", 2) == 0)

326 
O±iÚ
.
pæags
 = 
	`Li¡Aµ’d
(O±iÚ.pæags, 
¬gv
[
i
]);

328 ià(
	`¡rcmp
(
¬gv
[
i
], "-h") == 0)

330 
	`ShowH–p
();

332 ià(
	`¡rcmp
(
¬gv
[
i
], "-v") == 0)

334 
O±iÚ
.
v”bo£
 = 1;

336 ià(
	`¡ºcmp
(
¬gv
[
i
], "-Wl,", 4) == 0)

338 
O±iÚ
.
læags
 = 
	`Li¡Aµ’d
(O±iÚ.læags, 
¬gv
[
i
]);

340 ià(
	`¡ºcmp
(
¬gv
[
i
], "-Wa,", 4) == 0)

342 
O±iÚ
.
aæags
 = 
	`Li¡Aµ’d
(O±iÚ.aæags, 
¬gv
[
i
]);

344 ià(
¬gv
[
i
][0] == '-')

346 
	`´štf
("UÄecognized o±iÚ %s\n", 
¬gv
[
i
]);

347 
i
++;

353  
i
;

354 
	}
}

356 
	$maš
(
¬gc
, *
¬gv
[])

358 
i
;

360 ià(
¬gc
 <= 1)

362 
	`ShowH–p
();

363 
	`ex™
(0);

366 
O±iÚ
.
oáy³
 = 
EXE_FILE
;

367 
	`S‘upToŞChaš
();

368 
Commªd
 = 
	`AÎoc
((
¬gc
 + 60) * (*));

369 
Commªd
[0] = 
NULL
;

371 
i
 = 
	`P¬£CmdLše
(--
¬gc
, ++
¬gv
);

372 ; 
i
 < 
¬gc
; ++i)

374 ià(
¬gv
[
i
][0] == '-')

376 
O±iÚ
.
lšput
 = 
	`Li¡Aµ’d
(O±iÚ.lšput, 
¬gv
[
i
]);

380 
	`AddFe
(
¬gv
[
i
]);

384 
i
 = 
PP_FILE
; i <ğ
O±iÚ
.
oáy³
; ++i)

386 ià(
	`InvokeProg¿m
(
i
) != 0)

388 
	`RemoveFes
();

389 
	`årštf
(
¡d”r
, "ucc invoke commandƒrror:");

390 
	`PrštCommªd
();

395 
	`RemoveFes
();

397 
	}
}

	@driver/ucc.h

1 #iâdeà
__UCC_H_


2 
	#__UCC_H_


	)

5 ’um { 
	mC_FILE
, 
	mPP_FILE
, 
	mASM_FILE
, 
	mOBJ_FILE
, 
	mLIB_FILE
, 
	mEXE_FILE
 };

7 
	sli¡


9 *
	m¡r
;

10 
li¡
 *
	mÃxt
;

11 } *
	tLi¡
;

13 
	sİtiÚ


15 
Li¡
 
	mpæags
;

16 
Li¡
 
	mcæags
;

17 
Li¡
 
	maæags
;

18 
Li¡
 
	mlæags
;

19 
Li¡
 
	mcfes
;

20 
Li¡
 
	mpfes
;

21 
Li¡
 
	mafes
;

22 
Li¡
 
	mofes
;

23 
Li¡
 
	mlfes
;

24 
Li¡
 
	mlšput
;

25 
	mv”bo£
;

26 
	moáy³
;

27 *
	mout
;

30 * 
AÎoc
(
Ën
);

31 * 
FeName
(*
Çme
, *
ext
);

32 
Li¡
 
Li¡Aµ’d
(Li¡ 
li¡
, *
¡r
);

33 
Li¡
 
Li¡Combše
(Li¡ 
to
, Li¡ 
äom
);

34 
Li¡
 
P¬£O±iÚ
(*
İt
);

35 ** 
BudCommªd
(*
cmd
[], 
Li¡
 
æags
, Li¡ 
šfes
, Li¡ 
outfes
);

37 
S‘upToŞChaš
();

38 
InvokeProg¿m
(
oáy³
);

40 * 
ExtNames
[];

41 
Li¡
 
PPFes
;

42 
Li¡
 
ASMFes
;

43 
Li¡
 
OBJFes
;

44 
İtiÚ
 
O±iÚ
;

	@driver/win32.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<´oûss.h
>

5 
	~"ucc.h
"

7 *
	gCPPProg
[] =

11 *
	gCCProg
[] =

15 *
	gASProg
[] =

19 *
	gLDProg
[] =

25 *
	gExtNames
[] = { ".c;.C,", ".i;.I", ".asm;.ASM;.s;.S", ".obj;.OBJ", ".lib", 0 };

27 
	$S‘upToŞChaš
()

29 *
dœ
;

31 ià((
dœ
 = 
	`g‘’v
("VS90COMNTOOLS")è!ğ
NULL
)

33 
LDProg
[8] = "libcmt.lib";

34 
ok
;

37 ià((
dœ
 = 
	`g‘’v
("VS80COMNTOOLS")è!ğ
NULL
)

39 
LDProg
[8] = "libcmt.lib";

40 
ok
;

43 ià((
dœ
 = 
	`g‘’v
("VS71COMNTOOLS")è!ğ
NULL
)

44 
ok
;

48 
ok
:

49 
CCProg
[1] = "-ignore __declspec(deprecated),__declspec(noreturn),__inline,__fastcall";

50 
CCProg
[2] = "-keyword __int64";

51 
	}
}

53 
	$InvokeProg¿m
(
oáy³
)

55 
Li¡
 
p
 = 
NULL
;

56 **
cmd
;

57 *
fe
;

58 
¡©us
 = 0;

60 
oáy³
)

62 
PP_FILE
:

63 ià(
O±iÚ
.
cfes
 =ğ
NULL
)

66 
p
 = 
O±iÚ
.
cfes
;… !ğ
NULL
;… =…->
Ãxt
)

68 
PPFes
 = 
	`Li¡Aµ’d
(PPFes, 
	`FeName
(
p
->
¡r
, ".i"));

71 
O±iÚ
.
pfes
 = 
	`Li¡Combše
(O±iÚ.pfes, 
PPFes
);

72 
cmd
 = 
	`BudCommªd
(
CPPProg
, 
O±iÚ
.
pæags
, O±iÚ.
cfes
, 
PPFes
);

73 
¡©us
 = 
	`_¥awnvp
(
_P_WAIT
, 
cmd
[0], cmd);

75 
p
 = 
PPFes
;… !ğ
NULL
;… =…->
Ãxt
)

77 ià((
fe
 = 
	`¡¼chr
(
p
->
¡r
, '\\')) || (file = strrchr(p->str, '/')))

79 
	`»Çme
(
fe
 + 1, 
p
->
¡r
);

84 
ASM_FILE
:

85 ià(
O±iÚ
.
pfes
 =ğ
NULL
)

88 
p
 = 
O±iÚ
.
pfes
;… !ğ
NULL
;… =…->
Ãxt
)

90 
ASMFes
 = 
	`Li¡Aµ’d
(ASMFes, 
	`FeName
(
p
->
¡r
, ".asm"));

93 
O±iÚ
.
afes
 = 
	`Li¡Combše
(O±iÚ.afes, 
ASMFes
);

94 
cmd
 = 
	`BudCommªd
(
CCProg
, 
O±iÚ
.
cæags
, O±iÚ.
pfes
, 
ASMFes
);

95 
¡©us
 = 
	`_¥awnvp
(
_P_WAIT
, 
cmd
[0], cmd);

98 
OBJ_FILE
:

99 ià(
O±iÚ
.
afes
 =ğ
NULL
)

102 
p
 = 
O±iÚ
.
aæags
, O±iÚ.aæag ğ
NULL
;… !ğNULL;… =…->
Ãxt
)

104 
O±iÚ
.
aæags
 = 
	`Li¡Combše
(O±iÚ.aæags, 
	`P¬£O±iÚ
(
p
->
¡r
 + 4));

106 
p
 = 
O±iÚ
.
afes
;… !ğ
NULL
;… =…->
Ãxt
)

108 
fe
 = 
	`FeName
(
p
->
¡r
, ".obj");

109 
OBJFes
 = 
	`Li¡Aµ’d
(OBJFes, 
fe
);

110 
cmd
 = 
	`BudCommªd
(
ASProg
, 
O±iÚ
.
aæags
, 
	`Li¡Aµ’d
(
NULL
, 
p
->
¡r
), Li¡Aµ’d(NULL, 
fe
));

111 
¡©us
 = 
	`_¥awnvp
(
_P_WAIT
, 
cmd
[0], cmd);

113 
O±iÚ
.
ofes
 = 
	`Li¡Combše
(O±iÚ.ofes, 
OBJFes
);

116 
LIB_FILE
:

119 
EXE_FILE
:

120 ià(
O±iÚ
.
ofes
 =ğ
NULL
)

123 ià(
O±iÚ
.
out
 =ğ
NULL
)

125 
O±iÚ
.
out
 = O±iÚ.
ofes
->
¡r
;

127 
O±iÚ
.
out
 = 
	`FeName
(Option.out, ".exe");

128 
p
 = 
O±iÚ
.
læags
, O±iÚ.læag ğ
NULL
;… !ğNULL;… =…->
Ãxt
)

130 
O±iÚ
.
læags
 = 
	`Li¡Combše
(O±iÚ.læags, 
	`P¬£O±iÚ
(
p
->
¡r
 + 4));

132 
cmd
 = 
	`BudCommªd
(
LDProg
, 
O±iÚ
.
læags
, O±iÚ.
lšput
, 
	`Li¡Aµ’d
(
NULL
, O±iÚ.
out
));

133 
¡©us
 = 
	`_¥awnvp
(
_P_WAIT
, 
cmd
[0], cmd);

137  
¡©us
;

138 
	}
}

	@ucl/alloc.c

1 
	~"uş.h
"

15 
mblock
 *
	gF»eBlocks
;

20 
	$In™H—p
(
H—p
 
hp
)

22 
hp
->
h—d
.
Ãxt
 = 
NULL
;

23 
hp
->
h—d
.
begš
 = hp->h—d.
’d
 = hp->h—d.
ava
 = 
NULL
;

24 
hp
->
Ï¡
 = &hp->
h—d
;

25 
	}
}

31 * 
	$H—pAÎoÿ‹
(
H—p
 
hp
, 
size
)

33 
mblock
 *
blk
 = 
NULL
;

36 
size
 = 
	`ALIGN
(size, (
®ign
));

38 
blk
 = 
hp
->
Ï¡
;

43 
size
 > 
blk
->
’d
 - blk->
ava
)

45 ià((
blk
->
Ãxt
 = 
F»eBlocks
è!ğ
NULL
)

47 
F»eBlocks
 = F»eBlocks->
Ãxt
;

48 
blk
 = blk->
Ãxt
;

52 
m
 = 
size
 + 
MBLOCK_SIZE
 + (
mblock
);

54 
blk
->
Ãxt
 = (
mblock
 *)
	`m®loc
(
m
);

55 
blk
 = blk->
Ãxt
;

56 ià(
blk
 =ğ
NULL
)

58 
	`F©®
("Memoryƒxhausted");

60 
blk
->
’d
 = (*)blk + 
m
;

63 
blk
->
ava
 = blk->
begš
 = (*)(blk + 1);

64 
blk
->
Ãxt
 = 
NULL
;

65 
hp
->
Ï¡
 = 
blk
;

68 
blk
->
ava
 +ğ
size
;

70  
blk
->
ava
 - 
size
;

71 
	}
}

76 
	$F»eH—p
(
H—p
 
hp
)

78 
hp
->
Ï¡
->
Ãxt
 = 
F»eBlocks
;

79 
F»eBlocks
 = 
hp
->
h—d
.
Ãxt
;

80 
	`In™H—p
(
hp
);

81 
	}
}

	@ucl/alloc.h

1 #iâdeà
__ALLOC_H_


2 
	#__ALLOC_H_


	)

4 
	smblock


6 
mblock
 *
	mÃxt
;

7 *
	mbegš
;

8 *
	mava
;

9 *
	m’d
;

12 
	u®ign


14 
	md
;

15 (*
	mf
)();

18 
	sh—p


20 
mblock
 *
	mÏ¡
;

21 
mblock
 
	mh—d
;

22 } *
	tH—p
;

24 
	#ALLOC
(
p
è(Õèğ
	`H—pAÎoÿ‹
(
Cu¼’tH—p
,  *Õ)))

	)

25 
	#CALLOC
(
p
è
	`mem£t
(
	`ALLOC
Õ), 0,  *Õ))

	)

26 
	#MBLOCK_SIZE
 (4 * 1024)

	)

27 
	#HEAP
(
hp
è
h—p
 h°ğ{ &hp.
h—d
 }

	)

29 
In™H—p
(
H—p
 
hp
);

30 * 
H—pAÎoÿ‹
(
H—p
 
hp
, 
size
);

31 
F»eH—p
(
H—p
 
hp
);

	@ucl/assert.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

7 
	$_as£¹
(*
e
, *
fe
, 
lše
)

9 
	`årštf
(
¡d”r
, "assertion failed:");

10 ià(
e
)

11 
	`årštf
(
¡d”r
, " %s", 
e
);

12 ià(
fe
)

13 
	`årštf
(
¡d”r
, " f%s", 
fe
);

14 
	`årštf
(
¡d”r
, "†š%d\n", 
lše
);

15 
	`fæush
(
¡d”r
);

16 
	`abÜt
();

18 
	}
}

	@ucl/ast.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

4 
	gCu¼’tTok’
;

10 
	$Ex³ù
(
tok
)

12 ià(
Cu¼’tTok’
 =ğ
tok
)

14 
NEXT_TOKEN
;

19 ià(
tok
 =ğ
TK_SEMICOLON
 && 
Tok’CoÜd
.
lše
 - 
P»vCoÜd
.line == 1)

21 
	`E¼Ü
(&
P»vCoÜd
, "Expect ;");

25 
	`E¼Ü
(&
Tok’CoÜd
, "Ex³ù %s", 
Tok’SŒšgs
[
tok
 - 1]);

27 
	}
}

32 
	$Cu¼’tTok’In
(
toks
[])

34 *
p
 = 
toks
;

36 *
p
)

38 ià(
Cu¼’tTok’
 =ğ*
p
)

40 
p
++;

44 
	}
}

51 
	$SkTo
(
toks
[], *
ešfo
)

53 *
p
 = 
toks
;

54 
coÜd
 
cÜd
;

56 ià(
	`Cu¼’tTok’In
(
toks
è|| 
Cu¼’tTok’
 =ğ
TK_END
)

59 
cÜd
 = 
Tok’CoÜd
;

60 
Cu¼’tTok’
 !ğ
TK_END
)

62 
p
 = 
toks
;

63 *
p
)

65 ià(
Cu¼’tTok’
 =ğ*
p
)

66 
sync
;

67 
p
++;

69 
NEXT_TOKEN
;

72 
sync
:

73 
	`E¼Ü
(&
cÜd
, "skØ%s\n", 
ešfo
);

74 
	}
}

	@ucl/ast.h

1 #iâdeà
__AST_H_


2 
	#__AST_H_


	)

4 
	enodeKšd


6 
	mNK_T¿n¦©iÚUn™
, 
	mNK_FunùiÚ
, 
	mNK_Deş¬©iÚ
,

7 
	mNK_Ty³Name
, 
	mNK_S³cif›rs
, 
	mNK_Tok’
,

8 
	mNK_Ty³defName
, 
	mNK_EnumS³cif›r
, 
	mNK_Enum”©Ü
,

9 
	mNK_SŒuùS³cif›r
, 
	mNK_UniÚS³cif›r
, 
	mNK_SŒuùDeş¬©iÚ
,

10 
	mNK_SŒuùDeş¬©Ü
, 
	mNK_Poš‹rDeş¬©Ü
, 
	mNK_A¼ayDeş¬©Ü
,

11 
	mNK_FunùiÚDeş¬©Ü
, 
	mNK_P¬am‘”Ty³Li¡
, 
	mNK_P¬am‘”Deş¬©iÚ
,

12 
	mNK_NameDeş¬©Ü
, 
	mNK_In™Deş¬©Ü
, 
	mNK_In™Ÿliz”
,

14 
	mNK_Ex´essiÚ
,

16 
	mNK_Ex´essiÚS‹m’t
, 
	mNK_Lab–S‹m’t
, 
	mNK_Ca£S‹m’t
,

17 
	mNK_DeçuÉS‹m’t
, 
	mNK_IfS‹m’t
, 
	mNK_Sw™chS‹m’t
,

18 
	mNK_WheS‹m’t
, 
	mNK_DoS‹m’t
, 
	mNK_FÜS‹m’t
,

19 
	mNK_GÙoS‹m’t
, 
	mNK_B»akS‹m’t
, 
	mNK_CÚtšueS‹m’t
,

20 
	mNK_R‘uºS‹m’t
, 
	mNK_CompoundS‹m’t


23 
	#AST_NODE_COMMON
 \

	)

24 
	gkšd
; \

25 
a¡Node
 *
	gÃxt
; \

26 
coÜd
 
	gcoÜd
;

28 
	sa¡Node


30 
	mAST_NODE_COMMON


31 } *
	tA¡Node
;

33 
	sÏb–


35 
coÜd
 
	mcoÜd
;

36 *
	mid
;

37 
	m»f
;

38 
	mdefšed
;

39 
BBlock
 
	m»¥BB
;

40 
Ïb–
 *
	mÃxt
;

41 } *
	tLab–
;

43 
a¡Ex´essiÚ
 *
	tA¡Ex´essiÚ
;

44 
a¡S‹m’t
 *
	tA¡S‹m’t
;

45 
a¡Deş¬©iÚ
 *
	tA¡Deş¬©iÚ
;

46 
a¡Ty³Name
 *
	tA¡Ty³Name
;

47 
a¡T¿n¦©iÚUn™
 *
	tA¡T¿n¦©iÚUn™
;

49 
	sš™D©a


51 
	moff£t
;

52 
A¡Ex´essiÚ
 
	mex´
;

53 
In™D©a
 
	mÃxt
;

56 
	#CREATE_AST_NODE
(
p
, 
k
è\

	)

57 
CALLOC
(
p
); \

58 
	gp
->
	gkšd
 = 
NK_
##
k
; \

59 
	gp
->
	gcoÜd
 = 
Tok’CoÜd
;

61 
	#NEXT_TOKEN
 
Cu¼’tTok’
 = 
	`G‘NextTok’
();

	)

63 
A¡Ex´essiÚ
 
P¬£Ex´essiÚ
();

64 
A¡Ex´essiÚ
 
P¬£CÚ¡ªtEx´essiÚ
();

65 
A¡Ex´essiÚ
 
P¬£Assignm’tEx´essiÚ
();

66 
A¡S‹m’t
 
P¬£CompoundS‹m’t
();

67 
A¡Ty³Name
 
P¬£Ty³Name
();

68 
A¡Deş¬©iÚ
 
P¬£Deş¬©iÚ
();

69 
A¡T¿n¦©iÚUn™
 
P¬£T¿n¦©iÚUn™
(*
fe
);

71 
Po¡CheckTy³def
();

72 
CheckT¿n¦©iÚUn™
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
);

73 
T¿n¦©e
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
);

74 
Em™T¿n¦©iÚUn™
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
);

76 
Ex³ù
(
tok
);

77 
SkTo
(
toks
[], *
ešfo
);

78 
Cu¼’tTok’In
(
toks
[]);

79 
IsTy³Name
(
tok
);

81 
DumpT¿n¦©iÚUn™
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
);

82 
DAs£mT¿n¦©iÚUn™
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
);

84 
Cu¼’tTok’
;

85 
FIRST_Deş¬©iÚ
[];

	@ucl/config.h

1 #iâdeà
__CONFIG_H_


2 
	#__CONFIG_H_


	)

4 #undeà
LITTLE_ENDIAN


5 
	#LITTLE_ENDIAN
 1

	)

7 
	#CHAR_SIZE
 1

	)

8 
	#SHORT_SIZE
 2

	)

9 
	#INT_SIZE
 4

	)

10 
	#LONG_SIZE
 4

	)

11 
	#LONG_LONG_SIZE
 4

	)

12 
	#FLOAT_SIZE
 4

	)

13 
	#DOUBLE_SIZE
 8

	)

14 
	#LONG_DOUBLE_SIZE
 8

	)

16 #ifdeà
_WIN32


17 
	#WCHAR
 
USHORT


	)

19 
	#WCHAR
 
ULONG


	)

	@ucl/decl.c

1 
	~"uş.h
"

2 
	~"g¿mm”.h
"

3 
	~"a¡.h
"

4 
	~"deş.h
"

6 
	gFIRST_SŒuùDeş¬©iÚ
[] = { 
FIRST_DECLARATION
, 0};

7 
	gFF_SŒuùDeş¬©iÚ
[] = { 
FIRST_DECLARATION
, 
TK_RBRACE
, 0};

8 
	gFIRST_FunùiÚ
[] = { 
FIRST_DECLARATION
, 
TK_LBRACE
, 0};

9 
	gFIRST_Ex‹º®Deş¬©iÚ
[] = { 
FIRST_DECLARATION
, 
TK_MUL
, 
TK_LPAREN
, 0};

10 
VeùÜ
 
	gTy³defNames
, 
	gOv”lßdNames
;

12 
	gFIRST_Deş¬©iÚ
[] = { 
FIRST_DECLARATION
, 0};

14 
A¡Deş¬©Ü
 
P¬£Deş¬©Ü
(
ab¡¿ù
);

15 
A¡S³cif›rs
 
P¬£Deş¬©iÚS³cif›rs
();

20 * 
	$G‘Ou‹rmo¡ID
(
A¡Deş¬©Ü
 
dec
)

22 ià(
dec
->
kšd
 =ğ
NK_NameDeş¬©Ü
)

23  
dec
->
id
;

25  
	`G‘Ou‹rmo¡ID
(
dec
->dec);

26 
	}
}

66 
	$IsTy³defName
(*
id
)

68 
VeùÜ
 
v
 = 
Ty³defNames
;

69 
TDName
 
Š
;

71 
	`FOR_EACH_ITEM
(
TDName
, 
Š
, 
v
)

72 ià(
Š
->
id
 =ğid &&n->
Ëv–
 <ğ
Lev–
 && !n->
ov”lßd
)

74 
ENDFOR


77 
	}
}

84 
	$CheckTy³defName
(
sşass
, *
id
)

86 
VeùÜ
 
v
;

87 
TDName
 
Š
;

89 ià(
id
 =ğ
NULL
)

92 
v
 = 
Ty³defNames
;

93 ià(
sşass
 =ğ
TK_TYPEDEF
)

95 
	`FOR_EACH_ITEM
(
TDName
, 
Š
, 
v
)

96 if(
Š
->
id
 == id)

98 ià(
Lev–
 < 
Š
->
Ëv–
)

99 
Š
->
Ëv–
 = 
Lev–
;

102 
ENDFOR


104 
	`ALLOC
(
Š
);

105 
Š
->
id
 = id;

106 
Š
->
Ëv–
 = 
Lev–
;

107 
Š
->
ov”lßd
 = 0;

108 
	`INSERT_ITEM
(
v
, 
Š
);

112 
	`FOR_EACH_ITEM
(
TDName
, 
Š
, 
v
)

113 ià(
Š
->
id
 =ğid && 
Lev–
 >n->
Ëv–
)

115 
Š
->
ov”lßd
 = 1;

116 
	`INSERT_ITEM
(
Ov”lßdNames
, 
Š
);

119 
ENDFOR


121 
	}
}

126 
	$P»CheckTy³def
(
A¡Deş¬©iÚ
 
deş
)

128 
A¡Node
 
p
;

129 
sşass
 = 0;

131 ià(
deş
->
¥ecs
->
¡gCÏs£s
 !ğ
NULL
)

133 
sşass
 = ((
A¡Tok’
)
deş
->
¥ecs
->
¡gCÏs£s
)->
tok’
;

136 
p
 = 
deş
->
š™Decs
;

137 
p
 !ğ
NULL
)

139 
	`CheckTy³defName
(
sşass
, 
	`G‘Ou‹rmo¡ID
(((
A¡In™Deş¬©Ü
)
p
)->
dec
));

140 
p
 =…->
Ãxt
;

142 
	}
}

147 
	$Po¡CheckTy³def
()

149 
TDName
 
Š
;

151 
	`FOR_EACH_ITEM
(
TDName
, 
Š
, 
Ov”lßdNames
)

152 
Š
->
ov”lßd
 = 0;

153 
ENDFOR


155 
Ov”lßdNames
->
Ën
 = 0;

156 
	}
}

168 
A¡In™Ÿliz”
 
	$P¬£In™Ÿliz”
()

170 
A¡In™Ÿliz”
 
š™
;

171 
A¡Node
 *

;

173 
	`CREATE_AST_NODE
(
š™
, 
In™Ÿliz”
);

175 ià(
Cu¼’tTok’
 =ğ
TK_LBRACE
)

177 
š™
->
lb¿û
 = 1;

178 
NEXT_TOKEN
;

179 
š™
->
š™Ÿls
 = (
A¡Node
)
	`P¬£In™Ÿliz”
();

180 

 = &
š™
->
š™Ÿls
->
Ãxt
;

181 
Cu¼’tTok’
 =ğ
TK_COMMA
)

183 
NEXT_TOKEN
;

184 ià(
Cu¼’tTok’
 =ğ
TK_RBRACE
)

186 *

 = (
A¡Node
)
	`P¬£In™Ÿliz”
();

187 

 = &(*)->
Ãxt
;

189 
	`Ex³ù
(
TK_RBRACE
);

193 
š™
->
lb¿û
 = 0;

194 
š™
->
ex´
 = 
	`P¬£Assignm’tEx´essiÚ
();

197  
š™
;

198 
	}
}

205 
A¡In™Deş¬©Ü
 
	$P¬£In™Deş¬©Ü
()

207 
A¡In™Deş¬©Ü
 
š™Dec
;

209 
	`CREATE_AST_NODE
(
š™Dec
, 
In™Deş¬©Ü
);

211 
š™Dec
->
dec
 = 
	`P¬£Deş¬©Ü
(
DEC_CONCRETE
);

212 ià(
Cu¼’tTok’
 =ğ
TK_ASSIGN
)

214 
NEXT_TOKEN
;

215 
š™Dec
->
š™
 = 
	`P¬£In™Ÿliz”
();

218  
š™Dec
;

219 
	}
}

230 
A¡Deş¬©Ü
 
	$P¬£DœeùDeş¬©Ü
(
kšd
)

232 
A¡Deş¬©Ü
 
dec
;

234 ià(
Cu¼’tTok’
 =ğ
TK_LPAREN
)

236 
NEXT_TOKEN
;

237 
dec
 = 
	`P¬£Deş¬©Ü
(
kšd
);

238 
	`Ex³ù
(
TK_RPAREN
);

240  
dec
;

243 
	`CREATE_AST_NODE
(
dec
, 
NameDeş¬©Ü
);

245 ià(
Cu¼’tTok’
 =ğ
TK_ID
)

247 ià(
kšd
 =ğ
DEC_ABSTRACT
)

249 
	`E¼Ü
(&
Tok’CoÜd
, "Identifier is‚ot…ermitted inhe‡bstract declarator");

252 
dec
->
id
 = 
Tok’V®ue
.
p
;

253 
NEXT_TOKEN
;

255 ià(
kšd
 =ğ
DEC_CONCRETE
)

257 
	`E¼Ü
(&
Tok’CoÜd
, "Expect identifier");

260  
dec
;

261 
	}
}

268 
A¡P¬am‘”Deş¬©iÚ
 
	$P¬£P¬am‘”Deş¬©iÚ
()

270 
A¡P¬am‘”Deş¬©iÚ
 
·¿mDeş
;

272 
	`CREATE_AST_NODE
(
·¿mDeş
, 
P¬am‘”Deş¬©iÚ
);

274 
·¿mDeş
->
¥ecs
 = 
	`P¬£Deş¬©iÚS³cif›rs
();

275 
·¿mDeş
->
dec
 = 
	`P¬£Deş¬©Ü
(
DEC_ABSTRACT
 | 
DEC_CONCRETE
);

277  
·¿mDeş
;

278 
	}
}

293 
A¡P¬am‘”Ty³Li¡
 
	$P¬£P¬am‘”Ty³Li¡
()

295 
A¡P¬am‘”Ty³Li¡
 
·¿mTyLi¡
;

296 
A¡Node
 *

;

298 
	`CREATE_AST_NODE
(
·¿mTyLi¡
, 
P¬am‘”Ty³Li¡
);

300 
·¿mTyLi¡
->
·¿mDeşs
 = (
A¡Node
)
	`P¬£P¬am‘”Deş¬©iÚ
();

301 

 = &
·¿mTyLi¡
->
·¿mDeşs
->
Ãxt
;

302 
Cu¼’tTok’
 =ğ
TK_COMMA
)

304 
NEXT_TOKEN
;

305 ià(
Cu¼’tTok’
 =ğ
TK_ELLIPSE
)

307 
·¿mTyLi¡
->
–l£
 = 1;

308 
NEXT_TOKEN
;

311 *

 = (
A¡Node
)
	`P¬£P¬am‘”Deş¬©iÚ
();

312 

 = &(*)->
Ãxt
;

315  
·¿mTyLi¡
;

316 
	}
}

330 
A¡Deş¬©Ü
 
	$P¬£Po¡fixDeş¬©Ü
(
kšd
)

332 
A¡Deş¬©Ü
 
dec
 = 
	`P¬£DœeùDeş¬©Ü
(
kšd
);

336 ià(
Cu¼’tTok’
 =ğ
TK_LBRACKET
)

338 
A¡A¼ayDeş¬©Ü
 
¬rDec
;

340 
	`CREATE_AST_NODE
(
¬rDec
, 
A¼ayDeş¬©Ü
);

341 
¬rDec
->
dec
 = dec;

343 
NEXT_TOKEN
;

344 ià(
Cu¼’tTok’
 !ğ
TK_RBRACKET
)

346 
¬rDec
->
ex´
 = 
	`P¬£CÚ¡ªtEx´essiÚ
();

348 
	`Ex³ù
(
TK_RBRACKET
);

350 
dec
 = (
A¡Deş¬©Ü
)
¬rDec
;

352 ià(
Cu¼’tTok’
 =ğ
TK_LPAREN
)

356 
A¡FunùiÚDeş¬©Ü
 
funcDec
;

358 
	`CREATE_AST_NODE
(
funcDec
, 
FunùiÚDeş¬©Ü
);

359 
funcDec
->
dec
 = dec;

361 
NEXT_TOKEN
;

362 ià(
	`IsTy³Name
(
Cu¼’tTok’
))

364 
funcDec
->
·¿mTyLi¡
 = 
	`P¬£P¬am‘”Ty³Li¡
();

368 
funcDec
->
ids
 = 
	`C»©eVeùÜ
(4);

369 ià(
Cu¼’tTok’
 =ğ
TK_ID
)

371 
	`INSERT_ITEM
(
funcDec
->
ids
, 
Tok’V®ue
.
p
);

373 
NEXT_TOKEN
;

374 
Cu¼’tTok’
 =ğ
TK_COMMA
)

376 
NEXT_TOKEN
;

377 ià(
Cu¼’tTok’
 =ğ
TK_ID
)

379 
	`INSERT_ITEM
(
funcDec
->
ids
, 
Tok’V®ue
.
p
);

381 
	`Ex³ù
(
TK_ID
);

385 
	`Ex³ù
(
TK_RPAREN
);

386 
dec
 = (
A¡Deş¬©Ü
)
funcDec
;

390  
dec
;

393 
	}
}

455 
A¡Deş¬©Ü
 
	$P¬£Deş¬©Ü
(
kšd
)

457 ià(
Cu¼’tTok’
 =ğ
TK_MUL
)

459 
A¡Poš‹rDeş¬©Ü
 
±rDec
;

460 
A¡Tok’
 
tok
;

461 
A¡Node
 *

;

463 
	`CREATE_AST_NODE
(
±rDec
, 
Poš‹rDeş¬©Ü
);

464 

 = &
±rDec
->
tyQu®s
;

466 
NEXT_TOKEN
;

467 
Cu¼’tTok’
 =ğ
TK_CONST
 || Cu¼’tTok’ =ğ
TK_VOLATILE
)

469 
	`CREATE_AST_NODE
(
tok
, 
Tok’
);

470 
tok
->
tok’
 = 
Cu¼’tTok’
;

471 *

 = (
A¡Node
)
tok
;

472 

 = &
tok
->
Ãxt
;

473 
NEXT_TOKEN
;

475 
±rDec
->
dec
 = 
	`P¬£Deş¬©Ü
(
kšd
);

477  (
A¡Deş¬©Ü
)
±rDec
;

480  
	`P¬£Po¡fixDeş¬©Ü
(
kšd
);

481 
	}
}

488 
A¡SŒuùDeş¬©Ü
 
	$P¬£SŒuùDeş¬©Ü
()

490 
A¡SŒuùDeş¬©Ü
 
¡Dec
;

492 
	`CREATE_AST_NODE
(
¡Dec
, 
SŒuùDeş¬©Ü
);

494 ià(
Cu¼’tTok’
 !ğ
TK_COLON
)

496 
¡Dec
->
dec
 = 
	`P¬£Deş¬©Ü
(
DEC_CONCRETE
);

498 ià(
Cu¼’tTok’
 =ğ
TK_COLON
)

500 
NEXT_TOKEN
;

501 
¡Dec
->
ex´
 = 
	`P¬£CÚ¡ªtEx´essiÚ
();

504  
¡Dec
;

505 
	}
}

519 
A¡SŒuùDeş¬©iÚ
 
	$P¬£SŒuùDeş¬©iÚ
()

521 
A¡SŒuùDeş¬©iÚ
 
¡Deş
;

522 
A¡Node
 *

;

524 
	`CREATE_AST_NODE
(
¡Deş
, 
SŒuùDeş¬©iÚ
);

529 
¡Deş
->
¥ecs
 = 
	`P¬£Deş¬©iÚS³cif›rs
();

530 ià(
¡Deş
->
¥ecs
->
¡gCÏs£s
 !ğ
NULL
)

532 
	`E¼Ü
(&
¡Deş
->
coÜd
, "Struct/union member should‚ot have storage class");

533 
¡Deş
->
¥ecs
->
¡gCÏs£s
 = 
NULL
;

535 ià(
¡Deş
->
¥ecs
->
tyQu®s
 =ğ
NULL
 && stDeş->¥ecs->
tyS³cs
 == NULL)

537 
	`E¼Ü
(&
¡Deş
->
coÜd
, "Expectype specifier or qualifier");

541 ià(
Cu¼’tTok’
 =ğ
TK_SEMICOLON
)

543 
NEXT_TOKEN
;

544  
¡Deş
;

547 
¡Deş
->
¡Decs
 = (
A¡Node
)
	`P¬£SŒuùDeş¬©Ü
();

548 

 = &
¡Deş
->
¡Decs
->
Ãxt
;

549 
Cu¼’tTok’
 =ğ
TK_COMMA
)

551 
NEXT_TOKEN
;

552 *

 = (
A¡Node
)
	`P¬£SŒuùDeş¬©Ü
();

553 

 = &(*)->
Ãxt
;

555 
	`Ex³ù
(
TK_SEMICOLON
);

557  
¡Deş
;

558 
	}
}

573 
A¡SŒuùS³cif›r
 
	$P¬£SŒuùOrUniÚS³cif›r
()

575 
A¡SŒuùS³cif›r
 
¡S³c
;

576 
A¡Node
 *

;

578 
	`CREATE_AST_NODE
(
¡S³c
, 
SŒuùS³cif›r
);

579 ià(
Cu¼’tTok’
 =ğ
TK_UNION
)

581 
¡S³c
->
kšd
 = 
NK_UniÚS³cif›r
;

584 
NEXT_TOKEN
;

585 
Cu¼’tTok’
)

587 
TK_ID
:

588 
¡S³c
->
id
 = 
Tok’V®ue
.
p
;

589 
NEXT_TOKEN
;

590 ià(
Cu¼’tTok’
 =ğ
TK_LBRACE
)

591 
lb¿û
;

593  
¡S³c
;

595 
TK_LBRACE
:

596 
lb¿û
:

597 
NEXT_TOKEN
;

598 ià(
Cu¼’tTok’
 =ğ
TK_RBRACE
)

600 
NEXT_TOKEN
;

601  
¡S³c
;

605 

 = &
¡S³c
->
¡Deşs
;

606 
	`Cu¼’tTok’In
(
FIRST_SŒuùDeş¬©iÚ
))

608 *

 = (
A¡Node
)
	`P¬£SŒuùDeş¬©iÚ
();

609 

 = &(*)->
Ãxt
;

610 
	`SkTo
(
FF_SŒuùDeş¬©iÚ
, "the start of struct declaration or }");

612 
	`Ex³ù
(
TK_RBRACE
);

613  
¡S³c
;

616 
	`E¼Ü
(&
Tok’CoÜd
, "Expect identifier or {‡fter struct/union");

617  
¡S³c
;

619 
	}
}

629 
A¡Enum”©Ü
 
	$P¬£Enum”©Ü
()

631 
A¡Enum”©Ü
 
’um”
;

633 
	`CREATE_AST_NODE
(
’um”
, 
Enum”©Ü
);

635 ià(
Cu¼’tTok’
 !ğ
TK_ID
)

637 
	`E¼Ü
(&
Tok’CoÜd
, "Theƒumeration constant must be identifier");

638  
’um”
;

641 
’um”
->
id
 = 
Tok’V®ue
.
p
;

642 
NEXT_TOKEN
;

643 ià(
Cu¼’tTok’
 =ğ
TK_ASSIGN
)

645 
NEXT_TOKEN
;

646 
’um”
->
ex´
 = 
	`P¬£CÚ¡ªtEx´essiÚ
();

649  
’um”
;

650 
	}
}

662 
A¡EnumS³cif›r
 
	$P¬£EnumS³cif›r
()

664 
A¡EnumS³cif›r
 
’umS³c
;

665 
A¡Node
 *

;

667 
	`CREATE_AST_NODE
(
’umS³c
, 
EnumS³cif›r
);

669 
NEXT_TOKEN
;

670 ià(
Cu¼’tTok’
 =ğ
TK_ID
)

672 
’umS³c
->
id
 = 
Tok’V®ue
.
p
;

673 
NEXT_TOKEN
;

674 ià(
Cu¼’tTok’
 =ğ
TK_LBRACE
)

675 
’um”©Ü_li¡
;

677 ià(
Cu¼’tTok’
 =ğ
TK_LBRACE
)

679 
’um”©Ü_li¡
:

680 
NEXT_TOKEN
;

681 ià(
Cu¼’tTok’
 =ğ
TK_RBRACE
)

682  
’umS³c
;

684 
’umS³c
->
’um”s
 = (
A¡Node
)
	`P¬£Enum”©Ü
();

685 

 = &
’umS³c
->
’um”s
->
Ãxt
;

686 
Cu¼’tTok’
 =ğ
TK_COMMA
)

688 
NEXT_TOKEN
;

689 ià(
Cu¼’tTok’
 =ğ
TK_RBRACE
)

691 *

 = (
A¡Node
)
	`P¬£Enum”©Ü
();

692 

 = &(*)->
Ãxt
;

694 
	`Ex³ù
(
TK_RBRACE
);

698 
	`E¼Ü
(&
Tok’CoÜd
, "Expect identifier or {‡fterƒnum");

701  
’umS³c
;

702 
	}
}

735 
A¡S³cif›rs
 
	$P¬£Deş¬©iÚS³cif›rs
()

737 
A¡S³cif›rs
 
¥ecs
;

738 
A¡Tok’
 
tok
;

739 
A¡Node
 *
scTa
, *
tqTa
, *
tsTa
;

740 
£eTy
 = 0;

742 
	`CREATE_AST_NODE
(
¥ecs
, 
S³cif›rs
);

743 
scTa
 = &
¥ecs
->
¡gCÏs£s
;

744 
tqTa
 = &
¥ecs
->
tyQu®s
;

745 
tsTa
 = &
¥ecs
->
tyS³cs
;

747 
Ãxt_¥ecif›r
:

748 
Cu¼’tTok’
)

750 
TK_AUTO
:

751 
TK_REGISTER
:

752 
TK_STATIC
:

753 
TK_EXTERN
:

754 
TK_TYPEDEF
:

756 
	`CREATE_AST_NODE
(
tok
, 
Tok’
);

757 
tok
->
tok’
 = 
Cu¼’tTok’
;

758 *
scTa
 = (
A¡Node
)
tok
;

759 
scTa
 = &
tok
->
Ãxt
;

760 
NEXT_TOKEN
;

763 
TK_CONST
:

764 
TK_VOLATILE
:

766 
	`CREATE_AST_NODE
(
tok
, 
Tok’
);

767 
tok
->
tok’
 = 
Cu¼’tTok’
;

768 *
tqTa
 = (
A¡Node
)
tok
;

769 
tqTa
 = &
tok
->
Ãxt
;

770 
NEXT_TOKEN
;

773 
TK_VOID
:

774 
TK_CHAR
:

775 
TK_SHORT
:

776 
TK_INT
:

777 
TK_INT64
:

778 
TK_LONG
:

779 
TK_FLOAT
:

780 
TK_DOUBLE
:

781 
TK_SIGNED
:

782 
TK_UNSIGNED
:

784 
	`CREATE_AST_NODE
(
tok
, 
Tok’
);

785 
tok
->
tok’
 = 
Cu¼’tTok’
;

786 *
tsTa
 = (
A¡Node
)
tok
;

787 
tsTa
 = &
tok
->
Ãxt
;

788 
£eTy
 = 1;

789 
NEXT_TOKEN
;

792 
TK_ID
:

794 ià(! 
£eTy
 && 
	`IsTy³defName
(
Tok’V®ue
.
p
))

796 
A¡Ty³defName
 
Šame
;

798 
	`CREATE_AST_NODE
(
Šame
, 
Ty³defName
);

800 
Šame
->
id
 = 
Tok’V®ue
.
p
;

801 *
tsTa
 = (
A¡Node
)
Šame
;

802 
tsTa
 = &
Šame
->
Ãxt
;

803 
NEXT_TOKEN
;

804 
£eTy
 = 1;

807  
¥ecs
;

809 
TK_STRUCT
:

810 
TK_UNION
:

812 *
tsTa
 = (
A¡Node
)
	`P¬£SŒuùOrUniÚS³cif›r
();

813 
tsTa
 = &(*tsTa)->
Ãxt
;

814 
£eTy
 = 1;

817 
TK_ENUM
:

819 *
tsTa
 = (
A¡Node
)
	`P¬£EnumS³cif›r
();

820 
tsTa
 = &(*tsTa)->
Ãxt
;

821 
£eTy
 = 1;

825  
¥ecs
;

827 
Ãxt_¥ecif›r
;

828 
	}
}

830 
	$IsTy³Name
(
tok
)

832  
tok
 =ğ
TK_ID
 ? 
	`IsTy³defName
(
Tok’V®ue
.
p
è: (tok >ğ
TK_AUTO
 &&ok <ğ
TK_VOID
);

833 
	}
}

839 
A¡Ty³Name
 
	$P¬£Ty³Name
()

841 
A¡Ty³Name
 
tyName
;

843 
	`CREATE_AST_NODE
(
tyName
, 
Ty³Name
);

845 
tyName
->
¥ecs
 = 
	`P¬£Deş¬©iÚS³cif›rs
();

846 ià(
tyName
->
¥ecs
->
¡gCÏs£s
 !ğ
NULL
)

848 
	`E¼Ü
(&
tyName
->
coÜd
, "type‚ame should‚ot have storage class");

849 
tyName
->
¥ecs
->
¡gCÏs£s
 = 
NULL
;

851 
tyName
->
dec
 = 
	`P¬£Deş¬©Ü
(
DEC_ABSTRACT
);

853  
tyName
;

854 
	}
}

863 
A¡Deş¬©iÚ
 
	$P¬£CommÚH—d”
()

865 
A¡Deş¬©iÚ
 
deş
;

866 
A¡Node
 *

;

868 
	`CREATE_AST_NODE
(
deş
, 
Deş¬©iÚ
);

870 
deş
->
¥ecs
 = 
	`P¬£Deş¬©iÚS³cif›rs
();

871 ià(
Cu¼’tTok’
 !ğ
TK_SEMICOLON
)

873 
deş
->
š™Decs
 = (
A¡Node
)
	`P¬£In™Deş¬©Ü
();

874 

 = &
deş
->
š™Decs
->
Ãxt
;

875 
Cu¼’tTok’
 =ğ
TK_COMMA
)

877 
NEXT_TOKEN
;

878 *

 = (
A¡Node
)
	`P¬£In™Deş¬©Ü
();

879 

 = &(*)->
Ãxt
;

883  
deş
;

884 
	}
}

886 
A¡Deş¬©iÚ
 
	$P¬£Deş¬©iÚ
()

888 
A¡Deş¬©iÚ
 
deş
;

890 
deş
 = 
	`P¬£CommÚH—d”
();

891 
	`Ex³ù
(
TK_SEMICOLON
);

892 
	`P»CheckTy³def
(
deş
);

894  
deş
;

895 
	}
}

900 
A¡FunùiÚDeş¬©Ü
 
	$G‘FunùiÚDeş¬©Ü
(
A¡In™Deş¬©Ü
 
š™Dec
)

902 
A¡Deş¬©Ü
 
dec
;

904 ià(
š™Dec
 =ğ
NULL
 || in™Dec->
Ãxt
 !ğNULL || in™Dec->
š™
 != NULL)

905  
NULL
;

907 
dec
 = 
š™Dec
->dec;

908 
dec
 && dec->
kšd
 !ğ
NK_FunùiÚDeş¬©Ü
)

909 
dec
 = dec->dec;

911 ià(
dec
 =ğ
NULL
 || dec->dec->
kšd
 !ğ
NK_NameDeş¬©Ü
)

912  
NULL
;

914  (
A¡FunùiÚDeş¬©Ü
)
dec
;

915 
	}
}

932 
A¡Node
 
	$P¬£Ex‹º®Deş¬©iÚ
()

934 
A¡Deş¬©iÚ
 
deş
 = 
NULL
;

935 
A¡In™Deş¬©Ü
 
š™Dec
 = 
NULL
;

936 
A¡FunùiÚDeş¬©Ü
 
fdec
;

938 
deş
 = 
	`P¬£CommÚH—d”
();

939 
š™Dec
 = (
A¡In™Deş¬©Ü
)
deş
->
š™Decs
;

940 ià(
deş
->
¥ecs
->
¡gCÏs£s
 !ğ
NULL
 && ((
A¡Tok’
)deş->¥ecs->¡gCÏs£s)->
tok’
 =ğ
TK_TYPEDEF
)

941 
nÙ_func
;

943 
fdec
 = 
	`G‘FunùiÚDeş¬©Ü
(
š™Dec
);

944 ià(
fdec
 !ğ
NULL
)

946 
A¡FunùiÚ
 
func
;

947 
A¡Node
 *

;

949 ià(
Cu¼’tTok’
 =ğ
TK_SEMICOLON
)

951 
NEXT_TOKEN
;

952 ià(
Cu¼’tTok’
 !ğ
TK_LBRACE
)

953  (
A¡Node
)
deş
;

956 
	`E¼Ü
(&
deş
->
coÜd
, "maybe you‡ccidently‡ddhe ;");

958 ià(
fdec
->
·¿mTyLi¡
 && 
Cu¼’tTok’
 !ğ
TK_LBRACE
)

961 
nÙ_func
;

964 
	`CREATE_AST_NODE
(
func
, 
FunùiÚ
);

966 
func
->
coÜd
 = 
deş
->coord;

967 
func
->
¥ecs
 = 
deş
->specs;

968 
func
->
dec
 = 
š™Dec
->dec;

969 
func
->
fdec
 = fdec;

971 
Lev–
++;

972 ià(
func
->
fdec
->
·¿mTyLi¡
)

974 
A¡Node
 
p
 = 
func
->
fdec
->
·¿mTyLi¡
->
·¿mDeşs
;

976 
p
)

978 
	`CheckTy³defName
(0, 
	`G‘Ou‹rmo¡ID
(((
A¡P¬am‘”Deş¬©iÚ
)
p
)->
dec
));

979 
p
 =…->
Ãxt
;

982 

 = &
func
->
deşs
;

983 
	`Cu¼’tTok’In
(
FIRST_Deş¬©iÚ
))

985 *

 = (
A¡Node
)
	`P¬£Deş¬©iÚ
();

986 

 = &(*)->
Ãxt
;

988 
Lev–
--;

990 
func
->
¡mt
 = 
	`P¬£CompoundS‹m’t
();

992  (
A¡Node
)
func
;

995 
nÙ_func
:

996 
	`Ex³ù
(
TK_SEMICOLON
);

997 
	`P»CheckTy³def
(
deş
);

999  (
A¡Node
)
deş
;

1000 
	}
}

1007 
A¡T¿n¦©iÚUn™
 
	$P¬£T¿n¦©iÚUn™
(*
f’ame
)

1009 
A¡T¿n¦©iÚUn™
 
ŒªsUn™
;

1010 
A¡Node
 *

;

1012 
	`R—dSourûFe
(
f’ame
);

1014 
Tok’CoÜd
.
f’ame
 = filename;

1015 
Tok’CoÜd
.
lše
 = Tok’CoÜd.
cŞ
 = Tok’CoÜd.
µlše
 = 1;

1016 
Ty³defNames
 = 
	`C»©eVeùÜ
(8);

1017 
Ov”lßdNames
 = 
	`C»©eVeùÜ
(8);

1019 
	`CREATE_AST_NODE
(
ŒªsUn™
, 
T¿n¦©iÚUn™
);

1020 

 = &
ŒªsUn™
->
extDeşs
;

1022 
NEXT_TOKEN
;

1023 
Cu¼’tTok’
 !ğ
TK_END
)

1025 *

 = 
	`P¬£Ex‹º®Deş¬©iÚ
();

1026 

 = &(*)->
Ãxt
;

1027 
	`SkTo
(
FIRST_Ex‹º®Deş¬©iÚ
, "the beginning ofƒxternal declaration");

1030 
	`Clo£SourûFe
();

1032  
ŒªsUn™
;

1033 
	}
}

	@ucl/decl.h

1 #iâdeà
__DECL_H_


2 
	#__DECL_H_


	)

4 ’um { 
	mDEC_ABSTRACT
 = 0x01, 
	mDEC_CONCRETE
 = 0x02};

5 ’um { 
	mPOINTER_TO
, 
	mARRAY_OF
, 
	mFUNCTION_RETURN
 };

7 
	#AST_DECLARATOR_COMMON
 \

	)

8 
	gAST_NODE_COMMON
 \

9 
a¡Deş¬©Ü
 *
	gdec
; \

10 *
	gid
; \

11 
Ty³D”ivLi¡
 
	gtyDrvLi¡
;

13 
	stdÇme


15 *
	mid
;

16 
	mËv–
;

17 
	mov”lßd
;

18 } *
	tTDName
;

20 
	sty³D”ivLi¡


22 
	mùÜ
;

25 
	mËn
;

26 
	mqu®
;

27 
SigÇtu»
 
	msig
;

29 
ty³D”ivLi¡
 *
	mÃxt
;

30 } *
	tTy³D”ivLi¡
;

32 
a¡S³cif›rs
 *
	tA¡S³cif›rs
;

34 
	sa¡Deş¬©Ü


36 
	mAST_DECLARATOR_COMMON


37 } *
	tA¡Deş¬©Ü
;

39 
	sa¡In™Ÿliz”


41 
AST_NODE_COMMON


42 
	mlb¿û
;

45 
A¡Node
 
	mš™Ÿls
;

46 
A¡Ex´essiÚ
 
	mex´
;

48 
In™D©a
 
	mid©a
;

49 } *
	tA¡In™Ÿliz”
;

51 
	sa¡In™Deş¬©Ü


53 
AST_NODE_COMMON


54 
A¡Deş¬©Ü
 
	mdec
;

55 
A¡In™Ÿliz”
 
	mš™
;

56 } *
	tA¡In™Deş¬©Ü
;

58 
	sa¡P¬am‘”Deş¬©iÚ


60 
AST_NODE_COMMON


61 
A¡S³cif›rs
 
	m¥ecs
;

62 
A¡Deş¬©Ü
 
	mdec
;

63 } *
	tA¡P¬am‘”Deş¬©iÚ
;

65 
	sa¡P¬am‘”Ty³Li¡


67 
AST_NODE_COMMON


68 
A¡Node
 
	m·¿mDeşs
;

69 
	m–l£
;

70 } *
	tA¡P¬am‘”Ty³Li¡
;

72 
	sa¡FunùiÚDeş¬©Ü


74 
AST_DECLARATOR_COMMON


75 
VeùÜ
 
	mids
;

76 
A¡P¬am‘”Ty³Li¡
 
	m·¿mTyLi¡
;

77 
	m·¹OfDef
;

78 
SigÇtu»
 
	msig
;

79 } *
	tA¡FunùiÚDeş¬©Ü
;

81 
	sa¡A¼ayDeş¬©Ü


83 
AST_DECLARATOR_COMMON


84 
A¡Ex´essiÚ
 
	mex´
;

85 } *
	tA¡A¼ayDeş¬©Ü
;

87 
	sa¡Poš‹rDeş¬©Ü


89 
AST_DECLARATOR_COMMON


90 
A¡Node
 
	mtyQu®s
;

91 } *
	tA¡Poš‹rDeş¬©Ü
;

93 
	sa¡SŒuùDeş¬©Ü


95 
AST_NODE_COMMON


96 
A¡Deş¬©Ü
 
	mdec
;

97 
A¡Ex´essiÚ
 
	mex´
;

98 } *
	tA¡SŒuùDeş¬©Ü
;

100 
	sa¡SŒuùDeş¬©iÚ


102 
AST_NODE_COMMON


103 
A¡S³cif›rs
 
	m¥ecs
;

104 
A¡Node
 
	m¡Decs
;

105 } *
	tA¡SŒuùDeş¬©iÚ
;

107 
	sa¡SŒuùS³cif›r


109 
AST_NODE_COMMON


110 *
	mid
;

111 
A¡Node
 
	m¡Deşs
;

112 } *
	tA¡SŒuùS³cif›r
;

114 
	sa¡Enum”©Ü


116 
AST_NODE_COMMON


117 *
	mid
;

118 
A¡Ex´essiÚ
 
	mex´
;

119 } *
	tA¡Enum”©Ü
;

121 
	sa¡EnumS³cif›r


123 
AST_NODE_COMMON


124 *
	mid
;

125 
A¡Node
 
	m’um”s
;

126 } *
	tA¡EnumS³cif›r
;

128 
	sa¡Ty³defName


130 
AST_NODE_COMMON


131 *
	mid
;

132 
SymbŞ
 
	msym
;

133 } *
	tA¡Ty³defName
;

135 
	sa¡Tok’


137 
AST_NODE_COMMON


138 
	mtok’
;

139 } *
	tA¡Tok’
;

141 
	sa¡S³cif›rs


143 
AST_NODE_COMMON


144 
A¡Node
 
	m¡gCÏs£s
;

145 
A¡Node
 
	mtyQu®s
;

146 
A¡Node
 
	mtyS³cs
;

147 
	msşass
;

148 
Ty³
 
	mty
;

151 
	sa¡Ty³Name


153 
AST_NODE_COMMON


154 
A¡S³cif›rs
 
	m¥ecs
;

155 
A¡Deş¬©Ü
 
	mdec
;

158 
	sa¡Deş¬©iÚ


160 
AST_NODE_COMMON


161 
A¡S³cif›rs
 
	m¥ecs
;

162 
A¡Node
 
	mš™Decs
;

165 
	sa¡FunùiÚ


167 
AST_NODE_COMMON


168 
A¡S³cif›rs
 
	m¥ecs
;

169 
A¡Deş¬©Ü
 
	mdec
;

170 
A¡FunùiÚDeş¬©Ü
 
	mfdec
;

171 
A¡Node
 
	mdeşs
;

172 
A¡S‹m’t
 
	m¡mt
;

173 
FunùiÚSymbŞ
 
	mfsym
;

174 
Lab–
 
	mÏb–s
;

175 
VeùÜ
 
	mloİs
;

176 
VeùÜ
 
	mswtches
;

177 
VeùÜ
 
	mb»akabË
;

178 
	mhasR‘uº
;

179 } *
	tA¡FunùiÚ
;

181 
	sa¡T¿n¦©iÚUn™


183 
AST_NODE_COMMON


184 
A¡Node
 
	mextDeşs
;

187 
CheckLoÿlDeş¬©iÚ
(
A¡Deş¬©iÚ
 
deş
, 
VeùÜ
 
v
);

188 
Ty³
 
CheckTy³Name
(
A¡Ty³Name
 
Šame
);

190 
A¡FunùiÚ
 
CURRENTF
;

	@ucl/declchk.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"deş.h
"

4 
	~"ex´.h
"

5 
	~"¡mt.h
"

7 
A¡FunùiÚ
 
	gCURRENTF
;

8 
FunùiÚSymbŞ
 
	gFSYM
;

10 
CheckDeş¬©iÚS³cif›rs
(
A¡S³cif›rs
 
¥ecs
);

11 
CheckDeş¬©Ü
(
A¡Deş¬©Ü
 
dec
);

19 
A¡Ex´essiÚ
 
	$CheckAdd»ssCÚ¡ªt
(
A¡Ex´essiÚ
 
ex´
)

21 
A¡Ex´essiÚ
 
addr
;

22 
A¡Ex´essiÚ
 
p
;

23 
off£t
 = 0;

25 ià(! 
	`IsPŒTy³
(
ex´
->
ty
))

26  
NULL
;

28 ià(
ex´
->
İ
 =ğ
OP_ADD
 ||ƒx´->İ =ğ
OP_SUB
)

30 
addr
 = 
	`CheckAdd»ssCÚ¡ªt
(
ex´
->
kids
[0]);

31 ià(
addr
 =ğ
NULL
 || 
ex´
->
kids
[1]->
İ
 !ğ
OP_CONST
)

32  
NULL
;

34 
ex´
->
kids
[0] = 
addr
->kids[0];

35 
ex´
->
kids
[1]->
v®
.
i
[0] +ğÓx´->
İ
 =ğ
OP_ADD
 ? 1 : -1è* 
addr
->kids[1]->val.i[0];

37  
ex´
;

40 ià(
ex´
->
İ
 =ğ
OP_ADDRESS
)

41 
addr
 = 
ex´
->
kids
[0];

43 
addr
 = 
ex´
;

45 
addr
->
İ
 =ğ
OP_INDEX
 ||‡ddr->İ =ğ
OP_MEMBER
)

47 ià(
addr
->
İ
 =ğ
OP_INDEX
)

49 ià(
addr
->
kids
[1]->
İ
 !ğ
OP_CONST
)

50  
NULL
;

52 
off£t
 +ğ
addr
->
kids
[1]->
v®
.
i
[0] *‡ddr->
ty
->
size
;

56 
F›ld
 
æd
 = 
addr
->
v®
.
p
;

58 
off£t
 +ğ
æd
->offset;

60 
addr
 =‡ddr->
kids
[0];

63 ià(
addr
->
İ
 !ğ
OP_ID
 || (
ex´
->İ !ğ
OP_ADDRESS
 && !‡ddr->
i§¼ay
 && !‡ddr->
isfunc
))

64  
NULL
;

67 ((
SymbŞ
)
addr
->
v®
.
p
)->
»f
++;

69 
	`CREATE_AST_NODE
(
p
, 
Ex´essiÚ
);

70 
p
->
İ
 = 
OP_ADD
;

71 
p
->
ty
 = 
ex´
->ty;

72 
p
->
kids
[0] = 
addr
;

73 
p
->
kids
[1] = 
	`CÚ¡ªt
(
addr
->
coÜd
, 
	`T
(
INT
),…->
v®
);

75  
p
;

76 
	}
}

78 
	$CheckIn™CÚ¡ªt
(
A¡In™Ÿliz”
 
š™
)

80 
In™D©a
 
š™d
 = 
š™
->
id©a
;

82 
š™d
)

84 ià(! (
š™d
->
ex´
->
İ
 =ğ
OP_CONST
 || in™d->ex´->İ =ğ
OP_STR
 ||

85 (
š™d
->
ex´
 = 
	`CheckAdd»ssCÚ¡ªt
(initd->expr))))

87 
	`E¼Ü
(&
š™
->
coÜd
, "Initializer must be constant");

89 
š™d
 = in™d->
Ãxt
;

92 
	}
}

94 
A¡Ex´essiÚ
 
	$BORB™F›ld
(
A¡Ex´essiÚ
 
ex´1
, A¡Ex´essiÚ 
ex´2
)

96 
A¡Ex´essiÚ
 
bÜ
;

98 ià(
ex´1
->
İ
 =ğ
OP_CONST
 && 
ex´2
->op == OP_CONST)

100 
ex´1
->
v®
.
i
[0] |ğ
ex´2
->val.i[0];

101  
ex´1
;

104 
	`CREATE_AST_NODE
(
bÜ
, 
Ex´essiÚ
);

106 
bÜ
->
coÜd
 = 
ex´1
->coord;

107 
bÜ
->
ty
 = 
ex´1
->ty;

108 
bÜ
->
İ
 = 
OP_BITOR
;

109 
bÜ
->
kids
[0] = 
ex´1
;

110 
bÜ
->
kids
[1] = 
ex´2
;

112  
bÜ
;

113 
	}
}

115 
A¡Ex´essiÚ
 
	$PÏûB™F›ld
(
F›ld
 
æd
, 
A¡Ex´essiÚ
 
ex´
)

117 
A¡Ex´essiÚ
 
lsh
;

118 
v®ue
 
v®
;

120 ià(
ex´
->
İ
 =ğ
OP_CONST
)

122 
ex´
->
v®
.
i
[0] <<ğ
æd
->
pos
;

123  
ex´
;

126 
	`CREATE_AST_NODE
(
lsh
, 
Ex´essiÚ
);

128 
lsh
->
coÜd
 = 
ex´
->coord;

129 
lsh
->
ty
 = 
ex´
->ty;

130 
lsh
->
İ
 = 
OP_LSHIFT
;

131 
lsh
->
kids
[0] = 
ex´
;

132 
v®
.
i
[1] = 0;

133 
v®
.
i
[0] = 
æd
->
pos
;

134 
lsh
->
kids
[1] = 
	`CÚ¡ªt
(
ex´
->
coÜd
, 
	`T
(
INT
), 
v®
);

136  
lsh
;

137 
	}
}

139 
A¡In™Ÿliz”
 
	$CheckIn™Ÿliz”IÁ”Çl
(
In™D©a
 *

, 
A¡In™Ÿliz”
 
š™
, 
Ty³
 
ty
,

140 *
off£t
, *
”rÜ
)

142 
A¡In™Ÿliz”
 
p
;

143 
size
 = 0;

144 
In™D©a
 
š™d
;

146 ià(
	`IsSÿÏrTy³
(
ty
))

148 
p
 = 
š™
;

149 ià(
š™
->
lb¿û
)

151 
	`E¼Ü
(&
š™
->
coÜd
, "Can't use brace-enclosed initializer†ist for scalar");

152 *
”rÜ
 = 1;

153 
p
 = (
A¡In™Ÿliz”
)
š™
->
š™Ÿls
;

156 
p
->
ex´
 = 
	`Adju¡
(
	`CheckEx´essiÚ
(p->expr), 1);

157 ià(! 
	`CªAssign
(
ty
, 
p
->
ex´
))

159 
	`E¼Ü
(&
š™
->
coÜd
, "Wrong initializer");

160 *
”rÜ
 = 1;

164 
p
->
ex´
 = 
	`Ca¡
(
ty
,…->expr);

166 
	`ALLOC
(
š™d
);

167 
š™d
->
off£t
 = *offset;

168 
š™d
->
ex´
 = 
p
->expr;

169 
š™d
->
Ãxt
 = 
NULL
;

170 (*

)->
Ãxt
 = 
š™d
;

171 *

 = 
š™d
;

173  (
A¡In™Ÿliz”
)
š™
->
Ãxt
;

175 ià(
ty
->
ÿ‹g
 =ğ
UNION
)

177 
p
 = 
š™
->
lb¿û
 ? (
A¡In™Ÿliz”
)š™->
š™Ÿls
 : init;

178 
ty
 = ((
RecÜdTy³
éy)->
æds
->ty;

180 
p
 = 
	`CheckIn™Ÿliz”IÁ”Çl
(

,…, 
ty
, 
off£t
, 
”rÜ
);

182 ià(
š™
->
lb¿û
)

184 ià(
p
 !ğ
NULL
)

186 
	`E¼Ü
(&
š™
->
coÜd
, "too many initializer for union");

188  (
A¡In™Ÿliz”
)
š™
->
Ãxt
;

191  
p
;

193 ià(
ty
->
ÿ‹g
 =ğ
ARRAY
)

195 
¡¬t
 = *
off£t
;

196 
p
 = 
š™
->
lb¿û
 ? (
A¡In™Ÿliz”
)š™->
š™Ÿls
 : init;

198 ià(((
š™
->
lb¿û
 && ! 
p
->lb¿û &&…->
Ãxt
 =ğ
NULL
) || ! init->lbrace) &&

199 
p
->
ex´
->
İ
 =ğ
OP_STR
 && 
ty
->
ÿ‹g
 / 2 ==…->expr->ty->categ / 2)

201 
size
 = 
p
->
ex´
->
ty
->size;

202 ià(
ty
->
size
 == 0 ||y->size == size)

204 
ty
->
size
 = size;

206 ià(
ty
->
size
 == size - 1)

208 
p
->
ex´
->
ty
->
size
 = size - 1;

210 ià(
ty
->
size
 < size)

212 
	`E¼Ü
(&
š™
->
coÜd
, "string isoo†ong");

213 *
”rÜ
 = 1;

215 
	`ALLOC
(
š™d
);

216 
š™d
->
off£t
 = *offset;

217 
š™d
->
ex´
 = 
p
->expr;

218 
š™d
->
Ãxt
 = 
NULL
;

219 (*

)->
Ãxt
 = 
š™d
;

220 *

 = 
š™d
;

222  (
A¡In™Ÿliz”
)
š™
->
Ãxt
;

225 
p
 !ğ
NULL
)

227 
p
 = 
	`CheckIn™Ÿliz”IÁ”Çl
(

,…, 
ty
->
bty
, 
off£t
, 
”rÜ
);

228 
size
 +ğ
ty
->
bty
->size;

229 *
off£t
 = 
¡¬t
 + 
size
;

230 ià(
ty
->
size
 == size)

234 ià(
ty
->
size
 == 0)

236 
ty
->
size
 = size;

238 ià(
ty
->
size
 < size)

240 
	`E¼Ü
(&
š™
->
coÜd
, "too many initializer");

241 *
”rÜ
 = 1;

244 ià(
š™
->
lb¿û
)

246  (
A¡In™Ÿliz”
)
š™
->
Ãxt
;

248  
p
;

250 ià(
ty
->
ÿ‹g
 =ğ
STRUCT
)

252 
¡¬t
 = *
off£t
;

253 
F›ld
 
æd
 = ((
RecÜdTy³
)
ty
)->
æds
;

254 
p
 = 
š™
->
lb¿û
 ? (
A¡In™Ÿliz”
)š™->
š™Ÿls
 : init;

256 
æd
 && 
p
)

258 *
off£t
 = 
¡¬t
 + 
æd
->offset;

259 
p
 = 
	`CheckIn™Ÿliz”IÁ”Çl
(

,…, 
æd
->
ty
, 
off£t
, 
”rÜ
);

260 ià(
æd
->
b™s
 != 0)

262 (*

)->
ex´
 = 
	`PÏûB™F›ld
(
æd
, (*tail)->expr);

264 
æd
 = fld->
Ãxt
;

267 ià(
š™
->
lb¿û
)

269 ià(
p
 !ğ
NULL
)

271 
	`E¼Ü
(&
š™
->
coÜd
, "too many initializer");

272 *
”rÜ
 = 1;

274 *
off£t
 = 
ty
->
size
;

275  (
A¡In™Ÿliz”
)
š™
->
Ãxt
;

278  (
A¡In™Ÿliz”
)
p
;

281  
š™
;

282 
	}
}

284 
	$CheckIn™Ÿliz”
(
A¡In™Ÿliz”
 
š™
, 
Ty³
 
ty
)

286 
off£t
 = 0, 
”rÜ
 = 0;

287 
š™D©a
 
h—d”
;

288 
In™D©a
 

 = &
h—d”
;

289 
In™D©a
 
´ev
, 
cu¼
;

291 
h—d”
.
Ãxt
 = 
NULL
;

292 ià(
	`IsSÿÏrTy³
(
ty
è&& 
š™
->
lb¿û
)

294 
š™
 = (
A¡In™Ÿliz”
)š™->
š™Ÿls
;

296 ià(
ty
->
ÿ‹g
 =ğ
ARRAY
 && ! (ty->
bty
->ÿ‹g =ğ
CHAR
 ||y->bty->ÿ‹g =ğ
UCHAR
))

298 ià(! 
š™
->
lb¿û
)

300 
	`E¼Ü
(&
š™
->
coÜd
, "Can't initialize‡rray without brace");

304 ià((
ty
->
ÿ‹g
 =ğ
STRUCT
 ||y->ÿ‹g =ğ
UNION
è&& ! 
š™
->
lb¿û
)

306 
š™
->
ex´
 = 
	`Adju¡
(
	`CheckEx´essiÚ
(init->expr), 1);

307 ià(! 
	`CªAssign
(
ty
, 
š™
->
ex´
))

309 
	`E¼Ü
(&
š™
->
coÜd
, "Wrong initializer");

313 
	`ALLOC
(
š™
->
id©a
);

314 
š™
->
id©a
->
ex´
 = init->expr;

315 
š™
->
id©a
->
off£t
 = 0;

316 
š™
->
id©a
->
Ãxt
 = 
NULL
;

321 
	`CheckIn™Ÿliz”IÁ”Çl
(&

, 
š™
, 
ty
, &
off£t
, &
”rÜ
);

322 ià(
”rÜ
)

325 
š™
->
id©a
 = 
h—d”
.
Ãxt
;

326 
´ev
 = 
NULL
;

327 
cu¼
 = 
š™
->
id©a
;

328 
cu¼
)

330 ià(
´ev
 !ğ
NULL
 &&…»v->
off£t
 =ğ
cu¼
->offset)

332 
´ev
->
ex´
 = 
	`BORB™F›ld
Õ»v->ex´, 
cu¼
->expr);

333 
´ev
->
Ãxt
 = 
cu¼
->next;

334 
cu¼
 = cu¼->
Ãxt
;

338 
´ev
 = 
cu¼
;

339 
cu¼
 = cu¼->
Ãxt
;

342 
	}
}

344 
Ty³
 
	$D”iveTy³
(
Ty³D”ivLi¡
 
tyDrvLi¡
, 
Ty³
 
ty
)

346 
tyDrvLi¡
 !ğ
NULL
)

348 ià(
tyDrvLi¡
->
ùÜ
 =ğ
POINTER_TO
)

350 
ty
 = 
	`Qu®ify
(
tyDrvLi¡
->
qu®
, 
	`Poš‹rTo
(ty));

352 ià(
tyDrvLi¡
->
ùÜ
 =ğ
ARRAY_OF
)

354 ià(
ty
->
ÿ‹g
 =ğ
FUNCTION
 ||y->
size
 =ğ0 || (
	`IsRecÜdTy³
Ñyè&& ((
RecÜdTy³
éy)->
hasFËxA¼ay
))

355  
NULL
;

357 
ty
 = 
	`A¼ayOf
(
tyDrvLi¡
->
Ën
,y);

361 ià(
ty
->
ÿ‹g
 =ğ
ARRAY
 ||y->ÿ‹g =ğ
FUNCTION
)

362  
NULL
;

364 
ty
 = 
	`FunùiÚR‘uº
Ñy, 
tyDrvLi¡
->
sig
);

367 
tyDrvLi¡
 =yDrvLi¡->
Ãxt
;

370  
ty
;

371 
	}
}

373 
	$AddP¬am‘”
(
VeùÜ
 
·¿ms
, *
id
, 
Ty³
 
ty
, 
»g
, 
CoÜd
 
coÜd
)

375 
P¬am‘”
 
·¿m
;

377 
	`FOR_EACH_ITEM
(
P¬am‘”
, 
·¿m
, 
·¿ms
)

378 ià(
·¿m
->
id
 &&…aram->id == id)

380 
	`E¼Ü
(
coÜd
, "Redefš·¿m‘” %s", 
id
);

383 
ENDFOR


385 
	`ALLOC
(
·¿m
);

387 
·¿m
->
id
 = id;

388 
·¿m
->
ty
 =y;

389 
·¿m
->
»g
 =„eg;

390 
	`INSERT_ITEM
(
·¿ms
, 
·¿m
);

391 
	}
}

393 
	$CheckP¬am‘”Deş¬©iÚ
(
A¡FunùiÚDeş¬©Ü
 
funcDec
,

394 
A¡P¬am‘”Deş¬©iÚ
 
·¿mDeş
)

396 *
id
 = 
NULL
;

397 
Ty³
 
ty
 = 
NULL
;

399 
	`CheckDeş¬©iÚS³cif›rs
(
·¿mDeş
->
¥ecs
);

400 ià(
·¿mDeş
->
¥ecs
->
sşass
 &&…¬amDeş->¥ecs->sşas !ğ
TK_REGISTER
)

402 
	`E¼Ü
(&
·¿mDeş
->
coÜd
, "Invalid storage class");

404 
ty
 = 
·¿mDeş
->
¥ecs
->ty;

406 
	`CheckDeş¬©Ü
(
·¿mDeş
->
dec
);

407 ià(
·¿mDeş
->
dec
->
id
 =ğ
NULL
 &&…¬amDeş->dec->
tyDrvLi¡
 == NULL &&

408 
ty
->
ÿ‹g
 =ğ
VOID
 && 
	`LEN
(
funcDec
->
sig
->
·¿ms
) == 0)

410 ià(
·¿mDeş
->
Ãxt
 || 
ty
->
qu®
 ||…¬amDeş->
¥ecs
->
sşass
)

412 
	`E¼Ü
(&
·¿mDeş
->
coÜd
, "'void' must behe only…arameter");

413 
·¿mDeş
->
Ãxt
 = 
NULL
;

418 
ty
 = 
	`D”iveTy³
(
·¿mDeş
->
dec
->
tyDrvLi¡
,y);

419 ià(
ty
 !ğ
NULL
)

420 
ty
 = 
	`Adju¡P¬am‘”
(ty);

422 ià(
ty
 =ğ
NULL
 ||y->
size
 == 0)

424 
	`E¼Ü
(&
·¿mDeş
->
coÜd
, "Illegal…arameterype");

428 
id
 = 
·¿mDeş
->
dec
->id;

429 ià(
id
 =ğ
NULL
 && 
funcDec
->
·¹OfDef
)

431 
	`E¼Ü
(&
·¿mDeş
->
coÜd
, "Expect…arameter‚ame");

435 
	`AddP¬am‘”
(
funcDec
->
sig
->
·¿ms
, 
id
, 
ty
, 
·¿mDeş
->
¥ecs
->
sşass
 =ğ
TK_REGISTER
, &·¿mDeş->
coÜd
);

436 
	}
}

438 
	$CheckP¬am‘”Ty³Li¡
(
A¡FunùiÚDeş¬©Ü
 
funcDec
)

440 
A¡P¬am‘”Ty³Li¡
 
·¿mTyLi¡
 = 
funcDec
->paramTyList;

441 
A¡P¬am‘”Deş¬©iÚ
 
·¿mDeş
;

443 
·¿mDeş
 = (
A¡P¬am‘”Deş¬©iÚ
)
·¿mTyLi¡
->
·¿mDeşs
;

444 
·¿mDeş
)

446 
	`CheckP¬am‘”Deş¬©iÚ
(
funcDec
, 
·¿mDeş
);

447 
·¿mDeş
 = (
A¡P¬am‘”Deş¬©iÚ
í¬amDeş->
Ãxt
;

449 
funcDec
->
sig
->
hasEÎ£
 = 
·¿mTyLi¡
->
–l£
;

450 
	}
}

452 
	$CheckFunùiÚDeş¬©Ü
(
A¡FunùiÚDeş¬©Ü
 
dec
)

454 
A¡FunùiÚDeş¬©Ü
 
funcDec
 = (A¡FunùiÚDeş¬©Ü)
dec
;

457 
	`CheckDeş¬©Ü
(
funcDec
->
dec
);

459 
	`ALLOC
(
funcDec
->
sig
);

460 
funcDec
->
sig
->
hasPrÙo
 = funcDec->
·¿mTyLi¡
 !ğ
NULL
;

461 
funcDec
->
sig
->
hasEÎ£
 = 0;

462 
funcDec
->
sig
->
·¿ms
 = 
	`C»©eVeùÜ
(4);

464 ià(
funcDec
->
sig
->
hasPrÙo
)

466 
	`CheckP¬am‘”Ty³Li¡
(
funcDec
);

468 ià(
funcDec
->
·¹OfDef
)

470 *
id
;

471 
	`FOR_EACH_ITEM
(*, 
id
, 
funcDec
->
ids
)

472 
	`AddP¬am‘”
(
funcDec
->
sig
->
·¿ms
, 
id
, 
NULL
, 0, &funcDec->
coÜd
);

473 
ENDFOR


475 ià(
	`LEN
(
funcDec
->
ids
))

477 
	`E¼Ü
(&
funcDec
->
coÜd
, "Identifier†ist should be in definition.");

480 
	`ALLOC
(
funcDec
->
tyDrvLi¡
);

481 
funcDec
->
tyDrvLi¡
->
ùÜ
 = 
FUNCTION_RETURN
;

482 
funcDec
->
tyDrvLi¡
->
sig
 = funcDec->sig;

483 
funcDec
->
tyDrvLi¡
->
Ãxt
 = funcDec->
dec
->tyDrvList;

484 
funcDec
->
id
 = funcDec->
dec
->id;

485 
	}
}

487 
	$CheckA¼ayDeş¬©Ü
(
A¡A¼ayDeş¬©Ü
 
¬rDec
)

489 
	`CheckDeş¬©Ü
(
¬rDec
->
dec
);

490 ià(
¬rDec
->
ex´
)

492 ià((
¬rDec
->
ex´
 = 
	`CheckCÚ¡ªtEx´essiÚ
×¼Dec->ex´)è=ğ
NULL
)

494 
	`E¼Ü
(&
¬rDec
->
coÜd
, "The size ofhe‡rray must be integer constant.");

498 
	`ALLOC
(
¬rDec
->
tyDrvLi¡
);

499 
¬rDec
->
tyDrvLi¡
->
ùÜ
 = 
ARRAY_OF
;

500 
¬rDec
->
tyDrvLi¡
->
Ën
 =‡¼Dec->
ex´
 ?‡¼Dec->ex´->
v®
.
i
[0] : 0;

501 
¬rDec
->
tyDrvLi¡
->
Ãxt
 =‡¼Dec->
dec
->tyDrvList;

502 
¬rDec
->
id
 =‡¼Dec->
dec
->id;

503 
	}
}

505 
	$CheckPoš‹rDeş¬©Ü
(
A¡Poš‹rDeş¬©Ü
 
±rDec
)

507 
qu®
 = 0;

508 
A¡Tok’
 
tok
 = (A¡Tok’)
±rDec
->
tyQu®s
;

510 
	`CheckDeş¬©Ü
(
±rDec
->
dec
);

511 
tok
)

513 
qu®
 |ğ
tok
->
tok’
 =ğ
TK_CONST
 ? 
CONST
 : 
VOLATILE
;

514 
tok
 = (
A¡Tok’
éok->
Ãxt
;

517 
	`ALLOC
(
±rDec
->
tyDrvLi¡
);

518 
±rDec
->
tyDrvLi¡
->
ùÜ
 = 
POINTER_TO
;

519 
±rDec
->
tyDrvLi¡
->
qu®
 = qual;

520 
±rDec
->
tyDrvLi¡
->
Ãxt
 =…ŒDec->
dec
->tyDrvList;

521 
±rDec
->
id
 =…ŒDec->
dec
->id;

522 
	}
}

524 
	$CheckDeş¬©Ü
(
A¡Deş¬©Ü
 
dec
)

526 
dec
->
kšd
)

528 
NK_NameDeş¬©Ü
:

531 
NK_A¼ayDeş¬©Ü
:

532 
	`CheckA¼ayDeş¬©Ü
((
A¡A¼ayDeş¬©Ü
)
dec
);

535 
NK_FunùiÚDeş¬©Ü
:

536 
	`CheckFunùiÚDeş¬©Ü
((
A¡FunùiÚDeş¬©Ü
)
dec
);

539 
NK_Poš‹rDeş¬©Ü
:

540 
	`CheckPoš‹rDeş¬©Ü
((
A¡Poš‹rDeş¬©Ü
)
dec
);

544 
	`as£¹
(0);

546 
	}
}

548 
	$CheckSŒuùDeş¬©Ü
(
Ty³
 
¹y
, 
A¡SŒuùDeş¬©Ü
 
¡Dec
, Ty³ 
áy
)

550 *
id
 = 
NULL
;

551 
b™s
 = 0;

553 ià(
¡Dec
->
dec
 !ğ
NULL
)

555 
	`CheckDeş¬©Ü
(
¡Dec
->
dec
);

556 
id
 = 
¡Dec
->
dec
->id;

557 
áy
 = 
	`D”iveTy³
(
¡Dec
->
dec
->
tyDrvLi¡
, fty);

560 ià(
áy
 =ğ
NULL
 || fty->
ÿ‹g
 =ğ
FUNCTION
 || (áy->
size
 =ğ0 && fty->ÿ‹g !ğ
ARRAY
))

562 
	`E¼Ü
(&
¡Dec
->
coÜd
, "illegalype");

565 ià(((
RecÜdTy³
)
¹y
)->
hasFËxA¼ay
)

567 
	`E¼Ü
(&
¡Dec
->
coÜd
, "the flexible‡rray must behe†ast member");

570 ià(
	`IsRecÜdTy³
(
áy
è&& ((
RecÜdTy³
)áy)->
hasFËxA¼ay
)

572 
	`E¼Ü
(&
¡Dec
->
coÜd
, "A structure has flexible‡rray shall‚ot be‡ member");

575 ià(
id
 && 
	`LookupF›ld
(
¹y
, id))

577 
	`E¼Ü
(&
¡Dec
->
coÜd
, "member„edefinition");

581 ià(
¡Dec
->
ex´
)

583 
¡Dec
->
ex´
 = 
	`CheckCÚ¡ªtEx´essiÚ
(stDec->expr);

584 ià(
¡Dec
->
ex´
 =ğ
NULL
)

586 
	`E¼Ü
(&
¡Dec
->
coÜd
, "The width of bit field should be integer constant.");

588 ià(
id
 && 
¡Dec
->
ex´
->
v®
.
i
[0] == 0)

590 
	`E¼Ü
(&
¡Dec
->
coÜd
, "bit field's width should‚ot be 0");

592 ià(
áy
->
ÿ‹g
 !ğ
INT
 && fty->ÿ‹g !ğ
UINT
)

594 
	`E¼Ü
(&
¡Dec
->
coÜd
, "Bit field must be integerype.");

595 
áy
 = 
	`T
(
INT
);

598 
b™s
 = 
¡Dec
->
ex´
 ? stDec->ex´->
v®
.
i
[0] : 0;

599 ià(
b™s
 > 
	`T
(
INT
)->
size
 * 8)

601 
	`E¼Ü
(&
¡Dec
->
coÜd
, "Bit field's widthƒxceeds");

602 
b™s
 = 0;

605 
	`AddF›ld
(
¹y
, 
id
, 
áy
, 
b™s
);

606 
	}
}

608 
	$CheckSŒuùDeş¬©iÚ
(
A¡SŒuùDeş¬©iÚ
 
¡Deş
, 
Ty³
 
¹y
)

610 
A¡SŒuùDeş¬©Ü
 
¡Dec
;

612 
	`CheckDeş¬©iÚS³cif›rs
(
¡Deş
->
¥ecs
);

613 
¡Dec
 = (
A¡SŒuùDeş¬©Ü
)
¡Deş
->
¡Decs
;

614 ià(
¡Dec
 =ğ
NULL
)

617 
	`AddF›ld
(
¹y
, 
NULL
, 
¡Deş
->
¥ecs
->
ty
, 0);

620 
¡Dec
)

622 
	`CheckSŒuùDeş¬©Ü
(
¹y
, 
¡Dec
, 
¡Deş
->
¥ecs
->
ty
);

623 
¡Dec
 = (
A¡SŒuùDeş¬©Ü
)¡Dec->
Ãxt
;

625 
	}
}

627 
Ty³
 
	$CheckSŒuùOrUniÚS³cif›r
(
A¡SŒuùS³cif›r
 
¡S³c
)

629 
ÿ‹g
 = (
¡S³c
->
kšd
 =ğ
NK_SŒuùS³cif›r
è? 
STRUCT
 : 
UNION
;

630 
SymbŞ
 
g
;

631 
Ty³
 
ty
;

632 
A¡SŒuùDeş¬©iÚ
 
¡Deş
;

634 ià(
¡S³c
->
id
 !ğ
NULL
 && stS³c->
¡Deşs
 == NULL)

636 
g
 = 
	`LookupTag
(
¡S³c
->
id
);

637 ià(
g
 =ğ
NULL
)

639 
ty
 = 
	`S¹RecÜd
(
¡S³c
->
id
, 
ÿ‹g
);

640 
g
 = 
	`AddTag
(
¡S³c
->
id
, 
ty
);

642 ià(
g
->
ty
->
ÿ‹g
 != categ)

644 
	`E¼Ü
(&
¡S³c
->
coÜd
, "Inconsistentag declaration.");

647  
g
->
ty
;

649 ià(
¡S³c
->
id
 =ğ
NULL
 && stS³c->
¡Deşs
 != NULL)

651 
ty
 = 
	`S¹RecÜd
(
NULL
, 
ÿ‹g
);

652 
chk_deşs
;

654 ià(
¡S³c
->
id
 !ğ
NULL
 && stS³c->
¡Deşs
 != NULL)

656 
g
 = 
	`LookupTag
(
¡S³c
->
id
);

657 ià(
g
 =ğ
NULL
 ||ag->
Ëv–
 < 
Lev–
)

659 
ty
 = 
	`S¹RecÜd
(
¡S³c
->
id
, 
ÿ‹g
);

660 
	`AddTag
(
¡S³c
->
id
, 
ty
);

662 ià(
g
->
ty
->
ÿ‹g
 =ğÿ‹g &&ag->ty->
size
 == 0)

664 
ty
 = 
g
->ty;

668 
	`E¼Ü
(&
¡S³c
->
coÜd
, "Tag„edefinition.");

669  
g
->
ty
;

671 
chk_deşs
;

675 
ty
 = 
	`S¹RecÜd
(
NULL
, 
ÿ‹g
);

676 
	`EndRecÜd
(
ty
);

677  
ty
;

680 
chk_deşs
:

681 
¡Deş
 = (
A¡SŒuùDeş¬©iÚ
)
¡S³c
->
¡Deşs
;

683 
¡Deş
)

685 
	`CheckSŒuùDeş¬©iÚ
(
¡Deş
, 
ty
);

686 
¡Deş
 = (
A¡SŒuùDeş¬©iÚ
)¡Deş->
Ãxt
;

688 
	`EndRecÜd
(
ty
);

690  
ty
;

691 
	}
}

693 
	$CheckEnum”©Ü
(
A¡Enum”©Ü
 
’um”
, 
Ï¡
, 
Ty³
 
ty
)

695 ià(
’um”
->
ex´
 =ğ
NULL
)

697 
	`AddEnumCÚ¡ªt
(
’um”
->
id
, 
ty
, 
Ï¡
 + 1);

698  
Ï¡
 + 1;

702 
’um”
->
ex´
 = 
	`CheckCÚ¡ªtEx´essiÚ
(enumer->expr);

703 ià(
’um”
->
ex´
 =ğ
NULL
)

705 
	`E¼Ü
(&
’um”
->
coÜd
, "Theƒnumerator value must be integer constant.");

706 
	`AddEnumCÚ¡ªt
(
’um”
->
id
, 
ty
, 
Ï¡
 + 1);

707  
Ï¡
 + 1;

709 
	`AddEnumCÚ¡ªt
(
’um”
->
id
, 
ty
,ƒnum”->
ex´
->
v®
.
i
[0]);

711  
’um”
->
ex´
->
v®
.
i
[0];

713 
	}
}

715 
Ty³
 
	$CheckEnumS³cif›r
(
A¡EnumS³cif›r
 
’umS³c
)

717 
A¡Enum”©Ü
 
’um”
;

718 
SymbŞ
 
g
;

719 
Ty³
 
ty
;

720 
Ï¡
;

722 ià(
’umS³c
->
id
 =ğ
NULL
 &&ƒnumS³c->
’um”s
 == NULL)

723  
	`T
(
INT
);

725 ià(
’umS³c
->
id
 !ğ
NULL
 &&ƒnumS³c->
’um”s
 == NULL)

727 
g
 = 
	`LookupTag
(
’umS³c
->
id
);

728 ià(
g
 =ğ
NULL
 || (g->
Ëv–
 =ğ
Lev–
 &&ag->
ty
->
ÿ‹g
 !ğ
ENUM
))

730 
	`E¼Ü
(&
’umS³c
->
coÜd
, "Undeclaredƒnumype.");

731  
	`T
(
INT
);

733  
g
->
ty
;

735 ià(
’umS³c
->
id
 =ğ
NULL
 &&ƒnumS³c->
’um”s
 != NULL)

737 
ty
 = 
	`T
(
INT
);

738 
chk_’um”
;

742 
g
 = 
	`LookupTag
(
’umS³c
->
id
);

743 ià(
g
 =ğ
NULL
 ||ag->
Ëv–
 < 
Lev–
)

745 
g
 = 
	`AddTag
(
’umS³c
->
id
, 
	`Enum
(enumSpec->id));

747 ià(
g
->
ty
->
ÿ‹g
 !ğ
ENUM
)

749 
	`E¼Ü
(&
’umS³c
->
coÜd
, "Tag„edefinition.");

750  
	`T
(
INT
);

753 
ty
 = 
g
->ty;

754 
chk_’um”
;

757 
chk_’um”
:

758 
’um”
 = (
A¡Enum”©Ü
)
’umS³c
->
’um”s
;

759 
Ï¡
 = -1;

760 
’um”
)

762 
Ï¡
 = 
	`CheckEnum”©Ü
(
’um”
,†a¡, 
ty
);

763 
’um”
 = (
A¡Enum”©Ü
ënum”->
Ãxt
;

766  
ty
;

767 
	}
}

769 
	$CheckDeş¬©iÚS³cif›rs
(
A¡S³cif›rs
 
¥ecs
)

771 
A¡Tok’
 
tok
;

772 
A¡Node
 
p
;

773 
Ty³
 
ty
;

774 
size
 = 0, 
sign
 = 0;

775 
signCÁ
 = 0, 
sizeCÁ
 = 0, 
tyCÁ
 = 0;

776 
qu®
 = 0;

778 
tok
 = (
A¡Tok’
)
¥ecs
->
¡gCÏs£s
;

779 ià(
tok
)

781 ià(
tok
->
Ãxt
)

783 
	`E¼Ü
(&
¥ecs
->
coÜd
, "At most one storage class");

785 
¥ecs
->
sşass
 = 
tok
->
tok’
;

788 
tok
 = (
A¡Tok’
)
¥ecs
->
tyQu®s
;

789 
tok
)

791 
qu®
 |ğ(
tok
->
tok’
 =ğ
TK_CONST
 ? 
CONST
 : 
VOLATILE
);

792 
tok
 = (
A¡Tok’
éok->
Ãxt
;

795 
p
 = 
¥ecs
->
tyS³cs
;

796 
p
)

798 ià(
p
->
kšd
 =ğ
NK_SŒuùS³cif›r
 ||…->kšd =ğ
NK_UniÚS³cif›r
)

800 
ty
 = 
	`CheckSŒuùOrUniÚS³cif›r
((
A¡SŒuùS³cif›r
)
p
);

801 
tyCÁ
++;

803 ià(
p
->
kšd
 =ğ
NK_EnumS³cif›r
)

805 
ty
 = 
	`CheckEnumS³cif›r
((
A¡EnumS³cif›r
)
p
);

806 
tyCÁ
++;

808 ià(
p
->
kšd
 =ğ
NK_Ty³defName
)

810 
SymbŞ
 
sym
 = 
	`LookupID
(((
A¡Ty³defName
)
p
)->
id
);

812 
	`as£¹
(
sym
->
kšd
 =ğ
SK_Ty³defName
);

813 
ty
 = 
sym
->ty;

814 
tyCÁ
++;

818 
tok
 = (
A¡Tok’
)
p
;

820 
tok
->
tok’
)

822 
TK_SIGNED
:

823 
TK_UNSIGNED
:

824 
sign
 = 
tok
->
tok’
;

825 
signCÁ
++;

828 
TK_SHORT
:

829 
TK_LONG
:

830 ià(
size
 =ğ
TK_LONG
 && 
sizeCÁ
 == 1)

832 
size
 = 
TK_LONG
 + TK_LONG;

836 
size
 = 
tok
->
tok’
;

837 
sizeCÁ
++;

841 
TK_CHAR
:

842 
ty
 = 
	`T
(
CHAR
);

843 
tyCÁ
++;

846 
TK_INT
:

847 
ty
 = 
	`T
(
INT
);

848 
tyCÁ
++;

851 
TK_INT64
:

852 
ty
 = 
	`T
(
INT
);

853 
size
 = 
TK_LONG
 + TK_LONG;

854 
sizeCÁ
++;

857 
TK_FLOAT
:

858 
ty
 = 
	`T
(
FLOAT
);

859 
tyCÁ
++;

862 
TK_DOUBLE
:

863 
ty
 = 
	`T
(
DOUBLE
);

864 
tyCÁ
++;

867 
TK_VOID
:

868 
ty
 = 
	`T
(
VOID
);

869 
tyCÁ
++;

873 
p
 =…->
Ãxt
;

876 
ty
 = 
tyCÁ
 =ğ0 ? 
	`T
(
INT
) :y;

878 ià(
sizeCÁ
 > 1 || 
signCÁ
 > 1 || 
tyCÁ
 > 1)

879 
”r
;

881 ià(
ty
 =ğ
	`T
(
DOUBLE
è&& 
size
 =ğ
TK_LONG
)

883 
ty
 = 
	`T
(
LONGDOUBLE
);

884 
size
 = 0;

886 ià(
ty
 =ğ
	`T
(
CHAR
))

888 
sign
 = (sigÀ=ğ
TK_UNSIGNED
);

889 
ty
 = 
	`T
(
CHAR
 + 
sign
);

890 
sign
 = 0;

893 ià(
ty
 =ğ
	`T
(
INT
))

895 
sign
 = (sigÀ=ğ
TK_UNSIGNED
);

897 
size
)

899 
TK_SHORT
:

900 
ty
 = 
	`T
(
SHORT
 + 
sign
);

903 
TK_LONG
:

904 
ty
 = 
	`T
(
LONG
 + 
sign
);

907 
TK_LONG
 + TK_LONG:

908 
ty
 = 
	`T
(
LONGLONG
 + 
sign
);

912 
	`as£¹
(
size
 == 0);

913 
ty
 = 
	`T
(
INT
 + 
sign
);

918 ià(
size
 !ğ0 || 
sign
 != 0)

920 
”r
;

923 
¥ecs
->
ty
 = 
	`Qu®ify
(
qu®
,y);

926 
”r
:

927 
	`E¼Ü
(&
¥ecs
->
coÜd
, "Illegalype specifier.");

928 
¥ecs
->
ty
 = 
	`T
(
INT
);

930 
	}
}

932 
	$CheckTy³def
(
A¡Deş¬©iÚ
 
deş
)

934 
A¡In™Deş¬©Ü
 
š™Dec
;

935 
Ty³
 
ty
;

936 
SymbŞ
 
sym
;

938 
š™Dec
 = (
A¡In™Deş¬©Ü
)
deş
->
š™Decs
;

939 
š™Dec
)

941 
	`CheckDeş¬©Ü
(
š™Dec
->
dec
);

942 ià(
š™Dec
->
dec
->
id
 =ğ
NULL
)

943 
Ãxt
;

945 
ty
 = 
	`D”iveTy³
(
š™Dec
->
dec
->
tyDrvLi¡
, 
deş
->
¥ecs
->ty);

946 ià(
ty
 =ğ
NULL
)

948 
	`E¼Ü
(&
š™Dec
->
coÜd
, "Illegalype");

949 
ty
 = 
	`T
(
INT
);

952 ià(
š™Dec
->
š™
)

954 
	`E¼Ü
(&
š™Dec
->
coÜd
, "Can't initializeypedef‚ame");

957 
sym
 = 
	`LookupID
(
š™Dec
->
dec
->
id
);

958 ià(
sym
 && sym->
Ëv–
 =ğ
Lev–
 && (sym->
kšd
 !ğ
SK_Ty³defName
 || ! 
	`IsCom·tibËTy³
(
ty
, sym->ty)))

960 
	`E¼Ü
(&
š™Dec
->
coÜd
, "Redeş¬©iÚ oà%s", in™Dec->
dec
->
id
);

964 
	`AddTy³defName
(
š™Dec
->
dec
->
id
, 
ty
);

966 
Ãxt
:

967 
š™Dec
 = (
A¡In™Deş¬©Ü
)š™Dec->
Ãxt
;

969 
	}
}

971 
Ty³
 
	$CheckTy³Name
(
A¡Ty³Name
 
Šame
)

973 
Ty³
 
ty
;

975 
	`CheckDeş¬©iÚS³cif›rs
(
Šame
->
¥ecs
);

976 
	`CheckDeş¬©Ü
(
Šame
->
dec
);

977 
ty
 = 
	`D”iveTy³
(
Šame
->
dec
->
tyDrvLi¡
,Çme->
¥ecs
->ty);

978 ià(
ty
 =ğ
NULL
)

980 
	`E¼Ü
(&
Šame
->
coÜd
, "Illegalype");

981 
ty
 = 
	`T
(
INT
);

983  
ty
;

984 
	}
}

986 
	$CheckLoÿlDeş¬©iÚ
(
A¡Deş¬©iÚ
 
deş
, 
VeùÜ
 
v
)

988 
A¡In™Deş¬©Ü
 
š™Dec
;

989 
Ty³
 
ty
;

990 
sşass
;

991 
SymbŞ
 
sym
;

993 
	`CheckDeş¬©iÚS³cif›rs
(
deş
->
¥ecs
);

994 ià(
deş
->
¥ecs
->
sşass
 =ğ
TK_TYPEDEF
)

996 
	`CheckTy³def
(
deş
);

999 
ty
 = 
deş
->
¥ecs
->ty;

1000 
sşass
 = 
deş
->
¥ecs
->sclass;

1001 ià(
sşass
 == 0)

1003 
sşass
 = 
TK_AUTO
;

1006 
š™Dec
 = (
A¡In™Deş¬©Ü
)
deş
->
š™Decs
;

1007 
š™Dec
)

1009 
	`CheckDeş¬©Ü
(
š™Dec
->
dec
);

1010 ià(
š™Dec
->
dec
->
id
 =ğ
NULL
)

1011 
Ãxt
;

1013 
ty
 = 
	`D”iveTy³
(
š™Dec
->
dec
->
tyDrvLi¡
, 
deş
->
¥ecs
->ty);

1014 ià(
ty
 =ğ
NULL
)

1016 
	`E¼Ü
(&
š™Dec
->
coÜd
, "Illegalype");

1017 
ty
 = 
	`T
(
INT
);

1020 ià(
š™Dec
->
dec
->
kšd
 =ğ
NK_NameDeş¬©Ü
 && 
	`IsFunùiÚTy³
(
ty
))

1022 
ty
 = 
	`Poš‹rTo
(ty);

1025 ià(
	`IsFunùiÚTy³
(
ty
))

1027 ià(
sşass
 =ğ
TK_STATIC
)

1029 
	`E¼Ü
(&
deş
->
coÜd
, "can't specify static for block-scope function");

1031 ià(
š™Dec
->
š™
 !ğ
NULL
)

1033 
	`E¼Ü
(&
š™Dec
->
coÜd
, "please don't initialize function");

1036 ià((
sym
 = 
	`LookupID
(
š™Dec
->
dec
->
id
)è=ğ
NULL
)

1038 
sym
 = 
	`AddFunùiÚ
(
š™Dec
->
dec
->
id
, 
ty
, 
TK_EXTERN
);

1040 ià(! 
	`IsCom·tibËTy³
(
sym
->
ty
,y))

1042 
	`E¼Ü
(&
deş
->
coÜd
, "Incompatible with…revious declaration");

1046 
sym
->
ty
 = 
	`Compos™eTy³
(sym->ty,y);

1049 
Ãxt
;

1052 ià(
sşass
 =ğ
TK_EXTERN
 && 
š™Dec
->
š™
 !ğ
NULL
)

1054 
	`E¼Ü
(&
š™Dec
->
coÜd
, "can't initializeƒxtern variable");

1055 
š™Dec
->
š™
 = 
NULL
;

1058 ià((
sym
 = 
	`LookupID
(
š™Dec
->
dec
->
id
)è=ğ
NULL
 || sym->
Ëv–
 !ğ
Lev–
)

1060 
V¬ŸbËSymbŞ
 
vsym
;

1062 
vsym
 = (
V¬ŸbËSymbŞ
)
	`AddV¬ŸbË
(
š™Dec
->
dec
->
id
, 
ty
, 
sşass
);

1063 ià(
š™Dec
->
š™
)

1065 
	`CheckIn™Ÿliz”
(
š™Dec
->
š™
, 
ty
);

1066 ià(
sşass
 =ğ
TK_STATIC
)

1068 
	`CheckIn™CÚ¡ªt
(
š™Dec
->
š™
);

1072 
	`INSERT_ITEM
(
v
, 
vsym
);

1074 
vsym
->
id©a
 = 
š™Dec
->
š™
->idata;

1077 ià(! (
sym
->
sşass
 =ğ
TK_EXTERN
 && sşas =ğTK_EXTERN && 
	`IsCom·tibËTy³
(sym->
ty
,y)))

1079 
	`E¼Ü
(&
deş
->
coÜd
, "Variable„edefinition");

1081 
Ãxt
:

1082 
š™Dec
 = (
A¡In™Deş¬©Ü
)š™Dec->
Ãxt
;

1084 
	}
}

1086 
	$CheckGlob®Deş¬©iÚ
(
A¡Deş¬©iÚ
 
deş
)

1088 
A¡In™Deş¬©Ü
 
š™Dec
;

1089 
Ty³
 
ty
;

1090 
SymbŞ
 
sym
;

1091 
sşass
;

1093 
	`CheckDeş¬©iÚS³cif›rs
(
deş
->
¥ecs
);

1094 ià(
deş
->
¥ecs
->
sşass
 =ğ
TK_TYPEDEF
)

1096 
	`CheckTy³def
(
deş
);

1100 
ty
 = 
deş
->
¥ecs
->ty;

1101 
sşass
 = 
deş
->
¥ecs
->sclass;

1102 ià(
sşass
 =ğ
TK_REGISTER
 || sşas =ğ
TK_AUTO
)

1104 
	`E¼Ü
(&
deş
->
coÜd
, "Invalid storage class");

1105 
sşass
 = 
TK_EXTERN
;

1108 
š™Dec
 = (
A¡In™Deş¬©Ü
)
deş
->
š™Decs
;

1109 
š™Dec
)

1111 
	`CheckDeş¬©Ü
(
š™Dec
->
dec
);

1112 ià(
š™Dec
->
dec
->
id
 =ğ
NULL
)

1113 
Ãxt
;

1115 
ty
 = 
	`D”iveTy³
(
š™Dec
->
dec
->
tyDrvLi¡
, 
deş
->
¥ecs
->ty);

1116 ià(
ty
 =ğ
NULL
)

1118 
	`E¼Ü
(&
š™Dec
->
coÜd
, "Illegalype");

1119 
ty
 = 
	`T
(
INT
);

1121 ià(
š™Dec
->
dec
->
kšd
 =ğ
NK_NameDeş¬©Ü
 && 
	`IsFunùiÚTy³
(
ty
))

1123 
ty
 = 
	`Poš‹rTo
(ty);

1126 ià(
	`IsFunùiÚTy³
(
ty
))

1128 ià(
š™Dec
->
š™
)

1130 
	`E¼Ü
(&
š™Dec
->
coÜd
, "please don't initalize function");

1133 ià((
sym
 = 
	`LookupID
(
š™Dec
->
dec
->
id
)è=ğ
NULL
)

1135 
sym
 = 
	`AddFunùiÚ
(
š™Dec
->
dec
->
id
, 
ty
, 
sşass
 =ğ0 ? 
TK_EXTERN
 : sclass);

1139 ià(
sym
->
sşass
 =ğ
TK_EXTERN
 && sşas =ğ
TK_STATIC
)

1141 
	`E¼Ü
(&
deş
->
coÜd
, "CÚæiù†škagoàfunùiÚ %s", 
š™Dec
->
dec
->
id
);

1144 ià(! 
	`IsCom·tibËTy³
(
ty
, 
sym
->ty))

1146 
	`E¼Ü
(&
deş
->
coÜd
, "Incomptabile with…revious declaration");

1150 
sym
->
ty
 = 
	`Compos™eTy³
(ty, sym->ty);

1153 
Ãxt
;

1156 ià((
sym
 = 
	`LookupID
(
š™Dec
->
dec
->
id
)è=ğ
NULL
)

1158 
sym
 = 
	`AddV¬ŸbË
(
š™Dec
->
dec
->
id
, 
ty
, 
sşass
);

1161 ià(
š™Dec
->
š™
)

1163 
	`CheckIn™Ÿliz”
(
š™Dec
->
š™
, 
ty
);

1164 
	`CheckIn™CÚ¡ªt
(
š™Dec
->
š™
);

1167 ià(
ty
->
size
 =ğ0 && ! (
sşass
 !ğ
TK_STATIC
 &&y->
ÿ‹g
 =ğ
ARRAY
) &&

1168 ! (
sşass
 =ğ
TK_EXTERN
 && 
	`IsRecÜdTy³
(
ty
)))

1170 
	`E¼Ü
(&
š™Dec
->
coÜd
, "UnknowÀsizoà%s", in™Dec->
dec
->
id
);

1171 
ty
 = 
	`T
(
INT
);

1175 
sşass
 = sşas =ğ
TK_EXTERN
 ? 
sym
->sclass : sclass;

1177 ià((
sşass
 =ğ0 && 
sym
->sşas =ğ
TK_STATIC
) || (sclass != 0 && sym->sclass != sclass))

1179 
	`E¼Ü
(&
deş
->
coÜd
, "CÚæiù†škagoà%s", 
š™Dec
->
dec
->
id
);

1181 ià(
sym
->
sşass
 =ğ
TK_EXTERN
)

1182 
sym
->
sşass
 = sclass;

1184 ià(! 
	`IsCom·tibËTy³
(
ty
, 
sym
->ty))

1186 
	`E¼Ü
(&
deş
->
coÜd
, "Incom·tibË w™h…»viou defš™iÚ", 
š™Dec
->
dec
->
id
);

1187 
Ãxt
;

1191 
sym
->
ty
 = 
	`Compos™eTy³
(sym->ty,y);

1194 ià(
š™Dec
->
š™
)

1196 ià(
sym
->
defšed
)

1198 
	`E¼Ü
(&
š™Dec
->
coÜd
, "»defš™iÚ oà%s", in™Dec->
dec
->
id
);

1202 
	`AsV¬
(
sym
)->
id©a
 = 
š™Dec
->
š™
->idata;

1203 
sym
->
defšed
 = 1;

1207 
Ãxt
:

1208 
š™Dec
 = (
A¡In™Deş¬©Ü
)š™Dec->
Ãxt
;

1210 
	}
}

1212 
	$CheckIDDeş¬©iÚ
(
A¡FunùiÚDeş¬©Ü
 
funcDec
, 
A¡Deş¬©iÚ
 
deş
)

1214 
Ty³
 
ty
, 
bty
;

1215 
sşass
;

1216 
A¡In™Deş¬©Ü
 
š™Dec
;

1217 
P¬am‘”
 
·¿m
;

1218 
VeùÜ
 
·¿ms
 = 
funcDec
->
sig
->params;

1220 
	`CheckDeş¬©iÚS³cif›rs
(
deş
->
¥ecs
);

1221 
sşass
 = 
deş
->
¥ecs
->sclass;

1222 
bty
 = 
deş
->
¥ecs
->
ty
;

1223 ià(! (
sşass
 =ğ0 || sşas =ğ
TK_REGISTER
))

1225 
	`E¼Ü
(&
deş
->
coÜd
, "Invalid storage class");

1226 
sşass
 = 0;

1229 
š™Dec
 = (
A¡In™Deş¬©Ü
)
deş
->
š™Decs
;

1230 
š™Dec
)

1232 ià(
š™Dec
->
š™
)

1234 
	`E¼Ü
(&
š™Dec
->
coÜd
, "Parameter can't be initialized");

1236 
	`CheckDeş¬©Ü
(
š™Dec
->
dec
);

1237 ià(
š™Dec
->
dec
->
id
 =ğ
NULL
)

1238 
Ãxt_dec
;

1240 
	`FOR_EACH_ITEM
(
P¬am‘”
, 
·¿m
, 
·¿ms
)

1241 ià(
·¿m
->
id
 =ğ
š™Dec
->
dec
->id)

1242 
ok
;

1243 
ENDFOR


1244 
	`E¼Ü
(&
š™Dec
->
coÜd
, "% i nÙ fromhid’tif›¸li¡", in™Dec->
dec
->
id
);

1245 
Ãxt_dec
;

1247 
ok
:

1248 
ty
 = 
	`D”iveTy³
(
š™Dec
->
dec
->
tyDrvLi¡
, 
bty
);

1249 ià(
ty
 =ğ
NULL
)

1251 
	`E¼Ü
(&
š™Dec
->
coÜd
, "Illegalype");

1252 
ty
 = 
	`T
(
INT
);

1254 ià(
·¿m
->
ty
 =ğ
NULL
)

1256 
·¿m
->
ty
 =y;

1257 
·¿m
->
»g
 = 
sşass
 =ğ
TK_REGISTER
;

1261 
	`E¼Ü
(&
š™Dec
->
coÜd
, "Redefš·¿m‘” %s", 
·¿m
->
id
);

1263 
Ãxt_dec
:

1264 
š™Dec
 = (
A¡In™Deş¬©Ü
)š™Dec->
Ãxt
;

1266 
	}
}

1268 
	$CheckFunùiÚ
(
A¡FunùiÚ
 
func
)

1270 
SymbŞ
 
sym
;

1271 
Ty³
 
ty
;

1272 
sşass
;

1273 
Lab–
 
Ïb–
;

1274 
A¡Node
 
p
;

1275 
VeùÜ
 
·¿ms
;

1276 
P¬am‘”
 
·¿m
;

1278 
func
->
fdec
->
·¹OfDef
 = 1;

1280 
	`CheckDeş¬©iÚS³cif›rs
(
func
->
¥ecs
);

1281 ià((
sşass
 = 
func
->
¥ecs
->sclass) == 0)

1283 
sşass
 = 
TK_EXTERN
;

1286 
	`CheckDeş¬©Ü
(
func
->
dec
);

1288 
p
 = 
func
->
deşs
;

1289 
p
)

1291 
	`CheckIDDeş¬©iÚ
(
func
->
fdec
, (
A¡Deş¬©iÚ
)
p
);

1292 
p
 =…->
Ãxt
;

1295 
·¿ms
 = 
func
->
fdec
->
sig
->params;

1296 
	`FOR_EACH_ITEM
(
P¬am‘”
, 
·¿m
, 
·¿ms
)

1297 ià(
·¿m
->
ty
 =ğ
NULL
)

1298 
·¿m
->
ty
 = 
	`T
(
INT
);

1299 
ENDFOR


1301 
ty
 = 
	`D”iveTy³
(
func
->
dec
->
tyDrvLi¡
, func->
¥ecs
->ty);

1302 ià(
ty
 =ğ
NULL
)

1304 
	`E¼Ü
(&
func
->
coÜd
, "Illegal functionype");

1305 
ty
 = 
DeçuÉFunùiÚTy³
;

1308 
sym
 = 
	`LookupID
(
func
->
dec
->
id
);

1309 ià(
sym
 =ğ
NULL
)

1311 
func
->
fsym
 = (
FunùiÚSymbŞ
)
	`AddFunùiÚ
(func->
dec
->
id
, 
ty
, 
sşass
);

1313 ià(
sym
->
ty
->
ÿ‹g
 !ğ
FUNCTION
)

1315 
	`E¼Ü
(&
func
->
coÜd
, "Redeclaration‡s‡ function");

1316 
func
->
fsym
 = (
FunùiÚSymbŞ
)
	`AddFunùiÚ
(func->
dec
->
id
, 
ty
, 
sşass
);

1320 
func
->
fsym
 = (
FunùiÚSymbŞ
)
sym
;

1321 ià(
sym
->
sşass
 =ğ
TK_EXTERN
 && sşas =ğ
TK_STATIC
)

1323 
	`E¼Ü
(&
func
->
coÜd
, "Conflict function†inkage");

1325 ià(! 
	`IsCom·tibËTy³
(
ty
, 
sym
->ty))

1327 
	`E¼Ü
(&
func
->
coÜd
, "Incompatible with…revious declaration");

1328 
sym
->
ty
 =y;

1332 
sym
->
ty
 = 
	`Compos™eTy³
(ty, sym->ty);

1334 ià(
func
->
fsym
->
defšed
)

1336 
	`E¼Ü
(&
func
->
coÜd
, "Function„edefinition");

1339 
func
->
fsym
->
defšed
 = 1;

1340 
func
->
loİs
 = 
	`C»©eVeùÜ
(4);

1341 
func
->
b»akabË
 = 
	`C»©eVeùÜ
(4);

1342 
func
->
swtches
 = 
	`C»©eVeùÜ
(4);

1344 
CURRENTF
 = 
func
;

1345 
FSYM
 = 
func
->
fsym
;

1346 
	`EÁ”Scİe
();

1348 
VeùÜ
 
v
ğ((
FunùiÚTy³
)
ty
)->
sig
->
·¿ms
;

1350 
	`FOR_EACH_ITEM
(
P¬am‘”
, 
·¿m
, 
v
)

1351 
	`AddV¬ŸbË
(
·¿m
->
id
,…¬am->
ty
,…¬am->
»g
 ? 
TK_REGISTER
 : 
TK_AUTO
);

1352 
ENDFOR


1354 
FSYM
->
loÿls
 = 
NULL
;

1355 
FSYM
->
Ï¡v
 = &FSYM->
loÿls
;

1357 
	`CheckCompoundS‹m’t
(
func
->
¡mt
);

1358 
	`Ex™Scİe
();

1360 
Ïb–
 = 
func
->
Ïb–s
;

1361 
Ïb–
)

1363 ià(! 
Ïb–
->
defšed
)

1365 
	`E¼Ü
(&
Ïb–
->
coÜd
, "Undefined†abel");

1367 
Ïb–
 =†ab–->
Ãxt
;

1369 ià(
ty
->
bty
 !ğ
	`T
(
VOID
è&& ! 
func
->
hasR‘uº
)

1371 
	`W¬nšg
(&
func
->
coÜd
, "missing„eturn value");

1373 
	}
}

1375 
	$CheckT¿n¦©iÚUn™
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
)

1377 
A¡Node
 
p
;

1378 
SymbŞ
 
f
;

1380 
p
 = 
ŒªsUn™
->
extDeşs
;

1381 
p
)

1383 ià(
p
->
kšd
 =ğ
NK_FunùiÚ
)

1385 
	`CheckFunùiÚ
((
A¡FunùiÚ
)
p
);

1389 
	`as£¹
(
p
->
kšd
 =ğ
NK_Deş¬©iÚ
);

1390 
	`CheckGlob®Deş¬©iÚ
((
A¡Deş¬©iÚ
)
p
);

1392 
p
 =…->
Ãxt
;

1395 
f
 = 
FunùiÚs
;

1396 
f
 !ğ
NULL
)

1398 ià(
f
->
sşass
 =ğ
TK_STATIC
 && ! f->
defšed
)

1400 
	`E¼Ü
(
NULL
, "¡©iøfunùiÚ % nÙ defšed", 
f
->
Çme
);

1402 
f
 = f->
Ãxt
;

1404 
	}
}

	@ucl/dumpast.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"deş.h
"

4 
	~"ex´.h
"

5 
	~"¡mt.h
"

6 
	~"ouut.h
"

8 
	$DumpEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
, 
pos
)

10 *
İÇme
 = 
NULL
;

12 ià(
ex´
 =ğ
NULL
)

14 
	`årštf
(
ASTFe
, "NIL");

18 ià(
ex´
->
İ
 >ğ
OP_COMMA
 &&ƒx´->İ <ğ
OP_POSTDEC
)

20 
İÇme
 = 
OPNames
[
ex´
->
İ
];

23 
ex´
->
İ
)

25 
OP_COMMA
:

26 
OP_ASSIGN
:

27 
OP_BITOR_ASSIGN
:

28 
OP_BITXOR_ASSIGN
:

29 
OP_BITAND_ASSIGN
:

30 
OP_LSHIFT_ASSIGN
:

31 
OP_RSHIFT_ASSIGN
:

32 
OP_ADD_ASSIGN
:

33 
OP_SUB_ASSIGN
:

34 
OP_MUL_ASSIGN
:

35 
OP_DIV_ASSIGN
:

36 
OP_MOD_ASSIGN
:

37 
OP_OR
:

38 
OP_AND
:

39 
OP_BITOR
:

40 
OP_BITXOR
:

41 
OP_BITAND
:

42 
OP_EQUAL
:

43 
OP_UNEQUAL
:

44 
OP_GREAT
:

45 
OP_LESS
:

46 
OP_GREAT_EQ
:

47 
OP_LESS_EQ
:

48 
OP_LSHIFT
:

49 
OP_RSHIFT
:

50 
OP_ADD
:

51 
OP_SUB
:

52 
OP_MUL
:

53 
OP_DIV
:

54 
OP_MOD
:

55 
OP_INDEX
:

57 
	`årštf
(
ASTFe
, "(% ", 
İÇme
);

58 
pos
 +ğ
	`¡¾’
(
İÇme
) + 2;

59 
	`DumpEx´essiÚ
(
ex´
->
kids
[0], 
pos
);

60 
	`LeáAlign
(
ASTFe
, 
pos
);

61 
	`DumpEx´essiÚ
(
ex´
->
kids
[1], 
pos
);

62 
	`årštf
(
ASTFe
, ")");

65 
OP_CALL
:

67 
A¡Ex´essiÚ
 
p
 = 
ex´
->
kids
[1];

69 
	`årštf
(
ASTFe
, "(% ", 
İÇme
);

70 
pos
 +ğ
	`¡¾’
(
İÇme
) + 2;

71 
	`DumpEx´essiÚ
(
ex´
->
kids
[0], 
pos
);

72 
p
)

74 
	`LeáAlign
(
ASTFe
, 
pos
);

75 
	`DumpEx´essiÚ
(
p
, 
pos
);

76 ià(
p
->
Ãxt
 !ğ
NULL
)

78 
	`årštf
(
ASTFe
, ",");

80 
p
 = (
A¡Ex´essiÚ
í->
Ãxt
;

82 
	`årštf
(
ASTFe
, ")");

86 
OP_PREINC
:

87 
OP_PREDEC
:

88 
OP_POS
:

89 
OP_NEG
:

90 
OP_NOT
:

91 
OP_COMP
:

92 
OP_ADDRESS
:

93 
OP_DEREF
:

95 
	`årštf
(
ASTFe
, "(% ", 
İÇme
);

96 
pos
 +ğ
	`¡¾’
(
İÇme
) + 2;

97 
	`DumpEx´essiÚ
(
ex´
->
kids
[0], 
pos
);

98 
	`årštf
(
ASTFe
, ")");

101 
OP_CAST
:

103 
	`årštf
(
ASTFe
, "(% ", 
İÇme
);

104 
pos
 +ğ
	`¡¾’
(
İÇme
) + 2;

105 
	`årštf
(
ASTFe
, 
	`Ty³ToSŒšg
(
ex´
->
ty
));

106 
	`LeáAlign
(
ASTFe
, 
pos
);

107 
	`DumpEx´essiÚ
(
ex´
->
kids
[0], 
pos
);

108 
	`årštf
(
ASTFe
, ")");

111 
OP_SIZEOF
:

113 
	`årštf
(
ASTFe
, "(% ", 
İÇme
);

114 
pos
 +ğ
	`¡¾’
(
İÇme
) + 2;

115 ià(
ex´
->
kids
[0]->
kšd
 =ğ
NK_Ex´essiÚ
)

117 
	`DumpEx´essiÚ
(
ex´
->
kids
[0], 
pos
);

119 
	`årštf
(
ASTFe
, ")");

122 
OP_MEMBER
:

123 
OP_PTR_MEMBER
:

125 
	`årštf
(
ASTFe
, "(% ", 
İÇme
);

126 
pos
 +ğ
	`¡¾’
(
İÇme
) + 2;

127 
	`DumpEx´essiÚ
(
ex´
->
kids
[0], 
pos
);

128 
	`LeáAlign
(
ASTFe
, 
pos
);

129 
	`årštf
(
ASTFe
, "%s", ((
F›ld
)
ex´
->
v®
.
p
)->
id
);

132 
OP_QUESTION
:

134 
	`årštf
(
ASTFe
, "(% ", 
İÇme
);

135 
pos
 +ğ
	`¡¾’
(
İÇme
) + 2;;

136 
	`DumpEx´essiÚ
(
ex´
->
kids
[0], 
pos
);

137 
	`LeáAlign
(
ASTFe
, 
pos
);

138 
	`DumpEx´essiÚ
(
ex´
->
kids
[1]->kids[0], 
pos
);

139 
	`LeáAlign
(
ASTFe
, 
pos
);

140 
	`DumpEx´essiÚ
(
ex´
->
kids
[1]->kids[1], 
pos
);

141 
	`årštf
(
ASTFe
, ")");

144 
OP_POSTINC
:

145 
OP_POSTDEC
:

147 
	`DumpEx´essiÚ
(
ex´
->
kids
[0], 
pos
);

148 
	`årštf
(
ASTFe
, "%s", 
İÇme
);

151 
OP_ID
:

153 
	`årštf
(
ASTFe
, "%s", ((
SymbŞ
)
ex´
->
v®
.
p
)->
Çme
);

156 
OP_STR
:

158 
SŒšg
 
¡r
 = ((
SymbŞ
)
ex´
->
v®
.
p
)->val.p;

159 
i
;

161 ià(
ex´
->
ty
->
ÿ‹g
 !ğ
CHAR
)

162 
	`årštf
(
ASTFe
, "L");

164 
	`årštf
(
ASTFe
, "\"");

166 
i
 = 0; i < 
¡r
->
Ën
; ++i)

168 ià(
	`i¥ršt
(
¡r
->
chs
[
i
]))

169 
	`årštf
(
ASTFe
, "%c", 
¡r
->
chs
[
i
]);

171 
	`årštf
(
ASTFe
, "\\x%x", 
¡r
->
chs
[
i
]);

174 
	`årštf
(
ASTFe
, "\"");

178 
OP_CONST
:

180 
ÿ‹g
 = 
ex´
->
ty
->categ;

182 ià(
ÿ‹g
 =ğ
INT
 || c©eg =ğ
LONG
 || c©eg =ğ
LONGLONG
)

184 
	`årštf
(
ASTFe
, "%d", 
ex´
->
v®
.
i
[0]);

186 ià(
ÿ‹g
 =ğ
UINT
 || c©eg =ğ
ULONG
 || c©eg =ğ
ULONGLONG
 || c©eg =ğ
POINTER
)

188 
	`årštf
(
ASTFe
, "%u", 
ex´
->
v®
.
i
[0]);

190 ià(
ÿ‹g
 =ğ
FLOAT
)

192 
	`årštf
(
ASTFe
, "%g", 
ex´
->
v®
.
f
);

196 
	`årštf
(
ASTFe
, "%g", 
ex´
->
v®
.
d
);

202 
	`årštf
(
ASTFe
, "ERR");

206 
	}
}

208 
	$DumpS‹m’t
(
A¡S‹m’t
 
¡mt
, 
pos
)

210 
¡mt
->
kšd
)

212 
NK_Ex´essiÚS‹m’t
:

214 
	`DumpEx´essiÚ
(
	`AsEx´
(
¡mt
)->
ex´
, 
pos
);

217 
NK_Lab–S‹m’t
:

219 
	`årštf
(
ASTFe
, "Öab– %s:\n", 
	`AsLab–
(
¡mt
)->
id
);

220 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

221 
	`DumpS‹m’t
(
	`AsLab–
(
¡mt
)->¡mt, 
pos
 + 2);

222 
	`LeáAlign
(
ASTFe
, 
pos
);

223 
	`årštf
(
ASTFe
, "end-label)");

226 
NK_Ca£S‹m’t
:

228 
	`årštf
(
ASTFe
, "(case ");

229 
	`DumpEx´essiÚ
(
	`AsCa£
(
¡mt
)->
ex´
, 
pos
 + 7);

230 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

231 
	`DumpS‹m’t
(
	`AsCa£
(
¡mt
)->¡mt, 
pos
 + 2);

232 
	`LeáAlign
(
ASTFe
, 
pos
);

233 
	`årštf
(
ASTFe
, "end-case)");

236 
NK_DeçuÉS‹m’t
:

238 
	`årštf
(
ASTFe
, "(default ");

239 
	`DumpS‹m’t
(
	`AsDef
(
¡mt
)->¡mt, 
pos
 + 10);

240 
	`LeáAlign
(
ASTFe
, 
pos
);

241 
	`årštf
(
ASTFe
, "end-default)");

244 
NK_IfS‹m’t
:

246 
	`årštf
(
ASTFe
, "(if ");

247 
	`DumpEx´essiÚ
(
	`AsIf
(
¡mt
)->
ex´
, 
pos
 + 5);

248 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

249 
	`årštf
(
ASTFe
, "(then ");

250 
	`LeáAlign
(
ASTFe
, 
pos
 + 4);

251 
	`DumpS‹m’t
(
	`AsIf
(
¡mt
)->
th’Stmt
, 
pos
 + 4);

252 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

253 
	`årštf
(
ASTFe
, "end-then)");

254 ià(
	`AsIf
(
¡mt
)->
–£Stmt
 !ğ
NULL
)

256 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

257 
	`årštf
(
ASTFe
, "(else ");

258 
	`LeáAlign
(
ASTFe
, 
pos
 + 4);

259 
	`DumpS‹m’t
(
	`AsIf
(
¡mt
)->
–£Stmt
, 
pos
 + 4);

260 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

261 
	`årštf
(
ASTFe
, "end-else)");

263 
	`LeáAlign
(
ASTFe
, 
pos
);

264 
	`årštf
(
ASTFe
, "end-if)");

267 
NK_Sw™chS‹m’t
:

269 
	`årštf
(
ASTFe
, "(switch ");

270 
	`DumpEx´essiÚ
(
	`AsSw™ch
(
¡mt
)->
ex´
, 
pos
 + 9);

271 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

272 
	`DumpS‹m’t
(
	`AsSw™ch
(
¡mt
)->¡mt, 
pos
 + 2);

273 
	`LeáAlign
(
ASTFe
, 
pos
);

274 
	`årštf
(
ASTFe
, "end-switch)");

277 
NK_WheS‹m’t
:

279 
	`årštf
(
ASTFe
, "(while ");

280 
	`DumpEx´essiÚ
(
	`AsLoİ
(
¡mt
)->
ex´
, 
pos
 + 8);

281 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

282 
	`DumpS‹m’t
(
	`AsLoİ
(
¡mt
)->¡mt, 
pos
 + 2);

283 
	`LeáAlign
(
ASTFe
, 
pos
);

284 
	`årštf
(
ASTFe
, "end-while)");

287 
NK_DoS‹m’t
:

289 
	`årštf
(
ASTFe
, "(do ");

290 
	`DumpEx´essiÚ
(
	`AsLoİ
(
¡mt
)->
ex´
, 
pos
 + 5);

291 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

292 
	`DumpS‹m’t
(
	`AsLoİ
(
¡mt
)->¡mt, 
pos
 + 2);

293 
	`LeáAlign
(
ASTFe
, 
pos
);

294 
	`årštf
(
ASTFe
, ")");

297 
NK_FÜS‹m’t
:

299 
	`årštf
(
ASTFe
, "(for ");

300 
	`DumpEx´essiÚ
(
	`AsFÜ
(
¡mt
)->
š™Ex´
, 
pos
 + 6);

301 
	`LeáAlign
(
ASTFe
, 
pos
 + 6);

302 
	`DumpEx´essiÚ
(
	`AsFÜ
(
¡mt
)->
ex´
, 
pos
 + 6);

303 
	`LeáAlign
(
ASTFe
, 
pos
 + 6);

304 
	`DumpEx´essiÚ
(
	`AsFÜ
(
¡mt
)->
šüEx´
, 
pos
 + 6);

305 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

306 
	`DumpS‹m’t
(
	`AsFÜ
(
¡mt
)->¡mt, 
pos
 + 2);

307 
	`LeáAlign
(
ASTFe
, 
pos
);

308 
	`årštf
(
ASTFe
, "end-for)");

311 
NK_GÙoS‹m’t
:

313 
	`årštf
(
ASTFe
, "(gÙØ%s)", 
	`AsGÙo
(
¡mt
)->
id
);

316 
NK_CÚtšueS‹m’t
:

318 
	`årštf
(
ASTFe
, "(continue)");

321 
NK_B»akS‹m’t
:

323 
	`årštf
(
ASTFe
, "(break)");

326 
NK_R‘uºS‹m’t
:

328 
	`årštf
(
ASTFe
, "(ret ");

329 
	`DumpEx´essiÚ
(
	`AsR‘
(
¡mt
)->
ex´
, 
pos
 + 5);

330 
	`årštf
(
ASTFe
, ")");

333 
NK_CompoundS‹m’t
:

335 
A¡Node
 
p
 = ((
A¡CompoundS‹m’t
)
¡mt
)->
¡mts
;

337 
	`årštf
(
ASTFe
, "{");

338 
p
 !ğ
NULL
)

340 
	`LeáAlign
(
ASTFe
, 
pos
 + 2);

341 
	`DumpS‹m’t
((
A¡S‹m’t
)
p
, 
pos
 + 2);

342 ià(
p
->
Ãxt
 !ğ
NULL
)

343 
	`årštf
(
ASTFe
, "\n");

344 
p
 =…->
Ãxt
;

346 
	`LeáAlign
(
ASTFe
, 
pos
);

347 
	`årštf
(
ASTFe
, "}");

352 
	`as£¹
(0);

354 
	}
}

356 
	$DumpFunùiÚ
(
A¡FunùiÚ
 
func
)

358 
	`årštf
(
ASTFe
, "funùiÚ %s\n", 
func
->
fdec
->
dec
->
id
);

359 
	`DumpS‹m’t
(
func
->
¡mt
, 0);

360 
	`årštf
(
ASTFe
, "\n\n");

361 
	}
}

363 
	$DumpT¿n¦©iÚUn™
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
)

365 
A¡Node
 
p
;

367 
ASTFe
 = 
	`C»©eOuut
(
IÅut
.
f’ame
, ".ast");

369 
p
 = 
ŒªsUn™
->
extDeşs
;

370 
p
)

372 ià(
p
->
kšd
 =ğ
NK_FunùiÚ
)

374 
	`DumpFunùiÚ
((
A¡FunùiÚ
)
p
);

376 
p
 =…->
Ãxt
;

378 
	`fşo£
(
ASTFe
);

379 
	}
}

	@ucl/emit.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"deş.h
"

4 
	~"ex´.h
"

5 
	~"g’.h
"

6 
	~"ouut.h
"

7 
	~"rg‘.h
"

9 
	gSw™chTabËNum
;

14 
	$Em™SŒšgs
()

16 
SymbŞ
 
p
 = 
SŒšgs
;

17 
SŒšg
 
¡r
;

18 
Ën
;

19 
size
;

21 
p
)

23 
	`DefšeGlob®
(
p
);

24 
¡r
 = 
p
->
v®
.p;

25 
Ën
 = 
	`¡¾’
(
p
->
ªame
);

26 
size
 = 
¡r
->
Ën
 + 1;

27 ià(
p
->
ty
 =ğ
WCh¬Ty³
)

29 
i
 = 0;

30 
v®ue
 
v®
;

31 *
wı
 = (*)
¡r
->
chs
;

33 
v®
.
i
[1] = 0;

34 
i
 < 
size
)

36 
v®
.
i
[0] = 
wı
[i];

37 
	`DefšeV®ue
(
WCh¬Ty³
, 
v®
);

38 
	`LeáAlign
(
ASMFe
, 
Ën
);

39 
	`PutSŒšg
("\t");

40 
i
++;

42 
	`PutSŒšg
("\n");

46 
	`DefšeSŒšg
(
¡r
, 
size
);

48 
p
 =…->
Ãxt
;

50 
	`PutSŒšg
("\n");

51 
	}
}

53 
	$Em™FlßtCÚ¡ªts
()

55 
SymbŞ
 
p
 = 
FlßtCÚ¡ªts
;

57 
p
)

59 
	`DefšeFlßtCÚ¡ªt
(
p
);

60 
p
 =…->
Ãxt
;

62 
	`PutSŒšg
("\n");

63 
	}
}

65 
	$Em™Glob®s
()

67 
SymbŞ
 
p
 = 
Glob®s
;

68 
In™D©a
 
š™d
;

69 
Ën
, 
size
;

71 
p
)

73 
š™d
 = 
	`AsV¬
(
p
)->
id©a
;

75 ià(
p
->
sşass
 =ğ
TK_EXTERN
 && 
š™d
 =ğ
NULL
)

77 ià(
p
->
»f
 > 0)

79 
	`ImpÜt
(
p
);

82 ià(
š™d
 =ğ
NULL
)

84 
	`DefšeCommD©a
(
p
);

88 
	`DefšeGlob®
(
p
);

89 
Ën
 = 
	`¡¾’
(
p
->
ªame
);

90 
size
 = 0;

91 
š™d
)

93 ià(
š™d
->
off£t
 !ğ
size
)

95 
	`LeáAlign
(
ASMFe
, 
Ën
);

96 
	`PutSŒšg
("\t");

97 
	`S·û
(
š™d
->
off£t
 - 
size
);

99 ià(
š™d
->
off£t
 != 0)

101 
	`LeáAlign
(
ASMFe
, 
Ën
);

102 
	`PutSŒšg
("\t");

104 ià(
š™d
->
ex´
->
İ
 =ğ
OP_ADD
)

106 
n
 = 
š™d
->
ex´
->
kids
[1]->
v®
.
i
[0];

108 
	`DefšeAdd»ss
(
š™d
->
ex´
->
kids
[0]->
v®
.
p
);

109 ià(
n
 != 0)

111 
	`Pršt
("%s%d", 
n
 > 0 ? " + " : " ",‚);

113 
	`PutSŒšg
("\n");

115 ià(
š™d
->
ex´
->
İ
 =ğ
OP_STR
)

117 
SŒšg
 
¡r
 = 
š™d
->
ex´
->
v®
.
p
;

119 
size
 = 
š™d
->
ex´
->
ty
->size;

120 ià(
š™d
->
ex´
->
ty
 =ğ
WCh¬Ty³
)

122 
i
 = 0;

123 
v®ue
 
v®
;

124 *
wı
 = (*)
¡r
->
chs
;

126 
v®
.
i
[1] = 0;

127 
i
 < 
size
)

129 
v®
.
i
[0] = 
wı
[i];

130 
	`DefšeV®ue
(
WCh¬Ty³
, 
v®
);

131 
	`LeáAlign
(
ASMFe
, 
Ën
);

132 
	`PutSŒšg
("\t");

133 
i
++;

138 
	`DefšeSŒšg
(
¡r
, 
size
);

143 
	`DefšeV®ue
(
š™d
->
ex´
->
ty
, in™d->ex´->
v®
);

145 
size
 = 
š™d
->
off£t
 + in™d->
ex´
->
ty
->size;

146 
š™d
 = in™d->
Ãxt
;

148 ià(
size
 < 
p
->
ty
->size)

150 
	`LeáAlign
(
ASMFe
, 
Ën
);

151 
	`PutSŒšg
("\t");

152 
	`S·û
(
p
->
ty
->
size
 - size);

154 
	`PutSŒšg
("\n");

156 
p
 =…->
Ãxt
;

158 
	`PutSŒšg
("\n");

159 
	}
}

161 
	$ImpÜtFunùiÚs
()

163 
SymbŞ
 
p
 = 
FunùiÚs
;

165 
p
)

167 ià(! 
p
->
defšed
 &&…->
»f
)

169 
	`ImpÜt
(
p
);

171 
p
 =…->
Ãxt
;

173 
	}
}

178 
	$Em™FunùiÚs
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
)

180 
A¡Node
 
p
;

181 
FunùiÚSymbŞ
 
fsym
;

183 
p
 = 
ŒªsUn™
->
extDeşs
;

184 
p
 !ğ
NULL
)

186 ià(
p
->
kšd
 =ğ
NK_FunùiÚ
)

188 
fsym
 = ((
A¡FunùiÚ
)
p
)->fsym;

189 ià(
fsym
->
sşass
 !ğ
TK_STATIC
 || fsym->
»f
 > 0)

191 
	`Em™FunùiÚ
(
fsym
);

194 
p
 =…->
Ãxt
;

196 
	}
}

201 
	$Em™T¿n¦©iÚUn™
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
)

203 
ASMFe
 = 
	`C»©eOuut
(
IÅut
.
f’ame
, 
ExtName
);

205 
Sw™chTabËNum
 = 1;

207 
	`BegšProg¿m
();

209 
	`Segm’t
(
DATA
);

211 
	`Em™SŒšgs
();

213 
	`Em™FlßtCÚ¡ªts
();

215 
	`Em™Glob®s
();

217 
	`Segm’t
(
CODE
);

219 
	`ImpÜtFunùiÚs
();

221 
	`Em™FunùiÚs
(
ŒªsUn™
);

223 
	`EndProg¿m
();

225 
	`fşo£
(
ASMFe
);

226 
	}
}

	@ucl/error.c

1 
	~"uş.h
"

3 
	$E¼Ü
(
CoÜd
 
coÜd
, cÚ¡ *
fÜm©
, ...)

5 
va_li¡
 
­
;

7 
E¼ÜCouÁ
++;

8 ià(
coÜd
)

10 
	`årštf
(
¡d”r
, "(%s,%d):", 
coÜd
->
f’ame
, coÜd->
µlše
);

12 
	`årštf
(
¡d”r
, "error:");

13 
	`va_¡¬t
(
­
, 
fÜm©
);

14 
	`vårštf
(
¡d”r
, 
fÜm©
, 
­
);

15 
	`årštf
(
¡d”r
, "\n");

16 
	`va_’d
(
­
);

17 
	}
}

19 
	$F©®
(cÚ¡ *
fÜm©
, ...)

21 
va_li¡
 
­
;

23 
	`va_¡¬t
(
­
, 
fÜm©
);

24 
	`vårštf
(
¡d”r
, 
fÜm©
, 
­
);

25 
	`årštf
(
¡d”r
, "\n");

26 
	`va_’d
(
­
);

28 
	`ex™
(-1);

29 
	}
}

31 
	$W¬nšg
(
CoÜd
 
coÜd
, cÚ¡ *
fÜm©
, ...)

33 
va_li¡
 
­
;

35 
W¬nšgCouÁ
++;

36 ià(
coÜd
)

38 
	`årštf
(
¡d”r
, "(%s,%d):", 
coÜd
->
f’ame
, coÜd->
µlše
);

41 
	`årštf
(
¡d”r
, "warning:");

42 
	`va_¡¬t
(
­
, 
fÜm©
);

43 
	`vårštf
(
¡d”r
, 
fÜm©
, 
­
);

44 
	`årštf
(
¡d”r
, "\n");

45 
	`va_’d
(
­
);

48 
	}
}

	@ucl/error.h

1 #iâdeà
__ERROR_H_


2 
	#__ERROR_H_


	)

4 
E¼Ü
(
CoÜd
 
coÜd
, cÚ¡ *
fÜm©
, ...);

5 
F©®
(cÚ¡ *
fÜm©
, ...);

6 
W¬nšg
(
CoÜd
 
coÜd
, cÚ¡ *
fÜm©
, ...);

	@ucl/expr.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"ex´.h
"

14 
tok’Op
 
	gTok’Ops
[] =

16 
	#TOKENOP
(
tok
, 
bİ
, 
uİ
è{bİ, uİ},

	)

17 
	~"tok’İ.h
"

18 #undeà
TOKENOP


22 
	gP»c
[] =

24 
	#OPINFO
(
İ
, 
´ec
, 
Çme
, 
func
, 
İcode
è´ec,

	)

25 
	~"İšfo.h
"

27 #undeà
OPINFO


31 
A¡Ex´essiÚ
 
	gCÚ¡ªt0
;

34 *
	gOPNames
[] =

36 
	#OPINFO
(
İ
, 
´ec
, 
Çme
, 
func
, 
İcode
èÇme,

	)

37 
	~"İšfo.h
"

38 
NULL


39 #undeà
OPINFO


49 
A¡Ex´essiÚ
 
	$P¬£Prim¬yEx´essiÚ
()

51 
A¡Ex´essiÚ
 
ex´
;

54 
Cu¼’tTok’
)

56 
TK_ID
:

58 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

60 
ex´
->
İ
 = 
OP_ID
;

61 
ex´
->
v®
 = 
Tok’V®ue
;

62 
NEXT_TOKEN
;

64  
ex´
;

69 
TK_INTCONST
:

70 
TK_UINTCONST
:

71 
TK_LONGCONST
:

72 
TK_ULONGCONST
:

73 
TK_LLONGCONST
:

74 
TK_ULLONGCONST
:

75 
TK_FLOATCONST
:

76 
TK_DOUBLECONST
:

77 
TK_LDOUBLECONST
:

79 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

81 ià(
Cu¼’tTok’
 >ğ
TK_FLOATCONST
)

82 
Cu¼’tTok’
++;

86 
ex´
->
ty
 = 
	`T
(
INT
 + 
Cu¼’tTok’
 - 
TK_INTCONST
);

87 
ex´
->
İ
 = 
OP_CONST
;

88 
ex´
->
v®
 = 
Tok’V®ue
;

89 
NEXT_TOKEN
;

91  
ex´
;

93 
TK_STRING
:

94 
TK_WIDESTRING
:

96 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

98 
ex´
->
ty
 = 
	`A¼ayOf
(((
SŒšg
)
Tok’V®ue
.
p
)->
Ën
 + 1, 
Cu¼’tTok’
 =ğ
TK_STRING
 ? 
	`T
(
CHAR
è: 
WCh¬Ty³
);

99 
ex´
->
İ
 = 
OP_STR
;

100 
ex´
->
v®
 = 
Tok’V®ue
;

101 
NEXT_TOKEN
;

103  
ex´
;

105 
TK_LPAREN
:

107 
NEXT_TOKEN
;

108 
ex´
 = 
	`P¬£Ex´essiÚ
();

109 
	`Ex³ù
(
TK_RPAREN
);

111  
ex´
;

114 
	`E¼Ü
(&
Tok’CoÜd
, "Expect identifier, string, constant or (");

115  
CÚ¡ªt0
;

117 
	}
}

129 
A¡Ex´essiÚ
 
	$P¬£Po¡fixEx´essiÚ
()

131 
A¡Ex´essiÚ
 
ex´
, 
p
;

133 
ex´
 = 
	`P¬£Prim¬yEx´essiÚ
();

137 
Cu¼’tTok’
)

139 
TK_LBRACKET
:

141 
	`CREATE_AST_NODE
(
p
, 
Ex´essiÚ
);

143 
p
->
İ
 = 
OP_INDEX
;

144 
p
->
kids
[0] = 
ex´
;

145 
NEXT_TOKEN
;

146 
p
->
kids
[1] = 
	`P¬£Ex´essiÚ
();

147 
	`Ex³ù
(
TK_RBRACKET
);

149 
ex´
 = 
p
;

152 
TK_LPAREN
:

154 
	`CREATE_AST_NODE
(
p
, 
Ex´essiÚ
);

156 
p
->
İ
 = 
OP_CALL
;

157 
p
->
kids
[0] = 
ex´
;

158 
NEXT_TOKEN
;

159 ià(
Cu¼’tTok’
 !ğ
TK_RPAREN
)

161 
A¡Node
 *

;

165 
p
->
kids
[1] = 
	`P¬£Assignm’tEx´essiÚ
();

166 

 = &
p
->
kids
[1]->
Ãxt
;

167 
Cu¼’tTok’
 =ğ
TK_COMMA
)

169 
NEXT_TOKEN
;

170 *

 = (
A¡Node
)
	`P¬£Assignm’tEx´essiÚ
();

171 

 = &(*)->
Ãxt
;

174 
	`Ex³ù
(
TK_RPAREN
);

176 
ex´
 = 
p
;

179 
TK_DOT
:

180 
TK_POINTER
:

182 
	`CREATE_AST_NODE
(
p
, 
Ex´essiÚ
);

184 
p
->
İ
 = (
Cu¼’tTok’
 =ğ
TK_DOT
 ? 
OP_MEMBER
 : 
OP_PTR_MEMBER
);

185 
p
->
kids
[0] = 
ex´
;

186 
NEXT_TOKEN
;

187 ià(
Cu¼’tTok’
 !ğ
TK_ID
)

189 
	`E¼Ü
(&
p
->
coÜd
, "Expect identifier‡s struct or union member");

193 
p
->
v®
 = 
Tok’V®ue
;

194 
NEXT_TOKEN
;

197 
ex´
 = 
p
;

200 
TK_INC
:

201 
TK_DEC
:

203 
	`CREATE_AST_NODE
(
p
, 
Ex´essiÚ
);

205 
p
->
İ
 = (
Cu¼’tTok’
 =ğ
TK_INC
è? 
OP_POSTINC
 : 
OP_POSTDEC
;

206 
p
->
kids
[0] = 
ex´
;

207 
NEXT_TOKEN
;

209 
ex´
 = 
p
;

214  
ex´
;

217 
	}
}

230 
A¡Ex´essiÚ
 
	$P¬£UÇryEx´essiÚ
()

232 
A¡Ex´essiÚ
 
ex´
;

233 
t
;

235 
Cu¼’tTok’
)

237 
TK_INC
:

238 
TK_DEC
:

239 
TK_BITAND
:

240 
TK_MUL
:

241 
TK_ADD
:

242 
TK_SUB
:

243 
TK_NOT
:

244 
TK_COMP
:

246 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

248 
ex´
->
İ
 = 
UNARY_OP
;

249 
NEXT_TOKEN
;

250 
ex´
->
kids
[0] = 
	`P¬£UÇryEx´essiÚ
();

252  
ex´
;

254 
TK_LPAREN
:

260 
	`BegšP“kTok’
();

261 
t
 = 
	`G‘NextTok’
();

262 ià(
	`IsTy³Name
(
t
))

264 
	`EndP“kTok’
();

266 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

268 
ex´
->
İ
 = 
OP_CAST
;

269 
NEXT_TOKEN
;

270 
ex´
->
kids
[0] = (
A¡Ex´essiÚ
)
	`P¬£Ty³Name
();

271 
	`Ex³ù
(
TK_RPAREN
);

272 
ex´
->
kids
[1] = 
	`P¬£UÇryEx´essiÚ
();

274  
ex´
;

278 
	`EndP“kTok’
();

279  
	`P¬£Po¡fixEx´essiÚ
();

283 
TK_SIZEOF
:

286 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

288 
ex´
->
İ
 = 
OP_SIZEOF
;

289 
NEXT_TOKEN
;

290 ià(
Cu¼’tTok’
 =ğ
TK_LPAREN
)

292 
	`BegšP“kTok’
();

293 
t
 = 
	`G‘NextTok’
();

294 ià(
	`IsTy³Name
(
t
))

296 
	`EndP“kTok’
();

298 
NEXT_TOKEN
;

302 
ex´
->
kids
[0] = (
A¡Ex´essiÚ
)
	`P¬£Ty³Name
();

303 
	`Ex³ù
(
TK_RPAREN
);

307 
	`EndP“kTok’
();

308 
ex´
->
kids
[0] = 
	`P¬£UÇryEx´essiÚ
();

313 
ex´
->
kids
[0] = 
	`P¬£UÇryEx´essiÚ
();

316  
ex´
;

319  
	`P¬£Po¡fixEx´essiÚ
();

321 
	}
}

326 
A¡Ex´essiÚ
 
	$P¬£Bš¬yEx´essiÚ
(
´ec
)

328 
A¡Ex´essiÚ
 
bšEx´
;

329 
A¡Ex´essiÚ
 
ex´
;

330 
ÃwP»c
;

332 
ex´
 = 
	`P¬£UÇryEx´essiÚ
();

335 
	`IsBš¬yOP
(
Cu¼’tTok’
è&& (
ÃwP»c
 = 
P»c
[
BINARY_OP
]è>ğ
´ec
)

337 
	`CREATE_AST_NODE
(
bšEx´
, 
Ex´essiÚ
);

339 
bšEx´
->
İ
 = 
BINARY_OP
;

340 
bšEx´
->
kids
[0] = 
ex´
;

341 
NEXT_TOKEN
;

342 
bšEx´
->
kids
[1] = 
	`P¬£Bš¬yEx´essiÚ
(
ÃwP»c
 + 1);

344 
ex´
 = 
bšEx´
;

347  
ex´
;

349 
	}
}

356 
A¡Ex´essiÚ
 
	$P¬£CÚd™iÚ®Ex´essiÚ
()

358 
A¡Ex´essiÚ
 
ex´
;

360 
ex´
 = 
	`P¬£Bš¬yEx´essiÚ
(
P»c
[
OP_OR
]);

361 ià(
Cu¼’tTok’
 =ğ
TK_QUESTION
)

363 
A¡Ex´essiÚ
 
cÚdEx´
;

365 
	`CREATE_AST_NODE
(
cÚdEx´
, 
Ex´essiÚ
);

367 
cÚdEx´
->
İ
 = 
OP_QUESTION
;

368 
cÚdEx´
->
kids
[0] = 
ex´
;

369 
NEXT_TOKEN
;

371 
	`CREATE_AST_NODE
(
cÚdEx´
->
kids
[1], 
Ex´essiÚ
);

373 
cÚdEx´
->
kids
[1]->
İ
 = 
OP_COLON
;

374 
cÚdEx´
->
kids
[1]->kids[0] = 
	`P¬£Ex´essiÚ
();

375 
	`Ex³ù
(
TK_COLON
);

376 
cÚdEx´
->
kids
[1]->kids[1] = 
	`P¬£CÚd™iÚ®Ex´essiÚ
();

378  
cÚdEx´
;

381  
ex´
;

382 
	}
}

393 
A¡Ex´essiÚ
 
	$P¬£Assignm’tEx´essiÚ
()

395 
A¡Ex´essiÚ
 
ex´
;

397 
ex´
 = 
	`P¬£CÚd™iÚ®Ex´essiÚ
();

398 ià(
Cu¼’tTok’
 >ğ
TK_ASSIGN
 && Cu¼’tTok’ <ğ
TK_MOD_ASSIGN
)

400 
A¡Ex´essiÚ
 
asgnEx´
;

402 
	`CREATE_AST_NODE
(
asgnEx´
, 
Ex´essiÚ
);

404 
asgnEx´
->
İ
 = 
BINARY_OP
;

405 
asgnEx´
->
kids
[0] = 
ex´
;

406 
NEXT_TOKEN
;

407 
asgnEx´
->
kids
[1] = 
	`P¬£Assignm’tEx´essiÚ
();

409  
asgnEx´
;

412  
ex´
;

413 
	}
}

420 
A¡Ex´essiÚ
 
	$P¬£Ex´essiÚ
()

422 
A¡Ex´essiÚ
 
ex´
, 
comaEx´
;

424 
ex´
 = 
	`P¬£Assignm’tEx´essiÚ
();

425 
Cu¼’tTok’
 =ğ
TK_COMMA
)

427 
	`CREATE_AST_NODE
(
comaEx´
, 
Ex´essiÚ
);

429 
comaEx´
->
İ
 = 
OP_COMMA
;

430 
comaEx´
->
kids
[0] = 
ex´
;

431 
NEXT_TOKEN
;

432 
comaEx´
->
kids
[1] = 
	`P¬£Assignm’tEx´essiÚ
();

434 
ex´
 = 
comaEx´
;

437  
ex´
;

438 
	}
}

443 
A¡Ex´essiÚ
 
	$P¬£CÚ¡ªtEx´essiÚ
()

445  
	`P¬£CÚd™iÚ®Ex´essiÚ
();

446 
	}
}

	@ucl/expr.h

1 #iâdeà
__EXPR_H_


2 
	#__EXPR_H_


	)

4 
	eOP


6 
	#OPINFO
(
İ
, 
´ec
, 
Çme
, 
func
, 
İcode
èİ,

	)

7 
	~"İšfo.h
"

8 #undeà
OPINFO


11 
	stok’Op


13 
	mbİ
 : 16;

14 
	muİ
 : 16;

17 
	sa¡Ex´essiÚ


19 
AST_NODE_COMMON


20 
Ty³
 
	mty
;

21 
	mİ
 : 16;

22 
	mi§¼ay
 : 1;

23 
	misfunc
 : 1;

24 
	mlv®ue
 : 1;

25 
	mb™æd
 : 1;

26 
	mš»g
 : 1;

27 
	munu£d
 : 11;

28 
a¡Ex´essiÚ
 *
	mkids
[2];

29 
v®ue
 
	mv®
;

32 
	#IsBš¬yOP
(
tok
èÑok >ğ
TK_OR
 &&ok <ğ
TK_MOD
)

	)

33 
	#BINARY_OP
 
Tok’Ops
[
Cu¼’tTok’
 - 
TK_ASSIGN
].
bİ


	)

34 
	#UNARY_OP
 
Tok’Ops
[
Cu¼’tTok’
 - 
TK_ASSIGN
].
uİ


	)

36 
CªAssign
(
Ty³
 
ty
, 
A¡Ex´essiÚ
 
ex´
);

37 
A¡Ex´essiÚ
 
CÚ¡ªt
(
coÜd
 coÜd, 
Ty³
 
ty
, 
v®ue
 
v®
);

38 
A¡Ex´essiÚ
 
Ca¡
(
Ty³
 
ty
, A¡Ex´essiÚ 
ex´
);

39 
A¡Ex´essiÚ
 
Adju¡
(A¡Ex´essiÚ 
ex´
, 
rv®ue
);

40 
A¡Ex´essiÚ
 
DoIÁeg”PromÙiÚ
(A¡Ex´essiÚ 
ex´
);

41 
A¡Ex´essiÚ
 
FŞdCÚ¡ªt
(A¡Ex´essiÚ 
ex´
);

42 
A¡Ex´essiÚ
 
FŞdCa¡
(
Ty³
 
ty
, A¡Ex´essiÚ 
ex´
);

43 
A¡Ex´essiÚ
 
NÙ
(A¡Ex´essiÚ 
ex´
);

44 
A¡Ex´essiÚ
 
CheckEx´essiÚ
(A¡Ex´essiÚ 
ex´
);

45 
A¡Ex´essiÚ
 
CheckCÚ¡ªtEx´essiÚ
(A¡Ex´essiÚ 
ex´
);

47 
T¿n¦©eB¿nch
(
A¡Ex´essiÚ
 
ex´
, 
BBlock
 
ŒueBB
, BBlock 
çl£BB
);

48 
SymbŞ
 
T¿n¦©eEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
);

50 * 
OPNames
[];

	@ucl/exprchk.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"ex´.h
"

4 
	~"deş.h
"

6 
	#SWAP_KIDS
(
ex´
è\

	)

8 
A¡Ex´essiÚ
 
	gt
 = 
ex´
->
kids
[0]; \

9 
	gex´
->
	gkids
[0] = 
ex´
->
kids
[1]; \

10 
	gex´
->
	gkids
[1] = 
t
; \

13 
	#PERFORM_ARITH_CONVERSION
(
ex´
è\

	)

14 
	gex´
->
	gty
 = 
CommÚR—lTy³
(
ex´
->
kids
[0]->
ty
,ƒxpr->kids[1]->ty); \

15 
	gex´
->
	gkids
[0] = 
Ca¡
(
ex´
->
ty
,ƒx´->
kids
[0]); \

16 
	gex´
->
	gkids
[1] = 
Ca¡
(
ex´
->
ty
,ƒx´->
kids
[1]);

19 
	#REPORT_OP_ERROR
 \

	)

20 
E¼Ü
(&
ex´
->
coÜd
, "Inv®id o³¿nd tØ%s", 
OPNames
[ex´->
İ
]); \

21 
	gex´
->
	gty
 = 
T
(
INT
); \

22  
	gex´
;

27 
	$CªModify
(
A¡Ex´essiÚ
 
ex´
)

29  (
ex´
->
lv®ue
 && ! (ex´->
ty
->
qu®
 & 
CONST
) &&

30 (
	`IsRecÜdTy³
(
ex´
->
ty
è? ! ((
RecÜdTy³
ëx´->ty)->
hasCÚ¡Fld
 : 1));

31 
	}
}

36 
	$IsNuÎCÚ¡ªt
(
A¡Ex´essiÚ
 
ex´
)

38  
ex´
->
İ
 =ğ
OP_CONST
 &&ƒx´->
v®
.
i
[0] == 0;

39 
	}
}

44 
A¡Ex´essiÚ
 
	$SÿËPoš‹rOff£t
(
A¡Ex´essiÚ
 
off£t
, 
sÿË
)

46 
A¡Ex´essiÚ
 
ex´
;

47 
v®ue
 
v®
;

49 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

51 
ex´
->
ty
 = 
off£t
->ty;

52 
ex´
->
İ
 = 
OP_MUL
;

53 
ex´
->
kids
[0] = 
off£t
;

54 
v®
.
i
[1] = 0;

55 
v®
.
i
[0] = 
sÿË
;

56 
ex´
->
kids
[1] = 
	`CÚ¡ªt
(
off£t
->
coÜd
, off£t->
ty
, 
v®
);

58  
	`FŞdCÚ¡ªt
(
ex´
);

59 
	}
}

64 
A¡Ex´essiÚ
 
	$Poš‹rDifã»nû
(
A¡Ex´essiÚ
 
diff
, 
size
)

66 
A¡Ex´essiÚ
 
ex´
;

67 
v®ue
 
v®
;

69 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

71 
ex´
->
ty
 = 
diff
->ty;

72 
ex´
->
İ
 = 
OP_DIV
;

73 
ex´
->
kids
[0] = 
diff
;

74 
v®
.
i
[1] = 0;

75 
v®
.
i
[0] = 
size
;

76 
ex´
->
kids
[1] = 
	`CÚ¡ªt
(
diff
->
coÜd
, diff->
ty
, 
v®
);

78  
ex´
;

79 
	}
}

84 
A¡Ex´essiÚ
 
	$CheckPrim¬yEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

86 
SymbŞ
 
p
;

88 ià(
ex´
->
İ
 =ğ
OP_CONST
)

89  
ex´
;

91 ià(
ex´
->
İ
 =ğ
OP_STR
)

93 
ex´
->
İ
 = 
OP_ID
;

94 
ex´
->
v®
.
p
 = 
	`AddSŒšg
Óx´->
ty
,ƒxpr->val.p);

95 
ex´
->
lv®ue
 = 1;

96  
ex´
;

99 
p
 = 
	`LookupID
(
ex´
->
v®
.p);

100 ià(
p
 =ğ
NULL
)

102 
	`E¼Ü
(&
ex´
->
coÜd
, "Undeş¬ed id’tif›r: %s",ƒx´->
v®
.
p
);

103 
p
 = 
	`AddV¬ŸbË
(
ex´
->
v®
.p, 
	`T
(
INT
), 
Lev–
 =ğ0 ? 0 : 
TK_AUTO
);

104 
ex´
->
ty
 = 
	`T
(
INT
);

105 
ex´
->
lv®ue
 = 1;

107 ià(
p
->
kšd
 =ğ
SK_Ty³defName
)

109 
	`E¼Ü
(&
ex´
->
coÜd
, "Typedef‚ame cannot be used‡s variable");

110 
ex´
->
ty
 = 
	`T
(
INT
);

112 ià(
p
->
kšd
 =ğ
SK_EnumCÚ¡ªt
)

114 
ex´
->
İ
 = 
OP_CONST
;

115 
ex´
->
v®
 = 
p
->val;

116 
ex´
->
ty
 = 
	`T
(
INT
);

120 
ex´
->
ty
 = 
p
->ty;

121 
ex´
->
v®
.
p
 =…;

122 
ex´
->
š»g
 = 
p
->
sşass
 =ğ
TK_REGISTER
;

123 
ex´
->
lv®ue
 =ƒx´->
ty
->
ÿ‹g
 !ğ
FUNCTION
;

126  
ex´
;

127 
	}
}

129 
A¡Ex´essiÚ
 
	$PromÙeArgum’t
(
A¡Ex´essiÚ
 
¬g
)

131 
Ty³
 
ty
 = 
	`PromÙe
(
¬g
->ty);

133  
	`Ca¡
(
ty
, 
¬g
);

134 
	}
}

143 
A¡Ex´essiÚ
 
	$CheckArgum’t
(
FunùiÚTy³
 
áy
, 
A¡Ex´essiÚ
 
¬g
, 
¬gNo
, *
¬gFuÎ
)

145 
P¬am‘”
 
·¿m
;

146 
·rL’
 = 
	`LEN
(
áy
->
sig
->
·¿ms
);

148 
¬g
 = 
	`Adju¡
(
	`CheckEx´essiÚ
(arg), 1);

150 ià(
áy
->
sig
->
hasPrÙo
 && 
·rL’
 == 0)

152 *
¬gFuÎ
 = 1;

153  
¬g
;

156 ià(
¬gNo
 =ğ
·rL’
 && ! 
áy
->
sig
->
hasEÎ£
)

157 *
¬gFuÎ
 = 1;

159 ià(! 
áy
->
sig
->
hasPrÙo
)

161 
¬g
 = 
	`PromÙeArgum’t
(arg);

163 ià(
·rL’
 != 0)

165 
·¿m
 = 
	`GET_ITEM
(
áy
->
sig
->
·¿ms
, 
¬gNo
 - 1);

166 ià(! 
	`IsCom·tibËTy³
(
¬g
->
ty
, 
·¿m
->ty))

167 
”r
;

170  
¬g
;

172 ià(
¬gNo
 <ğ
·rL’
)

174 
·¿m
 = 
	`GET_ITEM
(
áy
->
sig
->
·¿ms
, 
¬gNo
 - 1);

175 ià(! 
	`CªAssign
(
·¿m
->
ty
, 
¬g
))

176 
”r
;

178 ià(
·¿m
->
ty
->
ÿ‹g
 < 
INT
)

179 
¬g
 = 
	`Ca¡
(
	`T
(
INT
),‡rg);

181 
¬g
 = 
	`Ca¡
(
·¿m
->
ty
,‡rg);

183  
¬g
;

187  
	`PromÙeArgum’t
(
¬g
);

190 
”r
:

191 
	`E¼Ü
(&
¬g
->
coÜd
, "Incompatible‡rgument");

192  
¬g
;

193 
	}
}

195 
A¡Ex´essiÚ
 
	$CheckFunùiÚC®l
(
A¡Ex´essiÚ
 
ex´
)

197 
A¡Ex´essiÚ
 
¬g
;

198 
Ty³
 
ty
;

199 
A¡Node
 *

;

200 
¬gNo
, 
¬gFuÎ
;

202 ià(
ex´
->
kids
[0]->
İ
 =ğ
OP_ID
 && 
	`LookupID
Óx´->kids[0]->
v®
.
p
è=ğ
NULL
)

204 
ex´
->
kids
[0]->
ty
 = 
DeçuÉFunùiÚTy³
;

205 
ex´
->
kids
[0]->
v®
.
p
 = 
	`AddFunùiÚ
Óx´->kids[0]->v®.p, 
DeçuÉFunùiÚTy³
, 
TK_EXTERN
);

209 
ex´
->
kids
[0] = 
	`CheckEx´essiÚ
(expr->kids[0]);

211 
ex´
->
kids
[0] = 
	`Adju¡
(expr->kids[0], 1);

212 
ty
 = 
ex´
->
kids
[0]->ty;

214 ià(! (
	`IsPŒTy³
(
ty
è&& 
	`IsFunùiÚTy³
Ñy->
bty
)))

216 
	`E¼Ü
(&
ex´
->
coÜd
, "The†eft operand must be function or function…ointer");

217 
ty
 = 
DeçuÉFunùiÚTy³
;

221 
ty
 =y->
bty
;

224 

 = (
A¡Node
 *)&
ex´
->
kids
[1];

225 
¬g
 = 
ex´
->
kids
[1];

226 
¬gNo
 = 1;

227 
¬gFuÎ
 = 0;

228 
¬g
 !ğ
NULL
 && ! 
¬gFuÎ
)

230 *

 = (
A¡Node
)
	`CheckArgum’t
((
FunùiÚTy³
)
ty
, 
¬g
, 
¬gNo
, &
¬gFuÎ
);

231 

 = &(*)->
Ãxt
;

232 
¬g
 = (
A¡Ex´essiÚ
ïrg->
Ãxt
;

233 
¬gNo
++;

235 *

 = 
NULL
;

237 ià(
¬g
 !ğ
NULL
)

239 
¬g
 !ğ
NULL
)

241 
	`CheckEx´essiÚ
(
¬g
);

242 
¬g
 = (
A¡Ex´essiÚ
ïrg->
Ãxt
;

244 
	`E¼Ü
(&
ex´
->
coÜd
, "Too many‡rguments");

246 ià(
¬gNo
 < 
	`LEN
(((
FunùiÚTy³
)
ty
)->
sig
->
·¿ms
))

248 
	`E¼Ü
(&
ex´
->
coÜd
, "Too few‡rguments");

250 
ex´
->
ty
 =y->
bty
;

252  
ex´
;

253 
	}
}

255 
A¡Ex´essiÚ
 
	$CheckMemb”Acûss
(
A¡Ex´essiÚ
 
ex´
)

257 
Ty³
 
ty
;

258 
F›ld
 
æd
;

260 
ex´
->
kids
[0] = 
	`CheckEx´essiÚ
(expr->kids[0]);

261 ià(
ex´
->
İ
 =ğ
OP_MEMBER
)

263 
ex´
->
kids
[0] = 
	`Adju¡
(expr->kids[0], 0);

264 
ty
 = 
ex´
->
kids
[0]->ty;

265 ià(! 
	`IsRecÜdTy³
(
ty
))

267 
REPORT_OP_ERROR
;

269 
ex´
->
lv®ue
 =ƒx´->
kids
[0]->lvalue;

273 
ex´
->
kids
[0] = 
	`Adju¡
(expr->kids[0], 1);

274 
ty
 = 
ex´
->
kids
[0]->ty;

275 ià(! (
	`IsPŒTy³
(
ty
è&& 
	`IsRecÜdTy³
Ñy->
bty
)))

277 
REPORT_OP_ERROR
;

279 
ty
 =y->
bty
;

280 
ex´
->
lv®ue
 = 1;

283 
æd
 = 
	`LookupF›ld
(
	`Unqu®
(
ty
), 
ex´
->
v®
.
p
);

284 ià(
æd
 =ğ
NULL
)

286 
	`E¼Ü
(&
ex´
->
coÜd
, "¡ruù o¸uniÚ memb” % dÛ¢'ˆexsi¡",ƒx´->
v®
.
p
);

287 
ex´
->
ty
 = 
	`T
(
INT
);

288  
ex´
;

290 
ex´
->
ty
 = 
	`Qu®ify
Ñy->
qu®
, 
æd
->ty);

291 
ex´
->
v®
.
p
 = 
æd
;

292 
ex´
->
b™æd
 = 
æd
->
b™s
 != 0;

293  
ex´
;

294 
	}
}

296 
A¡Ex´essiÚ
 
	$T¿nsfÜmInüem’t
(
A¡Ex´essiÚ
 
ex´
)

298 
A¡Ex´essiÚ
 
ÿsgn
;

299 
v®ue
 
v®
;

301 
v®
.
i
[1] = 0; val.i[0] = 1;

302 
	`CREATE_AST_NODE
(
ÿsgn
, 
Ex´essiÚ
);

303 
ÿsgn
->
coÜd
 = 
ex´
->coord;

304 
ÿsgn
->
İ
 = (
ex´
->İ =ğ
OP_POSTINC
 ||ƒx´->İ =ğ
OP_PREINC
è? 
OP_ADD_ASSIGN
 : 
OP_SUB_ASSIGN
;

305 
ÿsgn
->
kids
[0] = 
ex´
->kids[0];

306 
ÿsgn
->
kids
[1] = 
	`CÚ¡ªt
(
ex´
->
coÜd
, 
	`T
(
INT
), 
v®
);

308 
ex´
->
kids
[0] = 
	`CheckEx´essiÚ
(
ÿsgn
);

309 
ex´
->
ty
 =ƒx´->
kids
[0]->ty;

310  
ex´
;

311 
	}
}

313 
A¡Ex´essiÚ
 
	$CheckPo¡fixEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

315 
ex´
->
İ
)

317 
OP_INDEX
:

318 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 1);

319 
ex´
->
kids
[1] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[1]), 1);

320 ià(
	`IsIÁegTy³
(
ex´
->
kids
[0]->
ty
))

322 
	`SWAP_KIDS
(
ex´
);

324 ià(
	`IsObjeùPŒ
(
ex´
->
kids
[0]->
ty
è&& 
	`IsIÁegTy³
(expr->kids[1]->ty))

326 
ex´
->
ty
 =ƒx´->
kids
[0]->ty->
bty
;

327 
ex´
->
lv®ue
 = 1;

328 
ex´
->
kids
[1] = 
	`DoIÁeg”PromÙiÚ
(expr->kids[1]);

329 
ex´
->
kids
[1] = 
	`SÿËPoš‹rOff£t
Óx´->kids[1],ƒx´->
ty
->
size
);

330  
ex´
;

332 
REPORT_OP_ERROR
;

334 
OP_CALL
:

335  
	`CheckFunùiÚC®l
(
ex´
);

337 
OP_MEMBER
:

338 
OP_PTR_MEMBER
:

339  
	`CheckMemb”Acûss
(
ex´
);

341 
OP_POSTINC
:

342 
OP_POSTDEC
:

343  
	`T¿nsfÜmInüem’t
(
ex´
);

346 
	`as£¹
(0);

349 
REPORT_OP_ERROR
;

350 
	}
}

353 
A¡Ex´essiÚ
 
	$CheckTy³Ca¡
(
A¡Ex´essiÚ
 
ex´
)

355 
Ty³
 
ty
;

357 
ty
 = 
	`CheckTy³Name
((
A¡Ty³Name
)
ex´
->
kids
[0]);

358 
ex´
->
kids
[1] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[1]), 1);

360 ià(! (
	`BÙhSÿÏrTy³
(
ty
, 
ex´
->
kids
[1]->tyè||y->
ÿ‹g
 =ğ
VOID
))

362 
	`E¼Ü
(&
ex´
->
coÜd
, "Illegalype cast");

363  
ex´
->
kids
[1];

366  
	`Ca¡
(
ty
, 
ex´
->
kids
[1]);

367 
	}
}

371 
A¡Ex´essiÚ
 
	$CheckUÇryEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

373 
Ty³
 
ty
;

375 
ex´
->
İ
)

377 
OP_PREINC
:

378 
OP_PREDEC
:

379  
	`T¿nsfÜmInüem’t
(
ex´
);

381 
OP_ADDRESS
:

382 
ex´
->
kids
[0] = 
	`CheckEx´essiÚ
(expr->kids[0]);

383 
ty
 = 
ex´
->
kids
[0]->ty;

384 ià(
ex´
->
kids
[0]->
İ
 =ğ
OP_DEREF
)

386 
ex´
->
kids
[0]->kids[0]->
lv®ue
 = 0;

387  
ex´
->
kids
[0]->kids[0];

389 ià(
ex´
->
kids
[0]->
İ
 =ğ
OP_INDEX
)

391 
ex´
->
kids
[0]->
İ
 = 
OP_ADD
;

392 
ex´
->
kids
[0]->
ty
 = 
	`Poš‹rTo
(ty);

393 
ex´
->
kids
[0]->
lv®ue
 = 0;

394  
ex´
->
kids
[0];

396 ià(
	`IsFunùiÚTy³
(
ty
) ||

397 (
ex´
->
kids
[0]->
lv®ue
 && !ƒx´->kids[0]->
b™æd
 && !ƒx´->kids[0]->
š»g
))

399 
ex´
->
ty
 = 
	`Poš‹rTo
(ty);

400  
ex´
;

404 
OP_DEREF
:

405 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 1);

406 
ty
 = 
ex´
->
kids
[0]->ty;

407 ià(
ex´
->
kids
[0]->
İ
 =ğ
OP_ADDRESS
)

409 
ex´
->
kids
[0]->kids[0]->
ty
 =y->
bty
;

410  
ex´
->
kids
[0]->kids[0];

412 ià(
ex´
->
kids
[0]->
İ
 =ğ
OP_ADD
 &&ƒx´->kids[0]->kids[0]->
i§¼ay
)

414 
ex´
->
kids
[0]->
İ
 = 
OP_INDEX
;

415 
ex´
->
kids
[0]->
ty
 =y->
bty
;

416 
ex´
->
kids
[0]->
lv®ue
 = 1;

417  
ex´
->
kids
[0];

419 ià(
	`IsPŒTy³
(
ty
))

421 
ex´
->
ty
 =y->
bty
;

422 ià(
	`IsFunùiÚTy³
(
ex´
->
ty
))

424  
ex´
->
kids
[0];

426 
ex´
->
lv®ue
 = 1;

427  
ex´
;

431 
OP_POS
:

432 
OP_NEG
:

433 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 1);

434 ià(
	`IsAr™hTy³
(
ex´
->
kids
[0]->
ty
))

436 
ex´
->
kids
[0] = 
	`DoIÁeg”PromÙiÚ
(expr->kids[0]);

437 
ex´
->
ty
 =ƒx´->
kids
[0]->ty;

438  
ex´
->
İ
 =ğ
OP_POS
 ?ƒx´->
kids
[0] : 
	`FŞdCÚ¡ªt
(expr);

442 
OP_COMP
:

443 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 1);

444 ià(
	`IsIÁegTy³
(
ex´
->
kids
[0]->
ty
))

446 
ex´
->
kids
[0] = 
	`DoIÁeg”PromÙiÚ
(expr->kids[0]);

447 
ex´
->
ty
 =ƒx´->
kids
[0]->ty;

448  
	`FŞdCÚ¡ªt
(
ex´
);

452 
OP_NOT
:

453 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 1);

454 ià(
	`IsSÿÏrTy³
(
ex´
->
kids
[0]->
ty
))

456 
ex´
->
ty
 = 
	`T
(
INT
);

457  
	`FŞdCÚ¡ªt
(
ex´
);

461 
OP_SIZEOF
:

462 ià(
ex´
->
kids
[0]->
kšd
 =ğ
NK_Ex´essiÚ
)

464 
ex´
->
kids
[0] = 
	`CheckEx´essiÚ
(expr->kids[0]);

465 ià(
ex´
->
kids
[0]->
b™æd
)

466 
”r
;

467 
ty
 = 
ex´
->
kids
[0]->ty;

471 
ty
 = 
	`CheckTy³Name
((
A¡Ty³Name
)
ex´
->
kids
[0]);

473 ià(
	`IsFunùiÚTy³
(
ty
è||y->
size
 == 0)

474 
”r
;

476 
ex´
->
ty
 = 
	`T
(
UINT
);

477 
ex´
->
İ
 = 
OP_CONST
;

478 
ex´
->
v®
.
i
[0] = 
ty
->
size
;

479  
ex´
;

481 
OP_CAST
:

482  
	`CheckTy³Ca¡
(
ex´
);

485 
	`as£¹
(0);

488 
”r
:

489 
REPORT_OP_ERROR
;

491 
	}
}

493 
A¡Ex´essiÚ
 
	$CheckMuÉliÿtiveOP
(
A¡Ex´essiÚ
 
ex´
)

495 ià(
ex´
->
İ
 !ğ
OP_MOD
 && 
	`BÙhAr™hTy³
Óx´->
kids
[0]->
ty
,ƒxpr->kids[1]->ty))

496 
ok
;

498 ià(
ex´
->
İ
 =ğ
OP_MOD
 && 
	`BÙhIÁegTy³
Óx´->
kids
[0]->
ty
,ƒxpr->kids[1]->ty))

499 
ok
;

501 
REPORT_OP_ERROR
;

503 
ok
:

504 
	`PERFORM_ARITH_CONVERSION
(
ex´
);

505  
	`FŞdCÚ¡ªt
(
ex´
);

506 
	}
}

508 
A¡Ex´essiÚ
 
	$CheckAddOP
(
A¡Ex´essiÚ
 
ex´
)

510 
Ty³
 
ty1
, 
ty2
;

512 ià(
ex´
->
kids
[0]->
İ
 =ğ
OP_CONST
)

514 
	`SWAP_KIDS
(
ex´
);

516 
ty1
 = 
ex´
->
kids
[0]->
ty
;

517 
ty2
 = 
ex´
->
kids
[1]->
ty
;

519 ià(
	`BÙhAr™hTy³
(
ty1
, 
ty2
))

521 
	`PERFORM_ARITH_CONVERSION
(
ex´
);

522  
	`FŞdCÚ¡ªt
(
ex´
);

524 ià(
	`IsObjeùPŒ
(
ty2
è&& 
	`IsIÁegTy³
(
ty1
))

526 
	`SWAP_KIDS
(
ex´
);

527 
ty1
 = 
ex´
->
kids
[0]->
ty
;

528 
Ëá_±r
;

531 ià(
	`IsObjeùPŒ
(
ty1
è&& 
	`IsIÁegTy³
(
ty2
))

533 
Ëá_±r
:

534 
ex´
->
kids
[1] = 
	`DoIÁeg”PromÙiÚ
(expr->kids[1]);

535 
ex´
->
kids
[1] = 
	`SÿËPoš‹rOff£t
Óx´->kids[1], 
ty1
->
bty
->
size
);

536 
ex´
->
ty
 = 
ty1
;

537  
ex´
;

540 
REPORT_OP_ERROR
;

541 
	}
}

543 
A¡Ex´essiÚ
 
	$CheckSubOP
(
A¡Ex´essiÚ
 
ex´
)

545 
Ty³
 
ty1
, 
ty2
;

547 
ty1
 = 
ex´
->
kids
[0]->
ty
;

548 
ty2
 = 
ex´
->
kids
[1]->
ty
;

549 ià(
	`BÙhAr™hTy³
(
ty1
, 
ty2
))

551 
	`PERFORM_ARITH_CONVERSION
(
ex´
);

552  
	`FŞdCÚ¡ªt
(
ex´
);

554 ià(
	`IsObjeùPŒ
(
ty1
è&& 
	`IsIÁegTy³
(
ty2
))

556 
ex´
->
kids
[1] = 
	`DoIÁeg”PromÙiÚ
(expr->kids[1]);

557 
ex´
->
kids
[1] = 
	`SÿËPoš‹rOff£t
Óx´->kids[1], 
ty1
->
bty
->
size
);

558 
ex´
->
ty
 = 
ty1
;

559  
ex´
;

561 ià(
	`IsCom·tibËPŒ
(
ty1
, 
ty2
))

563 
ex´
->
ty
 = 
	`T
(
INT
);

564 
ex´
 = 
	`Poš‹rDifã»nû
Óx´, 
ty1
->
bty
->
size
);

565  
ex´
;

568 
REPORT_OP_ERROR
;

569 
	}
}

571 
A¡Ex´essiÚ
 
	$CheckShiáOP
(
A¡Ex´essiÚ
 
ex´
)

573 ià(
	`BÙhIÁegTy³
(
ex´
->
kids
[0]->
ty
,ƒxpr->kids[1]->ty))

575 
ex´
->
kids
[0] = 
	`DoIÁeg”PromÙiÚ
(expr->kids[0]);

576 
ex´
->
kids
[1] = 
	`DoIÁeg”PromÙiÚ
(expr->kids[1]);

577 
ex´
->
ty
 =ƒx´->
kids
[0]->ty;

578  
	`FŞdCÚ¡ªt
(
ex´
);

581 
REPORT_OP_ERROR
;

582 
	}
}

584 
A¡Ex´essiÚ
 
	$CheckR–©iÚ®OP
(
A¡Ex´essiÚ
 
ex´
)

586 
Ty³
 
ty1
, 
ty2
;

588 
ex´
->
ty
 = 
	`T
(
INT
);

589 
ty1
 = 
ex´
->
kids
[0]->
ty
;

590 
ty2
 = 
ex´
->
kids
[1]->
ty
;

591 ià(
	`BÙhAr™hTy³
(
ty1
, 
ty2
))

593 
	`PERFORM_ARITH_CONVERSION
(
ex´
);

594 
ex´
->
ty
 = 
	`T
(
INT
);

595  
	`FŞdCÚ¡ªt
(
ex´
);

598 ià(
	`IsObjeùPŒ
(
ty1
è&& IsObjeùPŒ(
ty2
) &&

599 
	`IsCom·tibËTy³
(
	`Unqu®
(
ty1
->
bty
), Unqu®(
ty2
->bty)))

601  
ex´
;

604 ià(
	`IsIncom¶‘ePŒ
(
ty1
è&& IsIncom¶‘ePŒ(
ty2
) &&

605 
	`IsCom·tibËTy³
(
	`Unqu®
(
ty1
->
bty
), Unqu®(
ty2
->bty)))

607  
ex´
;

610 
REPORT_OP_ERROR
;

611 
	}
}

613 
A¡Ex´essiÚ
 
	$CheckEqu®™yOP
(
A¡Ex´essiÚ
 
ex´
)

615 
Ty³
 
ty1
, 
ty2
;

617 
ex´
->
ty
 = 
	`T
(
INT
);

618 
ty1
 = 
ex´
->
kids
[0]->
ty
;

619 
ty2
 = 
ex´
->
kids
[1]->
ty
;

620 ià(
	`BÙhAr™hTy³
(
ty1
, 
ty2
))

622 
	`PERFORM_ARITH_CONVERSION
(
ex´
);

623 
ex´
->
ty
 = 
	`T
(
INT
);

624  
	`FŞdCÚ¡ªt
(
ex´
);

627 ià(
	`IsCom·tibËPŒ
(
ty1
, 
ty2
) ||

628 
	`NÙFunùiÚPŒ
(
ty1
è&& 
	`IsVoidPŒ
(
ty2
) ||

629 
	`NÙFunùiÚPŒ
(
ty2
è&& 
	`IsVoidPŒ
(
ty1
) ||

630 
	`IsPŒTy³
(
ty1
è&& 
	`IsNuÎCÚ¡ªt
(
ex´
->
kids
[1]) ||

631 
	`IsPŒTy³
(
ty2
è&& 
	`IsNuÎCÚ¡ªt
(
ex´
->
kids
[0]))

633  
ex´
;

636 
REPORT_OP_ERROR
;

637 
	}
}

639 
A¡Ex´essiÚ
 
	$CheckB™wi£OP
(
A¡Ex´essiÚ
 
ex´
)

641 ià(
	`BÙhIÁegTy³
(
ex´
->
kids
[0]->
ty
,ƒxpr->kids[1]->ty))

643 
	`PERFORM_ARITH_CONVERSION
(
ex´
);

644  
	`FŞdCÚ¡ªt
(
ex´
);

647 
REPORT_OP_ERROR
;

648 
	}
}

650 
A¡Ex´essiÚ
 
	$CheckLogiÿlOP
(
A¡Ex´essiÚ
 
ex´
)

652 ià(
	`BÙhSÿÏrTy³
(
ex´
->
kids
[0]->
ty
,ƒxpr->kids[1]->ty))

654 
ex´
->
ty
 = 
	`T
(
INT
);

655  
	`FŞdCÚ¡ªt
(
ex´
);

658 
REPORT_OP_ERROR
;

659 
	}
}

661 
	$A¡Ex´essiÚ
 (* 
Bš¬yOPCheck”s
[])(
A¡Ex´essiÚ
) =

663 
CheckLogiÿlOP
,

664 
CheckLogiÿlOP
,

665 
CheckB™wi£OP
,

666 
CheckB™wi£OP
,

667 
CheckB™wi£OP
,

668 
CheckEqu®™yOP
,

669 
CheckEqu®™yOP
,

670 
CheckR–©iÚ®OP
,

671 
CheckR–©iÚ®OP
,

672 
CheckR–©iÚ®OP
,

673 
CheckR–©iÚ®OP
,

674 
CheckShiáOP
,

675 
CheckShiáOP
,

676 
CheckAddOP
,

677 
CheckSubOP
,

678 
CheckMuÉliÿtiveOP
,

679 
CheckMuÉliÿtiveOP
,

680 
CheckMuÉliÿtiveOP


681 
	}
};

683 
A¡Ex´essiÚ
 
	$CheckBš¬yEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

685 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 1);;

686 
ex´
->
kids
[1] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[1]), 1);

688  (* 
Bš¬yOPCheck”s
[
ex´
->
İ
 - 
OP_OR
])(expr);

689 
	}
}

691 
A¡Ex´essiÚ
 
	$CheckAssignm’tEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

693 
İs
[] =

695 
OP_BITOR
, 
OP_BITXOR
, 
OP_BITAND
, 
OP_LSHIFT
, 
OP_RSHIFT
,

696 
OP_ADD
, 
OP_SUB
, 
OP_MUL
, 
OP_DIV
, 
OP_MOD


698 
Ty³
 
ty
;

700 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 0);

701 
ex´
->
kids
[1] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[1]), 1);

703 ià(! 
	`CªModify
(
ex´
->
kids
[0]))

705 
	`E¼Ü
(&
ex´
->
coÜd
, "The†eft operand cannot be modified");

707 ià(
ex´
->
İ
 !ğ
OP_ASSIGN
)

709 
A¡Ex´essiÚ
 
lİr
;

711 
	`CREATE_AST_NODE
(
lİr
, 
Ex´essiÚ
);

712 
lİr
->
coÜd
 = 
ex´
->coord;

713 
lİr
->
İ
 = 
İs
[
ex´
->İ - 
OP_BITOR_ASSIGN
];

714 
lİr
->
kids
[0] = 
ex´
->kids[0];

715 
lİr
->
kids
[1] = 
ex´
->kids[1];

717 
ex´
->
kids
[1] = (*
Bš¬yOPCheck”s
[
lİr
->
İ
 - 
OP_OR
])(lopr);

720 
ty
 = 
ex´
->
kids
[0]->ty;

721 ià(! 
	`CªAssign
(
ty
, 
ex´
->
kids
[1]))

723 
	`E¼Ü
(&
ex´
->
coÜd
, "Wrong‡ssignment");

727 
ex´
->
kids
[1] = 
	`Ca¡
(
ty
,ƒxpr->kids[1]);

729 
ex´
->
ty
 =y;

730  
ex´
;

731 
	}
}

733 
A¡Ex´essiÚ
 
	$CheckCÚd™iÚ®Ex´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

735 
qu®
;

736 
Ty³
 
ty1
, 
ty2
;

738 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 1);

740 ià(! 
	`IsSÿÏrTy³
(
ex´
->
kids
[0]->
ty
))

742 
	`E¼Ü
(&
ex´
->
coÜd
, "The firstƒxpression shall be scalarype.");

744 
ex´
->
kids
[1]->kids[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[1]->kids[0]), 1);

745 
ex´
->
kids
[1]->kids[1] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[1]->kids[1]), 1);

747 
ty1
 = 
ex´
->
kids
[1]->kids[0]->
ty
;

748 
ty2
 = 
ex´
->
kids
[1]->kids[1]->
ty
;

749 ià(
	`BÙhAr™hTy³
(
ty1
, 
ty2
))

751 
ex´
->
ty
 = 
	`CommÚR—lTy³
(
ty1
, 
ty2
);

752 
ex´
->
kids
[1]->kids[0] = 
	`Ca¡
Óx´->
ty
,ƒxpr->kids[1]->kids[0]);

753 
ex´
->
kids
[1]->kids[1] = 
	`Ca¡
Óx´->
ty
,ƒxpr->kids[1]->kids[1]);

755  
	`FŞdCÚ¡ªt
(
ex´
);

757 ià(
	`IsRecÜdTy³
(
ty1
è&&y1 =ğ
ty2
)

759 
ex´
->
ty
 = 
ty1
;

761 ià(
ty1
->
ÿ‹g
 =ğ
VOID
 && 
ty2
->categ == VOID)

763 
ex´
->
ty
 = 
	`T
(
VOID
);

765 ià(
	`IsCom·tibËPŒ
(
ty1
, 
ty2
))

767 
qu®
 = 
ty1
->
bty
->qu® | 
ty2
->bty->qual;

768 
ex´
->
ty
 = 
	`Poš‹rTo
(
	`Qu®ify
(
qu®
, 
	`Compos™eTy³
(
	`Unqu®
(
ty1
->
bty
), Unqu®(
ty2
->bty))));

770 ià(
	`IsPŒTy³
(
ty1
è&& 
	`IsNuÎCÚ¡ªt
(
ex´
->
kids
[1]->kids[1]))

772 
ex´
->
ty
 = 
ty1
;

774 ià(
	`IsPŒTy³
(
ty2
è&& 
	`IsNuÎCÚ¡ªt
(
ex´
->
kids
[1]->kids[0]))

776 
ex´
->
ty
 = 
ty2
;

778 ià(
	`NÙFunùiÚPŒ
(
ty1
è&& 
	`IsVoidPŒ
(
ty2
) ||

779 
	`NÙFunùiÚPŒ
(
ty2
è&& 
	`IsVoidPŒ
(
ty1
))

781 
qu®
 = 
ty1
->
bty
->qu® | 
ty2
->bty->qual;

782 
ex´
->
ty
 = 
	`Poš‹rTo
(
	`Qu®ify
(
qu®
, 
	`T
(
VOID
)));

786 
	`E¼Ü
(&
ex´
->
coÜd
, "invalid operand for ? operator.");

787 
ex´
->
ty
 = 
	`T
(
INT
);

790  
ex´
;

791 
	}
}

793 
A¡Ex´essiÚ
 
	$CheckCommaEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

795 
ex´
->
kids
[0] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[0]), 1);

796 
ex´
->
kids
[1] = 
	`Adju¡
(
	`CheckEx´essiÚ
(expr->kids[1]), 1);

798 
ex´
->
ty
 =ƒx´->
kids
[1]->ty;

800  
ex´
;

801 
	}
}

803 
A¡Ex´essiÚ
 
	$CheckE¼ÜEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

805 
	`as£¹
(0);

806  
NULL
;

807 
	}
}

809 
	$A¡Ex´essiÚ
 (* 
Ex´Check”s
[])(
A¡Ex´essiÚ
) =

811 
	#OPINFO
(
İ
, 
´ec
, 
Çme
, 
func
, 
İcode
è
Check
##func##
Ex´essiÚ
,

	)

812 
	~"İšfo.h
"

813 #undeà
OPINFO


814 
	}
};

816 
A¡Ex´essiÚ
 
	$Ca¡Ex´essiÚ
(
Ty³
 
ty
, 
A¡Ex´essiÚ
 
ex´
)

818 
A¡Ex´essiÚ
 
ÿ¡
;

820 ià(
ex´
->
İ
 =ğ
OP_CONST
 && 
ty
->
ÿ‹g
 !ğ
VOID
)

821  
	`FŞdCa¡
(
ty
, 
ex´
);

823 
	`CREATE_AST_NODE
(
ÿ¡
, 
Ex´essiÚ
);

825 
ÿ¡
->
coÜd
 = 
ex´
->coord;

826 
ÿ¡
->
İ
 = 
OP_CAST
;

827 
ÿ¡
->
ty
 =y;

828 
ÿ¡
->
kids
[0] = 
ex´
;

830  
ÿ¡
;

831 
	}
}

833 
	$CªAssign
(
Ty³
 
Éy
, 
A¡Ex´essiÚ
 
ex´
)

835 
Ty³
 
¹y
 = 
ex´
->
ty
;

837 
Éy
 = 
	`Unqu®
(lty);

838 
¹y
 = 
	`Unqu®
(rty);

839 ià(
Éy
 =ğ
¹y
)

843 ià(
	`BÙhAr™hTy³
(
Éy
, 
¹y
))

847 ià(
	`IsCom·tibËPŒ
(
Éy
, 
¹y
è&& (Öty->
bty
->
qu®
 &„ty->bty->qual) ==„ty->bty->qual))

851 ià((
	`NÙFunùiÚPŒ
(
Éy
è&& 
	`IsVoidPŒ
(
¹y
) || NotFunctionPtr(rty) && IsVoidPtr(lty))&&

852 ((
Éy
->
bty
->
qu®
 & 
¹y
->bty->qual) ==„ty->bty->qual))

856 ià(
	`IsPŒTy³
(
Éy
è&& 
	`IsNuÎCÚ¡ªt
(
ex´
))

861 ià(
	`IsPŒTy³
(
Éy
è&& IsPŒTy³(
¹y
))

867 ià((
	`IsPŒTy³
(
Éy
è&& 
	`IsIÁegTy³
(
¹y
) || IsPtrType(rty) && IsIntegType(lty))&&

868 (
Éy
->
size
 =ğ
¹y
->size))

870 
	`W¬nšg
(&
ex´
->
coÜd
, "conversion between…ointer‡nd integer without‡ cast");

875 
	}
}

877 
A¡Ex´essiÚ
 
	$Ca¡
(
Ty³
 
ty
, 
A¡Ex´essiÚ
 
ex´
)

879 
scode
 = 
	`Ty³Code
(
ex´
->
ty
);

880 
dcode
 = 
	`Ty³Code
(
ty
);

882 ià(
dcode
 =ğ
V
)

884  
	`Ca¡Ex´essiÚ
(
ty
, 
ex´
);

887 ià(
scode
 < 
F4
 && 
dcode
 < F4 && scode / 2 == dcode / 2)

889 
ex´
->
ty
 =y;

890  
ex´
;

893 ià(
scode
 < 
I4
)

895 
ex´
 = 
	`Ca¡Ex´essiÚ
(
	`T
(
INT
),ƒxpr);

896 
scode
 = 
I4
;

898 ià(
scode
 !ğ
dcode
)

900 ià(
dcode
 < 
I4
)

902 
ex´
 = 
	`Ca¡Ex´essiÚ
(
	`T
(
INT
),ƒxpr);

904 
ex´
 = 
	`Ca¡Ex´essiÚ
(
ty
,ƒxpr);

906  
ex´
;

907 
	}
}

909 
A¡Ex´essiÚ
 
	$Adju¡
(
A¡Ex´essiÚ
 
ex´
, 
rv®ue
)

911 ià(
rv®ue
)

913 
ex´
->
ty
 = 
	`Unqu®
(expr->ty);

914 
ex´
->
lv®ue
 = 0;

917 ià(
ex´
->
ty
->
ÿ‹g
 =ğ
FUNCTION
)

919 
ex´
->
ty
 = 
	`Poš‹rTo
(expr->ty);

920 
ex´
->
isfunc
 = 1;

922 ià(
ex´
->
ty
->
ÿ‹g
 =ğ
ARRAY
)

924 
ex´
->
ty
 = 
	`Poš‹rTo
Óx´->ty->
bty
);

925 
ex´
->
lv®ue
 = 0;

926 
ex´
->
i§¼ay
 = 1;

929  
ex´
;

930 
	}
}

932 
A¡Ex´essiÚ
 
	$DoIÁeg”PromÙiÚ
(
A¡Ex´essiÚ
 
ex´
)

934  
ex´
->
ty
->
ÿ‹g
 < 
INT
 ? 
	`Ca¡
(
	`T
(INT),ƒxpr) :ƒxpr;

935 
	}
}

937 
A¡Ex´essiÚ
 
	$CheckEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

939  (* 
Ex´Check”s
[
ex´
->
İ
])(expr);

940 
	}
}

942 
A¡Ex´essiÚ
 
	$CheckCÚ¡ªtEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

944 
ex´
 = 
	`CheckEx´essiÚ
(expr);

945 ià(! (
ex´
->
İ
 =ğ
OP_CONST
 && 
	`IsIÁegTy³
Óx´->
ty
)))

947  
NULL
;

949  
ex´
;

950 
	}
}

	@ucl/flow.c

1 
	~"uş.h
"

2 
	~"g’.h
"

7 
	$AddP»deûssÜ
(
BBlock
 
bb
, BBlock 
p
)

9 
CFGEdge
 
e
;

11 
	`ALLOC
(
e
);

12 
e
->
bb
 = 
p
;

13 
e
->
Ãxt
 = 
bb
->
´eds
;

14 
bb
->
´eds
 = 
e
;

15 
bb
->
Å»d
++;

16 
	}
}

21 
	$AddSucûssÜ
(
BBlock
 
bb
, BBlock 
s
)

23 
CFGEdge
 
e
;

25 
	`ALLOC
(
e
);

26 
e
->
bb
 = 
s
;

27 
e
->
Ãxt
 = 
bb
->
succs
;

28 
bb
->
succs
 = 
e
;

29 
bb
->
nsucc
++;

30 
	}
}

35 
	$RemoveEdge
(
CFGEdge
 *
µ»v
, 
BBlock
 
bb
)

37 
CFGEdge
 
e
;

39 
e
 = *
µ»v
;

40 
e
)

42 ià(
e
->
bb
 == bb)

44 *
µ»v
 = 
e
->
Ãxt
;

47 
µ»v
 = &
e
->
Ãxt
;

48 
e
 =ƒ->
Ãxt
;

50 
	`as£¹
(0);

52 
	}
}

57 
	$RemoveP»deûssÜ
(
BBlock
 
bb
, BBlock 
p
)

59 
	`RemoveEdge
(&
bb
->
´eds
, 
p
);

60 
bb
->
Å»d
--;

61 
	}
}

66 
	$RemoveSucûssÜ
(
BBlock
 
bb
, BBlock 
s
)

68 
	`RemoveEdge
(&
bb
->
succs
, 
s
);

69 
bb
->
nsucc
--;

70 
	}
}

76 
	$TryAddP»deûssÜ
(
BBlock
 
bb
, BBlock 
p
)

78 
CFGEdge
 
´ed
;

80 
´ed
 = 
bb
->
´eds
;

81 
´ed
 !ğ
NULL
)

83 ià(
´ed
->
bb
 =ğ
p
)

85 
´ed
 =…»d->
Ãxt
;

87 
	`AddP»deûssÜ
(
bb
, 
p
);

88 
	}
}

94 
	$TryAddSucûssÜ
(
BBlock
 
bb
, BBlock 
s
)

96 
CFGEdge
 
succ
;

98 
succ
 = 
bb
->
succs
;

99 
succ
 !ğ
NULL
)

101 ià(
succ
->
bb
 =ğ
s
)

103 
succ
 = succ->
Ãxt
;

105 
	`AddSucûssÜ
(
bb
, 
s
);

106 
	}
}

111 
	$M”geIn¡ruùiÚs
(
BBlock
 
bb1
, BBlock 
bb2
)

113 
IRIn¡
 
bb1_Ï¡i
 = 
bb1
->
š¡h
.
´ev
;

114 
IRIn¡
 
bb2_fœ¡i
 = 
bb2
->
š¡h
.
Ãxt
;

116 ià(
bb1_Ï¡i
->
İcode
 >ğ
JZ
 && bb1_Ï¡i->İcod<ğ
JMP
)

118 
bb1_Ï¡i
 = bb1_Ï¡i->
´ev
;

119 
bb1
->
nš¡
--;

122 ià(
bb2
->
nš¡
 == 0)

124 
bb1
->
š¡h
.
´ev
 = 
bb1_Ï¡i
;

125 
bb1_Ï¡i
->
Ãxt
 = &
bb1
->
š¡h
;

129 
bb1_Ï¡i
->
Ãxt
 = 
bb2_fœ¡i
;

130 
bb2_fœ¡i
->
´ev
 = 
bb1_Ï¡i
;

131 
bb2
->
š¡h
.
´ev
->
Ãxt
 = &
bb1
->insth;

132 
bb1
->
š¡h
.
´ev
 = 
bb2
->insth.prev;

134 
bb1
->
nš¡
 +ğ
bb2
->ninst;

135 
	}
}

137 
	$ModifySucûssÜ
(
BBlock
 
bb
, BBlock 
s
, BBlock 
ns
)

139 
IRIn¡
 
Ï¡i
 = 
bb
->
š¡h
.
´ev
;

141 
	`RemoveSucûssÜ
(
bb
, 
s
);

142 
	`TryAddSucûssÜ
(
bb
, 
ns
);

143 
	`TryAddP»deûssÜ
(
ns
, 
bb
);

144 ià(
Ï¡i
->
İcode
 >ğ
JZ
 &&†a¡i->İcod<ğ
JMP
)

146 ià((
BBlock
)
Ï¡i
->
İds
[0] =ğ
s
)

148 
s
->
»f
--;

149 
ns
->
»f
++;

150 
Ï¡i
->
İds
[0] = (
SymbŞ
)
ns
;

153 ià(
Ï¡i
->
İcode
 =ğ
IJMP
)

155 
BBlock
 *
d¡BBs
 = (BBlock *)
Ï¡i
->
İds
[0];

156 
i
 = 0;

158 
d¡BBs
[
i
] !ğ
NULL
)

160 ià(
d¡BBs
[
i
] =ğ
s
)

162 
s
->
»f
--;

163 
ns
->
»f
++;

164 
d¡BBs
[
i
] = 
ns
;

166 
i
++;

169 
	}
}

171 
	$D¿wCFGEdge
(
BBlock
 
h—d
, BBlock 

)

173 
	`AddSucûssÜ
(
h—d
, 

);

174 
	`AddP»deûssÜ
(

, 
h—d
);

175 
	}
}

177 
BBlock
 
	$TryM”geBBlock
(
BBlock
 
bb1
, BBlock 
bb2
)

179 ià(
bb2
 =ğ
NULL
)

180  
bb2
;

181 ià(
bb1
->
nsucc
 =ğ1 && 
bb2
->
Å»d
 =ğ1 && bb1->
succs
->
bb
 == bb2)

183 
CFGEdge
 
succ
;

185 
succ
 = 
bb2
->
succs
;

186 
succ
 !ğ
NULL
)

188 
	`RemoveP»deûssÜ
(
succ
->
bb
, 
bb2
);

189 
	`AddP»deûssÜ
(
succ
->
bb
, 
bb1
);

190 
succ
 = succ->
Ãxt
;

192 
bb1
->
succs
 = 
bb2
->succs;

193 
bb1
->
nsucc
 = 
bb2
->nsucc;

194 
	`M”geIn¡ruùiÚs
(
bb1
, 
bb2
);

195 
bb1
->
Ãxt
 = 
bb2
->next;

196 ià(
bb2
->
Ãxt
)

197 
bb2
->
Ãxt
->
´ev
 = 
bb1
;

199  
bb1
;

201 ià(
bb1
->
nš¡
 == 0)

203 
CFGEdge
 
´ed
;

205 
	`RemoveP»deûssÜ
(
bb2
, 
bb1
);

206 
´ed
 = 
bb1
->
´eds
;

207 
´ed
 !ğ
NULL
)

209 
	`ModifySucûssÜ
(
´ed
->
bb
, 
bb1
, 
bb2
);

210 
´ed
 =…»d->
Ãxt
;

212 
bb2
->
´ev
 = 
bb1
->prev;

213 ià(
bb1
->
´ev
)

214 
bb1
->
´ev
->
Ãxt
 = 
bb2
;

216  
bb1
->
´ev
;

218 ià(
bb2
->
nš¡
 =ğ0 && bb2->
Å»d
 == 0)

220 ià(
bb2
->
Ãxt
 =ğ
NULL
)

222 
bb1
->
Ãxt
 = 
NULL
;

226 
	`RemoveP»deûssÜ
(
bb2
->
Ãxt
, bb2);

227 
bb1
->
Ãxt
 = 
bb2
->next;

228 
bb2
->
Ãxt
->
´ev
 = 
bb1
;

231  
bb1
;

233 ià(
bb2
->
nš¡
 =ğ0 && bb2->
Å»d
 =ğ1 && bb2->
´eds
->
bb
 =ğ
bb1
)

235 ià(
bb2
->
Ãxt
 =ğ
NULL
)

237 
bb1
->
Ãxt
 = 
NULL
;

241 
	`RemoveP»deûssÜ
(
bb2
->
Ãxt
, bb2);

242 
	`ModifySucûssÜ
(
bb1
, 
bb2
, bb2->
Ãxt
);

243 
bb1
->
Ãxt
 = 
bb2
->next;

244 
bb2
->
Ãxt
->
´ev
 = 
bb1
;

247  
bb1
;

251 
IRIn¡
 
Ï¡i
 = 
bb1
->
š¡h
.
´ev
;

252 ià(
Ï¡i
->
İcode
 =ğ
JMP
 && 
bb1
->
succs
->
bb
 =ğbb1->
Ãxt
)

254 
Ï¡i
->
´ev
->
Ãxt
 =†asti->next;

255 
Ï¡i
->
Ãxt
->
´ev
 =†asti->prev;

256 
bb1
->
nš¡
--;

257  
bb1
;

261  
bb2
;

262 
	}
}

264 
	$ExamšeJump
(
BBlock
 
bb
)

266 
IRIn¡
 
Ï¡i
;

267 
CFGEdge
 
succ
;

268 
BBlock
 
bb1
, 
bb2
;

270 
Ï¡i
 = 
bb
->
š¡h
.
´ev
;

271 ià(! (
Ï¡i
->
İcode
 >ğ
JZ
 &&†a¡i->İcod<ğ
JMP
))

283 
succ
 = 
bb
->
succs
;

286 ià(
succ
->
bb
 =ğ(
BBlock
)
Ï¡i
->
İds
[0])

288 
succ
 = succ->
Ãxt
;

289 } 
succ
 !ğ
NULL
);

291 
bb1
 = 
succ
->
bb
;

292 ià(
bb1
->
nš¡
 =ğ1 && bb1->
š¡h
.
´ev
->
İcode
 =ğ
JMP
)

294 
bb2
 = 
bb1
->
succs
->
bb
;

295 
succ
->
bb
 = 
bb2
;

296 
	`RemoveP»deûssÜ
(
bb1
, 
bb
);

297 
	`AddP»deûssÜ
(
bb2
, 
bb
);

298 
bb1
->
»f
--;

299 
bb2
->
»f
++;

300 
Ï¡i
->
İds
[0] = (
SymbŞ
)
bb2
;

302 
	}
}

	@ucl/fold.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"ex´.h
"

5 
	#EXECUTE_BOP
(
İ
è\

	)

6 ià(
	gtcode
 =ğ
I4
è
v®
.
i
[0] = 
ex´1
->v®.i[0] 
İ
 
ex´2
->val.i[0]; \

7 ià(
	gtcode
 =ğ
U4
è
v®
.
i
[0] = ()
ex´1
->v®.i[0] 
	$İ
 ()
ex´2
->
v®
.
i
[0]; \

8 ià(
tcode
 =ğ
F4
è
v®
.
f
 = 
ex´1
->v®.à
İ
 
ex´2
->val.f; \

9 ià(
tcode
 =ğ
F8
è
v®
.
d
 = 
ex´1
->v®.d 
İ
 
ex´2
->val.d;

11 
	#EXECUTE_ROP
(
İ
è\

	)

12 ià(
tcode
 =ğ
I4
è
v®
.
i
[0] = 
ex´1
->v®.i[0] 
İ
 
ex´2
->val.i[0]; \

13 ià(
tcode
 =ğ
U4
è
v®
.
i
[0] = ()
ex´1
->v®.i[0] 
	$İ
 ()
ex´2
->
v®
.
i
[0]; \

14 ià(
tcode
 =ğ
F4
è
v®
.
i
[0] = 
ex´1
->v®.
f
 
İ
 
ex´2
->val.f; \

15 ià(
tcode
 =ğ
F8
è
v®
.
i
[0] = 
ex´1
->v®.
d
 
İ
 
ex´2
->val.d;

20 
A¡Ex´essiÚ
 
	$FŞdCa¡
(
Ty³
 
ty
, 
A¡Ex´essiÚ
 
ex´
)

22 
scode
 = 
	`Ty³Code
(
ex´
->
ty
);

23 
dcode
 = 
	`Ty³Code
(
ty
);

25 
scode
)

27 
I1
: 
U1
: 
I2
: 
U2
:

30 
I4
:

31 ià(
dcode
 =ğ
F4
)

33 
ex´
->
v®
.
f
 = (ëx´->v®.
i
[0];

35 ià(
dcode
 =ğ
F8
)

37 
ex´
->
v®
.
d
 = (ëx´->v®.
i
[0];

39 ià(
dcode
 =ğ
I1
)

41 
ex´
->
v®
.
i
[0] = ()expr->val.i[0];

43 ià(
dcode
 =ğ
U1
)

45 
ex´
->
v®
.
i
[0] = ()expr->val.i[0];

47 ià(
dcode
 =ğ
I2
)

49 
ex´
->
v®
.
i
[0] = ()expr->val.i[0];

51 ià(
dcode
 =ğ
U2
)

53 
ex´
->
v®
.
i
[0] = ()expr->val.i[0];

57 
U4
:

58 ià(
dcode
 =ğ
F4
)

60 
ex´
->
v®
.
f
 = ()(ëx´->v®.
i
[0];

62 ià(
dcode
 =ğ
F8
)

64 
ex´
->
v®
.
d
 = ()(ëx´->v®.
i
[0];

68 
F4
:

69 ià(
dcode
 =ğ
I4
)

71 
ex´
->
v®
.
i
[0] = (ëx´->v®.
f
;

73 ià(
dcode
 =ğ
U4
)

75 
ex´
->
v®
.
i
[0] = (ëx´->v®.
f
;

79 
ex´
->
v®
.
d
 = (ëx´->v®.
f
;

83 
F8
:

84 ià(
dcode
 =ğ
I4
)

86 
ex´
->
v®
.
i
[0] = (ëx´->v®.
d
;

88 ià(
dcode
 =ğ
U4
)

90 
ex´
->
v®
.
i
[0] = (ëx´->v®.
d
;

94 
ex´
->
v®
.
f
 = (ëx´->v®.
d
;

99 
	`as£¹
(0);

102 
ex´
->
ty
 =y;

103  
ex´
;

104 
	}
}

106 
A¡Ex´essiÚ
 
	$CÚ¡ªt
(
coÜd
 coÜd, 
Ty³
 
ty
, 
v®ue
 
v®
)

108 
A¡Ex´essiÚ
 
ex´
;

110 
	`CREATE_AST_NODE
(
ex´
, 
Ex´essiÚ
);

111 
ex´
->
coÜd
 = coord;

112 
ex´
->
ty
 =y;

113 
ex´
->
İ
 = 
OP_CONST
;

114 
ex´
->
v®
 = val;

116  
ex´
;

117 
	}
}

122 
A¡Ex´essiÚ
 
	$FŞdCÚ¡ªt
(
A¡Ex´essiÚ
 
ex´
)

124 
tcode
;

125 
v®ue
 
v®
;

126 
A¡Ex´essiÚ
 
ex´1
, 
ex´2
;

128 ià(
ex´
->
İ
 >ğ
OP_OR
 &&ƒx´->İ <ğ
OP_MOD
 &&

129 ! (
ex´
->
kids
[0]->
İ
 =ğ
OP_CONST
 &&ƒxpr->kids[1]->op == OP_CONST))

130  
ex´
;

132 ià(
ex´
->
İ
 >ğ
OP_POS
 &&ƒx´->İ <ğ
OP_NOT
 &&ƒx´->
kids
[0]->İ !ğ
OP_CONST
)

133  
ex´
;

135 ià(
ex´
->
İ
 =ğ
OP_QUESTION
)

137 ià(
ex´
->
kids
[0]->
İ
 =ğ
OP_CONST
 && 
	`IsIÁegTy³
Óx´->kids[0]->
ty
))

139  
ex´
->
kids
[0]->
v®
.
i
[0] ?ƒxpr->kids[1]->kids[0] :expr->kids[1]->kids[1];

141  
ex´
;

144 
v®
.
i
[1] = val.i[0] = 0;

145 
tcode
 = 
	`Ty³Code
(
ex´
->
kids
[0]->
ty
);

146 
ex´1
 = 
ex´
->
kids
[0];

147 
ex´2
 = 
ex´
->
kids
[1];

148 
ex´
->
İ
)

150 
OP_OR
:

151 
	`EXECUTE_ROP
(||);

154 
OP_AND
:

155 
	`EXECUTE_ROP
(&&);

158 
OP_BITOR
:

159 
v®
.
i
[0] = 
ex´1
->v®.i[0] | 
ex´2
->val.i[0];

162 
OP_BITXOR
:

163 
v®
.
i
[0] = 
ex´1
->v®.i[0] ^ 
ex´2
->val.i[0];

166 
OP_BITAND
:

167 
v®
.
i
[0] = 
ex´1
->v®.i[0] & 
ex´2
->val.i[0];

170 
OP_EQUAL
:

171 
	`EXECUTE_ROP
(==);

174 
OP_UNEQUAL
:

175 
	`EXECUTE_ROP
(!=);

178 
OP_GREAT
:

179 
	`EXECUTE_ROP
(>);

182 
OP_LESS
:

183 
	`EXECUTE_ROP
(<);

186 
OP_GREAT_EQ
:

187 
	`EXECUTE_ROP
(>=);

190 
OP_LESS_EQ
:

191 
	`EXECUTE_ROP
(<=);

194 
OP_LSHIFT
:

195 
v®
.
i
[0] = 
ex´1
->v®.i[0] << 
ex´2
->val.i[0];

198 
OP_RSHIFT
:

199 ià(
tcode
 =ğ
U4
)

200 
v®
.
i
[0] = ()
ex´1
->v®.i[0] >> 
ex´2
->val.i[0];

202 
v®
.
i
[0] = 
ex´1
->v®.i[0] >> 
ex´2
->val.i[0];

205 
OP_ADD
:

206 
	`EXECUTE_BOP
(+);

209 
OP_SUB
:

210 
	`EXECUTE_BOP
(-);

213 
OP_MUL
:

214 
	`EXECUTE_BOP
(*);

217 
OP_DIV
:

218 
	`EXECUTE_BOP
(/);

221 
OP_MOD
:

222 ià(
tcode
 =ğ
U4
)

223 
v®
.
i
[0] = ()
ex´1
->v®.i[0] % 
ex´2
->val.i[0];

225 
v®
.
i
[0] = 
ex´1
->v®.i[0] % 
ex´2
->val.i[0];

228 
OP_NEG
:

229 ià(
tcode
 =ğ
I4
 ||cod=ğ
U4
)

230 
v®
.
i
[0] = -
ex´1
->val.i[0];

231 ià(
tcode
 =ğ
F4
)

232 
v®
.
f
 = -
ex´1
->val.f;

233 ià(
tcode
 =ğ
F8
)

234 
v®
.
d
 = -
ex´
->val.d;

237 
OP_COMP
:

238 
v®
.
i
[0] = ~
ex´1
->val.i[0];

241 
OP_NOT
:

242 ià(
tcode
 =ğ
I4
 ||cod=ğ
U4
)

243 
v®
.
i
[0] = ! 
ex´1
->val.i[0];

244 ià(
tcode
 =ğ
F4
)

245 
v®
.
i
[0] = ! 
ex´1
->v®.
f
;

246 ià(
tcode
 =ğ
F8
)

247 
v®
.
i
[0] = ! 
ex´1
->v®.
d
;

251 
	`as£¹
(0);

252  
ex´
;

255  
	`CÚ¡ªt
(
ex´
->
coÜd
,ƒx´->
ty
, 
v®
);

256 
	}
}

	@ucl/gen.c

1 
	~"uş.h
"

2 
	~"g’.h
"

4 
	#IsCommu‹
(
İ
è0

	)

6 
BBlock
 
	gCu¼’tBB
;

7 
	gOPM­
[] =

9 
	#OPINFO
(
tok
, 
´ec
, 
Çme
, 
func
, 
İcode
èİcode,

	)

10 
	~"İšfo.h
"

11 #undeà
OPINFO


14 
	$T¿ckV®ueChªge
(
SymbŞ
 
p
)

16 
V®ueU£
 
u£
 = 
	`AsV¬
(
p
)->
u£s
;

18 
u£
)

20 ià(
u£
->
def
->
İ
 !ğ
ADDR
)

21 
u£
->
def
->
d¡
 = 
NULL
;

22 
u£
 = u£->
Ãxt
;

24 
	}
}

26 
	$T¿ckV®ueU£
(
SymbŞ
 
p
, 
V®ueDef
 
def
)

28 
V®ueU£
 
u£
;

30 
	`ALLOC
(
u£
);

31 
u£
->
def
 = def;

32 
u£
->
Ãxt
 = 
	`AsV¬
(
p
)->
u£s
;

33 
	`AsV¬
(
p
)->
u£s
 = 
u£
;

34 
	}
}

36 
	$DefšeTemp
(
SymbŞ
 
t
, 
İ
, SymbŞ 
¤c1
, SymbŞ 
¤c2
)

38 
V®ueDef
 
def
;

40 
	`ALLOC
(
def
);

41 
def
->
d¡
 = 
t
;

42 
def
->
İ
 = op;

43 
def
->
¤c1
 = src1;

44 
def
->
¤c2
 = src2;

45 
def
->
ownBB
 = 
Cu¼’tBB
;

47 ià(
İ
 =ğ
MOV
 || o°=ğ
CALL
)

49 
def
->
lšk
 = 
	`AsV¬
(
t
)->def;

50 
	`AsV¬
(
t
)->
def
 = def;

54 ià(
¤c1
->
kšd
 =ğ
SK_V¬ŸbË
)

56 
	`T¿ckV®ueU£
(
¤c1
, 
def
);

58 ià(
¤c2
 && src2->
kšd
 =ğ
SK_V¬ŸbË
)

60 
	`T¿ckV®ueU£
(
¤c2
, 
def
);

62 
	`AsV¬
(
t
)->
def
 = def;

63 
	}
}

65 
BBlock
 
	$C»©eBBlock
()

67 
BBlock
 
bb
;

69 
	`CALLOC
(
bb
);

71 
bb
->
š¡h
.
İcode
 = 
NOP
;

72 
bb
->
š¡h
.
´ev
 = bb->š¡h.
Ãxt
 = &bb->insth;

73  
bb
;

74 
	}
}

76 
	$S¹BBlock
(
BBlock
 
bb
)

78 
IRIn¡
 
Ï¡i
;

80 
Cu¼’tBB
->
Ãxt
 = 
bb
;

81 
bb
->
´ev
 = 
Cu¼’tBB
;

82 
Ï¡i
 = 
Cu¼’tBB
->
š¡h
.
´ev
;

83 ià(
Ï¡i
->
İcode
 !ğ
JMP
 &&†a¡i->İcod!ğ
IJMP
)

85 
	`D¿wCFGEdge
(
Cu¼’tBB
, 
bb
);

87 
Cu¼’tBB
 = 
bb
;

88 
	}
}

90 
	$Aµ’dIn¡
(
IRIn¡
 
š¡
)

92 
	`as£¹
(
Cu¼’tBB
 !ğ
NULL
);

94 
Cu¼’tBB
->
š¡h
.
´ev
->
Ãxt
 = 
š¡
;

95 
š¡
->
´ev
 = 
Cu¼’tBB
->
š¡h
.prev;

96 
š¡
->
Ãxt
 = &
Cu¼’tBB
->
š¡h
;

97 
Cu¼’tBB
->
š¡h
.
´ev
 = 
š¡
;

99 
Cu¼’tBB
->
nš¡
++;

100 
	}
}

102 
	$G’”©eMove
(
Ty³
 
ty
, 
SymbŞ
 
d¡
, SymbŞ 
¤c
)

104 
IRIn¡
 
š¡
;

106 
	`ALLOC
(
š¡
);

107 
d¡
->
»f
++;

108 
¤c
->
»f
++;

109 
š¡
->
ty
 =y;

110 
š¡
->
İcode
 = 
MOV
;

111 
š¡
->
İds
[0] = 
d¡
;

112 
š¡
->
İds
[1] = 
¤c
;

113 
š¡
->
İds
[2] = 
NULL
;

114 
	`Aµ’dIn¡
(
š¡
);

116 ià(
d¡
->
kšd
 =ğ
SK_V¬ŸbË
)

118 
	`T¿ckV®ueChªge
(
d¡
);

120 ià(
d¡
->
kšd
 =ğ
SK_Temp
)

122 
	`DefšeTemp
(
d¡
, 
MOV
, (
SymbŞ
)
š¡
, 
NULL
);

124 
	}
}

126 
	$G’”©eIndœeùMove
(
Ty³
 
ty
, 
SymbŞ
 
d¡
, SymbŞ 
¤c
)

128 
IRIn¡
 
š¡
;

130 
	`ALLOC
(
š¡
);

131 
d¡
->
»f
++;

132 
¤c
->
»f
++;

133 
š¡
->
ty
 =y;

134 
š¡
->
İcode
 = 
IMOV
;

135 
š¡
->
İds
[0] = 
d¡
;

136 
š¡
->
İds
[1] = 
¤c
;

137 
š¡
->
İds
[2] = 
NULL
;

138 
	`Aµ’dIn¡
(
š¡
);

139 
	}
}

141 
	$G’”©eAssign
(
Ty³
 
ty
, 
SymbŞ
 
d¡
, 
İcode
, SymbŞ 
¤c1
, SymbŞ 
¤c2
)

143 
IRIn¡
 
š¡
;

145 
	`ALLOC
(
š¡
);

146 
d¡
->
»f
++;

147 
¤c1
->
»f
++;

148 ià(
¤c2
è¤c2->
»f
++;

149 
š¡
->
ty
 =y;

150 
š¡
->
İcode
 = opcode;

151 
š¡
->
İds
[0] = 
d¡
;

152 
š¡
->
İds
[1] = 
¤c1
;

153 
š¡
->
İds
[2] = 
¤c2
;

154 
	`Aµ’dIn¡
(
š¡
);

156 
	`DefšeTemp
(
d¡
, 
İcode
, 
¤c1
, 
¤c2
);

157 
	}
}

159 
	$G’”©eB¿nch
(
Ty³
 
ty
, 
BBlock
 
d¡BB
, 
İcode
, 
SymbŞ
 
¤c1
, SymbŞ 
¤c2
)

161 
IRIn¡
 
š¡
;

163 
	`ALLOC
(
š¡
);

164 
d¡BB
->
»f
++;

165 
¤c1
->
»f
++;

166 ià(
¤c2
è¤c2->
»f
++;

167 
	`D¿wCFGEdge
(
Cu¼’tBB
, 
d¡BB
);

168 
š¡
->
ty
 =y;

169 
š¡
->
İcode
 = opcode;

170 
š¡
->
İds
[0] = (
SymbŞ
)
d¡BB
;

171 
š¡
->
İds
[1] = 
¤c1
;

172 
š¡
->
İds
[2] = 
¤c2
;

173 
	`Aµ’dIn¡
(
š¡
);

174 
	}
}

176 
	$G’”©eJump
(
BBlock
 
d¡BB
)

178 
IRIn¡
 
š¡
;

180 
	`ALLOC
(
š¡
);

181 
d¡BB
->
»f
++;

182 
	`D¿wCFGEdge
(
Cu¼’tBB
, 
d¡BB
);

183 
š¡
->
ty
 = 
	`T
(
VOID
);

184 
š¡
->
İcode
 = 
JMP
;

185 
š¡
->
İds
[0] = (
SymbŞ
)
d¡BB
;

186 
š¡
->
İds
[1] = in¡->İds[2] = 
NULL
;

187 
	`Aµ’dIn¡
(
š¡
);

188 
	}
}

190 
	$G’”©eIndœeùJump
(
BBlock
 *
d¡BBs
, 
Ën
, 
SymbŞ
 
šdex
)

192 
IRIn¡
 
š¡
;

193 
i
;

195 
	`ALLOC
(
š¡
);

196 
šdex
->
»f
++;

197 
i
 = 0; i < 
Ën
; ++i)

199 
d¡BBs
[
i
]->
»f
++;

200 
	`D¿wCFGEdge
(
Cu¼’tBB
, 
d¡BBs
[
i
]);

202 
š¡
->
ty
 = 
	`T
(
VOID
);

203 
š¡
->
İcode
 = 
IJMP
;

204 
š¡
->
İds
[0] = (
SymbŞ
)
d¡BBs
;

205 
š¡
->
İds
[1] = 
šdex
;

206 
š¡
->
İds
[2] = 
NULL
;

207 
	`Aµ’dIn¡
(
š¡
);

208 
	}
}

210 
	$G’”©eR‘uº
(
Ty³
 
ty
, 
SymbŞ
 
¤c
)

212 
IRIn¡
 
š¡
;

214 
	`ALLOC
(
š¡
);

215 
¤c
->
»f
++;

216 
š¡
->
ty
 =y;

217 
š¡
->
İcode
 = 
RET
;

218 
š¡
->
İds
[0] = 
¤c
;

219 
š¡
->
İds
[1] = in¡->İds[2] = 
NULL
;

220 
	`Aµ’dIn¡
(
š¡
);

221 
	}
}

223 
	$G’”©eFunùiÚC®l
(
Ty³
 
ty
, 
SymbŞ
 
»cv
, SymbŞ 
çddr
, 
VeùÜ
 
¬gs
)

225 
ILArg
 
p
;

226 
IRIn¡
 
š¡
;

228 
	`ALLOC
(
š¡
);

229 ià(
»cv
è»cv->
»f
++;

230 
çddr
->
»f
++;

231 
	`FOR_EACH_ITEM
(
ILArg
, 
p
, 
¬gs
)

232 
p
->
sym
->
»f
++;

233 
ENDFOR


234 
š¡
->
ty
 =y;

235 
š¡
->
İcode
 = 
CALL
;

236 
š¡
->
İds
[0] = 
»cv
;

237 
š¡
->
İds
[1] = 
çddr
;

238 
š¡
->
İds
[2] = (
SymbŞ
)
¬gs
;

239 
	`Aµ’dIn¡
(
š¡
);

241 ià(
»cv
 !ğ
NULL
)

242 
	`DefšeTemp
(
»cv
, 
CALL
, (
SymbŞ
)
š¡
, 
NULL
);

243 
	}
}

245 
	$G’”©eCË¬
(
SymbŞ
 
d¡
, 
size
)

247 
IRIn¡
 
š¡
;

249 
	`ALLOC
(
š¡
);

250 
d¡
->
»f
++;

251 
š¡
->
ty
 = 
	`T
(
UCHAR
);

252 
š¡
->
İcode
 = 
CLR
;

253 
š¡
->
İds
[0] = 
d¡
;

254 
š¡
->
İds
[1] = 
	`IÁCÚ¡ªt
(
size
);

255 
š¡
->
İds
[1]->
»f
++;

256 
š¡
->
İds
[2] = 
NULL
;

257 
	`Aµ’dIn¡
(
š¡
);

258 
	}
}

260 
SymbŞ
 
	$Add»ssOf
(
SymbŞ
 
p
)

262 ià(
p
->
kšd
 =ğ
SK_Temp
 && 
	`AsV¬
Õ)->
def
->
İ
 =ğ
DEREF
)

264  
	`AsV¬
(
p
)->
def
->
¤c1
;

267 
p
->
add»s£d
 = 1;

268 ià(
p
->
kšd
 =ğ
SK_V¬ŸbË
)

270 
	`T¿ckV®ueChªge
(
p
);

272  
	`TryAddV®ue
(
	`T
(
POINTER
), 
ADDR
, 
p
, 
NULL
);

273 
	}
}

276 
SymbŞ
 
	$D”ef
(
Ty³
 
ty
, 
SymbŞ
 
addr
)

278 
SymbŞ
 
tmp
;

280 ià(
addr
->
kšd
 =ğ
SK_Temp
 && 
	`AsV¬
×ddr)->
def
->
İ
 =ğ
ADDR
)

282  
	`AsV¬
(
addr
)->
def
->
¤c1
;

285 
tmp
 = 
	`C»©eTemp
(
ty
);

286 
	`G’”©eAssign
(
ty
, 
tmp
, 
DEREF
, 
addr
, 
NULL
);

287  
tmp
;

288 
	}
}

290 
SymbŞ
 
	$TryAddV®ue
(
Ty³
 
ty
, 
İ
, 
SymbŞ
 
¤c1
, SymbŞ 
¤c2
)

292 
h
 = (()
¤c1
 + ()
¤c2
 + 
İ
) & 15;

293 
V®ueDef
 
def
 = 
FSYM
->
v®NumTabË
[
h
];

294 
SymbŞ
 
t
;

296 ià(
İ
 !ğ
ADDR
 && (
¤c1
->
add»s£d
 || (
¤c2
 && src2->addressed)))

297 
Ãw_‹mp
;

299 
def
)

301 ià(
def
->
İ
 =ğİ && (def->
¤c1
 =ğ¤c1 && def->
¤c2
 == src2))

303 
def
 = def->
lšk
;

306 ià(
def
 && def->
ownBB
 =ğ
Cu¼’tBB
 && def->
d¡
 !ğ
NULL
)

307  
def
->
d¡
;

309 
Ãw_‹mp
:

310 
t
 = 
	`C»©eTemp
(
ty
);

311 
	`G’”©eAssign
(
ty
, 
t
, 
İ
, 
¤c1
, 
¤c2
);

313 
def
 = 
	`AsV¬
(
t
)->def;

314 
def
->
lšk
 = 
FSYM
->
v®NumTabË
[
h
];

315 
FSYM
->
v®NumTabË
[
h
] = 
def
;

316  
t
;

317 
	}
}

	@ucl/gen.h

1 #iâdeà
__GEN_H_


2 
	#__GEN_H_


	)

4 
	eOPCode


6 
	#OPCODE
(
code
, 
Çme
, 
func
ècode,

	)

7 
	~"İcode.h
"

8 #undeà
OPCODE


11 
	sœš¡


13 
œš¡
 *
	m´ev
;

14 
œš¡
 *
	mÃxt
;

15 
Ty³
 
	mty
;

16 
	mİcode
;

17 
SymbŞ
 
	mİds
[3];

18 } *
	tIRIn¡
;

20 
	scfgedge


22 
BBlock
 
	mbb
;

23 
cfgedge
 *
	mÃxt
;

24 } *
	tCFGEdge
;

26 
	sbblock


28 
bblock
 *
	m´ev
;

29 
bblock
 *
	mÃxt
;

30 
SymbŞ
 
	msym
;

31 
CFGEdge
 
	msuccs
;

32 
CFGEdge
 
	m´eds
;

33 
œš¡
 
	mš¡h
;

34 
	mnš¡
;

35 
	mnsucc
;

36 
	mÅ»d
;

37 
	m»f
;

38 
	mno
;

41 
	s¬g


43 
SymbŞ
 
	msym
;

44 
Ty³
 
	mty
;

45 } *
	tILArg
;

47 
BBlock
 
C»©eBBlock
();

48 
S¹BBlock
(
BBlock
 
bb
);

50 
G’”©eMove
(
Ty³
 
ty
, 
SymbŞ
 
d¡
, SymbŞ 
¤c
);

51 
G’”©eIndœeùMove
(
Ty³
 
ty
, 
SymbŞ
 
d¡
, SymbŞ 
¤c
);

52 
G’”©eAssign
(
Ty³
 
ty
, 
SymbŞ
 
d¡
, 
İcode
, SymbŞ 
¤c1
, SymbŞ 
¤c2
);

53 
G’”©eInc
(
Ty³
 
ty
, 
SymbŞ
 
¤c
);

54 
G’”©eDec
(
Ty³
 
ty
, 
SymbŞ
 
¤c
);

55 
G’”©eB¿nch
(
Ty³
 
ty
, 
BBlock
 
d¡BB
, 
İcode
, 
SymbŞ
 
¤c1
, SymbŞ 
¤c2
);

56 
G’”©eJump
(
BBlock
 
d¡BB
);

57 
G’”©eIndœeùJump
(
BBlock
 *
d¡BBs
, 
Ën
, 
SymbŞ
 
šdex
);

58 
G’”©eR‘uº
(
Ty³
 
ty
, 
SymbŞ
 
¤c
);

59 
G’”©eFunùiÚC®l
(
Ty³
 
ty
, 
SymbŞ
 
»cv
, SymbŞ 
çddr
, 
VeùÜ
 
¬gs
);

60 
G’”©eCË¬
(
SymbŞ
 
d¡
, 
size
);

62 
DefšeTemp
(
SymbŞ
 
t
, 
İ
, SymbŞ 
¤c1
, SymbŞ 
¤c2
);

63 
SymbŞ
 
Add»ssOf
(SymbŞ 
sym
);

64 
SymbŞ
 
D”ef
(
Ty³
 
ty
, SymbŞ 
addr
);

65 
SymbŞ
 
TryAddV®ue
(
Ty³
 
ty
, 
İ
, SymbŞ 
¤c1
, SymbŞ 
¤c2
);

66 
SymbŞ
 
Sim¶ify
(
Ty³
 
ty
, 
İ
, SymbŞ 
¤c1
, SymbŞ 
¤c2
);

68 
D¿wCFGEdge
(
BBlock
 
h—d
, BBlock 

);

69 
ExamšeJump
(
BBlock
 
bb
);

70 
BBlock
 
TryM”geBBlock
(BBlock 
bb1
, BBlock 
bb2
);

71 
O±imize
(
FunùiÚSymbŞ
 
fsym
);

73 
BBlock
 
Cu¼’tBB
;

74 
OPM­
[];

	@ucl/grammer.h

1 #iâdeà
__GRAMMER_H_


2 
	#__GRAMMER_H_


	)

4 
	#FIRST_DECLARATION
 \

	)

5 
	gTK_AUTO
, 
	gTK_EXTERN
, 
	gTK_REGISTER
, 
	gTK_STATIC
, 
	gTK_TYPEDEF
, \

6 
	gTK_CONST
, 
	gTK_VOLATILE
, 
	gTK_SIGNED
, 
	gTK_UNSIGNED
, 
	gTK_SHORT
, \

7 
	gTK_LONG
, 
	gTK_CHAR
, 
	gTK_INT
, 
	gTK_INT64
, 
	gTK_FLOAT
, \

8 
	gTK_DOUBLE
, 
	gTK_ENUM
, 
	gTK_STRUCT
, 
	gTK_UNION
, 
	gTK_VOID
, 
	gTK_ID


10 
	#FIRST_EXPRESSION
 \

	)

11 
	gTK_SIZEOF
, 
	gTK_ID
, 
	gTK_INTCONST
, 
	gTK_UINTCONST
, 
	gTK_LONGCONST
, \

12 
	gTK_ULONGCONST
, 
	gTK_LLONGCONST
, 
	gTK_ULLONGCONST
, 
	gTK_FLOATCONST
, 
	gTK_DOUBLECONST
,\

13 
	gTK_LDOUBLECONST
, 
	gTK_STRING
, 
	gTK_WIDESTRING
, 
	gTK_BITAND
, 
	gTK_ADD
, \

14 
	gTK_SUB
, 
	gTK_MUL
, 
	gTK_INC
, 
	gTK_DEC
, 
	gTK_NOT
, \

15 
	gTK_COMP
, 
	gTK_LPAREN


17 
	#FIRST_STATEMENT
 \

	)

18 
	gTK_BREAK
, 
	gTK_CASE
, 
	gTK_CONTINUE
, 
	gTK_DEFAULT
, 
	gTK_DO
, 
	gTK_FOR
, 
	gTK_GOTO
, \

19 
	gTK_IF
, 
	gTK_LBRACE
, 
	gTK_RETURN
, 
	gTK_SWITCH
, 
	gTK_WHILE
, 
	gTK_SEMICOLON
, 
	gFIRST_EXPRESSION


	@ucl/input.c

1 #ià
defšed
(
_UCC
)

3 
	~"¡dio.h
"

5 #–ià
defšed
(
_WIN32
)

7 
	~"wšdows.h
"

11 
	~<sys/mmª.h
>

12 
	~<sys/ty³s.h
>

13 
	~<sys/¡©.h
>

14 
	~<uni¡d.h
>

15 
	~<fú.h
>

19 
	~"šput.h
"

20 
	~"”rÜ.h
"

22 
	gEND_OF_FILE
 = 255;

23 
šput
 
	gIÅut
;

33 
	$R—dSourûFe
(*
f’ame
)

35 #ià
	`defšed
(
_UCC
)

37 
Ën
;

39 
IÅut
.
fe
 = 
	`fİ’
(
f’ame
, "r");

40 ià(
IÅut
.
fe
 =ğ
NULL
)

42 
	`F©®
("Cª'ˆİ’ fe: %s.", 
f’ame
);

45 
	`f£ek
(
IÅut
.
fe
, 0, 
SEEK_END
);

46 
IÅut
.
size
 = 
	`á–l
(IÅut.
fe
);

47 
IÅut
.
ba£
 = 
	`m®loc
(IÅut.
size
 + 1);

48 ià(
IÅut
.
ba£
 =ğ
NULL
)

50 
	`F©®
("Thf% i toØbig", 
f’ame
);

51 
	`fşo£
(
IÅut
.
fe
);

53 
	`f£ek
(
IÅut
.
fe
, 0, 
SEEK_SET
);

54 
IÅut
.
size
 = 
	`ä—d
(IÅut.
ba£
, 1, IÅut.size, IÅut.
fe
);

55 
	`fşo£
(
IÅut
.
fe
);

57 #–ià
	`defšed
(
_WIN32
)

59 
IÅut
.
fe
 = 
	`C»©eFeA
(
f’ame
, 
GENERIC_READ
 | 
GENERIC_WRITE
, 0, 
NULL
,

60 
OPEN_EXISTING
, 
FILE_FLAG_SEQUENTIAL_SCAN
, 
NULL
);

61 ià(
IÅut
.
fe
 =ğ
INVALID_HANDLE_VALUE
)

63 
	`F©®
("Cª'ˆİ’ fe: %s.", 
f’ame
);

66 
IÅut
.
size
 = 
	`G‘FeSize
(IÅut.
fe
, 
NULL
);

67 
IÅut
.
feM­pšg
 = 
	`C»©eFeM­pšg
(IÅut.
fe
, 
NULL
, 
PAGE_READWRITE
, 0, IÅut.
size
 + 1, NULL);

68 ià(
IÅut
.
feM­pšg
 =ğ
NULL
)

70 
	`F©®
("Cª'ˆü—‹ fm­pšg: %s.", 
f’ame
);

73 
IÅut
.
ba£
 = (*)
	`M­V›wOfFe
(IÅut.
feM­pšg
, 
FILE_MAP_WRITE
, 0, 0, 0);

74 ià(
IÅut
.
ba£
 =ğ
NULL
)

76 
	`F©®
("Cª'ˆm­ fe: %s.", 
f’ame
);

81 
¡©
 
¡
;

82 
âo
;

84 
âo
 = 
	`İ’
(
f’ame
, 
O_RDWR
);

85 ià(
âo
 == -1)

87 
	`F©®
("Cª'ˆİ’ f%s.\n", 
f’ame
);

90 ià(
	`f¡©
(
âo
, &
¡
) == -1)

92 
	`F©®
("Cª'ˆ¡© f%s.\n", 
f’ame
);

94 
IÅut
.
size
 = 
¡
.
¡_size
;

96 
IÅut
.
ba£
 = 
	`mm­
(
NULL
, IÅut.
size
 + 1, 
PROT_WRITE
, 
MAP_PRIVATE
, 
âo
, 0);

97 ià(
IÅut
.
ba£
 =ğ
MAP_FAILED
)

99 
	`F©®
("Cª'ˆmm­ f%s.\n", 
f’ame
);

102 
IÅut
.
fe
 = (*)
âo
;

106 
IÅut
.
f’ame
 = filename;

107 
IÅut
.
ba£
[IÅut.
size
] = 
END_OF_FILE
;

108 
IÅut
.
cursÜ
 = IÅut.
lšeH—d
 = IÅut.
ba£
;

109 
IÅut
.
lše
 = 1;

112 
	}
}

114 
	$Clo£SourûFe
()

116 #ià
	`defšed
(
_UCC
)

118 
	`ä“
(
IÅut
.
ba£
);

120 #–ià
	`defšed
(
_WIN32
)

122 
	`Unm­V›wOfFe
(
IÅut
.
ba£
);

123 
	`Clo£HªdË
(
IÅut
.
feM­pšg
);

124 
	`S‘FePoš‹r
(
IÅut
.
fe
, IÅut.
size
, 
NULL
, 
FILE_BEGIN
);

125 
	`S‘EndOfFe
(
IÅut
.
fe
);

126 
	`Clo£HªdË
(
IÅut
.
fe
);

129 
	`şo£
(()
IÅut
.
fe
);

130 
	`munm­
(
IÅut
.
ba£
, IÅut.
size
 + 1);

133 
	}
}

	@ucl/input.h

1 #iâdeà
__INPUT_H_


2 
	#__INPUT_H_


	)

4 
	scoÜd


6 *
	mf’ame
;

7 
	mµlše
;

8 
	mlše
;

9 
	mcŞ
;

10 } *
	tCoÜd
;

12 
	sšput


14 *
	mf’ame
;

15 *
	mba£
;

16 *
	mcursÜ
;

17 *
	mlšeH—d
;

18 
	mlše
;

19 * 
	mfe
;

20 * 
	mfeM­pšg
;

21 
	msize
;

24 
END_OF_FILE
;

25 
šput
 
IÅut
;

27 
R—dSourûFe
(*
feName
);

28 
Clo£SourûFe
();

	@ucl/keyword.h

1 
	skeywÜd


3 *
	mÇme
;

4 
	mËn
;

5 
	mtok
;

8 
keywÜd
 
	gkeywÜds_
[] =

10 {"__št64", 0, 
TK_INT64
},

11 {
NULL
, 0, 
TK_ID
}

14 
keywÜd
 
	gkeywÜdsA
[] =

16 {"auto", 4, 
TK_AUTO
},

17 {
NULL
, 0, 
TK_ID
}

20 
keywÜd
 
	gkeywÜdsB
[] =

22 {"b»ak", 5, 
TK_BREAK
},

23 {
NULL
, 0, 
TK_ID
}

26 
keywÜd
 
	gkeywÜdsC
[] =

28 {"ÿ£", 4, 
TK_CASE
},

29 {"ch¬", 4, 
TK_CHAR
},

30 {"cÚ¡", 5, 
TK_CONST
},

31 {"cÚtšue", 8, 
TK_CONTINUE
},

32 {
NULL
, 0, 
TK_ID
}

35 
keywÜd
 
	gkeywÜdsD
[] =

37 {"deçuÉ", 7, 
TK_DEFAULT
},

38 {"do", 2, 
TK_DO
},

39 {"doubË", 6, 
TK_DOUBLE
},

40 {
NULL
, 0, 
TK_ID
}

43 
keywÜd
 
	gkeywÜdsE
[] =

45 {"–£", 4, 
TK_ELSE
},

46 {"’um", 4, 
TK_ENUM
},

47 {"ex‹º", 6, 
TK_EXTERN
},

48 {
NULL
, 0, 
TK_ID
}

51 
keywÜd
 
	gkeywÜdsF
[] =

53 {"æßt", 5, 
TK_FLOAT
},

54 {"fÜ", 3, 
TK_FOR
},

55 {
NULL
, 0, 
TK_ID
}

58 
keywÜd
 
	gkeywÜdsG
[] =

60 {"gÙo", 4, 
TK_GOTO
},

61 {
NULL
, 0, 
TK_ID
}

64 
keywÜd
 
	gkeywÜdsH
[] =

66 {
NULL
, 0, 
TK_ID
}

69 
keywÜd
 
	gkeywÜdsI
[] =

71 {"if", 2, 
TK_IF
},

72 {"št", 3, 
TK_INT
},

73 {
NULL
, 0, 
TK_ID
}

76 
keywÜd
 
	gkeywÜdsJ
[] =

78 {
NULL
, 0, 
TK_ID
}

81 
keywÜd
 
	gkeywÜdsK
[] =

83 {
NULL
, 0, 
TK_ID
}

86 
keywÜd
 
	gkeywÜdsL
[] =

88 {"lÚg", 4, 
TK_LONG
},

89 {
NULL
, 0, 
TK_ID
}

92 
keywÜd
 
	gkeywÜdsM
[] =

94 {
NULL
, 0, 
TK_ID
}

97 
keywÜd
 
	gkeywÜdsN
[] =

99 {
NULL
, 0, 
TK_ID
}

102 
keywÜd
 
	gkeywÜdsO
[] =

104 {
NULL
, 0, 
TK_ID
}

107 
keywÜd
 
	gkeywÜdsP
[] =

109 {
NULL
, 0, 
TK_ID
}

112 
keywÜd
 
	gkeywÜdsQ
[] =

114 {
NULL
, 0, 
TK_ID
}

117 
keywÜd
 
	gkeywÜdsR
[] =

119 {"»gi¡”", 8, 
TK_REGISTER
},

120 {"»tuº", 6, 
TK_RETURN
},

121 {
NULL
, 0, 
TK_ID
}

124 
keywÜd
 
	gkeywÜdsS
[] =

126 {"shÜt", 5, 
TK_SHORT
},

127 {"sigÃd", 6, 
TK_SIGNED
},

128 {"sizeof", 6, 
TK_SIZEOF
},

129 {"¡©ic", 6, 
TK_STATIC
},

130 {"¡ruù", 6, 
TK_STRUCT
},

131 {"sw™ch", 6, 
TK_SWITCH
},

132 {
NULL
, 0, 
TK_ID
}

135 
keywÜd
 
	gkeywÜdsT
[] =

137 {"ty³def", 7, 
TK_TYPEDEF
},

138 {
NULL
, 0, 
TK_ID
}

141 
keywÜd
 
	gkeywÜdsU
[] =

143 {"uniÚ", 5, 
TK_UNION
},

144 {"unsigÃd", 8, 
TK_UNSIGNED
},

145 {
NULL
, 0, 
TK_ID
}

148 
keywÜd
 
	gkeywÜdsV
[] =

150 {"void", 4, 
TK_VOID
},

151 {"vŞ©e", 8, 
TK_VOLATILE
},

152 {
NULL
, 0, 
TK_ID
}

155 
keywÜd
 
	gkeywÜdsW
[] =

157 {"whe", 5, 
TK_WHILE
 },

158 {
NULL
, 0, 
TK_ID
}

161 
keywÜd
 
	gkeywÜdsX
[] =

163 {
NULL
, 0, 
TK_ID
}

166 
keywÜd
 
	gkeywÜdsY
[] =

168 {
NULL
, 0, 
TK_ID
}

171 
keywÜd
 
	gkeywÜdsZ
[] =

173 {
NULL
, 0, 
TK_ID
}

176 
keywÜd
 *
	gkeywÜds
[] =

178 
keywÜds_
, 
keywÜdsA
, 
keywÜdsB
, 
keywÜdsC
,

179 
keywÜdsD
, 
keywÜdsE
, 
keywÜdsF
, 
keywÜdsG
,

180 
keywÜdsH
, 
keywÜdsI
, 
keywÜdsJ
, 
keywÜdsK
,

181 
keywÜdsL
, 
keywÜdsM
, 
keywÜdsN
, 
keywÜdsO
,

182 
keywÜdsP
, 
keywÜdsQ
, 
keywÜdsR
, 
keywÜdsS
,

183 
keywÜdsT
, 
keywÜdsU
, 
keywÜdsV
, 
keywÜdsW
,

184 
keywÜdsX
, 
keywÜdsY
, 
keywÜdsZ


	@ucl/lex.c

1 
	~"uş.h
"

2 
	~"Ëx.h
"

3 
	~"keywÜd.h
"

5 
	#CURSOR
 (
IÅut
.
cursÜ
)

	)

6 
	#LINE
 (
IÅut
.
lše
)

	)

7 
	#LINEHEAD
 (
IÅut
.
lšeH—d
)

	)

9 (*
	tSÿÂ”
)();

11 *
P“kPošt
;

12 
v®ue
 
P“kV®ue
;

13 
coÜd
 
P“kCoÜd
;

14 
SÿÂ”
 
SÿÂ”s
[256];

16 
v®ue
 
Tok’V®ue
;

17 
coÜd
 
Tok’CoÜd
;

18 
coÜd
 
P»vCoÜd
;

19 * 
Tok’SŒšgs
[] =

21 
	#TOKEN
(
k
, 
s
ès,

	)

22 
	~"tok’.h
"

23 #undeà
TOKEN


24 
	}
};

32 
	$SÿnPPLše
()

34 
lše
 = 0;

36 
CURSOR
++;

37 *
CURSOR
 == ' ' || *CURSOR == '\t')

39 
CURSOR
++;

42 ià(
	`IsDig™
(*
CURSOR
))

44 
»ad_lše
;

46 ià(
	`¡ºcmp
(
CURSOR
, "line", 4) == 0)

48 
CURSOR
 += 4;

49 *
CURSOR
 == ' ' || *CURSOR == '\t')

51 
CURSOR
++;

53 
»ad_lše
:

54 
	`IsDig™
(*
CURSOR
))

56 
lše
 = 10 *†š+ *
CURSOR
 - '0';

57 
CURSOR
++;

59 
Tok’CoÜd
.
µlše
 = 
lše
 - 1;

61 *
CURSOR
 == ' ' || *CURSOR == '\t')

63 
CURSOR
++;

65 
Tok’CoÜd
.
f’ame
 = ++
CURSOR
;

66 *
CURSOR
 !ğ'"' && *CURSOR !ğ
END_OF_FILE
 && *CURSOR != '\n')

68 
CURSOR
++;

70 
Tok’CoÜd
.
f’ame
 = 
	`IÁ”nName
(Tok’CoÜd.f’ame, (*)
CURSOR
 - TokenCoord.filename);

73 *
CURSOR
 !ğ'\n' && *CURSOR !ğ
END_OF_FILE
)

75 
CURSOR
++;

77 
	}
}

79 
	$SkWh™eS·û
()

81 
ch
;

83 
agaš
:

84 
ch
 = *
CURSOR
;

85 
ch
 == '\t' || ch == '\v' || ch == '\f' || ch == ' ' ||

86 
ch
 == '\r' || ch == '\n' || ch == '/' || ch == '#')

88 
ch
)

91 
Tok’CoÜd
.
µlše
++;

92 
LINE
++;

93 
LINEHEAD
 = ++
CURSOR
;

97 
	`SÿnPPLše
();

101 ià(
CURSOR
[1] != '/' && CURSOR[1] != '*')

103 
CURSOR
++;

104 ià(*
CURSOR
 == '/')

106 
CURSOR
++;

107 *
CURSOR
 !ğ'\n' && *CURSOR !ğ
END_OF_FILE
)

109 
CURSOR
++;

114 
CURSOR
 += 2;

115 
CURSOR
[0] != '*' || CURSOR[1] != '/')

117 ià(*
CURSOR
 == '\n')

119 
Tok’CoÜd
.
µlše
++;

120 
LINE
++;

122 ià(
CURSOR
[0] =ğ
END_OF_FILE
 || CURSOR[1] == END_OF_FILE)

124 
	`E¼Ü
(&
Tok’CoÜd
, "Comment is‚ot closed");

127 
CURSOR
++;

129 
CURSOR
 += 2;

134 
CURSOR
++;

137 
ch
 = *
CURSOR
;

140 ià(
ExŒaWh™eS·û
 !ğ
NULL
)

142 *
p
;

144 
	`FOR_EACH_ITEM
(*, 
p
, 
ExŒaWh™eS·û
)

145 ià(
	`¡ºcmp
(
CURSOR
, 
p
, 
	`¡¾’
(p)) == 0)

147 
CURSOR
 +ğ
	`¡¾’
(
p
);

148 
agaš
;

150 
ENDFOR


152 
	}
}

154 
	$SÿnEsÿ³Ch¬
(
wide
)

156 
v
, 
ov”æow
;

158 
CURSOR
++;

159 *
CURSOR
++)

186  *(
CURSOR
 - 1);

189 ià(! 
	`IsHexDig™
(*
CURSOR
))

191 
	`E¼Ü
(&
Tok’CoÜd
, "Expect hex digit");

194 
v
 = 0;

195 
	`IsHexDig™
(*
CURSOR
))

197 ià(
v
 >> (
WCh¬Ty³
->
size
 - 4))

199 
ov”æow
 = 1;

201 ià(
	`IsDig™
(*
CURSOR
))

203 
v
 = (v << 4è+ *
CURSOR
 - '0';

207 
v
 = (v << 4è+ 
	`ToUµ”
(*
CURSOR
) - 'A' + 10;

209 
CURSOR
++;

211 ià(
ov”æow
 || (! 
wide
 && 
v
 > 255))

213 
	`W¬nšg
(&
Tok’CoÜd
, "Hexademicalƒspace sequence overflow");

215  
v
;

219 
v
 = *(
CURSOR
 - 1) - '0';

220 ià(
	`IsOùDig™
(*
CURSOR
))

222 
v
 = (v << 3è+ *
CURSOR
++ - '0';

223 ià(
	`IsOùDig™
(*
CURSOR
))

224 
v
 = (v << 3è+ *
CURSOR
++ - '0';

226  
v
;

229 
	`W¬nšg
(&
Tok’CoÜd
, "UÄecognizedƒsÿ³ sequ’û:\\%c", *
CURSOR
);

230  *
CURSOR
;

232 
	}
}

234 
	$FšdKeywÜd
(*
¡r
, 
Ën
)

236 
keywÜd
 *
p
 = 
NULL
;

237 
šdex
 = 0;

239 ià(*
¡r
 != '_')

240 
šdex
 = 
	`ToUµ”
(*
¡r
) - 'A' + 1;

242 
p
 = 
keywÜds
[
šdex
];

243 
p
->
Çme
)

245 ià(
p
->
Ën
 =ğËÀ&& 
	`¡ºcmp
(
¡r
,…->
Çme
,†en) == 0)

247 
p
++;

249  
p
->
tok
;

250 
	}
}

252 
	$SÿnIÁL™”®
(*
¡¬t
, 
Ën
, 
ba£
)

254 *
p
 = 
¡¬t
;

255 *
’d
 = 
¡¬t
 + 
Ën
;

256 
i
[2] = {0, 0};

257 
tok
 = 
TK_INTCONST
;

258 
d
 = 0;

259 
ÿ¼y0
 = 0, 
ÿ¼y1
 = 0;

260 
ov”æow
 = 0;

262 
p
 !ğ
’d
)

264 ià(
ba£
 == 16)

266 ià((*
p
 >= 'A' && *p <= 'F') ||

267 (*
p
 >= 'a' && *p <= 'f'))

269 
d
 = 
	`ToUµ”
(*
p
) - 'A' + 10;

273 
d
 = *
p
 - '0';

278 
d
 = *
p
 - '0';

281 
ba£
)

284 
ÿ¼y0
 = 
	`HIGH_4BIT
(
i
[0]);

285 
ÿ¼y1
 = 
	`HIGH_4BIT
(
i
[1]);

286 
i
[0] = i[0] << 4;

287 
i
[1] = i[1] << 4;

291 
ÿ¼y0
 = 
	`HIGH_3BIT
(
i
[0]);

292 
ÿ¼y1
 = 
	`HIGH_3BIT
(
i
[1]);

293 
i
[0] = i[0] << 3;

294 
i
[1] = i[1] << 3;

299 
t1
, 
t2
;

301 
ÿ¼y0
 = 
	`HIGH_3BIT
(
i
[0]è+ 
	`HIGH_1BIT
(i[0]);

302 
ÿ¼y1
 = 
	`HIGH_3BIT
(
i
[1]è+ 
	`HIGH_1BIT
(i[1]);

303 
t1
 = 
i
[0] << 3;

304 
t2
 = 
i
[0] << 1;

305 ià(
t1
 > 
UINT_MAX
 - 
t2
)

307 
ÿ¼y0
++;

309 
i
[0] = 
t1
 + 
t2
;

310 
t1
 = 
i
[1] << 3;

311 
t2
 = 
i
[1] << 1;

312 ià(
t1
 > 
UINT_MAX
 - 
t2
)

314 
ÿ¼y1
++;

316 
i
[1] = 
t1
 + 
t2
;

320 ià(
i
[0] > 
UINT_MAX
 - 
d
)

322 
ÿ¼y0
 +ğ
i
[0] - (
UINT_MAX
 - 
d
);

324 ià(
ÿ¼y1
 || (
i
[1] > 
UINT_MAX
 - 
ÿ¼y0
))

326 
ov”æow
 = 1;

328 
i
[0] +ğ
d
;

329 
i
[1] +ğ
ÿ¼y0
;

330 
p
++;

333 ià(
ov”æow
 || 
i
[1] != 0)

335 
	`W¬nšg
(&
Tok’CoÜd
, "Integer†iteral isoo big");

338 
Tok’V®ue
.
i
[1] = 0;

339 
Tok’V®ue
.
i
[0] = i[0];

340 
tok
 = 
TK_INTCONST
;

342 ià(*
CURSOR
 == 'U' || *CURSOR == 'u')

344 
CURSOR
++;

345 ià(
tok
 =ğ
TK_INTCONST
)

347 
tok
 = 
TK_UINTCONST
;

349 ià(
tok
 =ğ
TK_LLONGCONST
)

351 
tok
 = 
TK_ULLONGCONST
;

355 ià(*
CURSOR
 == 'L' || *CURSOR == 'l')

357 
CURSOR
++;

358 ià(
tok
 =ğ
TK_INTCONST
)

360 
tok
 = 
TK_LONGCONST
;

362 ià(
tok
 =ğ
TK_UINTCONST
)

364 
tok
 = 
TK_ULONGCONST
;

366 ià(*
CURSOR
 == 'L' || *CURSOR == 'l')

368 
CURSOR
++;

369 ià(
tok
 < 
TK_LLONGCONST
)

371 
tok
 = 
TK_LLONGCONST
;

376  
tok
;

377 
	}
}

379 
	$SÿnFlßtL™”®
(*
¡¬t
)

381 
d
;

383 ià(*
CURSOR
 == '.')

385 
CURSOR
++;

386 
	`IsDig™
(*
CURSOR
))

388 
CURSOR
++;

391 ià(*
CURSOR
 == 'e' || *CURSOR == 'E')

393 
CURSOR
++;

394 ià(*
CURSOR
 == '+' || *CURSOR == '-')

396 
CURSOR
++;

398 ià(! 
	`IsDig™
(*
CURSOR
))

400 
	`E¼Ü
(&
Tok’CoÜd
, "Expectƒxponent value");

404 
	`IsDig™
(*
CURSOR
))

406 
CURSOR
++;

411 
”ºo
 = 0;

412 
d
 = 
	`¡¹od
((*)
¡¬t
, 
NULL
);

413 ià(
”ºo
 =ğ
ERANGE
)

415 
	`W¬nšg
(&
Tok’CoÜd
, "Float†iteral overflow");

417 
Tok’V®ue
.
d
 = d;

418 ià(*
CURSOR
 == 'f' || *CURSOR == 'F')

420 
CURSOR
++;

421 
Tok’V®ue
.
f
 = ()
d
;

422  
TK_FLOATCONST
;

424 ià(*
CURSOR
 == 'L' || *CURSOR == 'l')

426 
CURSOR
++;

427  
TK_LDOUBLECONST
;

431  
TK_DOUBLECONST
;

433 
	}
}

435 
	$SÿnNum”icL™”®
()

437 *
¡¬t
 = 
CURSOR
;

438 
ba£
 = 10;

440 ià(*
CURSOR
 == '.')

442  
	`SÿnFlßtL™”®
(
¡¬t
);

445 ià(*
CURSOR
 == '0' && (CURSOR[1] == 'x' || CURSOR[1] == 'X'))

447 
CURSOR
 += 2;

448 
¡¬t
 = 
CURSOR
;

449 
ba£
 = 16;

450 ià(! 
	`IsHexDig™
(*
CURSOR
))

452 
	`E¼Ü
(&
Tok’CoÜd
, "Expect hex digit");

453 
Tok’V®ue
.
i
[0] = 0;

454  
TK_INTCONST
;

456 
	`IsHexDig™
(*
CURSOR
))

458 
CURSOR
++;

461 ià(*
CURSOR
 == '0')

463 
CURSOR
++;

464 
ba£
 = 8;

465 
	`IsOùDig™
(*
CURSOR
))

467 
CURSOR
++;

472 
CURSOR
++;

473 
	`IsDig™
(*
CURSOR
))

475 
CURSOR
++;

479 ià(
ba£
 =ğ16 || (*
CURSOR
 != '.' && *CURSOR != 'e' && *CURSOR != 'E'))

481  
	`SÿnIÁL™”®
(
¡¬t
, ()(
CURSOR
 - s¹), 
ba£
);

485  
	`SÿnFlßtL™”®
(
¡¬t
);

487 
	}
}

489 
	$SÿnCh¬L™”®
()

491 
ch
 = 0;

492 
couÁ
 = 0;

493 
wide
 = 0;

495 ià(*
CURSOR
 == 'L')

497 
CURSOR
++;

498 
wide
 = 1;

500 
CURSOR
++;

501 *
CURSOR
 != '\'')

503 ià(*
CURSOR
 =ğ'\n' || *CURSOR =ğ
END_OF_FILE
)

506 
ch
 = *
CURSOR
 =ğ'\\' ? 
	`SÿnEsÿ³Ch¬
(
wide
) : *CURSOR++;

507 
couÁ
++;

510 ià(*
CURSOR
 != '\'')

512 
	`E¼Ü
(&
Tok’CoÜd
, "Expect '");

513 
’d_ch¬
;

516 
CURSOR
++;

517 ià(
couÁ
 > 1)

519 
	`W¬nšg
(&
Tok’CoÜd
, "Two many characters");

522 
’d_ch¬
:

523 
Tok’V®ue
.
i
[0] = 
ch
;

524 
Tok’V®ue
.
i
[1] = 0;

526  
TK_INTCONST
;

527 
	}
}

529 
	$SÿnSŒšgL™”®
()

531 
tmp
[512];

532 *
ı
 = 
tmp
;

533 *
wı
 = (*)
tmp
;

534 
wide
 = 0;

535 
Ën
 = 0;

536 
maxËn
 = 512;

537 
ch
;

538 
SŒšg
 
¡r
;

540 
	`CALLOC
(
¡r
);

542 ià(*
CURSOR
 == 'L')

544 
CURSOR
++;

545 
wide
 = 1;

546 
maxËn
 /= ();

548 
CURSOR
++;

550 
Ãxt_¡ršg
:

551 *
CURSOR
 != '"')

553 ià(*
CURSOR
 =ğ'\n' || *CURSOR =ğ
END_OF_FILE
)

556 
ch
 = *
CURSOR
 =ğ'\\' ? 
	`SÿnEsÿ³Ch¬
(
wide
) : *CURSOR++;

557 ià(
wide
)

559 
wı
[
Ën
] = 
ch
;

563 
ı
[
Ën
] = ()
ch
;

565 
Ën
++;

566 ià(
Ën
 >ğ
maxËn
)

568 
	`Aµ’dSTR
(
¡r
, 
tmp
, 
Ën
, 
wide
);

569 
Ën
 = 0;

573 ià(*
CURSOR
 != '"')

575 
	`E¼Ü
(&
Tok’CoÜd
, "Expect \"");

576 
’d_¡ršg
;

579 
CURSOR
++;

580 
	`SkWh™eS·û
();

581 ià(
CURSOR
[0] == '"')

583 ià(
wide
 == 1)

585 
	`E¼Ü
(&
Tok’CoÜd
, "String wideness mismatch");

587 
CURSOR
++;

588 
Ãxt_¡ršg
;

590 ià(
CURSOR
[0] == 'L' && CURSOR[1] == '"')

592 ià(
wide
 == 0)

594 
	`E¼Ü
(&
Tok’CoÜd
, "String wideness mismatch");

596 
CURSOR
 += 2;

597 
Ãxt_¡ršg
;

600 
’d_¡ršg
:

601 
	`Aµ’dSTR
(
¡r
, 
tmp
, 
Ën
, 
wide
);

602 
Tok’V®ue
.
p
 = 
¡r
;

604  
wide
 ? 
TK_WIDESTRING
 : 
TK_STRING
;

605 
	}
}

607 
	$SÿnId’tif›r
()

609 *
¡¬t
 = 
CURSOR
;

610 
tok
;

612 ià(*
CURSOR
 == 'L')

614 ià(
CURSOR
[1] == '\'')

616  
	`SÿnCh¬L™”®
();

618 ià(
CURSOR
[1] == '"')

620  
	`SÿnSŒšgL™”®
();

624 
CURSOR
++;

625 
	`IsL‘‹rOrDig™
(*
CURSOR
))

627 
CURSOR
++;

630 
tok
 = 
	`FšdKeywÜd
((*)
¡¬t
, ()(
CURSOR
 - start));

631 ià(
tok
 =ğ
TK_ID
)

633 
Tok’V®ue
.
p
 = 
	`IÁ”nName
((*)
¡¬t
, ()(
CURSOR
 - start));

636  
tok
;

637 
	}
}

639 
	$SÿnPlus
()

641 
CURSOR
++;

642 ià(*
CURSOR
 == '+')

644 
CURSOR
++;

645  
TK_INC
;

647 ià(*
CURSOR
 == '=')

649 
CURSOR
++;

650  
TK_ADD_ASSIGN
;

654  
TK_ADD
;

656 
	}
}

658 
	$SÿnMšus
()

660 
CURSOR
++;

661 ià(*
CURSOR
 == '-')

663 
CURSOR
++;

664  
TK_DEC
;

666 ià(*
CURSOR
 == '=')

668 
CURSOR
++;

669  
TK_SUB_ASSIGN
;

671 ià(*
CURSOR
 == '>')

673 
CURSOR
++;

674  
TK_POINTER
;

678  
TK_SUB
;

680 
	}
}

682 
	$SÿnSr
()

684 
CURSOR
++;

685 ià(*
CURSOR
 == '=')

687 
CURSOR
++;

688  
TK_MUL_ASSIGN
;

692  
TK_MUL
;

694 
	}
}

696 
	$SÿnSÏsh
()

698 
CURSOR
++;

699 ià(*
CURSOR
 == '=')

701 
CURSOR
++;

702  
TK_DIV_ASSIGN
;

706  
TK_DIV
;

708 
	}
}

710 
	$SÿnP”ûÁ
()

712 
CURSOR
++;

713 ià(*
CURSOR
 == '=')

715 
CURSOR
++;

716  
TK_MOD_ASSIGN
;

720  
TK_MOD
;

722 
	}
}

724 
	$SÿnLess
()

726 
CURSOR
++;

727 ià(*
CURSOR
 == '<')

729 
CURSOR
++;

730 ià(*
CURSOR
 == '=')

732 
CURSOR
++;

733  
TK_LSHIFT_ASSIGN
;

735  
TK_LSHIFT
;

737 ià(*
CURSOR
 == '=')

739 
CURSOR
++;

740  
TK_LESS_EQ
;

744  
TK_LESS
;

746 
	}
}

748 
	$SÿnG»©
()

750 
CURSOR
++;

751 ià(*
CURSOR
 == '>')

753 
CURSOR
++;

754 ià(*
CURSOR
 == '=')

756 
CURSOR
++;

757  
TK_RSHIFT_ASSIGN
;

759  
TK_RSHIFT
;

761 ià(*
CURSOR
 == '=')

763 
CURSOR
++;

764  
TK_GREAT_EQ
;

768  
TK_GREAT
;

770 
	}
}

772 
	$SÿnExşam©iÚ
()

774 
CURSOR
++;

775 ià(*
CURSOR
 == '=')

777 
CURSOR
++;

778  
TK_UNEQUAL
;

782  
TK_NOT
;

784 
	}
}

786 
	$SÿnEqu®
()

788 
CURSOR
++;

789 ià(*
CURSOR
 == '=')

791 
CURSOR
++;

792  
TK_EQUAL
;

796  
TK_ASSIGN
;

798 
	}
}

800 
	$SÿnB¬
()

802 
CURSOR
++;

803 ià(*
CURSOR
 == '|')

805 
CURSOR
++;

806  
TK_OR
;

808 ià(*
CURSOR
 == '=')

810 
CURSOR
++;

811  
TK_BITOR_ASSIGN
;

815  
TK_BITOR
;

817 
	}
}

819 
	$SÿnAm³r§nd
()

821 
CURSOR
++;

822 ià(*
CURSOR
 == '&')

824 
CURSOR
++;

825  
TK_AND
;

827 ià(*
CURSOR
 == '=')

829 
CURSOR
++;

830  
TK_BITAND_ASSIGN
;

834  
TK_BITAND
;

836 
	}
}

838 
	$SÿnC¬‘
()

840 
CURSOR
++;

841 ià(*
CURSOR
 == '=')

843 
CURSOR
++;

844  
TK_BITXOR_ASSIGN
;

848  
TK_BITXOR
;

850 
	}
}

852 
	$SÿnDÙ
()

854 ià(
	`IsDig™
(
CURSOR
[1]))

856  
	`SÿnFlßtL™”®
(
CURSOR
);

858 ià(
CURSOR
[1] == '.' && CURSOR[2] == '.')

860 
CURSOR
 += 3;

861  
TK_ELLIPSE
;

865 
CURSOR
++;

866  
TK_DOT
;

868 
	}
}

870 
	#SINGLE_CHAR_SCANNER
(
t
è\

	)

871 
	gSÿn
##
t
() \

873 
	gCURSOR
++; \

874  
	gTK_
##
	gt
; \

877 
	$SINGLE_CHAR_SCANNER
(
LBRACE
)

878 
	$SINGLE_CHAR_SCANNER
(
RBRACE
)

879 
	$SINGLE_CHAR_SCANNER
(
LBRACKET
)

880 
	$SINGLE_CHAR_SCANNER
(
RBRACKET
)

881 
	$SINGLE_CHAR_SCANNER
(
LPAREN
)

882 
	$SINGLE_CHAR_SCANNER
(
RPAREN
)

883 
	$SINGLE_CHAR_SCANNER
(
COMMA
)

884 
	$SINGLE_CHAR_SCANNER
(
SEMICOLON
)

885 
	$SINGLE_CHAR_SCANNER
(
COMP
)

886 
	$SINGLE_CHAR_SCANNER
(
QUESTION
)

887 
	$SINGLE_CHAR_SCANNER
(
COLON
)

889 
	$SÿnBadCh¬
()

891 
	`E¼Ü
(&
Tok’CoÜd
, "Ëg® ch¬aù”:\\x%x", *
CURSOR
);

892  
	`G‘NextTok’
();

893 
	}
}

895 
	$SÿnEOF
()

897  
TK_END
;

898 
	}
}

900 
	$S‘upLex”
()

902 
i
;

904 
i
 = 0; i < 
END_OF_FILE
 + 1; i++)

906 ià(
	`IsL‘‹r
(
i
))

908 
SÿÂ”s
[
i
] = 
SÿnId’tif›r
;

910 ià(
	`IsDig™
(
i
))

912 
SÿÂ”s
[
i
] = 
SÿnNum”icL™”®
;

916 
SÿÂ”s
[
i
] = 
SÿnBadCh¬
;

920 
SÿÂ”s
[
END_OF_FILE
] = 
SÿnEOF
;

921 
SÿÂ”s
['\''] = 
SÿnCh¬L™”®
;

922 
SÿÂ”s
['"'] = 
SÿnSŒšgL™”®
;

923 
SÿÂ”s
['+'] = 
SÿnPlus
;

924 
SÿÂ”s
['-'] = 
SÿnMšus
;

925 
SÿÂ”s
['*'] = 
SÿnSr
;

926 
SÿÂ”s
['/'] = 
SÿnSÏsh
;

927 
SÿÂ”s
['%'] = 
SÿnP”ûÁ
;

928 
SÿÂ”s
['<'] = 
SÿnLess
;

929 
SÿÂ”s
['>'] = 
SÿnG»©
;

930 
SÿÂ”s
['!'] = 
SÿnExşam©iÚ
;

931 
SÿÂ”s
['='] = 
SÿnEqu®
;

932 
SÿÂ”s
['|'] = 
SÿnB¬
;

933 
SÿÂ”s
['&'] = 
SÿnAm³r§nd
;

934 
SÿÂ”s
['^'] = 
SÿnC¬‘
;

935 
SÿÂ”s
['.'] = 
SÿnDÙ
;

936 
SÿÂ”s
['{'] = 
SÿnLBRACE
;

937 
SÿÂ”s
['}'] = 
SÿnRBRACE
;

938 
SÿÂ”s
['['] = 
SÿnLBRACKET
;

939 
SÿÂ”s
[']'] = 
SÿnRBRACKET
;

940 
SÿÂ”s
['('] = 
SÿnLPAREN
;

941 
SÿÂ”s
[')'] = 
SÿnRPAREN
;

942 
SÿÂ”s
[','] = 
SÿnCOMMA
;

943 
SÿÂ”s
[';'] = 
SÿnSEMICOLON
;

944 
SÿÂ”s
['~'] = 
SÿnCOMP
;

945 
SÿÂ”s
['?'] = 
SÿnQUESTION
;

946 
SÿÂ”s
[':'] = 
SÿnCOLON
;

948 ià(
ExŒaKeywÜds
 !ğ
NULL
)

950 *
¡r
;

951 
keywÜd
 *
p
;

953 
	`FOR_EACH_ITEM
(*, 
¡r
, 
ExŒaKeywÜds
)

954 
p
 = 
keywÜds_
;

955 
p
->
Çme
)

957 ià(
	`¡rcmp
(
¡r
, 
p
->
Çme
) == 0)

959 
p
->
Ën
 = 
	`¡¾’
(
¡r
);

962 
p
++;

964 
ENDFOR


966 
	}
}

968 
	$G‘NextTok’
()

970 
tok
;

972 
P»vCoÜd
 = 
Tok’CoÜd
;

973 
	`SkWh™eS·û
();

974 
Tok’CoÜd
.
lše
 = 
LINE
;

975 
Tok’CoÜd
.
cŞ
 = ()(
CURSOR
 - 
LINEHEAD
 + 1);

977 
tok
 = (*
SÿÂ”s
[*
CURSOR
])();

978  
tok
;

979 
	}
}

981 
	$BegšP“kTok’
()

983 
P“kPošt
 = 
CURSOR
;

984 
P“kV®ue
 = 
Tok’V®ue
;

985 
P“kCoÜd
 = 
Tok’CoÜd
;

986 
	}
}

988 
	$EndP“kTok’
()

990 
CURSOR
 = 
P“kPošt
;

991 
Tok’V®ue
 = 
P“kV®ue
;

992 
Tok’CoÜd
 = 
P“kCoÜd
;

993 
	}
}

	@ucl/lex.h

1 #iâdeà
__LEX_H_


2 
	#__LEX_H_


	)

4 
	etok’


6 
	mTK_BEGIN
,

7 
	#TOKEN
(
k
, 
s
èk,

	)

8 
	~"tok’.h
"

9 #undeà
TOKEN


13 
	uv®ue


15 
	mi
[2];

16 
	mf
;

17 
	md
;

18 *
	mp
;

21 
	#IsDig™
(
c
è(ø>ğ'0' && c <ğ'9')

	)

22 
	#IsOùDig™
(
c
è(ø>ğ'0' && c <ğ'7')

	)

23 
	#IsHexDig™
(
c
è(
	`IsDig™
(cè|| (ø>ğ'A' && c <ğ'F'è|| (ø>ğ'a' && c <ğ'f'))

	)

24 
	#IsL‘‹r
(
c
è((ø>ğ'a' && c <ğ'z'è|| (ø=ğ'_'è|| (ø>ğ'A' && c <ğ'Z'))

	)

25 
	#IsL‘‹rOrDig™
(
c
è(
	`IsL‘‹r
(cè|| 
	`IsDig™
(c))

	)

26 
	#ToUµ”
(
c
è(ø& ~0x20)

	)

27 
	#HIGH_4BIT
(
v
è((vè>> (8 * (è- 4è& 0x0f)

	)

28 
	#HIGH_3BIT
(
v
è((vè>> (8 * (è- 3è& 0x07)

	)

29 
	#HIGH_1BIT
(
v
è((vè>> (8 * (è- 1è& 0x01)

	)

31 
S‘upLex”
();

32 
BegšP“kTok’
();

33 
EndP“kTok’
();

34 
G‘NextTok’
();

36 
v®ue
 
Tok’V®ue
;

37 
coÜd
 
Tok’CoÜd
;

38 
coÜd
 
P»vCoÜd
;

39 * 
Tok’SŒšgs
[];

	@ucl/linux/include/assert.h

1 #iâdeà
__ASSERT_H_


2 
	#__ASSERT_H_


	)

4 
as£¹
();

8 #undeà
as£¹


10 #ifdeà
NDEBUG


12 
	#as£¹
(
ignÜe
è(()0)

	)

16 
_as£¹
(*, *, );

17 
	#as£¹
(
e
è(()(Ó)||
	`_as£¹
(#e, 
__FILE__
, 
__LINE__
)))

	)

	@ucl/linux/include/float.h

1 #iâdeà
__FLOAT_H_


2 
	#__FLOAT_H_


	)

4 
	#FLT_ROUNDS
 (
	`__æt_rounds
())

	)

5 
	#FLT_RADIX
 2

	)

7 
	#FLT_DIG
 6

	)

8 
	#FLT_EPSILON
 1.19209289550781250000e-07

	)

9 
	#FLT_MANT_DIG
 24

	)

10 
	#FLT_MAX
 3.40282346638528860000e+38

	)

11 
	#FLT_MAX_10_EXP
 38

	)

12 
	#FLT_MAX_EXP
 128

	)

13 
	#FLT_MIN
 1.17549435082228750000e-38

	)

14 
	#FLT_MIN_10_EXP
 -37

	)

15 
	#FLT_MIN_EXP
 -125

	)

17 
	#DBL_DIG
 15

	)

18 
	#DBL_EPSILON
 2.22044604925031310000e-16

	)

19 
	#DBL_MANT_DIG
 53

	)

20 
	#DBL_MAX
 1.79769313486231570000e+308

	)

21 
	#DBL_MAX_10_EXP
 308

	)

22 
	#DBL_MAX_EXP
 1024

	)

23 
	#DBL_MIN
 2.22507385850720140000e-308

	)

24 
	#DBL_MIN_10_EXP
 -307

	)

25 
	#DBL_MIN_EXP
 -1021

	)

27 
	#LDBL_MANT_DIG
 
DBL_MANT_DIG


	)

28 
	#LDBL_EPSILON
 
DBL_EPSILON


	)

29 
	#LDBL_DIG
 
DBL_DIG


	)

30 
	#LDBL_MIN_EXP
 
DBL_MIN_EXP


	)

31 
	#LDBL_MIN
 
DBL_MIN


	)

32 
	#LDBL_MIN_10_EXP
 
DBL_MIN_10_EXP


	)

33 
	#LDBL_MAX_EXP
 
DBL_MAX_EXP


	)

34 
	#LDBL_MAX
 
DBL_MAX


	)

35 
	#LDBL_MAX_10_EXP
 
DBL_MAX_10_EXP


	)

	@ucl/linux/include/limits.h

1 #iâdeà
__LIMITS_H_


2 
	#__LIMITS_H_


	)

4 
	#CHAR_BIT
 8

	)

5 
	#MB_LEN_MAX
 1

	)

7 
	#UCHAR_MAX
 0xff

	)

8 
	#USHRT_MAX
 0xffff

	)

9 
	#UINT_MAX
 0xffffffff

	)

10 
	#ULONG_MAX
 0xffffffff

	)

12 
	#SCHAR_MAX
 0x7f

	)

13 
	#SHRT_MAX
 0x7fff

	)

14 
	#INT_MAX
 0x7fffffff

	)

15 
	#LONG_MAX
 0x7fffffffL

	)

17 
	#SCHAR_MIN
 (-
SCHAR_MAX
-1)

	)

18 
	#SHRT_MIN
 (-
SHRT_MAX
-1)

	)

19 
	#INT_MIN
 (-
INT_MAX
-1)

	)

20 
	#LONG_MIN
 (-
LONG_MAX
-1)

	)

22 #ifdeà
__CHAR_UNSIGNED__


23 
	#CHAR_MAX
 
UCHAR_MAX


	)

24 
	#CHAR_MIN
 0

	)

26 
	#CHAR_MAX
 
SCHAR_MAX


	)

27 
	#CHAR_MIN
 
SCHAR_MIN


	)

	@ucl/linux/include/math.h

1 #iâdeà
__MATH_H_


2 
	#__MATH_H_


	)

4 
	#HUGE_VAL
 1.79769313486231570000e+308

	)

6 
acos
();

7 
asš
();

8 
©ª
();

9 
©ª2
(, );

10 
cos
();

11 
sš
();

12 
n
();

13 
cosh
();

14 
sšh
();

15 
nh
();

16 
exp
();

17 
äexp
(, *);

18 
ldexp
(, );

19 
log
();

20 
log10
();

21 
modf
(, *);

22 
pow
(, );

23 
sq¹
();

24 
û
();

25 
çbs
();

26 
æoÜ
();

27 
fmod
(, );

	@ucl/linux/include/stdarg.h

1 #iâdeà
__STDARG_H_


2 
	#__STDARG_H_


	)

4 
	#ALIGN_INT
(
n
è((Òè+ (è- 1è& ~((è- 1))

	)

6 #ià!
defšed
(
_VA_LIST
è&& !defšed(
__VA_LIST_DEFINED
)

8 
	#_VA_LIST


	)

9 
	#_VA_LIST_DEFINED


	)

10 *
	t__va_li¡
;

14 
	g__va_¬g_tmp
;

15 
__va_li¡
 
	tva_li¡
;

17 
	#va_¡¬t
(
li¡
, 
¡¬t
èÖi¡ = (
va_li¡
)&¡¬ˆ+ 
	`ALIGN_INT
(¡¬t))

	)

18 
	#va_¬g
(
li¡
, 
t
è(*Ñ *)(Öi¡ +ğ
	`ALIGN_INT
Ñ)è- ALIGN_INTÑ)))

	)

19 
	#va_’d
(
li¡
èÖi¡ = (
va_li¡
)0)

	)

21 *
	t__gnuc_va_li¡
;

	@ucl/opcode.h

1 #iâdeà
OPCODE


5 
OPCODE
(
BOR
, "|", 
Assign
)

6 
OPCODE
(
BXOR
, "^", 
Assign
)

7 
OPCODE
(
BAND
, "&", 
Assign
)

8 
OPCODE
(
LSH
, "<<", 
Assign
)

9 
OPCODE
(
RSH
, ">>", 
Assign
)

10 
OPCODE
(
ADD
, "+", 
Assign
)

11 
OPCODE
(
SUB
, "-", 
Assign
)

12 
OPCODE
(
MUL
, "*", 
Assign
)

13 
OPCODE
(
DIV
, "/", 
Assign
)

14 
OPCODE
(
MOD
, "%", 
Assign
)

15 
OPCODE
(
NEG
, "-", 
Assign
)

16 
OPCODE
(
BCOM
, "~", 
Assign
)

17 
OPCODE
(
JZ
, "", 
B¿nch
)

18 
OPCODE
(
JNZ
, "!", 
B¿nch
)

19 
OPCODE
(
JE
, "==", 
B¿nch
)

20 
OPCODE
(
JNE
, "!=", 
B¿nch
)

21 
OPCODE
(
JG
, ">", 
B¿nch
)

22 
OPCODE
(
JL
, "<", 
B¿nch
)

23 
OPCODE
(
JGE
, ">=", 
B¿nch
)

24 
OPCODE
(
JLE
, "<=", 
B¿nch
)

25 
OPCODE
(
JMP
, "jmp", 
Jump
)

26 
OPCODE
(
IJMP
, "ijmp", 
IndœeùJump
)

27 
OPCODE
(
INC
, "++", 
Inc
)

28 
OPCODE
(
DEC
, "--", 
Dec
)

29 
OPCODE
(
ADDR
, "&", 
Add»ss
)

30 
OPCODE
(
DEREF
, "*", 
D”ef
)

31 
OPCODE
(
EXTI1
, "(št)(ch¬)", 
Ca¡
)

32 
OPCODE
(
EXTU1
, "(št)(unsigÃd ch¬)", 
Ca¡
)

33 
OPCODE
(
EXTI2
, "(št)(shÜt)", 
Ca¡
)

34 
OPCODE
(
EXTU2
, "(št)(unsigÃd shÜt)",
Ca¡
)

35 
OPCODE
(
TRUI1
, "(ch¬)(št)", 
Ca¡
)

36 
OPCODE
(
TRUI2
, "(shÜt)(št)", 
Ca¡
)

37 
OPCODE
(
CVTI4F4
, "(æßt)(št)", 
Ca¡
)

38 
OPCODE
(
CVTI4F8
, "(doubË)(št)", 
Ca¡
)

39 
OPCODE
(
CVTU4F4
, "(æßt)(unsigÃd)", 
Ca¡
)

40 
OPCODE
(
CVTU4F8
, "(doubË)(unsigÃd)", 
Ca¡
)

41 
OPCODE
(
CVTF4
, "(doubË)(æßt)", 
Ca¡
)

42 
OPCODE
(
CVTF4I4
, "(št)(æßt)", 
Ca¡
)

43 
OPCODE
(
CVTF4U4
, "(unsigÃd)(æßt)", 
Ca¡
)

44 
OPCODE
(
CVTF8
, "(æßt)(doubË)", 
Ca¡
)

45 
OPCODE
(
CVTF8I4
, "(št)(doubË)", 
Ca¡
)

46 
OPCODE
(
CVTF8U4
, "(unsigÃd)(doubË)", 
Ca¡
)

47 
OPCODE
(
MOV
, "=", 
Move
)

48 
OPCODE
(
IMOV
, "*=", 
IndœeùMove
)

49 
OPCODE
(
CALL
, "ÿÎ", 
C®l
)

50 
OPCODE
(
RET
, "»t", 
R‘uº
)

51 
OPCODE
(
CLR
, "", 
CË¬
)

52 
OPCODE
(
NOP
, "NOP", NOP)

	@ucl/opinfo.h

1 #iâdeà
OPINFO


5 
OPINFO
(
OP_COMMA
, 1, ",", 
Comma
, 
NOP
)

6 
OPINFO
(
OP_ASSIGN
, 2, "=", 
Assignm’t
, 
NOP
)

7 
OPINFO
(
OP_BITOR_ASSIGN
, 2, "|=", 
Assignm’t
, 
NOP
)

8 
OPINFO
(
OP_BITXOR_ASSIGN
, 2, "^=", 
Assignm’t
, 
NOP
)

9 
OPINFO
(
OP_BITAND_ASSIGN
, 2, "&=", 
Assignm’t
, 
NOP
)

10 
OPINFO
(
OP_LSHIFT_ASSIGN
, 2, "<<=", 
Assignm’t
, 
NOP
)

11 
OPINFO
(
OP_RSHIFT_ASSIGN
, 2, ">>=", 
Assignm’t
, 
NOP
)

12 
OPINFO
(
OP_ADD_ASSIGN
, 2, "+=", 
Assignm’t
, 
NOP
)

13 
OPINFO
(
OP_SUB_ASSIGN
, 2, "-=", 
Assignm’t
, 
NOP
)

14 
OPINFO
(
OP_MUL_ASSIGN
, 2, "*=", 
Assignm’t
, 
NOP
)

15 
OPINFO
(
OP_DIV_ASSIGN
, 2, "/=", 
Assignm’t
, 
NOP
)

16 
OPINFO
(
OP_MOD_ASSIGN
, 2, "%=", 
Assignm’t
, 
NOP
)

17 
OPINFO
(
OP_QUESTION
, 3, "?", 
CÚd™iÚ®
, 
NOP
)

18 
OPINFO
(
OP_COLON
, 3, ":", 
E¼Ü
, 
NOP
)

19 
OPINFO
(
OP_OR
, 4, "||", 
Bš¬y
, 
NOP
)

20 
OPINFO
(
OP_AND
, 5, "&&", 
Bš¬y
, 
NOP
)

21 
OPINFO
(
OP_BITOR
, 6, "|", 
Bš¬y
, 
BOR
)

22 
OPINFO
(
OP_BITXOR
, 7, "^", 
Bš¬y
, 
BXOR
)

23 
OPINFO
(
OP_BITAND
, 8, "&", 
Bš¬y
, 
BAND
)

24 
OPINFO
(
OP_EQUAL
, 9, "==", 
Bš¬y
, 
JE
)

25 
OPINFO
(
OP_UNEQUAL
, 9, "!=", 
Bš¬y
, 
JNE
)

26 
OPINFO
(
OP_GREAT
, 10, ">", 
Bš¬y
, 
JG
)

27 
OPINFO
(
OP_LESS
, 10, "<", 
Bš¬y
, 
JL
)

28 
OPINFO
(
OP_GREAT_EQ
, 10, ">=", 
Bš¬y
, 
JGE
)

29 
OPINFO
(
OP_LESS_EQ
, 10, "<=", 
Bš¬y
, 
JLE
)

30 
OPINFO
(
OP_LSHIFT
, 11, "<<", 
Bš¬y
, 
LSH
)

31 
OPINFO
(
OP_RSHIFT
, 11, ">>", 
Bš¬y
, 
RSH
)

32 
OPINFO
(
OP_ADD
, 12, "+", 
Bš¬y
, 
ADD
)

33 
OPINFO
(
OP_SUB
, 12, "-", 
Bš¬y
, 
SUB
)

34 
OPINFO
(
OP_MUL
, 13, "*", 
Bš¬y
, 
MUL
)

35 
OPINFO
(
OP_DIV
, 13, "/", 
Bš¬y
, 
DIV
)

36 
OPINFO
(
OP_MOD
, 13, "%", 
Bš¬y
, 
MOD
)

37 
OPINFO
(
OP_CAST
, 14, "ÿ¡", 
UÇry
, 
NOP
)

38 
OPINFO
(
OP_PREINC
, 14, "++", 
UÇry
, 
NOP
)

39 
OPINFO
(
OP_PREDEC
, 14, "--", 
UÇry
, 
NOP
)

40 
OPINFO
(
OP_ADDRESS
, 14, "&", 
UÇry
, 
ADDR
)

41 
OPINFO
(
OP_DEREF
, 14, "*", 
UÇry
, 
DEREF
)

42 
OPINFO
(
OP_POS
, 14, "+", 
UÇry
, 
NOP
)

43 
OPINFO
(
OP_NEG
, 14, "-", 
UÇry
, 
NEG
)

44 
OPINFO
(
OP_COMP
, 14, "~", 
UÇry
, 
BCOM
)

45 
OPINFO
(
OP_NOT
, 14, "!", 
UÇry
, 
NOP
)

46 
OPINFO
(
OP_SIZEOF
, 14, "sizeof", 
UÇry
, 
NOP
)

47 
OPINFO
(
OP_INDEX
, 15, "[]", 
Po¡fix
, 
NOP
)

48 
OPINFO
(
OP_CALL
, 15, "ÿÎ", 
Po¡fix
, 
NOP
)

49 
OPINFO
(
OP_MEMBER
, 15, ".", 
Po¡fix
, 
NOP
)

50 
OPINFO
(
OP_PTR_MEMBER
, 15, "->", 
Po¡fix
, 
NOP
)

51 
OPINFO
(
OP_POSTINC
, 15, "++", 
Po¡fix
, 
INC
)

52 
OPINFO
(
OP_POSTDEC
, 15, "--", 
Po¡fix
, 
DEC
)

53 
OPINFO
(
OP_ID
, 16, "id", 
Prim¬y
, 
NOP
)

54 
OPINFO
(
OP_CONST
, 16, "cÚ¡", 
Prim¬y
, 
NOP
)

55 
OPINFO
(
OP_STR
, 16, "¡r", 
Prim¬y
, 
NOP
)

56 
OPINFO
(
OP_NONE
, 17, "nİ", 
E¼Ü
, 
NOP
)

	@ucl/output.c

1 
	~"uş.h
"

2 
	~"ouut.h
"

3 
	~"rg‘.h
"

5 
	#BUF_LEN
 4096

	)

7 
	#PUT_CHAR
(
c
è\

	)

8 ià(
	gBufãrSize
 + 1 > 
	gBUF_LEN
) \

10 
Flush
(); \

12 
	gOutBufãr
[
BufãrSize
++] = 
c
;

14 
	gOutBufãr
[
BUF_LEN
];

15 
	gBufãrSize
;

17 
	$LeáAlign
(
FILE
 *
fe
, 
pos
)

19 
¥aûs
[256];

21 
pos
 =…os >= 256 ? 2 :…os;

22 
	`mem£t
(
¥aûs
, ' ', 
pos
);

23 
¥aûs
[
pos
] = '\0';

24 ià(
fe
 !ğ
ASMFe
)

26 
	`årštf
(
fe
, "\n%s", 
¥aûs
);

30 
	`PutSŒšg
(
¥aûs
);

32 
	}
}

38 
FILE
* 
	$C»©eOuut
(*
f’ame
, *
ext
)

40 
tmp
[256];

41 *
p
 = 
tmp
;

43 *
f’ame
 && *filename != '.')

44 *
p
++ = *
f’ame
++;

45 
	`¡rıy
(
p
, 
ext
);

47  
	`fİ’
(
tmp
, "w");

48 
	}
}

53 * 
	$FÜm©Name
(cÚ¡ *
fmt
, ...)

55 
buf
[256];

56 
va_li¡
 
­
;

58 
	`va_¡¬t
(
­
, 
fmt
);

59 
	`v¥rštf
(
buf
, 
fmt
, 
­
);

60 
	`va_’d
(
­
);

62  
	`IÁ”nName
(
buf
, 
	`¡¾’
(buf));

63 
	}
}

68 
	$Pršt
(cÚ¡ *
fmt
, ...)

70 
tmp
[1024];

71 
va_li¡
 
­
;

73 
	`va_¡¬t
(
­
, 
fmt
);

74 
	`v¥rštf
(
tmp
, 
fmt
, 
­
);

75 
	`va_’d
(
­
);

76 
	`PutSŒšg
(
tmp
);

77 
	}
}

79 
	$PutSŒšg
(*
s
)

81 
Ën
 = 
	`¡¾’
(
s
);

82 
i
;

83 *
p
;

85 ià(
Ën
 > 
BUF_LEN
)

87 
	`fwr™e
(
s
, 1, 
Ën
, 
ASMFe
);

91 ià(
Ën
 > 
BUF_LEN
 - 
BufãrSize
)

93 
	`Flush
();

96 
p
 = 
OutBufãr
 + 
BufãrSize
;

97 
i
 = 0; i < 
Ën
; ++i)

99 
p
[
i
] = 
s
[i];

101 
BufãrSize
 +ğ
Ën
;

102 
	}
}

104 
	$PutCh¬
(
ch
)

106 
	`PUT_CHAR
(
ch
);

107 
	}
}

109 
	$Flush
()

111 ià(
BufãrSize
 != 0)

113 
	`fwr™e
(
OutBufãr
, 1, 
BufãrSize
, 
ASMFe
);

115 
BufãrSize
 = 0;

116 
	}
}

	@ucl/output.h

1 #iâdeà
__OUTPUT_H_


2 
	#__OUTPUT_H_


	)

4 
LeáAlign
(
FILE
 *
fe
, 
pos
);

5 
FILE
* 
C»©eOuut
(*
f’ame
, *
ext
);

6 * 
FÜm©Name
(cÚ¡ *
fmt
, ...);

7 
Pršt
(cÚ¡ *
fmt
, ...);

8 
PutSŒšg
(*
¡r
);

9 
PutCh¬
(
ch
);

10 
Flush
();

	@ucl/reg.c

1 
	~"uş.h
"

2 
	~"g’.h
"

3 
	~"»g.h
"

4 
	~"rg‘.h
"

5 
	~"ouut.h
"

7 
SymbŞ
 
	gX86Regs
[
EDI
 + 1];

8 
SymbŞ
 
	gX86By‹Regs
[
EDI
 + 1];

9 
SymbŞ
 
	gX86WÜdRegs
[
EDI
 + 1];

10 
	gU£dRegs
;

12 
	$FšdEm±yReg
(
’dr
)

14 
i
;

16 
i
 = 
EAX
; i <ğ
’dr
; ++i)

18 ià(
X86Regs
[
i
] !ğ
NULL
 && X86Regs[i]->
lšk
 =ğNULL && ! (1 << i & 
U£dRegs
))

19  
i
;

22  
NO_REG
;

23 
	}
}

25 
	$S–eùSplReg
(
’dr
)

27 
SymbŞ
 
p
;

28 
i
;

29 
»g
 = 
NO_REG
;

30 
»f
, 
m»f
 = 
INT_MAX
;

32 
i
 = 
EAX
; i <ğ
’dr
; ++i)

34 ià(
X86Regs
[
i
] =ğ
NULL
 || (1 << i & 
U£dRegs
))

37 
p
 = 
X86Regs
[
i
]->
lšk
;

38 
»f
 = 0;

39 
p
)

41 ià(
p
->
Ãedwb
 &&…->
»f
 > 0)

43 
»f
 +ğ
p
->ref;

45 
p
 =…->
lšk
;

47 ià(
»f
 < 
m»f
)

49 
m»f
 = 
»f
;

50 
»g
 = 
i
;

54 
	`as£¹
(
»g
 !ğ
NO_REG
);

55  
»g
;

56 
	}
}

58 
SymbŞ
 
	$G‘RegIÁ”Çl
(
width
)

60 
i
, 
’dr
;

61 
SymbŞ
 *
»gs
;

63 
width
)

66 
’dr
 = 
EDX
;

67 
»gs
 = 
X86By‹Regs
;

71 
’dr
 = 
EDI
;

72 
»gs
 = 
X86WÜdRegs
;

76 
’dr
 = 
EDI
;

77 
»gs
 = 
X86Regs
;

81 
i
 = 
	`FšdEm±yReg
(
’dr
);

82 ià(
i
 =ğ
NO_REG
)

84 
i
 = 
	`S–eùSplReg
(
’dr
);

85 
	`SplReg
(
X86Regs
[
i
]);

87 
U£dRegs
 |ğ1 << 
i
;

89  
»gs
[
i
];

90 
	}
}

92 
	$SplReg
(
SymbŞ
 
»g
)

94 
SymbŞ
 
p
;

96 
p
 = 
»g
->
lšk
;

97 
p
)

99 
p
->
»g
 = 
NULL
;

100 ià(
p
->
Ãedwb
 &&…->
»f
 > 0)

102 
p
->
Ãedwb
 = 0;

103 
	`StÜeV¬
(
»g
, 
p
);

105 
p
 =…->
lšk
;

107 
»g
->
lšk
 = 
NULL
;

108 
	}
}

110 
	$CË¬Regs
()

112 
i
;

114 
i
 = 
EAX
; i <ğ
EDI
; ++i)

116 ià(
X86Regs
[
i
])

117 
	`SplReg
(
X86Regs
[
i
]);

119 
	}
}

121 
SymbŞ
 
	$G‘By‹Reg
()

123  
	`G‘RegIÁ”Çl
(1);

124 
	}
}

126 
SymbŞ
 
	$G‘WÜdReg
()

128  
	`G‘RegIÁ”Çl
(2);

129 
	}
}

131 
SymbŞ
 
	$G‘Reg
()

133  
	`G‘RegIÁ”Çl
(4);

134 
	}
}

136 
SymbŞ
 
	$C»©eReg
(*
Çme
, *
šame
, 
no
)

138 
SymbŞ
 
»g
;

140 
	`CALLOC
(
»g
);

142 
»g
->
kšd
 = 
SK_Regi¡”
;

143 
»g
->
Çme
 =„eg->
ªame
 =‚ame;

144 
»g
->
v®
.
i
[0] = 
no
;

145 
»g
->reg =„eg;

147 ià(
šame
 !ğ
NULL
)

149 
	`CALLOC
(
»g
->
Ãxt
);

150 
»g
->
Ãxt
->
kšd
 = 
SK_IRegi¡”
;

151 
»g
->
Ãxt
->
Çme
 =„eg->Ãxt->
ªame
 = 
šame
;

154  
»g
;

155 
	}
}

	@ucl/reg.h

1 #iâdeà
__REG_H_


2 
	#__REG_H_


	)

4 ’um { 
	mEAX
, 
	mECX
, 
	mEDX
, 
	mEBX
, 
	mESP
, 
	mEBP
, 
	mESI
, 
	mEDI
 };

6 
	#SK_IRegi¡”
 (
SK_Regi¡”
 + 1)

	)

7 
	#NO_REG
 -1

	)

9 
StÜeV¬
(
SymbŞ
 
»g
, SymbŞ 
v
);

10 
SplReg
(
SymbŞ
 
»g
);

11 
CË¬Regs
();

12 
SymbŞ
 
C»©eReg
(*
Çme
, *
šame
, 
no
);

13 
SymbŞ
 
G‘By‹Reg
();

14 
SymbŞ
 
G‘WÜdReg
();

15 
SymbŞ
 
G‘Reg
();

17 
SymbŞ
 
X86Regs
[];

18 
SymbŞ
 
X86By‹Regs
[];

19 
SymbŞ
 
X86WÜdRegs
[];

20 
U£dRegs
;

	@ucl/simp.c

1 
	~"uş.h
"

2 
	~"g’.h
"

8 
	$Pow”2
(
u
)

10 
n
;

12 ià(
u
 > 1 && (u &(u - 1)) == 0)

14 
n
 = 0; 
u
; u >>= 1,‚++)

16 ià(
u
 & 1)

17  
n
;

21 
	}
}

26 
SymbŞ
 
	$Sim¶ify
(
Ty³
 
ty
, 
İcode
, 
SymbŞ
 
¤c1
, SymbŞ 
¤c2
)

28 
V¬ŸbËSymbŞ
 
t
;

29 
SymbŞ
 
p1
, 
p2
;

30 
c1
, 
c2
;

32 ià(
	`IsR—lTy³
(
ty
))

33 
add_v®ue
;

35 ià(
¤c2
 =ğ
NULL
 || (¤c2->
kšd
 !ğ
SK_CÚ¡ªt
 && 
İcode
 !ğ
SUB
))

36 
add_v®ue
;

38 
İcode
)

40 
ADD
:

42 ià(
¤c2
->
v®
.
i
[0] == 0)

43  
¤c1
;

47 
p1
 = 
¤c1
; 
c1
 = 0;

48 ià(
¤c1
->
kšd
 =ğ
SK_Temp
)

50 
t
 = 
	`AsV¬
(
¤c1
);

52 ià(
t
->
def
->
¤c2
 &&->def->¤c2->
kšd
 =ğ
SK_CÚ¡ªt
 &&

53 (
t
->
def
->
İ
 =ğ
ADD
 ||->def->İ =ğ
SUB
))

55 
p1
 = 
t
->
def
->
¤c1
;

56 
c1
 = (
t
->
def
->
İ
 =ğ
ADD
 ? 1 : -1è*->def->
¤c2
->
v®
.
i
[0];

59 ià(
c1
 != 0)

61 
¤c1
 = 
p1
;

62 
¤c2
 = 
	`IÁCÚ¡ªt
(
c1
 + src2->
v®
.
i
[0]);

66 
SUB
:

68 ià(
¤c2
->
kšd
 =ğ
SK_CÚ¡ªt
 && src2->
v®
.
i
[0] == 0)

69  
¤c1
;

72 
p1
 = 
¤c1
; 
c1
 = 0;

73 ià(
¤c1
->
kšd
 =ğ
SK_Temp
)

75 
t
 = 
	`AsV¬
(
¤c1
);

76 ià(
t
->
def
->
¤c2
 &&->def->¤c2->
kšd
 =ğ
SK_CÚ¡ªt
 &&

77 (
t
->
def
->
İ
 =ğ
ADD
 ||->def->İ =ğ
SUB
))

79 
p1
 = 
t
->
def
->
¤c1
;

80 
c1
 = (
t
->
def
->
İ
 =ğ
ADD
 ? 1 : -1è*->def->
¤c2
->
v®
.
i
[0];

83 ià(
¤c1
->
kšd
 =ğ
SK_CÚ¡ªt
)

85 
p1
 = 
NULL
;

86 
c1
 = 
¤c1
->
v®
.
i
[0];

88 
p2
 = 
¤c2
; 
c2
 = 0;

89 ià(
¤c2
->
kšd
 =ğ
SK_Temp
)

91 
t
 = 
	`AsV¬
(
¤c2
);

92 ià(
t
->
def
->
¤c2
 &&->def->¤c2->
kšd
 =ğ
SK_CÚ¡ªt
 &&

93 (
t
->
def
->
İ
 =ğ
ADD
 ||->def->İ =ğ
SUB
))

95 
p2
 = 
t
->
def
->
¤c1
;

96 
c2
 = (
t
->
def
->
İ
 =ğ
ADD
 ? 1 : -1è*->def->
¤c2
->
v®
.
i
[0];

99 ià(
¤c2
->
kšd
 =ğ
SK_CÚ¡ªt
)

101 
p2
 = 
NULL
;

102 
c2
 = 
¤c2
->
v®
.
i
[0];

105 ià(
p1
 =ğ
p2
)

108  
	`IÁCÚ¡ªt
(
c1
 - 
c2
);

110 ià(
p1
 =ğ
NULL
)

113 
¤c1
 = 
	`IÁCÚ¡ªt
(
c1
 - 
c2
);

114 
¤c2
 = 
p2
;

116 ià(
p2
 =ğ
NULL
)

119 
¤c1
 = 
p1
;

120 
İcode
 = 
ADD
;

121 
¤c2
 = 
	`IÁCÚ¡ªt
(
c1
 - 
c2
);

125 
MUL
:

126 
DIV
:

128 ià(
¤c2
->
v®
.
i
[0] == 1)

129  
¤c1
;

132 
c1
 = 
	`Pow”2
(
¤c2
->
v®
.
i
[0]);

133 ià(
c1
 != 0)

135 
¤c2
 = 
	`IÁCÚ¡ªt
(
c1
);

136 
İcode
 = opcod=ğ
MUL
 ? 
LSH
 : 
RSH
;

140 
MOD
:

142 ià(
¤c2
->
v®
.
i
[0] == 1)

143  
	`IÁCÚ¡ªt
(0);

146 
c1
 = 
	`Pow”2
(
¤c2
->
v®
.
i
[0]);

147 ià(
c1
 != 0)

149 
¤c2
 = 
	`IÁCÚ¡ªt
(¤c2->
v®
.
i
[0] - 1);

150 
İcode
 = 
BAND
;

154 
LSH
:

155 
RSH
:

157 ià(
¤c2
->
v®
.
i
[0] == 0)

158  
¤c1
;

161 
BOR
:

163 ià(
¤c2
->
v®
.
i
[0] == 0)

164  
¤c1
;

165 ià(
¤c2
->
v®
.
i
[0] == -1)

166  
¤c2
;

169 
BXOR
:

171 ià(
¤c2
->
v®
.
i
[0] == 0)

172  
¤c1
;

175 
BAND
:

177 ià(
¤c2
->
v®
.
i
[0] == 0)

178  
	`IÁCÚ¡ªt
(0);

179 ià(
¤c2
->
v®
.
i
[0] == -1)

180  
¤c1
;

187 
add_v®ue
:

188  
	`TryAddV®ue
(
ty
, 
İcode
, 
¤c1
, 
¤c2
);

189 
	}
}

191 
	$P“pHŞe
(
BBlock
 
bb
)

193 
IRIn¡
 
š¡
 = 
bb
->
š¡h
.
Ãxt
;

194 
IRIn¡
 
nš¡
;

196 
š¡
 !ğ&
bb
->
š¡h
)

198 
nš¡
 = 
š¡
->
Ãxt
;

199 ià((
š¡
->
İcode
 =ğ
CALL
 || (š¡->İcod>ğ
EXTI1
 && in¡->İcod<ğ
CVTF8U4
)) &&

200 
nš¡
->
İcode
 =ğ
MOV
 && 
š¡
->
İds
[0] ==‚inst->opds[1])

202 
š¡
->
İds
[0]->
»f
 -= 2;

203 
š¡
->
İds
[0] = 
nš¡
->opds[0];

204 
š¡
->
Ãxt
 = 
nš¡
->next;

205 
nš¡
->
Ãxt
->
´ev
 = 
š¡
;

206 
bb
->
nš¡
--;

207 ià(
nš¡
->
İds
[0]->
kšd
 =ğ
SK_Temp
)

208 
	`DefšeTemp
(
nš¡
->
İds
[0], 
š¡
->
İcode
, (
SymbŞ
)š¡, 
NULL
);

210 ià((
š¡
->
İcode
 =ğ
MOV
 || in¡->İcod=ğ
IMOV
è&& in¡->
İds
[1]->
kšd
 =ğ
SK_Temp
)

212 
V®ueDef
 
def
 = 
	`AsV¬
(
š¡
->
İds
[1])->def;

213 
IRIn¡
 
p
;

215 ià(
def
->
İ
 =ğ
MOV
)

217 
def
 !ğ
NULL
)

219 
p
 = (
IRIn¡
)
def
->
¤c1
;

220 
p
->
İds
[0]->
»f
--;

221 
š¡
->
İds
[0]->
»f
++;

222 
p
->
İds
[0] = 
š¡
->opds[0];

223 
p
->
İcode
 = 
š¡
->opcode;

224 
def
 = def->
lšk
;

226 
š¡
->
İds
[0]->
»f
--;

227 
š¡
->
İds
[1]->
»f
--;

228 
š¡
->
´ev
->
Ãxt
 = inst->next;

229 
š¡
->
Ãxt
->
´ev
 = inst->prev;

232 ià((
š¡
->
İcode
 =ğ
ADD
 || in¡->İcod=ğ
SUB
è&& 
nš¡
->İcod=ğ
MOV
 &&

233 
š¡
->
İds
[0] =ğ
nš¡
->opds[1] && inst->opds[1] ==‚inst->opds[0] &&

234 
š¡
->
İds
[2]->
kšd
 =ğ
SK_CÚ¡ªt
)

236 
tcode
 = 
	`Ty³Code
(
š¡
->
ty
);

237 ià((
tcode
 =ğ
F4
 && 
š¡
->
İds
[2]->
v®
.
f
 == 1.0f) ||

238 (
tcode
 =ğ
F8
 && 
š¡
->
İds
[2]->
v®
.
d
 == 1.0) ||

239 (
š¡
->
İds
[2]->
v®
.
i
[0] == 1))

241 
š¡
->
İds
[0]->
»f
 -= 2;

242 
š¡
->
İds
[1]->
»f
--;

243 
š¡
->
İds
[2]->
»f
--;

244 
š¡
->
İcode
 = in¡->İcod=ğ
ADD
 ? 
INC
 : 
DEC
;

245 
š¡
->
İds
[0] = inst->opds[1];

246 
š¡
->
İds
[1] = in¡->İds[2] = 
NULL
;

247 
š¡
->
Ãxt
 = 
nš¡
->next;

248 
nš¡
->
Ãxt
->
´ev
 = 
š¡
;

251 
š¡
 = in¡->
Ãxt
;

253 
	}
}

255 
	$Elimš©eCode
(
BBlock
 
bb
)

257 
IRIn¡
 
š¡
 = 
bb
->
š¡h
.
Ãxt
;

258 
IRIn¡
 
nš¡
;

259 
found
 = 0;

260 
SymbŞ
 *
İds
;

262 
fšd_unu£d_‹mp
:

263 
š¡
 !ğ&
bb
->
š¡h
)

265 
nš¡
 = 
š¡
->
Ãxt
;

266 
İds
 = 
š¡
->opds;

267 ià(
š¡
->
İcode
 =ğ
CALL
)

269 ià(
İds
[0] && opds[0]->
kšd
 =ğ
SK_Temp
 && opds[0]->
»f
 == 1)

271 
İds
[0]->
»f
 = 0;

272 
İds
[0] = 
NULL
;

275 ià(
š¡
->
İcode
 <ğ
BCOM
 || (š¡->İcod>ğ
ADDR
 && in¡->İcod<ğ
MOV
))

277 ià(
İds
[0]->
kšd
 =ğ
SK_Temp
 && opds[0]->
»f
 == 1)

279 
İds
[0]->
»f
 = 0;

280 
İds
[1]->
»f
--;

281 ià(
İds
[2]èİds[2]->
»f
--;

282 
š¡
->
´ev
->
Ãxt
 = inst->next;

283 
š¡
->
Ãxt
->
´ev
 = inst->prev;

284 
found
 = 1;

285 
bb
->
nš¡
--;

288 
š¡
 = in¡->
Ãxt
;

291 ià(
found
)

293 
found
 = 0;

294 
š¡
 = 
bb
->
š¡h
.
Ãxt
;

295 
fšd_unu£d_‹mp
;

299 
	}
}

301 
	$O±imize
(
FunùiÚSymbŞ
 
fsym
)

303 
BBlock
 
bb
;

305 
bb
 = 
fsym
->
’ŒyBB
;

306 
bb
 !ğ
NULL
)

308 
	`P“pHŞe
(
bb
);

309 
bb
 = bb->
Ãxt
;

312 
bb
 = 
fsym
->
’ŒyBB
;

313 
bb
 !ğ
NULL
)

315 
	`Elimš©eCode
(
bb
);

316 
	`ExamšeJump
(
bb
);

317 
bb
 = bb->
Ãxt
;

320 
bb
 = 
fsym
->
’ŒyBB
;

321 
bb
 !ğ
NULL
)

323 
bb
 = 
	`TryM”geBBlock
(bb, bb->
Ãxt
);

325 
	}
}

	@ucl/stmt.c

1 
	~"uş.h
"

2 
	~"g¿mm”.h
"

3 
	~"a¡.h
"

4 
	~"¡mt.h
"

6 
	gFIRST_S‹m’t
[] = { 
FIRST_STATEMENT
, 0};

8 
A¡S‹m’t
 
P¬£S‹m’t
();

14 
A¡S‹m’t
 
	$P¬£Ex´essiÚS‹m’t
()

16 
A¡Ex´essiÚS‹m’t
 
ex´Stmt
;

18 
	`CREATE_AST_NODE
(
ex´Stmt
, 
Ex´essiÚS‹m’t
);

20 ià(
Cu¼’tTok’
 !ğ
TK_SEMICOLON
)

22 
ex´Stmt
->
ex´
 = 
	`P¬£Ex´essiÚ
();

24 
	`Ex³ù
(
TK_SEMICOLON
);

26  (
A¡S‹m’t
)
ex´Stmt
;

27 
	}
}

33 
A¡S‹m’t
 
	$P¬£Lab–S‹m’t
()

35 
A¡Lab–S‹m’t
 
Ïb–Stmt
;

36 
t
;

38 
	`BegšP“kTok’
();

39 
t
 = 
	`G‘NextTok’
();

40 ià(
t
 =ğ
TK_COLON
)

42 
	`EndP“kTok’
();

43 
	`CREATE_AST_NODE
(
Ïb–Stmt
, 
Lab–S‹m’t
);

44 
Ïb–Stmt
->
id
 = 
Tok’V®ue
.
p
;

46 
NEXT_TOKEN
;

47 
NEXT_TOKEN
;

48 
Ïb–Stmt
->
¡mt
 = 
	`P¬£S‹m’t
();

50  (
A¡S‹m’t
)
Ïb–Stmt
;

54 
	`EndP“kTok’
();

55  
	`P¬£Ex´essiÚS‹m’t
();

57 
	}
}

63 
A¡S‹m’t
 
	$P¬£Ca£S‹m’t
()

65 
A¡Ca£S‹m’t
 
ÿ£Stmt
;

67 
	`CREATE_AST_NODE
(
ÿ£Stmt
, 
Ca£S‹m’t
);

69 
NEXT_TOKEN
;

70 
ÿ£Stmt
->
ex´
 = 
	`P¬£CÚ¡ªtEx´essiÚ
();

71 
	`Ex³ù
(
TK_COLON
);

72 
ÿ£Stmt
->
¡mt
 = 
	`P¬£S‹m’t
();

74  (
A¡S‹m’t
)
ÿ£Stmt
;

75 
	}
}

81 
A¡S‹m’t
 
	$P¬£DeçuÉS‹m’t
()

83 
A¡DeçuÉS‹m’t
 
defStmt
;

85 
	`CREATE_AST_NODE
(
defStmt
, 
DeçuÉS‹m’t
);

87 
NEXT_TOKEN
;

88 
	`Ex³ù
(
TK_COLON
);

89 
defStmt
->
¡mt
 = 
	`P¬£S‹m’t
();

91  (
A¡S‹m’t
)
defStmt
;

92 
	}
}

99 
A¡S‹m’t
 
	$P¬£IfS‹m’t
()

101 
A¡IfS‹m’t
 
ifStmt
;

103 
	`CREATE_AST_NODE
(
ifStmt
, 
IfS‹m’t
);

105 
NEXT_TOKEN
;

106 
	`Ex³ù
(
TK_LPAREN
);

107 
ifStmt
->
ex´
 = 
	`P¬£Ex´essiÚ
();

108 
	`Ex³ù
(
TK_RPAREN
);

109 
ifStmt
->
th’Stmt
 = 
	`P¬£S‹m’t
();

110 ià(
Cu¼’tTok’
 =ğ
TK_ELSE
)

112 
NEXT_TOKEN
;

113 
ifStmt
->
–£Stmt
 = 
	`P¬£S‹m’t
();

116  (
A¡S‹m’t
)
ifStmt
;

117 
	}
}

123 
A¡S‹m’t
 
	$P¬£Sw™chS‹m’t
()

125 
A¡Sw™chS‹m’t
 
swtchStmt
;

127 
	`CREATE_AST_NODE
(
swtchStmt
, 
Sw™chS‹m’t
);

129 
NEXT_TOKEN
;

130 
	`Ex³ù
(
TK_LPAREN
);

131 
swtchStmt
->
ex´
 = 
	`P¬£Ex´essiÚ
();

132 
	`Ex³ù
(
TK_RPAREN
);

133 
swtchStmt
->
¡mt
 = 
	`P¬£S‹m’t
();

135  (
A¡S‹m’t
)
swtchStmt
;

136 
	}
}

142 
A¡S‹m’t
 
	$P¬£WheS‹m’t
()

144 
A¡LoİS‹m’t
 
wheStmt
;

146 
	`CREATE_AST_NODE
(
wheStmt
, 
WheS‹m’t
);

148 
NEXT_TOKEN
;

149 
	`Ex³ù
(
TK_LPAREN
);

150 
wheStmt
->
ex´
 = 
	`P¬£Ex´essiÚ
();

151 
	`Ex³ù
(
TK_RPAREN
);

152 
wheStmt
->
¡mt
 = 
	`P¬£S‹m’t
();

154  (
A¡S‹m’t
)
wheStmt
;

155 
	}
}

161 
A¡S‹m’t
 
	$P¬£DoS‹m’t
()

163 
A¡LoİS‹m’t
 
doStmt
;

165 
	`CREATE_AST_NODE
(
doStmt
, 
DoS‹m’t
);

167 
NEXT_TOKEN
;

168 
doStmt
->
¡mt
 = 
	`P¬£S‹m’t
();

169 
	`Ex³ù
(
TK_WHILE
);

170 
	`Ex³ù
(
TK_LPAREN
);

171 
doStmt
->
ex´
ğ
	`P¬£Ex´essiÚ
();

172 
	`Ex³ù
(
TK_RPAREN
);

173 
	`Ex³ù
(
TK_SEMICOLON
);

175  (
A¡S‹m’t
)
doStmt
;

176 
	}
}

182 
A¡S‹m’t
 
	$P¬£FÜS‹m’t
()

184 
A¡FÜS‹m’t
 
fÜStmt
;

186 
	`CREATE_AST_NODE
(
fÜStmt
, 
FÜS‹m’t
);

188 
NEXT_TOKEN
;

189 
	`Ex³ù
(
TK_LPAREN
);

190 ià(
Cu¼’tTok’
 !ğ
TK_SEMICOLON
)

192 
fÜStmt
->
š™Ex´
 = 
	`P¬£Ex´essiÚ
();

194 
	`Ex³ù
(
TK_SEMICOLON
);

195 ià(
Cu¼’tTok’
 !ğ
TK_SEMICOLON
)

197 
fÜStmt
->
ex´
 = 
	`P¬£Ex´essiÚ
();

199 
	`Ex³ù
(
TK_SEMICOLON
);

200 ià(
Cu¼’tTok’
 !ğ
TK_RPAREN
)

202 
fÜStmt
->
šüEx´
 = 
	`P¬£Ex´essiÚ
();

204 
	`Ex³ù
(
TK_RPAREN
);

205 
fÜStmt
->
¡mt
 = 
	`P¬£S‹m’t
();

207  (
A¡S‹m’t
)
fÜStmt
;

208 
	}
}

214 
A¡S‹m’t
 
	$P¬£GÙoS‹m’t
()

216 
A¡GÙoS‹m’t
 
gÙoStmt
;

218 
	`CREATE_AST_NODE
(
gÙoStmt
, 
GÙoS‹m’t
);

220 
NEXT_TOKEN
;

221 ià(
Cu¼’tTok’
 =ğ
TK_ID
)

223 
gÙoStmt
->
id
 = 
Tok’V®ue
.
p
;

224 
NEXT_TOKEN
;

225 
	`Ex³ù
(
TK_SEMICOLON
);

229 
	`E¼Ü
(&
Tok’CoÜd
, "Expect identifier");

230 ià(
Cu¼’tTok’
 =ğ
TK_SEMICOLON
)

231 
NEXT_TOKEN
;

234  (
A¡S‹m’t
)
gÙoStmt
;

235 
	}
}

241 
A¡S‹m’t
 
	$P¬£B»akS‹m’t
()

243 
A¡B»akS‹m’t
 
brkStmt
;

245 
	`CREATE_AST_NODE
(
brkStmt
, 
B»akS‹m’t
);

247 
NEXT_TOKEN
;

248 
	`Ex³ù
(
TK_SEMICOLON
);

250  (
A¡S‹m’t
)
brkStmt
;

251 
	}
}

257 
A¡S‹m’t
 
	$P¬£CÚtšueS‹m’t
()

259 
A¡CÚtšueS‹m’t
 
cÚtStmt
;

261 
	`CREATE_AST_NODE
(
cÚtStmt
, 
CÚtšueS‹m’t
);

263 
NEXT_TOKEN
;

264 
	`Ex³ù
(
TK_SEMICOLON
);

266  (
A¡S‹m’t
)
cÚtStmt
;

267 
	}
}

273 
A¡S‹m’t
 
	$P¬£R‘uºS‹m’t
()

275 
A¡R‘uºS‹m’t
 
»tStmt
;

277 
	`CREATE_AST_NODE
(
»tStmt
, 
R‘uºS‹m’t
);

279 
NEXT_TOKEN
;

280 ià(
Cu¼’tTok’
 !ğ
TK_SEMICOLON
)

282 
»tStmt
->
ex´
 = 
	`P¬£Ex´essiÚ
();

284 
	`Ex³ù
(
TK_SEMICOLON
);

286  (
A¡S‹m’t
)
»tStmt
;

287 
	}
}

299 
A¡S‹m’t
 
	$P¬£CompoundS‹m’t
()

301 
A¡CompoundS‹m’t
 
compStmt
;

302 
A¡Node
 *

;

304 
Lev–
++;

305 
	`CREATE_AST_NODE
(
compStmt
, 
CompoundS‹m’t
);

307 
NEXT_TOKEN
;

308 

 = &
compStmt
->
deşs
;

309 
	`Cu¼’tTok’In
(
FIRST_Deş¬©iÚ
))

311 ià(
Cu¼’tTok’
 =ğ
TK_ID
 && ! 
	`IsTy³Name
(CurrentToken))

313 *

 = (
A¡Node
)
	`P¬£Deş¬©iÚ
();

314 

 = &(*)->
Ãxt
;

316 

 = &
compStmt
->
¡mts
;

317 
Cu¼’tTok’
 !ğ
TK_RBRACE
 && Cu¼’tTok’ !ğ
TK_END
)

319 *

 = (
A¡Node
)
	`P¬£S‹m’t
();

320 

 = &(*)->
Ãxt
;

321 ià(
Cu¼’tTok’
 =ğ
TK_RBRACE
)

323 
	`SkTo
(
FIRST_S‹m’t
, "the beginning of‡ statement");

325 
	`Ex³ù
(
TK_RBRACE
);

327 
	`Po¡CheckTy³def
();

328 
Lev–
--;

330  (
A¡S‹m’t
)
compStmt
;

331 
	}
}

350 
A¡S‹m’t
 
	$P¬£S‹m’t
()

352 
Cu¼’tTok’
)

354 
TK_ID
:

355  
	`P¬£Lab–S‹m’t
();

357 
TK_CASE
:

358  
	`P¬£Ca£S‹m’t
();

360 
TK_DEFAULT
:

361  
	`P¬£DeçuÉS‹m’t
();

363 
TK_IF
:

364  
	`P¬£IfS‹m’t
();

366 
TK_SWITCH
:

367  
	`P¬£Sw™chS‹m’t
();

369 
TK_WHILE
:

370  
	`P¬£WheS‹m’t
();

372 
TK_DO
:

373  
	`P¬£DoS‹m’t
();

375 
TK_FOR
:

376  
	`P¬£FÜS‹m’t
();

378 
TK_GOTO
:

379  
	`P¬£GÙoS‹m’t
();

381 
TK_CONTINUE
:

382  
	`P¬£CÚtšueS‹m’t
();

384 
TK_BREAK
:

385  
	`P¬£B»akS‹m’t
();

387 
TK_RETURN
:

388  
	`P¬£R‘uºS‹m’t
();

390 
TK_LBRACE
:

391  
	`P¬£CompoundS‹m’t
();

394  
	`P¬£Ex´essiÚS‹m’t
();

396 
	}
}

	@ucl/stmt.h

1 #iâdeà
__STMT_H_


2 
	#__STMT_H_


	)

4 
	#AST_STATEMENT_COMMON
 
AST_NODE_COMMON


	)

6 
	#AST_LOOP_STATEMENT_COMMON
 \

	)

7 
	gAST_STATEMENT_COMMON
 \

8 
A¡Ex´essiÚ
 
	gex´
; \

9 
A¡S‹m’t
 
	g¡mt
; \

10 
BBlock
 
	gloİBB
; \

11 
BBlock
 
	gcÚtBB
; \

12 
BBlock
 
	gÃxtBB
;

14 
	sa¡S‹m’t


16 
	mAST_STATEMENT_COMMON


19 
	sa¡LoİS‹m’t


21 
	mAST_LOOP_STATEMENT_COMMON


22 } *
	tA¡LoİS‹m’t
;

24 
	sa¡Ex´essiÚS‹m’t


26 
AST_STATEMENT_COMMON


27 
A¡Ex´essiÚ
 
	mex´
;

28 } *
	tA¡Ex´essiÚS‹m’t
;

30 
	sa¡Lab–S‹m’t


32 
AST_STATEMENT_COMMON


33 *
	mid
;

34 
A¡S‹m’t
 
	m¡mt
;

35 
Lab–
 
	mÏb–
;

36 } *
	tA¡Lab–S‹m’t
;

38 
	sa¡Ca£S‹m’t


40 
AST_STATEMENT_COMMON


41 
A¡Ex´essiÚ
 
	mex´
;

42 
A¡S‹m’t
 
	m¡mt
;

43 
a¡Ca£S‹m’t
 *
	mÃxtCa£
;

44 
BBlock
 
	m»¥BB
;

45 } *
	tA¡Ca£S‹m’t
;

47 
	sa¡DeçuÉS‹m’t


49 
AST_STATEMENT_COMMON


50 
A¡S‹m’t
 
	m¡mt
;

51 
BBlock
 
	m»¥BB
;

52 } *
	tA¡DeçuÉS‹m’t
;

54 
	sa¡IfS‹m’t


56 
AST_STATEMENT_COMMON


57 
A¡Ex´essiÚ
 
	mex´
;

58 
A¡S‹m’t
 
	mth’Stmt
;

59 
A¡S‹m’t
 
	m–£Stmt
;

60 } *
	tA¡IfS‹m’t
;

62 
	ssw™chBuck‘


64 
	mnÿ£
;

65 
	mmšV®
;

66 
	mmaxV®
;

67 
A¡Ca£S‹m’t
 
	mÿ£s
;

68 
A¡Ca£S‹m’t
 *
	m
;

69 
sw™chBuck‘
 *
	m´ev
;

70 } *
	tSw™chBuck‘
;

72 
	sa¡Sw™chS‹m’t


74 
AST_STATEMENT_COMMON


75 
A¡Ex´essiÚ
 
	mex´
;

76 
A¡S‹m’t
 
	m¡mt
;

77 
A¡Ca£S‹m’t
 
	mÿ£s
;

78 
A¡DeçuÉS‹m’t
 
	mdefStmt
;

79 
Sw™chBuck‘
 
	mbuck‘s
;

80 
	mnbuck‘
;

81 
BBlock
 
	mÃxtBB
;

82 
BBlock
 
	mdefBB
;

83 } *
	tA¡Sw™chS‹m’t
;

85 
	sa¡FÜS‹m’t


87 
AST_LOOP_STATEMENT_COMMON


88 
A¡Ex´essiÚ
 
	mš™Ex´
;

89 
A¡Ex´essiÚ
 
	mšüEx´
;

90 
BBlock
 
	m‹¡BB
;

91 } *
	tA¡FÜS‹m’t
;

93 
	sa¡GÙoS‹m’t


95 
AST_STATEMENT_COMMON


96 *
	mid
;

97 
Lab–
 
	mÏb–
;

98 } *
	tA¡GÙoS‹m’t
;

100 
	sa¡B»akS‹m’t


102 
AST_STATEMENT_COMMON


103 
A¡S‹m’t
 
	mrg‘
;

104 } *
	tA¡B»akS‹m’t
;

106 
	sa¡CÚtšueS‹m’t


108 
AST_STATEMENT_COMMON


109 
A¡LoİS‹m’t
 
	mrg‘
;

110 } *
	tA¡CÚtšueS‹m’t
;

112 
	sa¡R‘uºS‹m’t


114 
AST_STATEMENT_COMMON


115 
A¡Ex´essiÚ
 
	mex´
;

116 } *
	tA¡R‘uºS‹m’t
;

118 
	sa¡CompoundS‹m’t


120 
AST_STATEMENT_COMMON


121 
A¡Node
 
	mdeşs
;

122 
A¡Node
 
	m¡mts
;

123 
VeùÜ
 
	moÿls
;

124 } *
	tA¡CompoundS‹m’t
;

126 
	#AsEx´
(
¡mt
è((
A¡Ex´essiÚS‹m’t
)¡mt)

	)

127 
	#AsLab–
(
¡mt
è((
A¡Lab–S‹m’t
)¡mt)

	)

128 
	#AsCa£
(
¡mt
è((
A¡Ca£S‹m’t
)¡mt)

	)

129 
	#AsDef
(
¡mt
è((
A¡DeçuÉS‹m’t
)¡mt)

	)

130 
	#AsIf
(
¡mt
è((
A¡IfS‹m’t
)¡mt)

	)

131 
	#AsSw™ch
(
¡mt
è((
A¡Sw™chS‹m’t
)¡mt)

	)

132 
	#AsLoİ
(
¡mt
è((
A¡LoİS‹m’t
)¡mt)

	)

133 
	#AsFÜ
(
¡mt
è((
A¡FÜS‹m’t
)¡mt)

	)

134 
	#AsGÙo
(
¡mt
è((
A¡GÙoS‹m’t
)¡mt)

	)

135 
	#AsCÚt
(
¡mt
è((
A¡CÚtšueS‹m’t
)¡mt)

	)

136 
	#AsB»ak
(
¡mt
è((
A¡B»akS‹m’t
)¡mt)

	)

137 
	#AsR‘
(
¡mt
è((
A¡R‘uºS‹m’t
)¡mt)

	)

138 
	#AsComp
(
¡mt
è((
A¡CompoundS‹m’t
)¡mt)

	)

140 
A¡S‹m’t
 
CheckCompoundS‹m’t
(A¡S‹m’ˆ
¡mt
);

	@ucl/stmtchk.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"deş.h
"

4 
	~"ex´.h
"

5 
	~"¡mt.h
"

7 
	#PushS‹m’t
(
v
, 
¡mt
è
	`INSERT_ITEM
(v, stmt)

	)

8 
	#PİS‹m’t
(
v
è(v->
d©a
[--v->
Ën
])

	)

9 
	#TİS‹m’t
(
v
è
	`TOP_ITEM
(v)

	)

11 
A¡S‹m’t
 
CheckS‹m’t
(A¡S‹m’ˆ
¡mt
);

13 
Lab–
 
	$TryAddLab–
(*
id
)

15 
Lab–
 
p
 = 
CURRENTF
->
Ïb–s
;

17 
p
)

19 ià(
p
->
id
 == id)

20  
p
;

21 
p
 =…->
Ãxt
;

24 
	`CALLOC
(
p
);

26 
p
->
id
 = id;

27 
p
->
Ãxt
 = 
CURRENTF
->
Ïb–s
;

28 
CURRENTF
->
Ïb–s
 = 
p
;

30  
p
;

31 
	}
}

33 
	$AddCa£
(
A¡Sw™chS‹m’t
 
swtchStmt
, 
A¡Ca£S‹m’t
 
ÿ£Stmt
)

35 
A¡Ca£S‹m’t
 
p
 = 
swtchStmt
->
ÿ£s
;

36 
A¡Ca£S‹m’t
 *
µ»v
 = &
swtchStmt
->
ÿ£s
;

37 
diff
;

39 
p
)

41 
diff
 = 
ÿ£Stmt
->
ex´
->
v®
.
i
[0] - 
p
->expr->val.i[0];

42 ià(
diff
 < 0)

45 ià(
diff
 > 0)

47 
µ»v
 = &
p
->
ÃxtCa£
;

48 
p
 =…->
ÃxtCa£
;

52 
	`E¼Ü
(&
ÿ£Stmt
->
coÜd
, "Repeated constant in‡ switch statement");

57 *
µ»v
 = 
ÿ£Stmt
;

58 
ÿ£Stmt
->
ÃxtCa£
 = 
p
;

59 
	}
}

61 
A¡S‹m’t
 
	$CheckEx´essiÚS‹m’t
(
A¡S‹m’t
 
¡mt
)

63 
A¡Ex´essiÚS‹m’t
 
ex´Stmt
 = 
	`AsEx´
(
¡mt
);

65 ià(
ex´Stmt
->
ex´
 !ğ
NULL
)

67 
ex´Stmt
->
ex´
 = 
	`CheckEx´essiÚ
(exprStmt->expr);

70  
¡mt
;

71 
	}
}

73 
A¡S‹m’t
 
	$CheckLab–S‹m’t
(
A¡S‹m’t
 
¡mt
)

75 
A¡Lab–S‹m’t
 
Ïb–Stmt
 = 
	`AsLab–
(
¡mt
);

77 
Ïb–Stmt
->
Ïb–
 = 
	`TryAddLab–
Öab–Stmt->
id
);

78 ià(
Ïb–Stmt
->
Ïb–
->
defšed
)

80 
	`E¼Ü
(&
¡mt
->
coÜd
, "Label‚ame should be unique within function.");

82 
Ïb–Stmt
->
Ïb–
->
defšed
 = 1;

83 
Ïb–Stmt
->
Ïb–
->
coÜd
 = 
¡mt
->coord;

84 
Ïb–Stmt
->
¡mt
 = 
	`CheckS‹m’t
(labelStmt->stmt);

86  
¡mt
;

87 
	}
}

89 
A¡S‹m’t
 
	$CheckCa£S‹m’t
(
A¡S‹m’t
 
¡mt
)

91 
A¡Ca£S‹m’t
 
ÿ£Stmt
 = 
	`AsCa£
(
¡mt
);

92 
A¡Sw™chS‹m’t
 
swtchStmt
;

94 
swtchStmt
 = (
A¡Sw™chS‹m’t
)
	`TİS‹m’t
(
CURRENTF
->
swtches
);

95 ià(
swtchStmt
 =ğ
NULL
)

97 
	`E¼Ü
(&
¡mt
->
coÜd
, "A case†abel shall‡ppear in‡ switch statement.");

98  
¡mt
;

101 
ÿ£Stmt
->
ex´
 = 
	`CheckCÚ¡ªtEx´essiÚ
(caseStmt->expr);

102 ià(
ÿ£Stmt
->
ex´
 =ğ
NULL
)

104 
	`E¼Ü
(&
¡mt
->
coÜd
, "The case value must be integer constant.");

105  
¡mt
;

108 
ÿ£Stmt
->
¡mt
 = 
	`CheckS‹m’t
(caseStmt->stmt);

109 
ÿ£Stmt
->
ex´
 = 
	`FŞdCa¡
(
swtchStmt
->ex´->
ty
, caseStmt->expr);

110 
	`AddCa£
(
swtchStmt
, 
ÿ£Stmt
);

112  
¡mt
;

113 
	}
}

115 
A¡S‹m’t
 
	$CheckDeçuÉS‹m’t
(
A¡S‹m’t
 
¡mt
)

117 
A¡DeçuÉS‹m’t
 
defStmt
 = 
	`AsDef
(
¡mt
);

118 
A¡Sw™chS‹m’t
 
swtchStmt
;

120 
swtchStmt
 = (
A¡Sw™chS‹m’t
)
	`TİS‹m’t
(
CURRENTF
->
swtches
);

121 ià(
swtchStmt
 =ğ
NULL
)

123 
	`E¼Ü
(&
¡mt
->
coÜd
, "A default†abel shall‡ppear in‡ switch statement.");

124  
¡mt
;

126 ià(
swtchStmt
->
defStmt
 !ğ
NULL
)

128 
	`E¼Ü
(&
¡mt
->
coÜd
, "There shall be only one default†abel in‡ switch statement.");

129  
¡mt
;

132 
defStmt
->
¡mt
 = 
	`CheckS‹m’t
(defStmt->stmt);

133 
swtchStmt
->
defStmt
 = defStmt;

135  
¡mt
;

136 
	}
}

138 
A¡S‹m’t
 
	$CheckIfS‹m’t
(
A¡S‹m’t
 
¡mt
)

140 
A¡IfS‹m’t
 
ifStmt
 = 
	`AsIf
(
¡mt
);

142 
ifStmt
->
ex´
 = 
	`Adju¡
(
	`CheckEx´essiÚ
(ifStmt->expr), 1);

143 ià(! 
	`IsSÿÏrTy³
(
ifStmt
->
ex´
->
ty
))

145 
	`E¼Ü
(&
¡mt
->
coÜd
, "Theƒxpression in if statement shall be scalarype.");

148 
ifStmt
->
th’Stmt
 = 
	`CheckS‹m’t
(ifStmt->thenStmt);

149 ià(
ifStmt
->
–£Stmt
)

151 
ifStmt
->
–£Stmt
 = 
	`CheckS‹m’t
(ifStmt->elseStmt);

154  
¡mt
;

155 
	}
}

157 
A¡S‹m’t
 
	$CheckSw™chS‹m’t
(
A¡S‹m’t
 
¡mt
)

159 
A¡Sw™chS‹m’t
 
swtchStmt
 = 
	`AsSw™ch
(
¡mt
);

161 
	`PushS‹m’t
(
CURRENTF
->
swtches
, 
¡mt
);

162 
	`PushS‹m’t
(
CURRENTF
->
b»akabË
, 
¡mt
);

164 
swtchStmt
->
ex´
 = 
	`Adju¡
(
	`CheckEx´essiÚ
(swtchStmt->expr), 1);

165 ià(! 
	`IsIÁegTy³
(
swtchStmt
->
ex´
->
ty
))

167 
	`E¼Ü
(&
¡mt
->
coÜd
, "Theƒxpression in‡ switch statement shall be integerype.");

168 
swtchStmt
->
ex´
->
ty
 = 
	`T
(
INT
);

170 ià(
swtchStmt
->
ex´
->
ty
->
ÿ‹g
 < 
INT
)

172 
swtchStmt
->
ex´
 = 
	`Ca¡
(
	`T
(
INT
), swtchStmt->expr);

174 
swtchStmt
->
¡mt
 = 
	`CheckS‹m’t
(swtchStmt->stmt);

176 
	`PİS‹m’t
(
CURRENTF
->
swtches
);

177 
	`PİS‹m’t
(
CURRENTF
->
b»akabË
);

179  
¡mt
;

180 
	}
}

182 
A¡S‹m’t
 
	$CheckLoİS‹m’t
(
A¡S‹m’t
 
¡mt
)

184 
A¡LoİS‹m’t
 
loİStmt
 = 
	`AsLoİ
(
¡mt
);

186 
	`PushS‹m’t
(
CURRENTF
->
loİs
, 
¡mt
);

187 
	`PushS‹m’t
(
CURRENTF
->
b»akabË
, 
¡mt
);

189 
loİStmt
->
ex´
 = 
	`Adju¡
(
	`CheckEx´essiÚ
(loopStmt->expr), 1);

190 ià(! 
	`IsSÿÏrTy³
(
loİStmt
->
ex´
->
ty
))

192 
	`E¼Ü
(&
¡mt
->
coÜd
, "Theƒxpression in do or while statement shall be scalarype.");

194 
loİStmt
->
¡mt
 = 
	`CheckS‹m’t
(loopStmt->stmt);

196 
	`PİS‹m’t
(
CURRENTF
->
loİs
);

197 
	`PİS‹m’t
(
CURRENTF
->
b»akabË
);

199  
¡mt
;

200 
	}
}

202 
A¡S‹m’t
 
	$CheckFÜS‹m’t
(
A¡S‹m’t
 
¡mt
)

204 
A¡FÜS‹m’t
 
fÜStmt
 = 
	`AsFÜ
(
¡mt
);

206 
	`PushS‹m’t
(
CURRENTF
->
loİs
, 
¡mt
);

207 
	`PushS‹m’t
(
CURRENTF
->
b»akabË
, 
¡mt
);

209 ià(
fÜStmt
->
š™Ex´
)

211 
fÜStmt
->
š™Ex´
 = 
	`CheckEx´essiÚ
(forStmt->initExpr);

213 ià(
fÜStmt
->
ex´
)

215 
fÜStmt
->
ex´
 = 
	`Adju¡
(
	`CheckEx´essiÚ
(forStmt->expr), 1);

216 ià(! 
	`IsSÿÏrTy³
(
fÜStmt
->
ex´
->
ty
))

218 
	`E¼Ü
(&
¡mt
->
coÜd
, "The secondƒxpression in for statement shall be scalarype.");

221 ià(
fÜStmt
->
šüEx´
)

223 
fÜStmt
->
šüEx´
 = 
	`CheckEx´essiÚ
(forStmt->incrExpr);

225 
fÜStmt
->
¡mt
 = 
	`CheckS‹m’t
(forStmt->stmt);

227 
	`PİS‹m’t
(
CURRENTF
->
loİs
);

228 
	`PİS‹m’t
(
CURRENTF
->
b»akabË
);

230  
¡mt
;

231 
	}
}

233 
A¡S‹m’t
 
	$CheckGÙoS‹m’t
(
A¡S‹m’t
 
¡mt
)

235 
A¡GÙoS‹m’t
 
gÙoStmt
 = 
	`AsGÙo
(
¡mt
);

237 ià(
gÙoStmt
->
id
 !ğ
NULL
)

239 
gÙoStmt
->
Ïb–
 = 
	`TryAddLab–
(gÙoStmt->
id
);

240 
gÙoStmt
->
Ïb–
->
coÜd
 = gotoStmt->coord;

241 
gÙoStmt
->
Ïb–
->
»f
++;

244  
¡mt
;

245 
	}
}

247 
A¡S‹m’t
 
	$CheckB»akS‹m’t
(
A¡S‹m’t
 
¡mt
)

249 
A¡B»akS‹m’t
 
brkStmt
 = 
	`AsB»ak
(
¡mt
);

251 
brkStmt
->
rg‘
 = 
	`TİS‹m’t
(
CURRENTF
->
b»akabË
);

252 ià(
brkStmt
->
rg‘
 =ğ
NULL
)

254 
	`E¼Ü
(&
¡mt
->
coÜd
, "The break shall‡ppear in‡ switch or†oop");

257  
¡mt
;

258 
	}
}

260 
A¡S‹m’t
 
	$CheckCÚtšueS‹m’t
(
A¡S‹m’t
 
¡mt
)

262 
A¡CÚtšueS‹m’t
 
cÚtStmt
 = 
	`AsCÚt
(
¡mt
);

264 
cÚtStmt
->
rg‘
 = (
A¡LoİS‹m’t
)
	`TİS‹m’t
(
CURRENTF
->
loİs
);

265 ià(
cÚtStmt
->
rg‘
 =ğ
NULL
)

267 
	`E¼Ü
(&
¡mt
->
coÜd
, "The continue shall‡ppear in‡†oop.");

270  
¡mt
;

271 
	}
}

273 
A¡S‹m’t
 
	$CheckR‘uºS‹m’t
(
A¡S‹m’t
 
¡mt
)

275 
A¡R‘uºS‹m’t
 
»tStmt
 = 
	`AsR‘
(
¡mt
);

276 
Ty³
 
¹y
 = 
FSYM
->
ty
->
bty
;

278 
CURRENTF
->
hasR‘uº
 = 1;

279 ià(
»tStmt
->
ex´
)

281 
»tStmt
->
ex´
 = 
	`Adju¡
(
	`CheckEx´essiÚ
(retStmt->expr), 1);

283 ià(
¹y
->
ÿ‹g
 =ğ
VOID
)

285 
	`E¼Ü
(&
¡mt
->
coÜd
, "Void function should‚ot„eturn value");

286  
¡mt
;

289 ià(! 
	`CªAssign
(
¹y
, 
»tStmt
->
ex´
))

291 
	`E¼Ü
(&
¡mt
->
coÜd
, "Incompatible„eturn value");

292  
¡mt
;

295 
»tStmt
->
ex´
 = 
	`Ca¡
(
¹y
,„etStmt->expr);

297  
¡mt
;

300 ià(
¹y
->
ÿ‹g
 !ğ
VOID
)

302 
	`W¬nšg
(&
¡mt
->
coÜd
, "The function should„eturn‡ value.");

304  
¡mt
;

305 
	}
}

307 
A¡S‹m’t
 
	$CheckLoÿlCompound
(
A¡S‹m’t
 
¡mt
)

309 
A¡S‹m’t
 
s
;

311 
	`EÁ”Scİe
();

313 
s
 = 
	`CheckCompoundS‹m’t
(
¡mt
);

315 
	`Ex™Scİe
();

317  
¡mt
;

318 
	}
}

320 
	$A¡S‹m’t
 (* 
StmtCheck”s
[])(
A¡S‹m’t
) =

322 
CheckEx´essiÚS‹m’t
,

323 
CheckLab–S‹m’t
,

324 
CheckCa£S‹m’t
,

325 
CheckDeçuÉS‹m’t
,

326 
CheckIfS‹m’t
,

327 
CheckSw™chS‹m’t
,

328 
CheckLoİS‹m’t
,

329 
CheckLoİS‹m’t
,

330 
CheckFÜS‹m’t
,

331 
CheckGÙoS‹m’t
,

332 
CheckB»akS‹m’t
,

333 
CheckCÚtšueS‹m’t
,

334 
CheckR‘uºS‹m’t
,

335 
CheckLoÿlCompound


336 
	}
};

338 
A¡S‹m’t
 
	$CheckS‹m’t
(
A¡S‹m’t
 
¡mt
)

340  (* 
StmtCheck”s
[
¡mt
->
kšd
 - 
NK_Ex´essiÚS‹m’t
])(stmt);

341 
	}
}

343 
A¡S‹m’t
 
	$CheckCompoundS‹m’t
(
A¡S‹m’t
 
¡mt
)

345 
A¡CompoundS‹m’t
 
compStmt
 = 
	`AsComp
(
¡mt
);

346 
A¡Node
 
p
;

348 
compStmt
->
oÿls
 = 
	`C»©eVeùÜ
(1);

349 
p
 = 
compStmt
->
deşs
;

350 
p
)

352 
	`CheckLoÿlDeş¬©iÚ
((
A¡Deş¬©iÚ
)
p
, 
compStmt
->
oÿls
);

353 
p
 =…->
Ãxt
;

355 
p
 = 
compStmt
->
¡mts
;

356 
p
)

358 
	`CheckS‹m’t
((
A¡S‹m’t
)
p
);

359 
p
 =…->
Ãxt
;

362  
¡mt
;

363 
	}
}

	@ucl/str.c

1 
	~"uş.h
"

2 
	~"Ëx.h
"

4 
NameBuck‘
 
	gNameBuck‘s
[
NAME_HASH_MASK
 + 1];

6 
	$ELFHash
(*
¡r
, 
Ën
)

8 
h
 = 0;

9 
x
 = 0;

10 
i
;

12 
i
 = 0; i < 
Ën
; ++i)

14 
h
 = (h << 4è+ *
¡r
++;

15 ià((
x
 = 
h
 & 0xF0000000) != 0)

17 
h
 ^ğ
x
 >> 24;

18 
h
 &ğ~
x
;

22  
h
;

23 
	}
}

30 * 
	$IÁ”nName
(*
id
, 
Ën
)

32 
i
;

33 
h
;

34 
NameBuck‘
 
p
;

36 
h
 = 
	`ELFHash
(
id
, 
Ën
è& 
NAME_HASH_MASK
;

37 
p
 = 
NameBuck‘s
[
h
];… !ğ
NULL
;… =…->
lšk
)

39 ià(
Ën
 =ğ
p
->ËÀ&& 
	`¡ºcmp
(
id
,…->
Çme
,†en) == 0)

40  
p
->
Çme
;

43 
p
 = 
	`H—pAÎoÿ‹
(&
SŒšgH—p
, (*p));

44 
p
->
Çme
 = 
	`H—pAÎoÿ‹
(&
SŒšgH—p
, 
Ën
 + 1);

45 
i
 = 0; i < 
Ën
; ++i)

47 
p
->
Çme
[
i
] = 
id
[i];

49 
p
->
Çme
[
Ën
] = 0;

50 
p
->
Ën
 =†en;

52 
p
->
lšk
 = 
NameBuck‘s
[
h
];

53 
NameBuck‘s
[
h
] = 
p
;

55  
p
->
Çme
;

56 
	}
}

67 
	$Aµ’dSTR
(
SŒšg
 
¡r
, *
tmp
, 
Ën
, 
wide
)

69 
i
, 
size
;

70 *
p
;

71 
times
 = 1;

73 
size
 = 
¡r
->
Ën
 +†en + 1;

74 ià(
wide
è
times
 = 4;

76 
p
 = 
	`H—pAÎoÿ‹
(&
SŒšgH—p
, 
size
 * 
times
);

77 
i
 = 0; i < 
¡r
->
Ën
 * 
times
; ++i)

79 
p
[
i
] = 
¡r
->
chs
[i];

81 
i
 = 0; i < 
Ën
 * 
times
; ++i)

83 
p
[
i
] = 
tmp
[i];

85 
¡r
->
chs
 = 
p
;

86 
¡r
->
Ën
 = 
size
 - 1;

87 ià(! 
wide
)

89 
¡r
->
chs
[
size
 - 1] = 0;

93 *
wı
 = (*)
p
 + (
size
 - 1);

94 *
wı
 = 0;

96 
	}
}

	@ucl/str.h

1 #iâdeà
__STR_H_


2 
	#__STR_H_


	)

4 
	sÇmeBuck‘


6 *
	mÇme
;

7 
	mËn
;

8 
ÇmeBuck‘
 *
	mlšk
;

9 } *
	tNameBuck‘
;

11 
	s¡ršg


13 *
	mchs
;

14 
	mËn
;

15 } *
	tSŒšg
;

17 
	#NAME_HASH_MASK
 1023

	)

19 * 
IÁ”nName
(*
id
, 
Ën
);

20 
Aµ’dSTR
(
SŒšg
 
¡r
, *
tmp
, 
Ën
, 
wide
);

	@ucl/symbol.c

1 
	~"uş.h
"

2 
	~"ouut.h
"

5 
	gSŒšgNum
;

7 
bË
 
	gGlob®Tags
;

9 
bË
 
	gGlob®IDs
;

11 
bË
 
	gCÚ¡ªts
;

13 
TabË
 
	gTags
;

15 
TabË
 
	gId’tif›rs
;

17 
SymbŞ
 *
	gFunùiÚTa
, *
	gGlob®Ta
, *
	gSŒšgTa
, *
	gFlßtTa
;

20 
SymbŞ
 
	gFunùiÚs
;

22 
SymbŞ
 
	gGlob®s
;

24 
SymbŞ
 
	gSŒšgs
;

26 
SymbŞ
 
	gFlßtCÚ¡ªts
;

29 
	gLev–
;

31 
	gTempNum
;

33 
	gLab–Num
;

38 
SymbŞ
 
	$LookupSymbŞ
(
TabË
 
tbl
, *
Çme
)

40 
SymbŞ
 
p
;

41 
h
 = ()
Çme
 & 
SYM_HASH_MASK
;

45 ià(
tbl
->
buck‘s
 !ğ
NULL
)

47 
p
 = 
tbl
->
buck‘s
[
h
];…;… =…->
lšk
)

49 ià(
p
->
Çme
 ==‚ame)

50  
p
;

53 } (
tbl
 =bl->
ou‹r
è!ğ
NULL
);

55  
NULL
;

56 
	}
}

61 
SymbŞ
 
	$AddSymbŞ
(
TabË
 
tbl
, 
SymbŞ
 
sym
)

63 
h
 = ()
sym
->
Çme
 & 
SYM_HASH_MASK
;

67 ià(
tbl
->
buck‘s
 =ğ
NULL
)

69 
size
 = (
SymbŞ
è* (
SYM_HASH_MASK
 + 1);

71 
tbl
->
buck‘s
 = 
	`H—pAÎoÿ‹
(
Cu¼’tH—p
, 
size
);

72 
	`mem£t
(
tbl
->
buck‘s
, 0, 
size
);

75 
sym
->
lšk
 = 
tbl
->
buck‘s
[
h
];

76 
sym
->
Ëv–
 = 
tbl
->level;

77 
tbl
->
buck‘s
[
h
] = 
sym
;

79  
sym
;

80 
	}
}

86 
	$EÁ”Scİe
()

88 
TabË
 
t
;

90 
Lev–
++;

92 
	`ALLOC
(
t
);

93 
t
->
Ëv–
 = 
Lev–
;

94 
t
->
ou‹r
 = 
Id’tif›rs
;

95 
t
->
buck‘s
 = 
NULL
;

96 
Id’tif›rs
 = 
t
;

98 
	`ALLOC
(
t
);

99 
t
->
Ëv–
 = 
Lev–
;

100 
t
->
ou‹r
 = 
Tags
;

101 
t
->
buck‘s
 = 
NULL
;

102 
Tags
 = 
t
;

103 
	}
}

109 
	$Ex™Scİe
()

111 
Lev–
--;

112 
Id’tif›rs
 = Id’tif›rs->
ou‹r
;

113 
Tags
 = Tags->
ou‹r
;

114 
	}
}

116 
SymbŞ
 
	$LookupID
(*
Çme
)

118  
	`LookupSymbŞ
(
Id’tif›rs
, 
Çme
);

119 
	}
}

121 
SymbŞ
 
	$LookupTag
(*
Çme
)

123  
	`LookupSymbŞ
(
Tags
, 
Çme
);

124 
	}
}

126 
SymbŞ
 
	$AddTag
(*
Çme
, 
Ty³
 
ty
)

128 
SymbŞ
 
p
;

130 
	`CALLOC
(
p
);

132 
p
->
kšd
 = 
SK_Tag
;

133 
p
->
Çme
 =‚ame;

134 
p
->
ty
 =y;

136  
	`AddSymbŞ
(
Tags
, 
p
);

137 
	}
}

139 
SymbŞ
 
	$AddEnumCÚ¡ªt
(*
Çme
, 
Ty³
 
ty
, 
v®
)

141 
SymbŞ
 
p
;

143 
	`CALLOC
(
p
);

145 
p
->
kšd
 = 
SK_EnumCÚ¡ªt
;

146 
p
->
Çme
 =‚ame;

147 
p
->
ty
 =y;

148 
p
->
v®
.
i
[0] = val;

150  
	`AddSymbŞ
(
Id’tif›rs
, 
p
);

151 
	}
}

153 
SymbŞ
 
	$AddTy³defName
(*
Çme
, 
Ty³
 
ty
)

155 
SymbŞ
 
p
;

157 
	`CALLOC
(
p
);

159 
p
->
kšd
 = 
SK_Ty³defName
;

160 
p
->
Çme
 =‚ame;

161 
p
->
ty
 =y;

163  
	`AddSymbŞ
(
Id’tif›rs
, 
p
);

164 
	}
}

166 
SymbŞ
 
	$AddV¬ŸbË
(*
Çme
, 
Ty³
 
ty
, 
sşass
)

168 
V¬ŸbËSymbŞ
 
p
;

170 
	`CALLOC
(
p
);

172 
p
->
kšd
 = 
SK_V¬ŸbË
;

173 
p
->
Çme
 =‚ame;

174 
p
->
ty
 =y;

175 
p
->
sşass
 = sclass;

177 ià(
Lev–
 =ğ0 || 
sşass
 =ğ
TK_STATIC
)

179 *
Glob®Ta
 = (
SymbŞ
)
p
;

180 
Glob®Ta
 = &
p
->
Ãxt
;

182 ià(
sşass
 !ğ
TK_EXTERN
)

184 *
FSYM
->
Ï¡v
 = (
SymbŞ
)
p
;

185 
FSYM
->
Ï¡v
 = &
p
->
Ãxt
;

188  
	`AddSymbŞ
(
Id’tif›rs
, (
SymbŞ
)
p
);

189 
	}
}

191 
SymbŞ
 
	$AddFunùiÚ
(*
Çme
, 
Ty³
 
ty
, 
sşass
)

193 
FunùiÚSymbŞ
 
p
;

195 
	`CALLOC
(
p
);

197 
p
->
kšd
 = 
SK_FunùiÚ
;

198 
p
->
Çme
 =‚ame;

199 
p
->
ty
 =y;

200 
p
->
sşass
 = sclass;

201 
p
->
Ï¡v
 = &p->
·¿ms
;

203 *
FunùiÚTa
 = (
SymbŞ
)
p
;

204 
FunùiÚTa
 = &
p
->
Ãxt
;

206  
	`AddSymbŞ
(&
Glob®IDs
, (
SymbŞ
)
p
);

207 
	}
}

209 
SymbŞ
 
	$AddCÚ¡ªt
(
Ty³
 
ty
, 
v®ue
 
v®
)

211 
h
 = ()
v®
.
i
[0] & 
SYM_HASH_MASK
;

212 
SymbŞ
 
p
;

214 
ty
 = 
	`Unqu®
(ty);

215 ià(
	`IsIÁegTy³
(
ty
))

217 
ty
 = 
	`T
(
INT
);

219 ià(
	`IsPŒTy³
(
ty
))

221 
ty
 = 
	`T
(
POINTER
);

223 ià(
ty
->
ÿ‹g
 =ğ
LONGDOUBLE
)

225 
ty
 = 
	`T
(
DOUBLE
);

228 
p
 = 
CÚ¡ªts
.
buck‘s
[
h
];… !ğ
NULL
;… =…->
lšk
)

230 ià(
p
->
ty
 =ğty &&…->
v®
.
i
[0] == val.i[0] &&…->val.i[1] == val.i[1])

231  
p
;

234 
	`CALLOC
(
p
);

236 
p
->
kšd
 = 
SK_CÚ¡ªt
;

237 
ty
->
ÿ‹g
)

239 
INT
:

240 
p
->
Çme
 = 
	`FÜm©Name
("%d", 
v®
.
i
[0]);

243 
POINTER
:

244 ià(
v®
.
i
[0] == 0)

246 
p
->
Çme
 = "0";

250 
p
->
Çme
 = 
	`FÜm©Name
("0x%x", 
v®
.
i
[0]);

254 
FLOAT
:

255 
p
->
Çme
 = 
	`FÜm©Name
("%g", 
v®
.
f
);

258 
DOUBLE
:

259 
p
->
Çme
 = 
	`FÜm©Name
("%g", 
v®
.
d
);

263 
	`as£¹
(0);

265 
p
->
ty
 =y;

266 
p
->
sşass
 = 
TK_STATIC
;

267 
p
->
v®
 = val;

269 
p
->
lšk
 = 
CÚ¡ªts
.
buck‘s
[
h
];

270 
CÚ¡ªts
.
buck‘s
[
h
] = 
p
;

272 ià(
ty
->
ÿ‹g
 =ğ
FLOAT
 ||y->ÿ‹g =ğ
DOUBLE
)

274 *
FlßtTa
 = 
p
;

275 
FlßtTa
 = &
p
->
Ãxt
;

277  
p
;

278 
	}
}

280 
SymbŞ
 
	$IÁCÚ¡ªt
(
i
)

282 
v®ue
 
v®
;

284 
v®
.
i
[0] = i;

285 
v®
.
i
[1] = 0;

287  
	`AddCÚ¡ªt
(
	`T
(
INT
), 
v®
);

288 
	}
}

290 
SymbŞ
 
	$AddSŒšg
(
Ty³
 
ty
, 
SŒšg
 
¡r
)

292 
SymbŞ
 
p
;

294 
	`CALLOC
(
p
);

296 
p
->
kšd
 = 
SK_SŒšg
;

297 
p
->
Çme
 = 
	`FÜm©Name
("¡r%d", 
SŒšgNum
++);

298 
p
->
ty
 =y;

299 
p
->
sşass
 = 
TK_STATIC
;

300 
p
->
v®
.°ğ
¡r
;

302 *
SŒšgTa
 = 
p
;

303 
SŒšgTa
 = &
p
->
Ãxt
;

305  
p
;

306 
	}
}

308 
SymbŞ
 
	$C»©eTemp
(
Ty³
 
ty
)

310 
V¬ŸbËSymbŞ
 
p
;

312 
	`CALLOC
(
p
);

314 
p
->
kšd
 = 
SK_Temp
;

315 
p
->
Çme
 = 
	`FÜm©Name
("t%d", 
TempNum
++);

316 
p
->
ty
 =y;

317 
p
->
Ëv–
 = 1;

320 *
FSYM
->
Ï¡v
 = (
SymbŞ
)
p
;

321 
FSYM
->
Ï¡v
 = &
p
->
Ãxt
;

323  (
SymbŞ
)
p
;

324 
	}
}

326 
SymbŞ
 
	$C»©eLab–
()

328 
SymbŞ
 
p
;

330 
	`CALLOC
(
p
);

332 
p
->
kšd
 = 
SK_Lab–
;

333 
p
->
Çme
 = 
	`FÜm©Name
("BB%d", 
Lab–Num
++);

335  
p
;

336 
	}
}

338 
SymbŞ
 
	$C»©eOff£t
(
Ty³
 
ty
, 
SymbŞ
 
ba£
, 
coff
)

340 
V¬ŸbËSymbŞ
 
p
;

342 ià(
coff
 == 0)

343  
ba£
;

345 
	`CALLOC
(
p
);

346 ià(
ba£
->
kšd
 =ğ
SK_Off£t
)

348 
coff
 +ğ
	`AsV¬
(
ba£
)->
off£t
;

349 
ba£
 = ba£->
lšk
;

351 
p
->
add»s£d
 = 1;

352 
p
->
kšd
 = 
SK_Off£t
;

353 
p
->
ty
 =y;

354 
p
->
lšk
 = 
ba£
;

355 
p
->
off£t
 = 
coff
;

356 
p
->
Çme
 = 
	`FÜm©Name
("%s[%d]", 
ba£
->Çme, 
coff
);

357 
ba£
->
»f
++;

359  (
SymbŞ
)
p
;

360 
	}
}

362 
	$In™SymbŞTabË
()

364 
size
;

366 
Lev–
 = 0;

368 
Glob®Tags
.
buck‘s
 = 
Glob®IDs
.buck‘ ğ
NULL
;

369 
Glob®Tags
.
ou‹r
 = 
Glob®IDs
.ou‹¸ğ
NULL
;

370 
Glob®Tags
.
Ëv–
 = 
Glob®IDs
.level = 0;

372 
size
 = (
SymbŞ
è* (
SYM_HASH_MASK
 + 1);

373 
CÚ¡ªts
.
buck‘s
 = 
	`H—pAÎoÿ‹
(
Cu¼’tH—p
, 
size
);

374 
	`mem£t
(
CÚ¡ªts
.
buck‘s
, 0, 
size
);

375 
CÚ¡ªts
.
ou‹r
 = 
NULL
;

376 
CÚ¡ªts
.
Ëv–
 = 0;

378 
FunùiÚs
 = 
Glob®s
 = 
SŒšgs
 = 
FlßtCÚ¡ªts
 = 
NULL
;

379 
FunùiÚTa
 = &
FunùiÚs
;

380 
Glob®Ta
 = &
Glob®s
;

381 
SŒšgTa
 = &
SŒšgs
;

382 
FlßtTa
 = &
FlßtCÚ¡ªts
;

384 
Tags
 = &
Glob®Tags
;

385 
Id’tif›rs
 = &
Glob®IDs
;

387 
TempNum
 = 
Lab–Num
 = 
SŒšgNum
 = 0;

388 
	}
}

	@ucl/symbol.h

1 #iâdeà
__SYMBOL_H_


2 
	#__SYMBOL_H_


	)

6 
	mSK_Tag
, 
	mSK_Ty³defName
, 
	mSK_EnumCÚ¡ªt
, 
	mSK_CÚ¡ªt
, 
	mSK_V¬ŸbË
, 
	mSK_Temp
,

7 
	mSK_Off£t
, 
	mSK_SŒšg
, 
	mSK_Lab–
, 
	mSK_FunùiÚ
, 
	mSK_Regi¡”


10 
	#SYM_HASH_MASK
 127

	)

12 
	#SYMBOL_COMMON
 \

	)

13 
	gkšd
; \

14 *
	gÇme
; \

15 *
	gªame
; \

16 
Ty³
 
	gty
; \

17 
	gËv–
; \

18 
	gsşass
; \

19 
	g»f
; \

20 
	gdefšed
 : 1; \

21 
	gadd»s£d
 : 1; \

22 
	gÃedwb
 : 1; \

23 
	gunu£d
 : 29; \

24 
v®ue
 
	gv®
; \

25 
symbŞ
 *
	g»g
; \

26 
symbŞ
 *
	glšk
; \

27 
symbŞ
 *
	gÃxt
;

29 
bblock
 *
	tBBlock
;

30 
š™D©a
 *
	tIn™D©a
;

32 
	ssymbŞ


34 
	mSYMBOL_COMMON


35 } *
	tSymbŞ
;

37 
	sv®ueDef


39 
SymbŞ
 
	md¡
;

40 
	mİ
;

41 
SymbŞ
 
	m¤c1
;

42 
SymbŞ
 
	m¤c2
;

43 
BBlock
 
	mownBB
;

44 
v®ueDef
 *
	mlšk
;

45 } *
	tV®ueDef
;

47 
	sv®ueU£


49 
V®ueDef
 
	mdef
;

50 
v®ueU£
 *
	mÃxt
;

51 } *
	tV®ueU£
;

53 
	sv¬ŸbËSymbŞ


55 
SYMBOL_COMMON


56 
In™D©a
 
	mid©a
;

57 
V®ueDef
 
	mdef
;

58 
V®ueU£
 
	mu£s
;

59 
	moff£t
;

60 } *
	tV¬ŸbËSymbŞ
;

62 
	sfunùiÚSymbŞ


64 
SYMBOL_COMMON


65 
SymbŞ
 
	m·¿ms
;

66 
SymbŞ
 
	mloÿls
;

67 
SymbŞ
 *
	mÏ¡v
;

68 
	mnbblock
;

69 
BBlock
 
	m’ŒyBB
;

70 
BBlock
 
	mex™BB
;

71 
V®ueDef
 
	mv®NumTabË
[16];

72 } *
	tFunùiÚSymbŞ
;

74 
	sbË


76 
SymbŞ
 *
	mbuck‘s
;

77 
	mËv–
;

78 
bË
 *
	mou‹r
;

79 } *
	tTabË
;

81 
	#AsV¬
(
sym
è((
V¬ŸbËSymbŞ
)sym)

	)

82 
	#AsFunc
(
sym
è((
FunùiÚSymbŞ
)sym)

	)

84 
In™SymbŞTabË
();

85 
EÁ”Scİe
();

86 
Ex™Scİe
();

88 
SymbŞ
 
LookupID
(*
id
);

89 
SymbŞ
 
LookupTag
(*
id
);

90 
SymbŞ
 
AddCÚ¡ªt
(
Ty³
 
ty
, 
v®ue
 
v®
);

91 
SymbŞ
 
AddEnumCÚ¡ªt
(*
id
, 
Ty³
 
ty
, 
v®
);

92 
SymbŞ
 
AddTy³defName
(*
id
, 
Ty³
 
ty
);

93 
SymbŞ
 
AddV¬ŸbË
(*
id
, 
Ty³
 
ty
, 
sşass
);

94 
SymbŞ
 
AddFunùiÚ
(*
id
, 
Ty³
 
ty
, 
sşass
);

95 
SymbŞ
 
AddTag
(*
id
, 
Ty³
 
ty
);

96 
SymbŞ
 
IÁCÚ¡ªt
(
i
);

97 
SymbŞ
 
C»©eTemp
(
Ty³
 
ty
);

98 
SymbŞ
 
C»©eLab–
();

99 
SymbŞ
 
AddSŒšg
(
Ty³
 
ty
, 
SŒšg
 
¡r
);

100 
SymbŞ
 
C»©eOff£t
(
Ty³
 
ty
, SymbŞ 
ba£
, 
off£t
);

102 
Lev–
;

103 
Lab–Num
, 
TempNum
;

104 
SymbŞ
 
FunùiÚs
;

105 
SymbŞ
 
Glob®s
;

106 
SymbŞ
 
SŒšgs
;

107 
SymbŞ
 
FlßtCÚ¡ªts
;

108 
FunùiÚSymbŞ
 
FSYM
;

	@ucl/target.h

1 #iâdeà
__TARGET_H_


2 
	#__TARGET_H_


	)

4 ’um { 
	mCODE
, 
	mDATA
 };

7 
PutASMCode
(
code
, 
SymbŞ
 
İds
[]);

8 
S‘upRegi¡”s
();

9 
BegšProg¿m
();

10 
Segm’t
(
£g
);

11 
ImpÜt
(
SymbŞ
 
p
);

12 
ExpÜt
(
SymbŞ
 
p
);

13 
DefšeGlob®
(
SymbŞ
 
p
);

14 
DefšeCommD©a
(
SymbŞ
 
p
);

15 
DefšeSŒšg
(
SŒšg
 
p
, 
size
);

16 
DefšeFlßtCÚ¡ªt
(
SymbŞ
 
p
);

17 
DefšeAdd»ss
(
SymbŞ
 
p
);

18 
DefšeLab–
(
SymbŞ
 
p
);

19 
DefšeV®ue
(
Ty³
 
ty
, 
v®ue
 
v®
);

20 
S·û
(
size
);

21 
Em™FunùiÚ
(
FunùiÚSymbŞ
 
p
);

22 
EndProg¿m
();

	@ucl/template.h

1 #iâdeà
TEMPLATE


5 
TEMPLATE
(
X86_MOV
, "mov %0, %1")

6 
TEMPLATE
(
X86_MOVB
, "leaƒdi, %0;leaƒsi, %1;movƒcx, %2;rep movsb")

7 
TEMPLATE
(
X86_OR
, "or %0, %2")

8 
TEMPLATE
(
X86_XOR
, "xor %0, %2")

9 
TEMPLATE
(
X86_AND
, "and %0, %2")

10 
TEMPLATE
(
X86_SHL
, "shl %0, %2")

11 
TEMPLATE
(
X86_SAR
, "sar %0, %2")

12 
TEMPLATE
(
X86_SHR
, "shr %0, %2")

13 
TEMPLATE
(
X86_ADD
, "add %0, %2")

14 
TEMPLATE
(
X86_SUB
, "sub %0, %2")

15 
TEMPLATE
(
X86_IMUL
, "imul %0, %2")

16 
TEMPLATE
(
X86_MUL
, "mul %2")

17 
TEMPLATE
(
X86_IDIV
, "cdq;idiv %2")

18 
TEMPLATE
(
X86_DIV
, "movƒdx, 0;div %2")

19 
TEMPLATE
(
X86_IMOD
, "cdq;idiv %2")

20 
TEMPLATE
(
X86_MOD
, "movƒdx, 0;div %2")

21 
TEMPLATE
(
X86_NEG
, "neg %0")

22 
TEMPLATE
(
X86_NOT
, "not %0")

23 
TEMPLATE
(
X86_ADDR
, "lea %0, %1")

24 
TEMPLATE
(
X86_INC
, "inc %0")

25 
TEMPLATE
(
X86_DEC
, "dec %0")

27 
TEMPLATE
(
X86_JMP
, "jmp %0")

28 
TEMPLATE
(
X86_IJMP
, "jmp DWORD PTR %0[%1]")

29 
TEMPLATE
(
X86_JZ
, "cmp %1, 0;je %0")

30 
TEMPLATE
(
X86_JNZ
, "cmp %1, 0;jne %0")

31 
TEMPLATE
(
X86_JE
, "cmp %1, %2;je %0")

32 
TEMPLATE
(
X86_JNE
, "cmp %1, %2;jne %0")

33 
TEMPLATE
(
X86_JG
, "cmp %1, %2;jg %0")

34 
TEMPLATE
(
X86_JA
, "cmp %1, %2;ja %0")

35 
TEMPLATE
(
X86_JL
, "cmp %1, %2;jl %0")

36 
TEMPLATE
(
X86_JB
, "cmp %1, %2;jb %0")

37 
TEMPLATE
(
X86_JGE
, "cmp %1, %2;jge %0")

38 
TEMPLATE
(
X86_JAE
, "cmp %1, %2;jae %0")

39 
TEMPLATE
(
X86_JLE
, "cmp %1, %2;jle %0")

40 
TEMPLATE
(
X86_JBE
, "cmp %1, %2;jbe %0")

42 
TEMPLATE
(
X86_PROLOGUE
, "pushƒbp;pushƒbx;pushƒsi;pushƒdi;movƒbp,ƒsp")

43 
TEMPLATE
(
X86_PUSH
, "push %0")

44 
TEMPLATE
(
X86_PUSHR4
, "pushƒcx;fld %0;fstp DWORD PTR [esp]")

45 
TEMPLATE
(
X86_PUSHR8
, "subƒsp, 8;fld %0;fstp QWORD PTR [esp]")

46 
TEMPLATE
(
X86_PUSHB
, "leaƒsi, %0;subƒsp, %1;movƒdi,ƒsp;movƒcx, %1;rep movsb")

47 
TEMPLATE
(
X86_EXPANDF
, "subƒsp, %0")

48 
TEMPLATE
(
X86_CALL
, "call %1")

49 
TEMPLATE
(
X86_REDUCEF
, "addƒsp, %0")

50 
TEMPLATE
(
X86_EPILOGUE
, "movƒsp,ƒbp;popƒdi;popƒsi;popƒbx;popƒbp;ret")

52 
TEMPLATE
(
X86_FADD
, "fadd %2")

53 
TEMPLATE
(
X86_FSUB
, "fsub %2")

54 
TEMPLATE
(
X86_FMUL
, "fmul %2")

55 
TEMPLATE
(
X86_FDIV
, "fdiv %2")

56 
TEMPLATE
(
X86_FNEG
, "fchs")

57 
TEMPLATE
(
X86_FINC
, "fld1;fadd %0;fstp %0")

58 
TEMPLATE
(
X86_FDEC
, "fld1;fsub %0;fabs;fstp %0")

60 
TEMPLATE
(
X86_FLD
, "fld %0")

61 
TEMPLATE
(
X86_FSTP
, "fstp %0")

62 
TEMPLATE
(
X86_FJZ
, "fldz;fcomp %1;fnstsw‡x;and‡h, 40h;je %0")

63 
TEMPLATE
(
X86_FJNZ
, "fldz;fcomp %1;fnstsw‡x;and‡h, 40h;jne %0")

64 
TEMPLATE
(
X86_FJE
, "fcom %2;fnstsw‡x;and‡h, 40h;jnz %0")

65 
TEMPLATE
(
X86_FJNE
, "fcom %2;fnstsw‡x;and‡h, 40h;jz %0")

66 
TEMPLATE
(
X86_FJG
, "fcom %2;fnstsw‡x;and‡h, 41h;jz %0")

67 
TEMPLATE
(
X86_FJL
, "fcom %2;fnstsw‡x;and‡h, 1h;jnz %0")

68 
TEMPLATE
(
X86_FJGE
, "fcom %2;fnstsw‡x;and‡h, 1h;jz %0")

69 
TEMPLATE
(
X86_FJLE
, "fcom %2;fnstsw‡x;and‡h, 41h;jnz %0")

71 
TEMPLATE
(
X86_MOVSX
, "movsx %0, %1")

72 
TEMPLATE
(
X86_MOVZX
, "movzx %0, %1")

73 
TEMPLATE
(
X86_CVTIF
, "push %1;fild DWORD PTR [esp];fstp %0")

74 
TEMPLATE
(
X86_CVTUF
, "push 0;push %1;fild QWORD PTR [esp];fstp %0")

75 
TEMPLATE
(
X86_CVTFI
, "fld %1;call __ftol;")

76 
TEMPLATE
(
X86_CVTFU
, "fld %1;subƒsp, 16;fnstsw [esp];movzxƒax, WORD PTR [esp];"

79 
TEMPLATE
(
X86_CVTF
, "fld %1;fistp %0")

81 
TEMPLATE
(
X86_HLT
, "hlt")

	@ucl/token.h

1 #iâdeà
TOKEN


6 
TOKEN
(
TK_AUTO
, "auto")

7 
TOKEN
(
TK_EXTERN
, "extern")

8 
TOKEN
(
TK_REGISTER
, "register")

9 
TOKEN
(
TK_STATIC
, "static")

10 
TOKEN
(
TK_TYPEDEF
, "typedef")

11 
TOKEN
(
TK_CONST
, "const")

12 
TOKEN
(
TK_VOLATILE
, "volatile")

13 
TOKEN
(
TK_SIGNED
, "signed")

14 
TOKEN
(
TK_UNSIGNED
, "unsigned")

15 
TOKEN
(
TK_SHORT
, "short")

16 
TOKEN
(
TK_LONG
, "long")

17 
TOKEN
(
TK_CHAR
, "char")

18 
TOKEN
(
TK_INT
, "int")

19 
TOKEN
(
TK_INT64
, "__int64")

20 
TOKEN
(
TK_FLOAT
, "float")

21 
TOKEN
(
TK_DOUBLE
, "double")

22 
TOKEN
(
TK_ENUM
, "enum")

23 
TOKEN
(
TK_STRUCT
, "struct")

24 
TOKEN
(
TK_UNION
, "union")

25 
TOKEN
(
TK_VOID
, "void")

26 
TOKEN
(
TK_BREAK
, "break")

27 
TOKEN
(
TK_CASE
, "case")

28 
TOKEN
(
TK_CONTINUE
, "continue")

29 
TOKEN
(
TK_DEFAULT
, "default")

30 
TOKEN
(
TK_DO
, "do")

31 
TOKEN
(
TK_ELSE
, "else")

32 
TOKEN
(
TK_FOR
, "for")

33 
TOKEN
(
TK_GOTO
, "goto")

34 
TOKEN
(
TK_IF
, "if")

35 
TOKEN
(
TK_RETURN
, "return")

36 
TOKEN
(
TK_SWITCH
, "switch")

37 
TOKEN
(
TK_WHILE
, "while")

38 
TOKEN
(
TK_SIZEOF
, "sizeof")

41 
TOKEN
(
TK_ID
, "ID")

44 
TOKEN
(
TK_INTCONST
, "int")

45 
TOKEN
(
TK_UINTCONST
, "unsigned int")

46 
TOKEN
(
TK_LONGCONST
, "long")

47 
TOKEN
(
TK_ULONGCONST
, "unsigned†ong")

48 
TOKEN
(
TK_LLONGCONST
, "long†ong")

49 
TOKEN
(
TK_ULLONGCONST
, "unsigned†ong†ong")

50 
TOKEN
(
TK_FLOATCONST
, "float")

51 
TOKEN
(
TK_DOUBLECONST
, "double")

52 
TOKEN
(
TK_LDOUBLECONST
, "long double")

53 
TOKEN
(
TK_STRING
, "STR")

54 
TOKEN
(
TK_WIDESTRING
, "WSTR")

57 
TOKEN
(
TK_COMMA
, ",")

58 
TOKEN
(
TK_QUESTION
, "?")

59 
TOKEN
(
TK_COLON
, ":")

60 
TOKEN
(
TK_ASSIGN
, "=")

61 
TOKEN
(
TK_BITOR_ASSIGN
, "|=")

62 
TOKEN
(
TK_BITXOR_ASSIGN
, "^=")

63 
TOKEN
(
TK_BITAND_ASSIGN
, "&=")

64 
TOKEN
(
TK_LSHIFT_ASSIGN
, "<<=")

65 
TOKEN
(
TK_RSHIFT_ASSIGN
, ">>=")

66 
TOKEN
(
TK_ADD_ASSIGN
, "+=")

67 
TOKEN
(
TK_SUB_ASSIGN
, "-=")

68 
TOKEN
(
TK_MUL_ASSIGN
, "*=")

69 
TOKEN
(
TK_DIV_ASSIGN
, "/=")

70 
TOKEN
(
TK_MOD_ASSIGN
, "%=")

71 
TOKEN
(
TK_OR
, "||")

72 
TOKEN
(
TK_AND
, "&&")

73 
TOKEN
(
TK_BITOR
, "|")

74 
TOKEN
(
TK_BITXOR
, "^")

75 
TOKEN
(
TK_BITAND
, "&")

76 
TOKEN
(
TK_EQUAL
, "==")

77 
TOKEN
(
TK_UNEQUAL
, "!=")

78 
TOKEN
(
TK_GREAT
, ">")

79 
TOKEN
(
TK_LESS
, "<")

80 
TOKEN
(
TK_GREAT_EQ
, ">=")

81 
TOKEN
(
TK_LESS_EQ
, "<=")

82 
TOKEN
(
TK_LSHIFT
, "<<")

83 
TOKEN
(
TK_RSHIFT
, ">>")

84 
TOKEN
(
TK_ADD
, "+")

85 
TOKEN
(
TK_SUB
, "-")

86 
TOKEN
(
TK_MUL
, "*")

87 
TOKEN
(
TK_DIV
, "/")

88 
TOKEN
(
TK_MOD
, "%")

89 
TOKEN
(
TK_INC
, "++")

90 
TOKEN
(
TK_DEC
, "--")

91 
TOKEN
(
TK_NOT
, "!")

92 
TOKEN
(
TK_COMP
, "~")

93 
TOKEN
(
TK_DOT
, ".")

94 
TOKEN
(
TK_POINTER
, "->")

95 
TOKEN
(
TK_LPAREN
, "(")

96 
TOKEN
(
TK_RPAREN
, ")")

97 
TOKEN
(
TK_LBRACKET
, "[")

98 
TOKEN
(
TK_RBRACKET
, "]")

101 
TOKEN
(
TK_LBRACE
, "{")

102 
TOKEN
(
TK_RBRACE
, "}")

103 
TOKEN
(
TK_SEMICOLON
, ";")

104 
TOKEN
(
TK_ELLIPSE
, "...")

105 
TOKEN
(
TK_POUND
, "#")

106 
TOKEN
(
TK_NEWLINE
, "\n")

108 
TOKEN
(
TK_END
, "EOF")

	@ucl/tokenop.h

1 #iâdeà
TOKENOP


5 
	$TOKENOP
(
TK_ASSIGN
, 
OP_ASSIGN
, 
OP_NONE
)

6 
	$TOKENOP
(
TK_BITOR_ASSIGN
, 
OP_BITOR_ASSIGN
, 
OP_NONE
)

7 
	$TOKENOP
(
TK_BITXOR_ASSIGN
, 
OP_BITXOR_ASSIGN
, 
OP_NONE
)

8 
	$TOKENOP
(
TK_BITAND_ASSIGN
, 
OP_BITAND_ASSIGN
, 
OP_NONE
)

9 
	$TOKENOP
(
TK_LSHIFT_ASSIGN
, 
OP_LSHIFT_ASSIGN
, 
OP_NONE
)

10 
	$TOKENOP
(
TK_RSHIFT_ASSIGN
, 
OP_RSHIFT_ASSIGN
, 
OP_NONE
)

11 
	$TOKENOP
(
TK_ADD_ASSIGN
, 
OP_ADD_ASSIGN
, 
OP_NONE
)

12 
	$TOKENOP
(
TK_SUB_ASSIGN
, 
OP_SUB_ASSIGN
, 
OP_NONE
)

13 
	$TOKENOP
(
TK_MUL_ASSIGN
, 
OP_MUL_ASSIGN
, 
OP_NONE
)

14 
	$TOKENOP
(
TK_DIV_ASSIGN
, 
OP_DIV_ASSIGN
, 
OP_NONE
)

15 
	$TOKENOP
(
TK_MOD_ASSIGN
, 
OP_MOD_ASSIGN
, 
OP_NONE
)

16 
	$TOKENOP
(
TK_OR
, 
OP_OR
, 
OP_NONE
)

17 
	$TOKENOP
(
TK_AND
, 
OP_AND
, 
OP_NONE
)

18 
	$TOKENOP
(
TK_BITOR
, 
OP_BITOR
, 
OP_NONE
)

19 
	$TOKENOP
(
TK_BITXOR
, 
OP_BITXOR
, 
OP_NONE
)

20 
	$TOKENOP
(
TK_BITAND
, 
OP_BITAND
, 
OP_ADDRESS
)

21 
	$TOKENOP
(
TK_EQUAL
, 
OP_EQUAL
, 
OP_NONE
)

22 
	$TOKENOP
(
TK_UNEQUAL
, 
OP_UNEQUAL
, 
OP_NONE
)

23 
	$TOKENOP
(
TK_GREAT
, 
OP_GREAT
, 
OP_NONE
)

24 
	$TOKENOP
(
TK_LESS
, 
OP_LESS
, 
OP_NONE
)

25 
	$TOKENOP
(
TK_LESS_EQ
, 
OP_GREAT_EQ
, 
OP_NONE
)

26 
	$TOKENOP
(
TK_GREAT_EQ
, 
OP_LESS_EQ
, 
OP_NONE
)

27 
	$TOKENOP
(
TK_LSHIFT
, 
OP_LSHIFT
, 
OP_NONE
)

28 
	$TOKENOP
(
TK_RSHIFT
, 
OP_RSHIFT
, 
OP_NONE
)

29 
	$TOKENOP
(
TK_ADD
, 
OP_ADD
, 
OP_POS
)

30 
	$TOKENOP
(
TK_SUB
, 
OP_SUB
, 
OP_NEG
)

31 
	$TOKENOP
(
TK_MUL
, 
OP_MUL
, 
OP_DEREF
)

32 
	$TOKENOP
(
TK_DIV
, 
OP_DIV
, 
OP_NONE
)

33 
	$TOKENOP
(
TK_MOD
, 
OP_MOD
, 
OP_NONE
)

34 
	$TOKENOP
(
TK_INC
, 
OP_NONE
, 
OP_PREINC
)

35 
	$TOKENOP
(
TK_DEC
, 
OP_NONE
, 
OP_PREDEC
)

36 
	$TOKENOP
(
TK_NOT
, 
OP_NONE
, 
OP_NOT
)

37 
	`TOKENOP
(
TK_COMP
, 
OP_NONE
, 
OP_COMP
)

	@ucl/tranexpr.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"ex´.h
"

4 
	~"g’.h
"

9 
SymbŞ
 
	$T¿n¦©ePrim¬yEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

11 ià(
ex´
->
İ
 =ğ
OP_CONST
)

12  
	`AddCÚ¡ªt
(
ex´
->
ty
,ƒx´->
v®
);

16 ià(
ex´
->
İ
 =ğ
OP_STR
 ||ƒx´->
i§¼ay
 ||ƒx´->
isfunc
)

17  
	`Add»ssOf
(
ex´
->
v®
.
p
);

19  
ex´
->
v®
.
p
;

20 
	}
}

27 
SymbŞ
 
	$R—dB™F›ld
(
F›ld
 
æd
, 
SymbŞ
 
p
)

29 
size
 = 8 * 
æd
->
ty
->size;

30 
lb™s
 = 
size
 - (
æd
->
b™s
 + fld->
pos
);

31 
rb™s
 = 
size
 - (
æd
->
b™s
);

47 
p
 = 
	`Sim¶ify
(
	`T
(
INT
), 
LSH
,…, 
	`IÁCÚ¡ªt
(
lb™s
));

48 
p
 = 
	`Sim¶ify
(
	`T
(
INT
), 
RSH
,…, 
	`IÁCÚ¡ªt
(
rb™s
));

50  
p
;

51 
	}
}

53 
SymbŞ
 
	$Wr™eB™F›ld
(
F›ld
 
æd
, 
SymbŞ
 
d¡
, SymbŞ 
¤c
)

55 
fmask
 = (1 << 
æd
->
b™s
) - 1;

56 
mask
 = 
fmask
 << 
æd
->
pos
;

57 
SymbŞ
 
p
;

59 ià(
¤c
->
kšd
 =ğ
SK_CÚ¡ªt
 && src->
v®
.
i
[0] == 0)

61 
p
 = 
	`Sim¶ify
(
	`T
(
INT
), 
BAND
, 
d¡
, 
	`IÁCÚ¡ªt
(~
mask
));

63 ià(
¤c
->
kšd
 =ğ
SK_CÚ¡ªt
 && (¤c->
v®
.
i
[0] & 
fmask
) == fmask)

65 
p
 = 
	`Sim¶ify
(
	`T
(
INT
), 
BOR
, 
d¡
, 
	`IÁCÚ¡ªt
(
mask
));

69 ià(
¤c
->
kšd
 =ğ
SK_CÚ¡ªt
)

71 
¤c
 = 
	`IÁCÚ¡ªt
((¤c->
v®
.
i
[0] << 
æd
->
pos
è& 
mask
);

75 
¤c
 = 
	`Sim¶ify
(
	`T
(
INT
), 
LSH
, src, 
	`IÁCÚ¡ªt
(
æd
->
pos
));

76 
¤c
 = 
	`Sim¶ify
(
	`T
(
INT
), 
BAND
, src, 
	`IÁCÚ¡ªt
(
mask
));

78 
p
 = 
	`Sim¶ify
(
	`T
(
INT
), 
BAND
, 
d¡
, 
	`IÁCÚ¡ªt
(~
mask
));

79 
p
 = 
	`Sim¶ify
(
	`T
(
INT
), 
BOR
,…, 
¤c
);

82 ià(
d¡
->
kšd
 =ğ
SK_Temp
 && 
	`AsV¬
(d¡)->
def
->
İ
 =ğ
DEREF
)

84 
SymbŞ
 
addr
 = 
	`AsV¬
(
d¡
)->
def
->
¤c1
;

86 
	`G’”©eIndœeùMove
(
æd
->
ty
, 
addr
, 
p
);

87 
d¡
 = 
	`D”ef
(
æd
->
ty
, 
addr
);

91 
	`G’”©eMove
(
æd
->
ty
, 
d¡
, 
p
);

93  
	`R—dB™F›ld
(
æd
, 
d¡
);

94 
	}
}

96 
SymbŞ
 
	$Off£t
(
Ty³
 
ty
, 
SymbŞ
 
addr
, SymbŞ 
voff
, 
coff
)

98 ià(
voff
 !ğ
NULL
)

100 
voff
 = 
	`Sim¶ify
(
	`T
(
POINTER
), 
ADD
, voff, 
	`IÁCÚ¡ªt
(
coff
));

101 
addr
 = 
	`Sim¶ify
(
	`T
(
POINTER
), 
ADD
,‡ddr, 
voff
);

102  
	`D”ef
(
ty
, 
addr
);

105 ià(
addr
->
kšd
 =ğ
SK_Temp
 && 
	`AsV¬
×ddr)->
def
->
İ
 =ğ
ADDR
)

107  
	`C»©eOff£t
(
ty
, 
	`AsV¬
(
addr
)->
def
->
¤c1
, 
coff
);

110  
	`D”ef
(
ty
, 
	`Sim¶ify
(
	`T
(
POINTER
), 
ADD
, 
addr
, 
	`IÁCÚ¡ªt
(
coff
)));

111 
	}
}

126 
SymbŞ
 
	$T¿n¦©eB¿nchEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

128 
BBlock
 
ÃxtBB
, 
ŒueBB
, 
çl£BB
;

129 
SymbŞ
 
t
;

131 
t
 = 
	`C»©eTemp
(
ex´
->
ty
);

132 
ÃxtBB
 = 
	`C»©eBBlock
();

133 
ŒueBB
 = 
	`C»©eBBlock
();

134 
çl£BB
 = 
	`C»©eBBlock
();

136 
	`T¿n¦©eB¿nch
(
ex´
, 
ŒueBB
, 
çl£BB
);

138 
	`S¹BBlock
(
çl£BB
);

139 
	`G’”©eMove
(
ex´
->
ty
, 
t
, 
	`IÁCÚ¡ªt
(0));

140 
	`G’”©eJump
(
ÃxtBB
);

142 
	`S¹BBlock
(
ŒueBB
);

143 
	`G’”©eMove
(
ex´
->
ty
, 
t
, 
	`IÁCÚ¡ªt
(1));

145 
	`S¹BBlock
(
ÃxtBB
);

147  
t
;

148 
	}
}

153 
SymbŞ
 
	$T¿n¦©eA¼ayIndex
(
A¡Ex´essiÚ
 
ex´
)

155 
A¡Ex´essiÚ
 
p
;

156 
SymbŞ
 
addr
, 
d¡
, 
voff
 = 
NULL
;

157 
coff
 = 0;

159 
p
 = 
ex´
;

163 ià(
p
->
kids
[1]->
İ
 =ğ
OP_CONST
)

165 
coff
 +ğ
p
->
kids
[1]->
v®
.
i
[0];

167 ià(
voff
 =ğ
NULL
)

169 
voff
 = 
	`T¿n¦©eEx´essiÚ
(
p
->
kids
[1]);

173 
voff
 = 
	`Sim¶ify
(voff->
ty
, 
ADD
, voff, 
	`T¿n¦©eEx´essiÚ
(
p
->
kids
[1]));

175 
p
 =…->
kids
[0];

176 } 
p
->
İ
 =ğ
OP_INDEX
 &&…->
kids
[0]->
i§¼ay
);

178 
addr
 = 
	`T¿n¦©eEx´essiÚ
(
p
);

179 
d¡
 = 
	`Off£t
(
ex´
->
ty
, 
addr
, 
voff
, 
coff
);

181  
ex´
->
i§¼ay
 ? 
	`Add»ssOf
(
d¡
) : dst;

182 
	}
}

184 
SymbŞ
 
	$T¿n¦©eFunùiÚC®l
(
A¡Ex´essiÚ
 
ex´
)

186 
A¡Ex´essiÚ
 
¬g
;

187 
SymbŞ
 
çddr
, 
»cv
;

188 
ILArg
 
¬g
;

189 
VeùÜ
 
¬gs
 = 
	`C»©eVeùÜ
(4);

191 
ex´
->
kids
[0]->
isfunc
 = 0;

192 
çddr
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[0]);

193 
¬g
 = 
ex´
->
kids
[1];

194 
¬g
)

196 
	`ALLOC
(
¬g
);

197 
¬g
->
sym
 = 
	`T¿n¦©eEx´essiÚ
(
¬g
);

198 
¬g
->
ty
 = 
¬g
->ty;

199 
	`INSERT_ITEM
(
¬gs
, 
¬g
);

200 
¬g
 = (
A¡Ex´essiÚ
ïrg->
Ãxt
;

203 
»cv
 = 
NULL
;

204 ià(
ex´
->
ty
->
ÿ‹g
 !ğ
VOID
)

206 
»cv
 = 
	`C»©eTemp
(
ex´
->
ty
);

208 
	`G’”©eFunùiÚC®l
(
ex´
->
ty
, 
»cv
, 
çddr
, 
¬gs
);

210  
»cv
;

211 
	}
}

213 
SymbŞ
 
	$T¿n¦©eMemb”Acûss
(
A¡Ex´essiÚ
 
ex´
)

215 
A¡Ex´essiÚ
 
p
;

216 
F›ld
 
æd
;

217 
SymbŞ
 
addr
, 
d¡
;

218 
coff
 = 0;

220 
p
 = 
ex´
;

221 ià(
p
->
İ
 =ğ
OP_PTR_MEMBER
)

223 
æd
 = 
p
->
v®
.p;

224 
coff
 = 
æd
->
off£t
;

225 
addr
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[0]);

229 
p
->
İ
 =ğ
OP_MEMBER
)

231 
æd
 = 
p
->
v®
.p;

232 
coff
 +ğ
æd
->
off£t
;

233 
p
 =…->
kids
[0];

235 
addr
 = 
	`Add»ssOf
(
	`T¿n¦©eEx´essiÚ
(
p
));

238 
d¡
 = 
	`Off£t
(
ex´
->
ty
, 
addr
, 
NULL
, 
coff
);

239 
æd
 = 
d¡
->
v®
.
p
 = 
ex´
->val.p;

241 ià(
æd
->
b™s
 !ğ0 && 
ex´
->
lv®ue
 == 0)

242  
	`R—dB™F›ld
(
æd
, 
d¡
);

244  
ex´
->
i§¼ay
 ? 
	`Add»ssOf
(
d¡
) : dst;

245 
	}
}

247 
SymbŞ
 
	$T¿n¦©eInüem’t
(
A¡Ex´essiÚ
 
ex´
)

249 
A¡Ex´essiÚ
 
ÿsgn
;

250 
SymbŞ
 
p
;

251 
F›ld
 
æd
 = 
NULL
;

253 
ÿsgn
 = 
ex´
->
kids
[0];

254 
p
 = 
	`T¿n¦©eEx´essiÚ
(
ÿsgn
->
kids
[0]);

255 
ÿsgn
->
kids
[0]->
İ
 = 
OP_ID
;

256 
ÿsgn
->
kids
[0]->
v®
.
p
 =…;

257 
æd
 = 
p
->
v®
.p;

259 ià(
ex´
->
İ
 =ğ
OP_POSTINC
 ||ƒx´->İ =ğ
OP_POSTDEC
)

261 
SymbŞ
 
»t
;

263 
»t
 = 
p
;

264 ià(
ÿsgn
->
kids
[0]->
b™æd
)

266 
»t
 = 
	`R—dB™F›ld
(
æd
, 
p
);

268 ià(
p
->
kšd
 !ğ
SK_Temp
)

270 
»t
 = 
	`C»©eTemp
(
ex´
->
ty
);

271 
	`G’”©eMove
(
ex´
->
ty
, 
»t
, 
p
);

273 
	`T¿n¦©eEx´essiÚ
(
ÿsgn
);

274  
»t
;

277  
	`T¿n¦©eEx´essiÚ
(
ÿsgn
);

278 
	}
}

280 
SymbŞ
 
	$T¿n¦©ePo¡fixEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

282 
ex´
->
İ
)

284 
OP_INDEX
:

285  
	`T¿n¦©eA¼ayIndex
(
ex´
);

287 
OP_CALL
:

288  
	`T¿n¦©eFunùiÚC®l
(
ex´
);

290 
OP_MEMBER
:

291 
OP_PTR_MEMBER
:

292  
	`T¿n¦©eMemb”Acûss
(
ex´
);

294 
OP_POSTINC
:

295 
OP_POSTDEC
:

296  
	`T¿n¦©eInüem’t
(
ex´
);

299 
	`as£¹
(0);

300  
NULL
;

302 
	}
}

304 
SymbŞ
 
	$T¿n¦©eCa¡
(
Ty³
 
ty
, Ty³ 
¡y
, 
SymbŞ
 
¤c
)

306 
SymbŞ
 
d¡
;

307 
scode
, 
dcode
, 
İcode
;

309 
dcode
 = 
	`Ty³Code
(
ty
);

310 
scode
 = 
	`Ty³Code
(
¡y
);

312 ià(
dcode
 =ğ
V
)

313  
NULL
;

315 
scode
)

317 
I1
:

318 
İcode
 = 
EXTI1
; ;

320 
I2
:

321 
İcode
 = 
EXTI2
; ;

323 
U1
:

324 
İcode
 = 
EXTU1
; ;

326 
U2
:

327 
İcode
 = 
EXTU2
; ;

329 
I4
:

330 ià(
dcode
 <ğ
U1
)

331 
İcode
 = 
TRUI1
;

332 ià(
dcode
 <ğ
U2
)

333 
İcode
 = 
TRUI2
;

334 ià(
dcode
 =ğ
F4
)

335 
İcode
 = 
CVTI4F4
;

336 ià(
dcode
 =ğ
F8
)

337 
İcode
 = 
CVTI4F8
;

339  
¤c
;

342 
U4
:

343 ià(
dcode
 =ğ
F4
)

344 
İcode
 = 
CVTU4F4
;

345 ià(
dcode
 =ğ
F8
)

346 
İcode
 = 
CVTU4F8
;

348  
¤c
;

351 
F4
:

352 ià(
dcode
 =ğ
I4
)

353 
İcode
 = 
CVTF4I4
;

354 ià(
dcode
 =ğ
U4
)

355 
İcode
 = 
CVTF4U4
;

357 
İcode
 = 
CVTF4
;

360 
F8
:

361 ià(
dcode
 =ğ
I4
)

362 
İcode
 = 
CVTF8I4
;

363 ià(
dcode
 =ğ
U4
)

364 
İcode
 = 
CVTF8U4
;

366 
İcode
 = 
CVTF8
;

370 
	`as£¹
(0);

371  
NULL
;

374 
d¡
 = 
	`C»©eTemp
(
ty
);

375 
	`G’”©eAssign
(
¡y
, 
d¡
, 
İcode
, 
¤c
, 
NULL
);

376  
d¡
;

377 
	}
}

379 
SymbŞ
 
	$T¿n¦©eUÇryEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

381 
SymbŞ
 
¤c
;

383 ià(
ex´
->
İ
 =ğ
OP_NOT
)

385  
	`T¿n¦©eB¿nchEx´essiÚ
(
ex´
);

388 ià(
ex´
->
İ
 =ğ
OP_PREINC
 ||ƒx´->İ =ğ
OP_PREDEC
)

390  
	`T¿n¦©eInüem’t
(
ex´
);

393 
¤c
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[0]);

394 
ex´
->
İ
)

396 
OP_CAST
:

397  
	`T¿n¦©eCa¡
(
ex´
->
ty
,ƒx´->
kids
[0]->ty, 
¤c
);

399 
OP_ADDRESS
:

400  
	`Add»ssOf
(
¤c
);

402 
OP_DEREF
:

403  
	`D”ef
(
ex´
->
ty
, 
¤c
);

405 
OP_NEG
:

406 
OP_COMP
:

407  
	`Sim¶ify
(
ex´
->
ty
, 
OPM­
[ex´->
İ
], 
¤c
, 
NULL
);

410 
	`as£¹
(0);

411  
NULL
;

413 
	}
}

415 
SymbŞ
 
	$T¿n¦©eBš¬yEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

417 
SymbŞ
 
¤c1
, 
¤c2
;

419 ià(
ex´
->
İ
 =ğ
OP_OR
 ||ƒx´->İ =ğ
OP_AND
 || (ex´->İ >ğ
OP_EQUAL
 &&ƒx´->İ <ğ
OP_LESS_EQ
))

421  
	`T¿n¦©eB¿nchEx´essiÚ
(
ex´
);

424 
¤c1
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[0]);

425 
¤c2
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[1]);

426  
	`Sim¶ify
(
ex´
->
ty
, 
OPM­
[ex´->
İ
], 
¤c1
, 
¤c2
);

427 
	}
}

429 
SymbŞ
 
	$T¿n¦©eCÚd™iÚ®Ex´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

431 
SymbŞ
 
t
, 
t1
, 
t2
;

432 
BBlock
 
ŒueBB
, 
çl£BB
, 
ÃxtBB
;

434 
t
 = 
NULL
;

435 ià(
ex´
->
ty
->
ÿ‹g
 !ğ
VOID
)

437 
t
 = 
	`C»©eTemp
(
ex´
->
ty
);

439 
ŒueBB
 = 
	`C»©eBBlock
();

440 
çl£BB
 = 
	`C»©eBBlock
();

441 
ÃxtBB
 = 
	`C»©eBBlock
();

443 
	`T¿n¦©eB¿nch
(
ex´
->
kids
[0], 
ŒueBB
, 
çl£BB
);

445 
	`S¹BBlock
(
çl£BB
);

446 
t1
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[1]->kids[1]);

447 ià(
t1
 !ğ
NULL
)

448 
	`G’”©eMove
(
ex´
->
ty
, 
t
, 
t1
);

449 
	`G’”©eJump
(
ÃxtBB
);

451 
	`S¹BBlock
(
ŒueBB
);

452 
t2
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[1]->kids[0]);

453 ià(
t2
 !ğ
NULL
)

454 
	`G’”©eMove
(
ex´
->
ty
, 
t
, 
t2
);

456 
	`S¹BBlock
(
ÃxtBB
);

457  
t
;

458 
	}
}

460 
SymbŞ
 
	$T¿n¦©eAssignm’tEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

462 
SymbŞ
 
d¡
, 
¤c
;

463 
F›ld
 
æd
 = 
NULL
;

465 
d¡
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[0]);

466 
æd
 = 
d¡
->
v®
.
p
;

467 ià(
ex´
->
İ
 !ğ
OP_ASSIGN
)

469 
ex´
->
kids
[0]->
İ
 = 
OP_ID
;

470 
ex´
->
kids
[0]->
v®
.
p
 =ƒx´->kids[0]->
b™æd
 ? 
	`R—dB™F›ld
(
æd
, 
d¡
) : dst;

472 
¤c
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[1]);

474 ià(
ex´
->
kids
[0]->
b™æd
)

476  
	`Wr™eB™F›ld
(
æd
, 
d¡
, 
¤c
);

478 ià(
d¡
->
kšd
 =ğ
SK_Temp
 && 
	`AsV¬
(d¡)->
def
->
İ
 =ğ
DEREF
)

480 
SymbŞ
 
addr
 = 
	`AsV¬
(
d¡
)->
def
->
¤c1
;

482 
	`G’”©eIndœeùMove
(
ex´
->
ty
, 
addr
, 
¤c
);

483 
d¡
 = 
	`D”ef
(
ex´
->
ty
, 
addr
);

487 
	`G’”©eMove
(
ex´
->
ty
, 
d¡
, 
¤c
);

490  
d¡
;

491 
	}
}

493 
SymbŞ
 
	$T¿n¦©eCommaEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

495 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[0]);

496  
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[1]);

497 
	}
}

499 
SymbŞ
 
	$T¿n¦©eE¼ÜEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

501 
	`as£¹
(0);

502  
NULL
;

503 
	}
}

505 
	$SymbŞ
 (* 
Ex´T¿ns
[])(
A¡Ex´essiÚ
) =

507 
	#OPINFO
(
İ
, 
´ec
, 
Çme
, 
func
, 
İcode
è
T¿n¦©e
##func##
Ex´essiÚ
,

	)

508 
	~"İšfo.h
"

509 #undeà
OPINFO


510 
	}
};

512 
A¡Ex´essiÚ
 
	$NÙ
(
A¡Ex´essiÚ
 
ex´
)

514 
rİs
[] = { 
OP_UNEQUAL
, 
OP_EQUAL
, 
OP_LESS_EQ
, 
OP_GREAT_EQ
, 
OP_LESS
, 
OP_GREAT
 };

515 
A¡Ex´essiÚ
 
t
;

517 
ex´
->
İ
)

519 
OP_OR
:

520 
ex´
->
İ
 = 
OP_AND
;

521 
ex´
->
kids
[0] = 
	`NÙ
(expr->kids[0]);

522 
ex´
->
kids
[1] = 
	`NÙ
(expr->kids[1]);

523  
ex´
;

525 
OP_AND
:

526 
ex´
->
İ
 = 
OP_OR
;

527 
ex´
->
kids
[0] = 
	`NÙ
(expr->kids[0]);

528 
ex´
->
kids
[1] = 
	`NÙ
(expr->kids[1]);

529  
ex´
;

531 
OP_EQUAL
:

532 
OP_UNEQUAL
:

533 
OP_GREAT
:

534 
OP_LESS
:

535 
OP_GREAT_EQ
:

536 
OP_LESS_EQ
:

537 
ex´
->
İ
 = 
rİs
[ex´->İ - 
OP_EQUAL
];

538  
ex´
;

540 
OP_NOT
:

541  
ex´
->
kids
[0];

544 
	`CREATE_AST_NODE
(
t
, 
Ex´essiÚ
);

545 
t
->
coÜd
 = 
ex´
->coord;

546 
t
->
ty
 = 
	`T
(
INT
);

547 
t
->
İ
 = 
OP_NOT
;

548 
t
->
kids
[0] = 
ex´
;

549  
	`FŞdCÚ¡ªt
(
t
);

551 
	}
}

553 
	$T¿n¦©eB¿nch
(
A¡Ex´essiÚ
 
ex´
, 
BBlock
 
ŒueBB
, BBlock 
çl£BB
)

555 
BBlock
 
¹e¡BB
;

556 
SymbŞ
 
¤c1
, 
¤c2
;

557 
Ty³
 
ty
;

559 
ex´
->
İ
)

561 
OP_AND
:

562 
¹e¡BB
 = 
	`C»©eBBlock
();

563 
	`T¿n¦©eB¿nch
(
	`NÙ
(
ex´
->
kids
[0]), 
çl£BB
, 
¹e¡BB
);

564 
	`S¹BBlock
(
¹e¡BB
);

565 
	`T¿n¦©eB¿nch
(
ex´
->
kids
[1], 
ŒueBB
, 
çl£BB
);

568 
OP_OR
:

569 
¹e¡BB
 = 
	`C»©eBBlock
();

570 
	`T¿n¦©eB¿nch
(
ex´
->
kids
[0], 
ŒueBB
, 
¹e¡BB
);

571 
	`S¹BBlock
(
¹e¡BB
);

572 
	`T¿n¦©eB¿nch
(
ex´
->
kids
[1], 
ŒueBB
, 
çl£BB
);

575 
OP_EQUAL
:

576 
OP_UNEQUAL
:

577 
OP_GREAT
:

578 
OP_LESS
:

579 
OP_GREAT_EQ
:

580 
OP_LESS_EQ
:

581 
¤c1
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[0]);

582 
¤c2
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[1]);

583 
	`G’”©eB¿nch
(
ex´
->
kids
[0]->
ty
, 
ŒueBB
, 
OPM­
[ex´->
İ
], 
¤c1
, 
¤c2
);

586 
OP_NOT
:

587 
¤c1
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
->
kids
[0]);

588 
ty
 = 
ex´
->
kids
[0]->ty;

589 ià(
ty
->
ÿ‹g
 < 
INT
)

591 
¤c1
 = 
	`T¿n¦©eCa¡
(
	`T
(
INT
), 
ty
, src1);

592 
ty
 = 
	`T
(
INT
);

594 
	`G’”©eB¿nch
(
ty
, 
ŒueBB
, 
JZ
, 
¤c1
, 
NULL
);

597 
OP_CONST
:

598 ià(! (
ex´
->
v®
.
i
[0] == 0 &&ƒxpr->val.i[1] == 0))

600 
	`G’”©eJump
(
ŒueBB
);

605 
¤c1
 = 
	`T¿n¦©eEx´essiÚ
(
ex´
);

606 ià(
¤c1
->
kšd
 =ğ
SK_CÚ¡ªt
)

608 ià(! (
¤c1
->
v®
.
i
[0] == 0 && src1->val.i[1] == 0))

610 
	`G’”©eJump
(
ŒueBB
);

615 
ty
 = 
ex´
->ty;

616 ià(
ty
->
ÿ‹g
 < 
INT
)

618 
¤c1
 = 
	`T¿n¦©eCa¡
(
	`T
(
INT
), 
ty
, src1);

619 
ty
 = 
	`T
(
INT
);

621 
	`G’”©eB¿nch
(
ty
, 
ŒueBB
, 
JNZ
, 
¤c1
, 
NULL
);

625 
	}
}

627 
SymbŞ
 
	$T¿n¦©eEx´essiÚ
(
A¡Ex´essiÚ
 
ex´
)

629  (* 
Ex´T¿ns
[
ex´
->
İ
])(expr);

630 
	}
}

	@ucl/transtmt.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"¡mt.h
"

4 
	~"ex´.h
"

5 
	~"deş.h
"

6 
	~"g’.h
"

8 
T¿n¦©eS‹m’t
(
A¡S‹m’t
 
¡mt
);

15 
	$HasSideEfãù
(
A¡Ex´essiÚ
 
ex´
)

17 ià(
ex´
 =ğ
NULL
)

21 ià(
ex´
->
İ
 =ğ
OP_ID
 &&ƒx´->
ty
->
qu®
 & 
VOLATILE
)

25 ià(
ex´
->
İ
 =ğ
OP_CALL
)

29 ià(
ex´
->
İ
 >ğ
OP_ASSIGN
 &&ƒx´->İ <ğ
OP_MOD_ASSIGN
 ||

30 
ex´
->
İ
 =ğ
OP_PREINC
 ||ƒx´->İ =ğ
OP_PREDEC
 ||

31 
ex´
->
İ
 =ğ
OP_POSTINC
 ||ƒx´->İ =ğ
OP_POSTDEC
)

34  
	`HasSideEfãù
(
ex´
->
kids
[0]) || HasSideEffect(expr->kids[1]);

35 
	}
}

40 
	$T¿n¦©eEx´essiÚS‹m’t
(
A¡S‹m’t
 
¡mt
)

42 
A¡Ex´essiÚS‹m’t
 
ex´Stmt
 = 
	`AsEx´
(
¡mt
);

44 ià(
ex´Stmt
->
ex´
 !ğ
NULL
)

46 
	`T¿n¦©eEx´essiÚ
(
ex´Stmt
->
ex´
);

48 
	}
}

53 
	$T¿n¦©eLab–S‹m’t
(
A¡S‹m’t
 
¡mt
)

55 
A¡Lab–S‹m’t
 
Ïb–Stmt
 = 
	`AsLab–
(
¡mt
);

58 ià(
Ïb–Stmt
->
Ïb–
->
»f
 > 0)

62 ià(
Ïb–Stmt
->
Ïb–
->
»¥BB
 =ğ
NULL
)

64 
Ïb–Stmt
->
Ïb–
->
»¥BB
 = 
	`C»©eBBlock
();

66 
	`S¹BBlock
(
Ïb–Stmt
->
Ïb–
->
»¥BB
);

68 
	`T¿n¦©eS‹m’t
(
Ïb–Stmt
->
¡mt
);

69 
	}
}

74 
	$T¿n¦©eCa£S‹m’t
(
A¡S‹m’t
 
¡mt
)

76 
A¡Ca£S‹m’t
 
ÿ£Stmt
 = 
	`AsCa£
(
¡mt
);

80 
	`S¹BBlock
(
ÿ£Stmt
->
»¥BB
);

81 
	`T¿n¦©eS‹m’t
(
ÿ£Stmt
->
¡mt
);

82 
	}
}

87 
	$T¿n¦©eDeçuÉS‹m’t
(
A¡S‹m’t
 
¡mt
)

89 
A¡DeçuÉS‹m’t
 
defStmt
 = 
	`AsDef
(
¡mt
);

93 
	`S¹BBlock
(
defStmt
->
»¥BB
);

94 
	`T¿n¦©eS‹m’t
(
defStmt
->
¡mt
);

95 
	}
}

117 
	$T¿n¦©eIfS‹m’t
(
A¡S‹m’t
 
¡mt
)

119 
A¡IfS‹m’t
 
ifStmt
 = 
	`AsIf
(
¡mt
);

120 
BBlock
 
ÃxtBB
;

121 
BBlock
 
ŒueBB
;

122 
BBlock
 
çl£BB
;

124 
ÃxtBB
 = 
	`C»©eBBlock
();

125 
ŒueBB
 = 
	`C»©eBBlock
();

127 ià(
ifStmt
->
–£Stmt
 =ğ
NULL
)

129 
	`T¿n¦©eB¿nch
(
	`NÙ
(
ifStmt
->
ex´
), 
ÃxtBB
, 
ŒueBB
);

131 
	`S¹BBlock
(
ŒueBB
);

132 
	`T¿n¦©eS‹m’t
(
ifStmt
->
th’Stmt
);

136 
çl£BB
 = 
	`C»©eBBlock
();

138 
	`T¿n¦©eB¿nch
(
	`NÙ
(
ifStmt
->
ex´
), 
çl£BB
, 
ŒueBB
);

140 
	`S¹BBlock
(
ŒueBB
);

141 
	`T¿n¦©eS‹m’t
(
ifStmt
->
th’Stmt
);

142 
	`G’”©eJump
(
ÃxtBB
);

144 
	`S¹BBlock
(
çl£BB
);

145 
	`T¿n¦©eS‹m’t
(
ifStmt
->
–£Stmt
);

148 
	`S¹BBlock
(
ÃxtBB
);

149 
	}
}

163 
	$T¿n¦©eWheS‹m’t
(
A¡S‹m’t
 
¡mt
)

165 
A¡LoİS‹m’t
 
wheStmt
 = 
	`AsLoİ
(
¡mt
);

167 
wheStmt
->
loİBB
 = 
	`C»©eBBlock
();

168 
wheStmt
->
cÚtBB
 = 
	`C»©eBBlock
();

169 
wheStmt
->
ÃxtBB
 = 
	`C»©eBBlock
();

171 
	`G’”©eJump
(
wheStmt
->
cÚtBB
);

173 
	`S¹BBlock
(
wheStmt
->
loİBB
);

174 
	`T¿n¦©eS‹m’t
(
wheStmt
->
¡mt
);

176 
	`S¹BBlock
(
wheStmt
->
cÚtBB
);

177 
	`T¿n¦©eB¿nch
(
wheStmt
->
ex´
, wheStmt->
loİBB
, wheStmt->
ÃxtBB
);

179 
	`S¹BBlock
(
wheStmt
->
ÃxtBB
);

180 
	}
}

193 
	$T¿n¦©eDoS‹m’t
(
A¡S‹m’t
 
¡mt
)

195 
A¡LoİS‹m’t
 
doStmt
 = 
	`AsLoİ
(
¡mt
);

197 
doStmt
->
loİBB
 = 
	`C»©eBBlock
();

198 
doStmt
->
cÚtBB
 = 
	`C»©eBBlock
();

199 
doStmt
->
ÃxtBB
 = 
	`C»©eBBlock
();

201 
	`S¹BBlock
(
doStmt
->
loİBB
);

202 
	`T¿n¦©eS‹m’t
(
doStmt
->
¡mt
);

204 
	`S¹BBlock
(
doStmt
->
cÚtBB
);

205 
	`T¿n¦©eB¿nch
(
doStmt
->
ex´
, doStmt->
loİBB
, doStmt->
ÃxtBB
);

207 
	`S¹BBlock
(
doStmt
->
ÃxtBB
);

208 
	}
}

228 
	$T¿n¦©eFÜS‹m’t
(
A¡S‹m’t
 
¡mt
)

230 
A¡FÜS‹m’t
 
fÜStmt
 = 
	`AsFÜ
(
¡mt
);

232 
fÜStmt
->
loİBB
 = 
	`C»©eBBlock
();

233 
fÜStmt
->
cÚtBB
 = 
	`C»©eBBlock
();

234 
fÜStmt
->
‹¡BB
 = 
	`C»©eBBlock
();

235 
fÜStmt
->
ÃxtBB
 = 
	`C»©eBBlock
();

237 ià(
fÜStmt
->
š™Ex´
)

239 
	`T¿n¦©eEx´essiÚ
(
fÜStmt
->
š™Ex´
);

241 
	`G’”©eJump
(
fÜStmt
->
‹¡BB
);

243 
	`S¹BBlock
(
fÜStmt
->
loİBB
);

244 
	`T¿n¦©eS‹m’t
(
fÜStmt
->
¡mt
);

246 
	`S¹BBlock
(
fÜStmt
->
cÚtBB
);

247 ià(
fÜStmt
->
šüEx´
)

249 
	`T¿n¦©eEx´essiÚ
(
fÜStmt
->
šüEx´
);

252 
	`S¹BBlock
(
fÜStmt
->
‹¡BB
);

253 ià(
fÜStmt
->
ex´
)

255 
	`T¿n¦©eB¿nch
(
fÜStmt
->
ex´
, fÜStmt->
loİBB
, fÜStmt->
ÃxtBB
);

259 
	`G’”©eJump
(
fÜStmt
->
loİBB
);

262 
	`S¹BBlock
(
fÜStmt
->
ÃxtBB
);

263 
	}
}

273 
	$T¿n¦©eGÙoS‹m’t
(
A¡S‹m’t
 
¡mt
)

275 
A¡GÙoS‹m’t
 
gÙoStmt
 = 
	`AsGÙo
(
¡mt
);

279 ià(
gÙoStmt
->
Ïb–
->
»¥BB
 =ğ
NULL
)

281 
gÙoStmt
->
Ïb–
->
»¥BB
 = 
	`C»©eBBlock
();

283 
	`G’”©eJump
(
gÙoStmt
->
Ïb–
->
»¥BB
);

284 
	`S¹BBlock
(
	`C»©eBBlock
());

285 
	}
}

297 
	$T¿n¦©eB»akS‹m’t
(
A¡S‹m’t
 
¡mt
)

299 
A¡B»akS‹m’t
 
brkStmt
 = 
	`AsB»ak
(
¡mt
);

301 ià(
brkStmt
->
rg‘
->
kšd
 =ğ
NK_Sw™chS‹m’t
)

303 
	`G’”©eJump
(
	`AsSw™ch
(
brkStmt
->
rg‘
)->
ÃxtBB
);

307 
	`G’”©eJump
(
	`AsLoİ
(
brkStmt
->
rg‘
)->
ÃxtBB
);

309 
	`S¹BBlock
(
	`C»©eBBlock
());

310 
	}
}

321 
	$T¿n¦©eCÚtšueS‹m’t
(
A¡S‹m’t
 
¡mt
)

323 
A¡CÚtšueS‹m’t
 
cÚtStmt
 = 
	`AsCÚt
(
¡mt
);

325 
	`G’”©eJump
(
cÚtStmt
->
rg‘
->
cÚtBB
);

326 
	`S¹BBlock
(
	`C»©eBBlock
());

327 
	}
}

333 
	$T¿n¦©eR‘uºS‹m’t
(
A¡S‹m’t
 
¡mt
)

335 
A¡R‘uºS‹m’t
 
»tStmt
 = 
	`AsR‘
(
¡mt
);

337 ià(
»tStmt
->
ex´
)

339 
	`G’”©eR‘uº
(
»tStmt
->
ex´
->
ty
, 
	`T¿n¦©eEx´essiÚ
(retStmt->expr));

341 
	`G’”©eJump
(
FSYM
->
ex™BB
);

342 
	`S¹BBlock
(
	`C»©eBBlock
());

343 
	}
}

348 
	$M”geSw™chBuck‘
(
Sw™chBuck‘
 *
pBuck‘
)

350 
Sw™chBuck‘
 
buck‘
 = *
pBuck‘
;

351 
couÁ
 = 0;

353 
buck‘
->
´ev
)

355 ià((
buck‘
->
´ev
->
nÿ£
 + buck‘->nÿ£ + 1è* 2 <ğ(buck‘->
maxV®
 - buck‘->´ev->
mšV®
))

358 
buck‘
->
´ev
->
nÿ£
 += bucket->ncase;

359 
buck‘
->
´ev
->
maxV®
 = bucket->maxVal;

360 *
buck‘
->
´ev
->

 = buck‘->
ÿ£s
;

361 
buck‘
->
´ev
->

 = bucket->tail;

362 
buck‘
ğbuck‘->
´ev
;

363 
couÁ
++;

366 *
pBuck‘
 = 
buck‘
;

367  
couÁ
;

368 
	}
}

379 
	$T¿n¦©eSw™chBuck‘s
(
Sw™chBuck‘
 *
buck‘A¼ay
, 
Ëá
, 
right
,

380 
SymbŞ
 
choiû
, 
BBlock
 
cu¼BB
, BBlock 
defBB
)

382 
mid
, 
Ën
, 
i
;

383 
A¡Ca£S‹m’t
 
p
;

384 
BBlock
 
lh®fBB
, 
rh®fBB
;

385 
BBlock
 *
d¡BBs
;

386 
SymbŞ
 
šdex
;

388 ià(
Ëá
 > 
right
)

391 
mid
 = (
Ëá
 + 
right
) / 2;

392 
lh®fBB
 = (
Ëá
 > 
mid
 - 1è? 
defBB
 : 
	`C»©eBBlock
();

393 
rh®fBB
 = (
mid
 + 1 > 
right
è? 
defBB
 : 
	`C»©eBBlock
();

395 
Ën
 = 
buck‘A¼ay
[
mid
]->
maxV®
 - buck‘A¼ay[mid]->
mšV®
 + 1;

397 
d¡BBs
 = 
	`H—pAÎoÿ‹
(
Cu¼’tH—p
, (
Ën
 + 1)* (
BBlock
));

398 
i
 = 0; i < 
Ën
; ++i)

399 
d¡BBs
[
i
] = 
defBB
;

400 
d¡BBs
[
Ën
] = 
NULL
;

402 
p
 = 
buck‘A¼ay
[
mid
]->
ÿ£s
;

403 
p
)

405 
i
 = 
p
->
ex´
->
v®
.i[0] - 
buck‘A¼ay
[
mid
]->
mšV®
;

406 
d¡BBs
[
i
] = 
p
->
»¥BB
;

407 
p
 =…->
ÃxtCa£
;

410 ià(
cu¼BB
 !ğ
NULL
)

412 
	`S¹BBlock
(
cu¼BB
);

414 
	`G’”©eB¿nch
(
choiû
->
ty
, 
lh®fBB
, 
JL
, choiû, 
	`IÁCÚ¡ªt
(
buck‘A¼ay
[
mid
]->
mšV®
));

416 
	`S¹BBlock
(
	`C»©eBBlock
());

417 
	`G’”©eB¿nch
(
choiû
->
ty
, 
rh®fBB
, 
JG
, choiû, 
	`IÁCÚ¡ªt
(
buck‘A¼ay
[
mid
]->
maxV®
));

419 
	`S¹BBlock
(
	`C»©eBBlock
());

421 ià(
Ën
 != 1)

423 
šdex
 = 
	`C»©eTemp
(
choiû
->
ty
);

424 
	`G’”©eAssign
(
choiû
->
ty
, 
šdex
, 
SUB
, choiû, 
	`IÁCÚ¡ªt
(
buck‘A¼ay
[
mid
]->
mšV®
));

425 
	`G’”©eIndœeùJump
(
d¡BBs
, 
Ën
, 
šdex
);

429 
	`G’”©eJump
(
d¡BBs
[0]);

432 
	`S¹BBlock
(
	`C»©eBBlock
());

434 
	`T¿n¦©eSw™chBuck‘s
(
buck‘A¼ay
, 
Ëá
, 
mid
 - 1, 
choiû
, 
lh®fBB
, 
defBB
);

435 
	`T¿n¦©eSw™chBuck‘s
(
buck‘A¼ay
, 
mid
 + 1, 
right
, 
choiû
, 
rh®fBB
, 
defBB
);

437 
	}
}

461 
	$T¿n¦©eSw™chS‹m’t
(
A¡S‹m’t
 
¡mt
)

463 
A¡Sw™chS‹m’t
 
swtchStmt
 = 
	`AsSw™ch
(
¡mt
);

464 
A¡Ca£S‹m’t
 
p
, 
q
;

465 
Sw™chBuck‘
 
buck‘
, 
b
;

466 
Sw™chBuck‘
 *
buck‘A¼ay
;

467 
i
, 
v®
;

468 
SymbŞ
 
sym
;

470 
sym
 = 
	`T¿n¦©eEx´essiÚ
(
swtchStmt
->
ex´
);

472 
buck‘
 = 
b
 = 
NULL
;

473 
p
 = 
swtchStmt
->
ÿ£s
;

474 
p
)

476 
q
 = 
p
;

477 
p
 =…->
ÃxtCa£
;

479 
q
->
»¥BB
 = 
	`C»©eBBlock
();

480 
v®
 = 
q
->
ex´
->v®.
i
[0];

481 ià(
buck‘
 && (buck‘->
nÿ£
 + 1è* 2 > (
v®
 - buck‘->
mšV®
))

483 
buck‘
->
nÿ£
++;

484 
buck‘
->
maxV®
 = 
v®
;

485 *
buck‘
->

 = 
q
;

486 
buck‘
->

 = &(
q
->
ÃxtCa£
);

487 
swtchStmt
->
nbuck‘
 -ğ
	`M”geSw™chBuck‘
(&
buck‘
);

491 
	`ALLOC
(
b
);

493 
b
->
ÿ£s
 = 
q
;

494 
b
->
nÿ£
 = 1;

495 
b
->
mšV®
 = b->
maxV®
 = 
v®
;

496 
b
->

 = &(
q
->
ÃxtCa£
);

497 
b
->
´ev
 = 
buck‘
;

498 
buck‘
 = 
b
;

499 
swtchStmt
->
nbuck‘
++;

502 
swtchStmt
->
buck‘s
 = 
buck‘
;

504 
buck‘A¼ay
 = 
	`H—pAÎoÿ‹
(
Cu¼’tH—p
, 
swtchStmt
->
nbuck‘
 * (
Sw™chBuck‘
));

506 
i
 = 
swtchStmt
->
nbuck‘
 - 1; i >= 0; i--)

508 
buck‘A¼ay
[
i
] = 
buck‘
;

509 *
buck‘
->

 = 
NULL
;

510 
buck‘
 = buck‘->
´ev
;

513 
swtchStmt
->
defBB
 = 
	`C»©eBBlock
();

514 ià(
swtchStmt
->
defStmt
)

516 
swtchStmt
->
defStmt
->
»¥BB
 = swtchStmt->
defBB
;

517 
swtchStmt
->
ÃxtBB
 = 
	`C»©eBBlock
();

521 
swtchStmt
->
ÃxtBB
 = swtchStmt->
defBB
;

523 
	`T¿n¦©eSw™chBuck‘s
(
buck‘A¼ay
, 0, 
swtchStmt
->
nbuck‘
 - 1, 
sym
, 
NULL
, swtchStmt->
defBB
);

524 
	`T¿n¦©eS‹m’t
(
swtchStmt
->
¡mt
);

525 
	`S¹BBlock
(
swtchStmt
->
ÃxtBB
);

526 
	}
}

528 
	$T¿n¦©eCompoundS‹m’t
(
A¡S‹m’t
 
¡mt
)

530 
A¡CompoundS‹m’t
 
compStmt
 = 
	`AsComp
(
¡mt
);

531 
A¡Node
 
p
 = 
compStmt
->
¡mts
;

532 
VeùÜ
 
oÿls
 = 
compStmt
->ilocals;

533 
SymbŞ
 
v
;

534 
i
;

536 
i
 = 0; i < 
	`LEN
(
oÿls
); ++i)

538 
In™D©a
 
š™d
;

539 
Ty³
 
ty
;

540 
SymbŞ
 
d¡
, 
¤c
;

541 
size
;

543 
v
 = 
	`GET_ITEM
(
oÿls
, 
i
);

544 
š™d
 = 
	`AsV¬
(
v
)->
id©a
;

545 
size
 = 0;

546 
š™d
 !ğ
NULL
)

548 ià(
š™d
->
off£t
 !ğ
size
)

550 
d¡
 = 
	`C»©eOff£t
(
	`T
(
UCHAR
), 
v
, 
size
);

551 
	`G’”©eCË¬
(
d¡
, 
š™d
->
off£t
 - 
size
);

553 
ty
 = 
š™d
->
ex´
->ty;

554 ià(
š™d
->
ex´
->
İ
 =ğ
OP_STR
)

556 
SŒšg
 
¡r
 = 
š™d
->
ex´
->
v®
.
p
;

558 
¤c
 = 
	`AddSŒšg
(
	`A¼ayOf
(
¡r
->
Ën
 + 1, 
ty
->
bty
), str);

562 
¤c
 = 
	`T¿n¦©eEx´essiÚ
(
š™d
->
ex´
);

564 
d¡
 = 
	`C»©eOff£t
(
ty
, 
v
, 
š™d
->
off£t
);

565 
	`G’”©eMove
(
ty
, 
d¡
, 
¤c
);

567 
size
 = 
š™d
->
off£t
 + 
ty
->size;

568 
š™d
 = in™d->
Ãxt
;

570 ià(
size
 < 
v
->
ty
->size)

572 
d¡
 = 
	`C»©eOff£t
(
	`T
(
UCHAR
), 
v
, 
size
);

573 
	`G’”©eCË¬
(
d¡
, 
v
->
ty
->
size
 - size);

577 
p
)

579 
	`T¿n¦©eS‹m’t
((
A¡S‹m’t
)
p
);

580 
p
 =…->
Ãxt
;

583 
	}
}

585 (* 
StmtT¿ns
[])(
A¡S‹m’t
) =

587 
T¿n¦©eEx´essiÚS‹m’t
,

588 
T¿n¦©eLab–S‹m’t
,

589 
T¿n¦©eCa£S‹m’t
,

590 
T¿n¦©eDeçuÉS‹m’t
,

591 
T¿n¦©eIfS‹m’t
,

592 
T¿n¦©eSw™chS‹m’t
,

593 
T¿n¦©eWheS‹m’t
,

594 
T¿n¦©eDoS‹m’t
,

595 
T¿n¦©eFÜS‹m’t
,

596 
T¿n¦©eGÙoS‹m’t
,

597 
T¿n¦©eB»akS‹m’t
,

598 
T¿n¦©eCÚtšueS‹m’t
,

599 
T¿n¦©eR‘uºS‹m’t
,

600 
T¿n¦©eCompoundS‹m’t


601 
	}
};

603 
	$T¿n¦©eS‹m’t
(
A¡S‹m’t
 
¡mt
)

605 (* 
StmtT¿ns
[
¡mt
->
kšd
 - 
NK_Ex´essiÚS‹m’t
])(stmt);

606 
	}
}

608 
	$T¿n¦©eFunùiÚ
(
A¡FunùiÚ
 
func
)

610 
BBlock
 
bb
;

612 
FSYM
 = 
func
->
fsym
;

613 ià(! 
FSYM
->
defšed
)

616 
TempNum
 = 0;

617 
FSYM
->
’ŒyBB
 = 
	`C»©eBBlock
();

618 
FSYM
->
ex™BB
 = 
	`C»©eBBlock
();

620 
Cu¼’tBB
 = 
FSYM
->
’ŒyBB
;

621 
	`T¿n¦©eS‹m’t
(
func
->
¡mt
);

622 
	`S¹BBlock
(
FSYM
->
ex™BB
);

624 
	`O±imize
(
FSYM
);

626 
bb
 = 
FSYM
->
’ŒyBB
;

627 
bb
 !ğ
NULL
)

629 ià(
bb
->
»f
 != 0)

631 
bb
->
sym
 = 
	`C»©eLab–
();

633 
bb
 = bb->
Ãxt
;

635 
	}
}

637 
	$T¿n¦©e
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
)

639 
A¡Node
 
p
 = 
ŒªsUn™
->
extDeşs
;

641 
p
)

643 ià(
p
->
kšd
 =ğ
NK_FunùiÚ
 && ((
A¡FunùiÚ
í)->
¡mt
)

645 
	`T¿n¦©eFunùiÚ
((
A¡FunùiÚ
)
p
);

647 
p
 =…->
Ãxt
;

649 
	}
}

	@ucl/type.c

1 
	~"uş.h
"

2 
	~"ouut.h
"

3 
	~"ty³.h
"

4 
	~"cÚfig.h
"

6 
ty³
 
	gTy³s
[
VOID
 - 
CHAR
 + 1];

7 
Ty³
 
	gDeçuÉFunùiÚTy³
;

8 
Ty³
 
	gWCh¬Ty³
;

13 
Ty³
 
	$PromÙe
(
Ty³
 
ty
)

15  
ty
->
ÿ‹g
 < 
INT
 ? 
	`T
(INTè: (ty->ÿ‹g =ğ
FLOAT
 ? T(
DOUBLE
) :y);

16 
	}
}

22 
	$IsCom·tibËFunùiÚ
(
FunùiÚTy³
 
áy1
, FunùiÚTy³ 
áy2
)

24 
SigÇtu»
 
sig1
 = 
áy1
->
sig
;

25 
SigÇtu»
 
sig2
 = 
áy2
->
sig
;

26 
P¬am‘”
 
p1
, 
p2
;

27 
·rL’1
, 
·rL’2
;

28 
i
;

31 ià(! 
	`IsCom·tibËTy³
(
áy1
->
bty
, 
áy2
->bty))

34 ià(! 
sig1
->
hasPrÙo
 && ! 
sig2
->hasProto)

38 ià(
sig1
->
hasPrÙo
 && 
sig2
->hasProto)

40 
·rL’1
 = 
	`LEN
(
sig1
->
·¿ms
);

41 
·rL’2
 = 
	`LEN
(
sig2
->
·¿ms
);

43 ià((
sig1
->
hasEÎ£
 ^ 
sig2
->hasEÎ£è|| (
·rL’1
 !ğ
·rL’2
))

46 
i
 = 0; i < 
·rL’1
; ++i)

48 
p1
 = (
P¬am‘”
)
	`GET_ITEM
(
sig1
->
·¿ms
, 
i
);

49 
p2
 = (
P¬am‘”
)
	`GET_ITEM
(
sig2
->
·¿ms
, 
i
);

51 ià(! 
	`IsCom·tibËTy³
(
p1
->
ty
, 
p2
->ty))

57 ià(! 
sig1
->
hasPrÙo
 && 
sig2
->hasProto)

59 
sig1
 = 
áy2
->
sig
;

60 
sig2
 = 
áy1
->
sig
;

61 
mix_´Ùo
;

65 
mix_´Ùo
:

66 
·rL’1
 = 
	`LEN
(
sig1
->
·¿ms
);

67 
·rL’2
 = 
	`LEN
(
sig2
->
·¿ms
);

69 ià(
sig1
->
hasEÎ£
)

72 ià(
·rL’2
 == 0)

74 
	`FOR_EACH_ITEM
(
P¬am‘”
, 
p1
, 
sig1
->
·¿ms
)

75 ià(! 
	`IsCom·tibËTy³
(
	`PromÙe
(
p1
->
ty
),…1->ty))

77 
ENDFOR


81 ià(
·rL’1
 !ğ
·rL’2
)

87 
i
 = 0; i < 
·rL’1
; ++i)

89 
p1
 = (
P¬am‘”
)
	`GET_ITEM
(
sig1
->
·¿ms
, 
i
);

90 
p2
 = (
P¬am‘”
)
	`GET_ITEM
(
sig2
->
·¿ms
, 
i
);

92 ià(! 
	`IsCom·tibËTy³
(
p1
->
ty
, 
	`PromÙe
(
p2
->ty)))

98 
	}
}

104 
	$IsCom·tibËTy³
(
Ty³
 
ty1
, Ty³ 
ty2
)

106 ià(
ty1
 =ğ
ty2
)

109 ià(
ty1
->
qu®
 !ğ
ty2
->qual)

112 
ty1
 = 
	`Unqu®
(ty1);

113 
ty2
 = 
	`Unqu®
(ty2);

115 ià(
ty1
->
ÿ‹g
 =ğ
ENUM
 && 
ty2
 =ğty1->
bty
 ||

116 
ty2
->
ÿ‹g
 =ğ
ENUM
 && 
ty1
 =ğty2->
bty
)

119 ià(
ty1
->
ÿ‹g
 !ğ
ty2
->categ)

122 
ty1
->
ÿ‹g
)

124 
POINTER
:

125  
	`IsCom·tibËTy³
(
ty1
->
bty
, 
ty2
->bty);

127 
ARRAY
:

128  
	`IsCom·tibËTy³
(
ty1
->
bty
, 
ty2
->bty) &&

129 (
ty1
->
size
 =ğ
ty2
->size ||y1->size == 0 ||y2->size == 0);

131 
FUNCTION
:

132  
	`IsCom·tibËFunùiÚ
((
FunùiÚTy³
)
ty1
, (FunùiÚTy³)
ty2
);

135  
ty1
 =ğ
ty2
;

137 
	}
}

147 
Ty³
 
	$Enum
(*
id
)

149 
EnumTy³
 
‘y
;

151 
	`ALLOC
(
‘y
);

153 
‘y
->
ÿ‹g
 = 
ENUM
;

154 
‘y
->
id
 = id;

157 
‘y
->
bty
 = 
	`T
(
INT
);

158 
‘y
->
size
 =ƒty->
bty
->size;

159 
‘y
->
®ign
 =ƒty->
bty
->align;

160 
‘y
->
qu®
 = 0;

162  (
Ty³
)
‘y
;

163 
	}
}

168 
Ty³
 
	$Qu®ify
(
qu®
, 
Ty³
 
ty
)

170 
Ty³
 
qty
;

172 ià(
qu®
 =ğ0 || qu® =ğ
ty
->qual)

173  
ty
;

175 
	`ALLOC
(
qty
);

176 *
qty
 = *
ty
;

177 
qty
->
qu®
 |= qual;

178 ià(
ty
->
qu®
 != 0)

180 
qty
->
bty
 = 
ty
->bty;

184 
qty
->
bty
 = 
ty
;

186  
qty
;

187 
	}
}

192 
Ty³
 
	$Unqu®
(
Ty³
 
ty
)

194 ià(
ty
->
qu®
)

195 
ty
 =y->
bty
;

196  
ty
;

197 
	}
}

202 
Ty³
 
	$A¼ayOf
(
Ën
, 
Ty³
 
ty
)

204 
Ty³
 
©y
;

206 
	`ALLOC
(
©y
);

208 
©y
->
ÿ‹g
 = 
ARRAY
;

209 
©y
->
qu®
 = 0;

210 
©y
->
size
 = 
Ën
 * 
ty
->size;

211 
©y
->
®ign
 = 
ty
->align;

212 
©y
->
bty
 = 
ty
;

214  (
Ty³
)
©y
;

215 
	}
}

220 
Ty³
 
	$Poš‹rTo
(
Ty³
 
ty
)

222 
Ty³
 
±y
;

224 
	`ALLOC
(
±y
);

226 
±y
->
ÿ‹g
 = 
POINTER
;

227 
±y
->
qu®
 = 0;

228 
±y
->
®ign
 = 
	`T
(
POINTER
)->align;

229 
±y
->
size
 = 
	`T
(
POINTER
)->size;

230 
±y
->
bty
 = 
ty
;

232  
±y
;

233 
	}
}

238 
Ty³
 
	$FunùiÚR‘uº
(
Ty³
 
ty
, 
SigÇtu»
 
sig
)

240 
FunùiÚTy³
 
áy
;

242 
	`ALLOC
(
áy
);

244 
áy
->
ÿ‹g
 = 
FUNCTION
;

245 
áy
->
qu®
 = 0;

246 
áy
->
size
 = 
	`T
(
POINTER
)->size;

247 
áy
->
®ign
 = 
	`T
(
POINTER
)->align;

248 
áy
->
sig
 = sig;

249 
áy
->
bty
 = 
ty
;

251  (
Ty³
)
áy
;

252 
	}
}

257 
Ty³
 
	$S¹RecÜd
(*
id
, 
ÿ‹g
)

259 
RecÜdTy³
 
¹y
;

261 
	`ALLOC
(
¹y
);

262 
	`mem£t
(
¹y
, 0, (*rty));

264 
¹y
->
ÿ‹g
 = categ;

265 
¹y
->
id
 = id;

266 
¹y
->

ğ&¹y->
æds
;

268  (
Ty³
)
¹y
;

269 
	}
}

276 
F›ld
 
	$AddF›ld
(
Ty³
 
ty
, *
id
, Ty³ 
áy
, 
b™s
)

278 
RecÜdTy³
 
¹y
 = (RecÜdTy³)
ty
;

279 
F›ld
 
æd
;

281 ià(
áy
->
size
 == 0)

283 
	`as£¹
(
áy
->
ÿ‹g
 =ğ
ARRAY
);

284 
¹y
->
hasFËxA¼ay
 = 1;

286 ià(
áy
->
qu®
 & 
CONST
)

288 
¹y
->
hasCÚ¡Fld
 = 1;

291 
	`ALLOC
(
æd
);

293 
æd
->
id
 = id;

294 
æd
->
ty
 = 
áy
;

295 
æd
->
b™s
 = bits;

296 
æd
->
pos
 = fld->
off£t
 = 0;

297 
æd
->
Ãxt
 = 
NULL
;

299 *
¹y
->

 = 
æd
;

300 
¹y
->

 = &(
æd
->
Ãxt
);

302  
æd
;

303 
	}
}

308 
F›ld
 
	$LookupF›ld
(
Ty³
 
ty
, *
id
)

310 
RecÜdTy³
 
¹y
 = (RecÜdTy³)
ty
;

311 
F›ld
 
æd
 = 
¹y
->
æds
;

313 
æd
 !ğ
NULL
)

316 ià(
æd
->
id
 =ğ
NULL
 && 
	`IsRecÜdTy³
(æd->
ty
))

318 
F›ld
 
p
;

320 
p
 = 
	`LookupF›ld
(
æd
->
ty
, 
id
);

321 ià(
p
)

322  
p
;

324 ià(
æd
->
id
 == id)

325  
æd
;

327 
æd
 = fld->
Ãxt
;

330  
NULL
;

331 
	}
}

337 
	$AddOff£t
(
RecÜdTy³
 
¹y
, 
off£t
)

339 
F›ld
 
æd
 = 
¹y
->
æds
;

342 
æd
)

344 
æd
->
off£t
 += offset;

345 ià(
æd
->
id
 =ğ
NULL
 && 
	`IsRecÜdTy³
(æd->
ty
))

347 
	`AddOff£t
((
RecÜdTy³
)
æd
->
ty
, fld->
off£t
);

349 
æd
 = fld->
Ãxt
;

352 
	}
}

359 
	$EndRecÜd
(
Ty³
 
ty
)

361 
RecÜdTy³
 
¹y
 = (RecÜdTy³)
ty
;

362 
F›ld
 
æd
 = 
¹y
->
æds
;

363 
b™s
 = 0;

364 
štB™s
 = 
	`T
(
INT
)->
size
 * 8;

366 ià(
¹y
->
ÿ‹g
 =ğ
STRUCT
)

368 
æd
)

371 
æd
->
off£t
 = 
¹y
->
size
 = 
	`ALIGN
Ôty->size, fld->
ty
->
®ign
);

372 ià(
æd
->
id
 =ğ
NULL
 && 
	`IsRecÜdTy³
(æd->
ty
))

374 
	`AddOff£t
((
RecÜdTy³
)
æd
->
ty
, fld->
off£t
);

376 ià(
æd
->
b™s
 == 0)

380 ià(
b™s
 != 0)

382 
æd
->
off£t
 = 
¹y
->
size
 = 
	`ALIGN
Ôty->siz+ 
	`T
(
INT
)->size, fld->
ty
->
®ign
);

384 
b™s
 = 0;

385 
¹y
->
size
 =„ty->siz+ 
æd
->
ty
->size;

387 ià(
b™s
 + 
æd
->b™ <ğ
štB™s
)

390 
æd
->
pos
 = 
LITTLE_ENDIAN
 ? 
b™s
 : 
štB™s
 - bits;

391 
b™s
 = b™ + 
æd
->bits;

392 ià(
b™s
 =ğ
štB™s
)

394 
¹y
->
size
 +ğ
	`T
(
INT
)->size;

395 
b™s
 = 0;

402 
¹y
->
size
 +ğ
	`T
(
INT
)->size;

403 
æd
->
off£t
 +ğ
	`T
(
INT
)->
size
;

404 
æd
->
pos
 = 
LITTLE_ENDIAN
 ? 0 : 
štB™s
 - fld->
b™s
;

405 
b™s
 = 
æd
->bits;

407 ià(
æd
->
ty
->
®ign
 > 
¹y
->align)

409 
¹y
->
®ign
 = 
æd
->
ty
->align;

412 
æd
 = fld->
Ãxt
;

414 ià(
b™s
 != 0)

416 
¹y
->
size
 +ğ
	`T
(
INT
)->size;

418 
¹y
->
size
 = 
	`ALIGN
Ôty->size,„ty->
®ign
);

422 
æd
)

424 ià(
æd
->
ty
->
®ign
 > 
¹y
->align)

426 
¹y
->
®ign
 = 
æd
->
ty
->align;

428 ià(
æd
->
ty
->
size
 > 
¹y
->size)

430 
¹y
->
size
 = 
æd
->
ty
->size;

432 
æd
 = fld->
Ãxt
;

435 
	}
}

440 
Ty³
 
	$Compos™eTy³
(
Ty³
 
ty1
, Ty³ 
ty2
)

443 
	`as£¹
(
	`IsCom·tibËTy³
(
ty1
, 
ty2
));

445 ià(
ty1
->
ÿ‹g
 =ğ
ENUM
)

446  
ty1
;

448 ià(
ty2
->
ÿ‹g
 =ğ
ENUM
)

449  
ty2
;

451 
ty1
->
ÿ‹g
)

453 
POINTER
:

454  
	`Qu®ify
(
ty1
->
qu®
, 
	`Poš‹rTo
(
	`Compos™eTy³
Ñy1->
bty
, 
ty2
->bty)));

456 
ARRAY
:

457  
ty1
->
size
 !ğ0 ?y1 : 
ty2
;

459 
FUNCTION
:

461 
FunùiÚTy³
 
áy1
 = (FunùiÚTy³)
ty1
;

462 
FunùiÚTy³
 
áy2
 = (FunùiÚTy³)
ty2
;

464 
áy1
->
bty
 = 
	`Compos™eTy³
(áy1->bty, 
áy2
->bty);

465 ià(
áy1
->
sig
->
hasPrÙo
 && 
áy2
->sig->hasProto)

467 
P¬am‘”
 
p1
, 
p2
;

468 
i
, 
Ën
 = 
	`LEN
(
áy1
->
sig
->
·¿ms
);

470 
i
 = 0; i < 
Ën
; ++i)

472 
p1
 = (
P¬am‘”
)
	`GET_ITEM
(
áy1
->
sig
->
·¿ms
, 
i
);

473 
p2
 = (
P¬am‘”
)
	`GET_ITEM
(
áy2
->
sig
->
·¿ms
, 
i
);

474 
p1
->
ty
 = 
	`Compos™eTy³
Õ1->ty, 
p2
->ty);

477  
ty1
;

480  
áy1
->
sig
->
hasPrÙo
 ? 
ty1
 : 
ty2
;

484  
ty1
;

486 
	}
}

491 
Ty³
 
	$CommÚR—lTy³
(
Ty³
 
ty1
, Ty³ 
ty2
)

493 ià(
ty1
->
ÿ‹g
 =ğ
LONGDOUBLE
 || 
ty2
->categ == LONGDOUBLE)

494  
	`T
(
LONGDOUBLE
);

496 ià(
ty1
->
ÿ‹g
 =ğ
DOUBLE
 || 
ty2
->categ == DOUBLE)

497  
	`T
(
DOUBLE
);

499 ià(
ty1
->
ÿ‹g
 =ğ
FLOAT
 || 
ty2
->categ == FLOAT)

500  
	`T
(
FLOAT
);

502 
ty1
 =y1->
ÿ‹g
 < 
INT
 ? 
	`T
(INT) :y1;

503 
ty2
 =y2->
ÿ‹g
 < 
INT
 ? 
	`T
(INT) :y2;

505 ià(
ty1
->
ÿ‹g
 =ğ
ty2
->categ)

506  
ty1
;

508 ià((
	`IsUnsigÃd
(
ty1
è^ IsUnsigÃd(
ty2
)) == 0)

509  
ty1
->
ÿ‹g
 > 
ty2
->categ ?y1 :y2;

511 ià(
	`IsUnsigÃd
(
ty2
))

513 
Ty³
 
ty
;

515 
ty
 = 
ty1
;

516 
ty1
 = 
ty2
;

517 
ty2
 = 
ty
;

520 ià(
ty1
->
ÿ‹g
 >ğ
ty2
->categ)

521  
ty1
;

523 ià(
ty2
->
size
 > 
ty1
->size)

524  
ty2
;

526  
	`T
(
ty2
->
ÿ‹g
 + 1);

528 
	}
}

533 
Ty³
 
	$Adju¡P¬am‘”
(
Ty³
 
ty
)

535 
ty
 = 
	`Unqu®
(ty);

537 ià(
ty
->
ÿ‹g
 =ğ
ARRAY
)

538  
	`Poš‹rTo
(
ty
->
bty
);

540 ià(
ty
->
ÿ‹g
 =ğ
FUNCTION
)

541  
	`Poš‹rTo
(
ty
);

543  
ty
;

544 
	}
}

558 
	$Ty³Code
(
Ty³
 
ty
)

560 
İty³s
[] = {
I1
, 
U1
, 
I2
, 
U2
, 
I4
, 
U4
, I4, U4, I4, U4, I4, 
F4
, 
F8
, F8, U4, 
V
, 
B
, B, B};

562 
	`as£¹
(
ty
->
ÿ‹g
 !ğ
FUNCTION
);

563  
İty³s
[
ty
->
ÿ‹g
];

564 
	}
}

569 * 
	$Ty³ToSŒšg
(
Ty³
 
ty
)

571 
qu®
;

572 *
¡r
;

573 *
Çmes
[] =

580 ià(
ty
->
qu®
 != 0)

582 
qu®
 = 
ty
->qual;

583 
ty
 = 
	`Unqu®
(ty);

585 ià(
qu®
 =ğ
CONST
)

586 
¡r
 = "const";

587 ià(
qu®
 =ğ
VOLATILE
)

588 
¡r
 = "volatile";

590 
¡r
 = "const volatile";

592  
	`FÜm©Name
("% %s", 
¡r
, 
	`Ty³ToSŒšg
(
ty
));

595 ià(
ty
->
ÿ‹g
 >ğ
CHAR
 &&y->ÿ‹g <ğ
LONGDOUBLE
 &&y->ÿ‹g !ğ
ENUM
)

596  
Çmes
[
ty
->
ÿ‹g
];

598 
ty
->
ÿ‹g
)

600 
ENUM
:

601  
	`FÜm©Name
("’um %s", ((
EnumTy³
)
ty
)->
id
);

603 
POINTER
:

604  
	`FÜm©Name
("% *", 
	`Ty³ToSŒšg
(
ty
->
bty
));

606 
UNION
:

607  
	`FÜm©Name
("uniÚ %s", ((
RecÜdTy³
)
ty
)->
id
);

609 
STRUCT
:

610  
	`FÜm©Name
("¡ruù %s", ((
RecÜdTy³
)
ty
)->
id
);

612 
ARRAY
:

613  
	`FÜm©Name
("%s[%d]", 
	`Ty³ToSŒšg
(
ty
->
bty
),y->
size
 /y->bty->size);

615 
VOID
:

618 
FUNCTION
:

620 
FunùiÚTy³
 
áy
 = (FunùiÚTy³)
ty
;

622  
	`FÜm©Name
("% ()", 
	`Ty³ToSŒšg
(
áy
->
bty
));

626 
	`as£¹
(0);

627  
NULL
;

629 
	}
}

634 
	$S‘upTy³Sy¡em
()

636 
i
;

637 
FunùiÚTy³
 
áy
;

639 
	`T
(
CHAR
)->
size
 = T(
UCHAR
)->sizğ
CHAR_SIZE
;

640 
	`T
(
SHORT
)->
size
 = T(
USHORT
)->sizğ
SHORT_SIZE
;

641 
	`T
(
INT
)->
size
 = T(
UINT
)->sizğ
INT_SIZE
;

642 
	`T
(
LONG
)->
size
 = T(
ULONG
)->sizğ
LONG_SIZE
;

643 
	`T
(
LONGLONG
)->
size
 = T(
ULONGLONG
)->sizğ
LONG_LONG_SIZE
;

644 
	`T
(
FLOAT
)->
size
 = 
FLOAT_SIZE
;

645 
	`T
(
DOUBLE
)->
size
 = 
DOUBLE_SIZE
;

646 
	`T
(
LONGDOUBLE
)->
size
 = 
LONG_DOUBLE_SIZE
;

647 
	`T
(
POINTER
)->
size
 = 
INT_SIZE
;

649 
i
 = 
CHAR
; i <ğ
VOID
; ++i)

651 
	`T
(
i
)->
ÿ‹g
 = i;

652 
	`T
(
i
)->
®ign
 = T(i)->
size
;

655 
	`ALLOC
(
áy
);

656 
áy
->
ÿ‹g
 = 
FUNCTION
;

657 
áy
->
qu®
 = 0;

658 
áy
->
®ign
 = fty->
size
 = 
	`T
(
POINTER
)->size;

659 
áy
->
bty
 = 
	`T
(
INT
);

660 
	`ALLOC
(
áy
->
sig
);

661 
	`CALLOC
(
áy
->
sig
->
·¿ms
);

662 
áy
->
sig
->
hasPrÙo
 = 0;

663 
áy
->
sig
->
hasEÎ£
 = 0;

665 
DeçuÉFunùiÚTy³
 = (
Ty³
)
áy
;

666 
WCh¬Ty³
 = 
	`T
(
WCHAR
);

667 
	}
}

	@ucl/type.h

1 #iâdeà
__TYPE_H_


2 
	#__TYPE_H_


	)

6 
	mCHAR
, 
	mUCHAR
, 
	mSHORT
, 
	mUSHORT
, 
	mINT
, 
	mUINT
, 
	mLONG
, 
	mULONG
, 
	mLONGLONG
, 
	mULONGLONG
, 
	mENUM
,

7 
	mFLOAT
, 
	mDOUBLE
, 
	mLONGDOUBLE
, 
	mPOINTER
, 
	mVOID
, 
	mUNION
, 
	mSTRUCT
, 
	mARRAY
, 
	mFUNCTION


10 ’um { 
	mCONST
 = 0x1, 
	mVOLATILE
 = 0x2 };

12 ’um {
	mI1
, 
	mU1
, 
	mI2
, 
	mU2
, 
	mI4
, 
	mU4
, 
	mF4
, 
	mF8
, 
	mV
, 
	mB
};

14 
	#TYPE_COMMON
 \

	)

15 
	gÿ‹g
 : 8; \

16 
	gqu®
 : 8; \

17 
	g®ign
 : 16; \

18 
	gsize
; \

19 
ty³
 *
	gbty
;

21 
	sty³


23 
	mTYPE_COMMON


24 } *
	tTy³
;

26 
	sf›ld


28 
	moff£t
;

29 *
	mid
;

30 
	mb™s
;

31 
	mpos
;

32 
Ty³
 
	mty
;

33 
f›ld
 *
	mÃxt
;

34 } *
	tF›ld
;

36 
	s»cÜdTy³


38 
TYPE_COMMON


39 *
	mid
;

40 
F›ld
 
	mæds
;

41 
F›ld
 *
	m
;

42 
	mhasCÚ¡Fld
 : 16;

43 
	mhasFËxA¼ay
 : 16;

44 } *
	tRecÜdTy³
;

46 
	s’umTy³


48 
TYPE_COMMON


49 *
	mid
;

50 } *
	tEnumTy³
;

52 
	s·¿m‘”


54 *
	mid
;

55 
Ty³
 
	mty
;

56 
	m»g
;

57 } *
	tP¬am‘”
;

59 
	ssigÇtu»


61 
	mhasPrÙo
 : 16;

62 
	mhasEÎ£
 : 16;

63 
VeùÜ
 
	m·¿ms
;

64 } *
	tSigÇtu»
;

66 
	sfunùiÚTy³


68 
TYPE_COMMON


69 
SigÇtu»
 
	msig
;

70 } *
	tFunùiÚTy³
;

72 
	#T
(
ÿ‹g
è(
Ty³s
 + c©eg)

	)

74 
	#IsIÁegTy³
(
ty
èÑy->
ÿ‹g
 <ğ
ENUM
)

	)

75 
	#IsUnsigÃd
(
ty
èÑy->
ÿ‹g
 & 0x1)

	)

76 
	#IsR—lTy³
(
ty
èÑy->
ÿ‹g
 >ğ
FLOAT
 &&y->ÿ‹g <ğ
LONGDOUBLE
)

	)

77 
	#IsAr™hTy³
(
ty
èÑy->
ÿ‹g
 <ğ
LONGDOUBLE
)

	)

78 
	#IsSÿÏrTy³
(
ty
èÑy->
ÿ‹g
 <ğ
POINTER
)

	)

79 
	#IsPŒTy³
(
ty
èÑy->
ÿ‹g
 =ğ
POINTER
)

	)

80 
	#IsRecÜdTy³
(
ty
èÑy->
ÿ‹g
 =ğ
STRUCT
 ||y->ÿ‹g =ğ
UNION
)

	)

81 
	#IsFunùiÚTy³
(
ty
èÑy->
ÿ‹g
 =ğ
FUNCTION
)

	)

83 
	#IsObjeùPŒ
(
ty
èÑy->
ÿ‹g
 =ğ
POINTER
 &&y->
bty
->
size
 !ğ0 &&y->bty->ÿ‹g !ğ
FUNCTION
)

	)

84 
	#IsIncom¶‘ePŒ
(
ty
èÑy->
ÿ‹g
 =ğ
POINTER
 &&y->
bty
->
size
 =ğ0)

	)

85 
	#IsVoidPŒ
(
ty
èÑy->
ÿ‹g
 =ğ
POINTER
 &&y->
bty
->ÿ‹g =ğ
VOID
)

	)

86 
	#NÙFunùiÚPŒ
(
ty
èÑy->
ÿ‹g
 =ğ
POINTER
 &&y->
bty
->ÿ‹g !ğ
FUNCTION
)

	)

88 
	#BÙhIÁegTy³
(
ty1
, 
ty2
è(
	`IsIÁegTy³
Ñy1è&& IsIÁegTy³Ñy2))

	)

89 
	#BÙhAr™hTy³
(
ty1
, 
ty2
è(
	`IsAr™hTy³
Ñy1è&& IsAr™hTy³Ñy2))

	)

90 
	#BÙhSÿÏrTy³
(
ty1
, 
ty2
è(
	`IsSÿÏrTy³
Ñy1è&& IsSÿÏrTy³Ñy2))

	)

91 
	#IsCom·tibËPŒ
(
ty1
, 
ty2
è(
	`IsPŒTy³
Ñy1è&& IsPŒTy³Ñy2è&& \

	)

92 
IsCom·tibËTy³
(
Unqu®
(
ty1
->
bty
), Unqu®(
ty2
->bty)))

94 
Ty³Code
(
Ty³
 
ty
);

95 
Ty³
 
Enum
(*
id
);

96 
Ty³
 
Qu®ify
(
qu®
, Ty³ 
ty
);

97 
Ty³
 
Unqu®
(Ty³ 
ty
);

98 
Ty³
 
Poš‹rTo
(Ty³ 
ty
);

99 
Ty³
 
A¼ayOf
(
Ën
, Ty³ 
ty
);

100 
Ty³
 
FunùiÚR‘uº
(Ty³ 
ty
, 
SigÇtu»
 
sig
);

101 
Ty³
 
PromÙe
(Ty³ 
ty
);

103 
Ty³
 
S¹RecÜd
(*
id
, 
ÿ‹g
);

104 
F›ld
 
AddF›ld
(
Ty³
 
ty
, *
id
, Ty³ 
áy
, 
b™s
);

105 
F›ld
 
LookupF›ld
(
Ty³
 
ty
, *
id
);

106 
EndRecÜd
(
Ty³
 
ty
);

108 
IsCom·tibËTy³
(
Ty³
 
ty1
, Ty³ 
ty2
);

109 
Ty³
 
Compos™eTy³
(Ty³ 
ty1
, Ty³ 
ty2
);

110 
Ty³
 
CommÚR—lTy³
(Ty³ 
ty1
, Ty³ 
ty2
);

111 
Ty³
 
Adju¡P¬am‘”
(Ty³ 
ty
);

112 * 
Ty³ToSŒšg
(
Ty³
 
ty
);

114 
S‘upTy³Sy¡em
();

116 
Ty³
 
DeçuÉFunùiÚTy³
;

117 
Ty³
 
WCh¬Ty³
;

118 
ty³
 
Ty³s
[
VOID
 - 
CHAR
 + 1];

	@ucl/ucl.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"rg‘.h
"

6 
	gDumpAST
;

8 
	gDumpIR
;

10 
FILE
 *
	gASTFe
;

12 
FILE
 *
	gIRFe
;

14 
FILE
 *
	gASMFe
;

16 *
	gExtName
 = ".s";

18 
H—p
 
	gCu¼’tH—p
;

20 
HEAP
(
Prog¿mH—p
);

22 
HEAP
(
FeH—p
);

24 
HEAP
(
SŒšgH—p
);

26 
	gW¬nšgCouÁ
;

28 
	gE¼ÜCouÁ
;

29 
VeùÜ
 
	gExŒaWh™eS·û
;

30 
VeùÜ
 
	gExŒaKeywÜds
;

32 
	$In™Ÿlize
()

34 
Cu¼’tH—p
 = &
FeH—p
;

35 
E¼ÜCouÁ
 = 
W¬nšgCouÁ
 = 0;

36 
	`In™SymbŞTabË
();

37 
ASTFe
 = 
IRFe
 = 
ASMFe
 = 
NULL
;

38 
	}
}

40 
	$Fš®ize
()

42 
	`F»eH—p
(&
FeH—p
);

43 
	}
}

45 
	$Compe
(*
fe
)

47 
A¡T¿n¦©iÚUn™
 
ŒªsUn™
;

49 
	`In™Ÿlize
();

52 
ŒªsUn™
 = 
	`P¬£T¿n¦©iÚUn™
(
fe
);

55 
	`CheckT¿n¦©iÚUn™
(
ŒªsUn™
);

57 ià(
E¼ÜCouÁ
 != 0)

58 
ex™
;

60 ià(
DumpAST
)

62 
	`DumpT¿n¦©iÚUn™
(
ŒªsUn™
);

66 
	`T¿n¦©e
(
ŒªsUn™
);

68 ià(
DumpIR
)

70 
	`DAs£mT¿n¦©iÚUn™
(
ŒªsUn™
);

74 
	`Em™T¿n¦©iÚUn™
(
ŒªsUn™
);

76 
ex™
:

77 
	`Fš®ize
();

78 
	}
}

80 
	$AddWh™eS·û
(*
¡r
)

82 *
p
, *
q
;

84 
ExŒaWh™eS·û
 = 
	`C»©eVeùÜ
(1);

85 
p
 = 
¡r
;

86 (
q
 = 
	`¡rchr
(
p
, ',')è!ğ
NULL
)

88 *
q
 = 0;

89 
	`INSERT_ITEM
(
ExŒaWh™eS·û
, 
p
);

90 
p
 = 
q
 + 1;

92 
	`INSERT_ITEM
(
ExŒaWh™eS·û
, 
p
);

93 
	}
}

95 
	$AddKeywÜd
(*
¡r
)

97 *
p
, *
q
;

99 
ExŒaKeywÜds
 = 
	`C»©eVeùÜ
(1);

100 
p
 = 
¡r
;

101 (
q
 = 
	`¡rchr
(
p
, ',')è!ğ
NULL
)

103 *
q
 = 0;

104 
	`INSERT_ITEM
(
ExŒaKeywÜds
, 
p
);

105 
p
 = 
q
 + 1;

107 
	`INSERT_ITEM
(
ExŒaKeywÜds
, 
p
);

108 
	}
}

110 
	$P¬£CommªdLše
(
¬gc
, *
¬gv
[])

112 
i
;

114 
i
 = 0; i < 
¬gc
; ++i)

116 ià(
	`¡ºcmp
(
¬gv
[
i
], "-ext:", 5) == 0)

118 
ExtName
 = 
¬gv
[
i
] + 5;

120 ià(
	`¡rcmp
(
¬gv
[
i
], "-ignore") == 0)

122 
i
++;

123 
	`AddWh™eS·û
(
¬gv
[
i
]);

125 ià(
	`¡rcmp
(
¬gv
[
i
], "-keyword") == 0)

127 
i
++;

128 
	`AddKeywÜd
(
¬gv
[
i
]);

130 ià(
	`¡rcmp
(
¬gv
[
i
], "--dump-ast") == 0)

132 
DumpAST
 = 1;

134 ià(
	`¡rcmp
(
¬gv
[
i
], "--dump-IR") == 0)

136 
DumpIR
 = 1;

139  
i
;

141  
i
;

142 
	}
}

149 
	$maš
(
¬gc
, *
¬gv
[])

151 
i
;

153 
Cu¼’tH—p
 = &
Prog¿mH—p
;

154 
¬gc
--; 
¬gv
++;

155 
i
 = 
	`P¬£CommªdLše
(
¬gc
, 
¬gv
);

157 
	`S‘upRegi¡”s
();

158 
	`S‘upLex”
();

159 
	`S‘upTy³Sy¡em
();

160 ; 
i
 < 
¬gc
; ++i)

162 
	`Compe
(
¬gv
[
i
]);

165  (
E¼ÜCouÁ
 != 0);

166 
	}
}

	@ucl/ucl.h

1 #iâdeà
__UCC_H_


2 
	#__UCC_H_


	)

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<¡d¬g.h
>

7 
	~<as£¹.h
>

8 
	~<lim™s.h
>

9 
	~<”ºo.h
>

10 
	~<¡ršg.h
>

11 
	~<ùy³.h
>

13 
	~"šput.h
"

14 
	~"”rÜ.h
"

15 
	~"®loc.h
"

16 
	~"veùÜ.h
"

17 
	~"¡r.h
"

18 
	~"Ëx.h
"

19 
	~"ty³.h
"

20 
	~"symbŞ.h
"

23 
	#ALIGN
(
size
, 
®ign
è((siz+‡ligÀ- 1è& (~×ligÀ- 1)))

	)

25 
VeùÜ
 
ExŒaWh™eS·û
;

26 
VeùÜ
 
ExŒaKeywÜds
;

27 
FILE
 *
ASTFe
;

28 
FILE
 *
IRFe
;

29 
FILE
 *
ASMFe
;

30 *
ExtName
;

31 
H—p
 
Cu¼’tH—p
;

32 
h—p
 
Prog¿mH—p
;

33 
h—p
 
FeH—p
;

34 
h—p
 
SŒšgH—p
;

35 
W¬nšgCouÁ
;

36 
E¼ÜCouÁ
;

	@ucl/uildasm.c

1 
	~"uş.h
"

2 
	~"ouut.h
"

3 
	~"a¡.h
"

4 
	~"deş.h
"

5 
	~"g’.h
"

7 
	#DST
 
š¡
->
İds
[0]

	)

8 
	#SRC1
 
š¡
->
İds
[1]

	)

9 
	#SRC2
 
š¡
->
İds
[2]

	)

11 *
	gOPCodeNames
[] =

13 
	#OPCODE
(
code
, 
Çme
, 
func
èÇme,

	)

14 
	~"İcode.h
"

15 #undeà
OPCODE


18 
	$DAs£mUIL
(
IRIn¡
 
š¡
)

20 
İ
 = 
š¡
->
İcode
;

22 
	`årštf
(
IRFe
, "\t");

23 
İ
)

25 
BOR
:

26 
BXOR
:

27 
BAND
:

28 
LSH
:

29 
RSH
:

30 
ADD
:

31 
SUB
:

32 
MUL
:

33 
DIV
:

34 
MOD
:

35 
	`årštf
(
IRFe
, "% ğ% % %s", 
DST
->
Çme
, 
SRC1
->Çme, 
OPCodeNames
[
İ
], 
SRC2
->name);

38 
INC
:

39 
DEC
:

40 
	`årštf
(
IRFe
, "%s%s", 
OPCodeNames
[
İ
], 
DST
->
Çme
);

43 
BCOM
:

44 
NEG
:

45 
ADDR
:

46 
DEREF
:

47 
	`årštf
(
IRFe
, "% ğ%s%s", 
DST
->
Çme
, 
OPCodeNames
[
İ
], 
SRC1
->name);

50 
MOV
:

51 
	`årštf
(
IRFe
, "% ğ%s", 
DST
->
Çme
, 
SRC1
->name);

54 
IMOV
:

55 
	`årštf
(
IRFe
, "*% ğ%s", 
DST
->
Çme
, 
SRC1
->name);

58 
JE
:

59 
JNE
:

60 
JG
:

61 
JL
:

62 
JGE
:

63 
JLE
:

64 
	`årštf
(
IRFe
, "ià(% % %sègÙØ%s", 
SRC1
->
Çme
, 
OPCodeNames
[
İ
],

65 
SRC2
->
Çme
, ((
BBlock
)
DST
)->
sym
->name);

68 
JZ
:

69 
	`årštf
(
IRFe
, "ià(! %sègÙØ%s", 
SRC1
->
Çme
, ((
BBlock
)
DST
)->
sym
->name);

72 
JNZ
:

73 
	`årštf
(
IRFe
, "ià(%sègÙØ%s", 
SRC1
->
Çme
, ((
BBlock
)
DST
)->
sym
->name);

76 
JMP
:

77 
	`årštf
(
IRFe
, "gÙØ%s", ((
BBlock
)
DST
)->
sym
->
Çme
);

80 
IJMP
:

82 
BBlock
 *
p
 = (BBlock *)
DST
;

84 
	`årštf
(
IRFe
, "goto (");

85 *
p
 !ğ
NULL
)

87 
	`årštf
(
IRFe
, "%s,", (*
p
)->
sym
->
Çme
);

88 
p
++;

90 
	`årštf
(
IRFe
, ")[%s]", 
SRC1
->
Çme
);

94 
CALL
:

96 
ILArg
 
¬g
;

97 
VeùÜ
 
¬gs
 = (VeùÜ)
SRC2
;

98 
i
;

100 ià(
DST
 !ğ
NULL
)

102 
	`årštf
(
IRFe
, "% ğ", 
DST
->
Çme
);

104 
	`årštf
(
IRFe
, "%s(", 
SRC1
->
Çme
);

105 
i
 = 0; i < 
	`LEN
(
¬gs
); ++i)

107 
¬g
 = 
	`GET_ITEM
(
¬gs
, 
i
);

108 ià(
i
 !ğ
	`LEN
(
¬gs
) - 1)

109 
	`årštf
(
IRFe
, "%s, ", 
¬g
->
sym
->
Çme
);

111 
	`årštf
(
IRFe
, "%s", 
¬g
->
sym
->
Çme
);

113 
	`årštf
(
IRFe
, ")");

117 
RET
:

118 
	`årštf
(
IRFe
, "»tuº %s", 
DST
->
Çme
);

122 
	`årštf
(
IRFe
, "% ğ%s%s", 
DST
->
Çme
, 
OPCodeNames
[
İ
], 
SRC1
->name);

125 
	`årštf
(
IRFe
, ";\n");

126 
	}
}

128 
	$DAs£mFunùiÚ
(
A¡FunùiÚ
 
func
)

130 
FunùiÚSymbŞ
 
fsym
 = 
func
->fsym;

131 
BBlock
 
bb
 = 
fsym
->
’ŒyBB
;

132 
IRIn¡
 
š¡
;

134 ià(! 
fsym
->
defšed
)

137 
	`årštf
(
IRFe
, "funùiÚ %s\n", 
fsym
->
Çme
);

139 
bb
 !ğ
NULL
)

141 ià(
bb
->
»f
 != 0)

143 
	`årštf
(
IRFe
, "%s:\n", 
bb
->
sym
->
Çme
);

145 
š¡
 = 
bb
->
š¡h
.
Ãxt
;

146 
š¡
 !ğ&
bb
->
š¡h
)

148 
	`DAs£mUIL
(
š¡
);

149 
š¡
 = in¡->
Ãxt
;

151 
bb
 = bb->
Ãxt
;

153 ià(
fsym
->
ex™BB
->
Å»d
 != 0)

154 
	`årštf
(
IRFe
, "\tret\n");

156 
	`årštf
(
IRFe
, "\n\n");

157 
	}
}

159 
	$DAs£mT¿n¦©iÚUn™
(
A¡T¿n¦©iÚUn™
 
ŒªsUn™
)

161 
A¡Node
 
p
 = 
ŒªsUn™
->
extDeşs
;

163 
IRFe
 = 
	`C»©eOuut
(
IÅut
.
f’ame
, ".uil");

165 
p
)

167 ià(
p
->
kšd
 =ğ
NK_FunùiÚ
)

169 
	`DAs£mFunùiÚ
((
A¡FunùiÚ
)
p
);

171 
p
 =…->
Ãxt
;

174 
	`fşo£
(
IRFe
);

175 
	}
}

	@ucl/vector.c

1 
	~"uş.h
"

7 
VeùÜ
 
	$C»©eVeùÜ
(
size
)

9 
VeùÜ
 
v
 = 
NULL
;

11 
	`ALLOC
(
v
);

12 
v
->
d©a
 = (**)
	`H—pAÎoÿ‹
(
Cu¼’tH—p
, 
size
 * (*));

13 
v
->
size
 = size;

14 
v
->
Ën
 = 0;

15  
v
;

16 
	}
}

21 
	$Ex·ndVeùÜ
(
VeùÜ
 
v
)

23 *
Üig
;

25 
Üig
 = 
v
->
d©a
;

26 
v
->
d©a
 = 
	`H—pAÎoÿ‹
(
Cu¼’tH—p
, v->
size
 * 2 * (*));

27 
	`memıy
(
v
->
d©a
, 
Üig
, v->
size
 * (*));

28 
v
->
size
 *= 2;

29 
	}
}

	@ucl/vector.h

1 #iâdeà
__VECTOR_H_


2 
	#__VECTOR_H_


	)

4 
	sveùÜ


6 **
	md©a
;

7 
	mËn
;

8 
	msize
;

9 } *
	tVeùÜ
;

11 
	#LEN
(
v
è(v->
Ën
)

	)

13 
	#INSERT_ITEM
(
v
, 
™em
è\

	)

15 ià(
	gv
->
	gËn
 >ğ
v
->
size
) \

16 
Ex·ndVeùÜ
(
v
); \

17 
	gv
->
	gd©a
[
v
->
Ën
] = 
™em
; \

18 
	gv
->
	gËn
++; \

21 
	#GET_ITEM
(
v
, 
i
è(v->
d©a
[i])

	)

23 
	#TOP_ITEM
(
v
è(v->
Ën
 =ğ0 ? 
NULL
 : v->
d©a
[v->ËÀ- 1])

	)

25 
	#FOR_EACH_ITEM
(
ty
, 
™em
, 
v
è\

	)

27 
Ën
 = 
v
->len; \

28 
i
 = 0; \

29 
i
 = 0; i < 
Ën
; i++) \

31 
™em
 = (
ty
)
v
->
d©a
[
i
];

33 
	#ENDFOR
 \

	)

35 
	}
}

37 
VeùÜ
 
C»©eVeùÜ
(
size
);

38 
Ex·ndVeùÜ
(
VeùÜ
 
v
);

	@ucl/x86.c

1 
	~"uş.h
"

2 
	~"a¡.h
"

3 
	~"ex´.h
"

4 
	~"g’.h
"

5 
	~"»g.h
"

6 
	~"rg‘.h
"

7 
	~"ouut.h
"

9 
Sw™chTabËNum
;

10 
	eASMCode


12 
	#TEMPLATE
(
code
, 
¡r
ècode,

	)

13 
	~"x86wš32.l
"

14 #undeà
TEMPLATE


17 
	#ASM_CODE
(
İcode
, 
tcode
è((İcod<< 2è+cod- 
I4
)

	)

18 
	#DST
 
š¡
->
İds
[0]

	)

19 
	#SRC1
 
š¡
->
İds
[1]

	)

20 
	#SRC2
 
š¡
->
İds
[2]

	)

21 
	#IsNÜm®RecÜd
(
¹y
èÔty->
size
 !ğ1 &&„ty->siz!ğ2 &&„ty->siz!ğ4 &&„ty->siz!ğ8)

	)

22 
	#PRESERVE_REGS
 4

	)

23 
	#SCRATCH_REGS
 4

	)

24 
	#STACK_ALIGN_SIZE
 4

	)

26 
SymbŞ
 
	gX87Tİ
;

27 
	gX87TCode
;

32 
	$Move
(
code
, 
SymbŞ
 
d¡
, SymbŞ 
¤c
)

34 
SymbŞ
 
İds
[2];

36 
İds
[0] = 
d¡
;

37 
İds
[1] = 
¤c
;

38 
	`PutASMCode
(
code
, 
İds
);

39 
	}
}

44 
	$AddV¬ToReg
(
SymbŞ
 
»g
, SymbŞ 
v
)

46 
v
->
lšk
 = 
»g
->link;

47 
»g
->
lšk
 = 
v
;

48 
v
->
»g
 =„eg;

49 
	}
}

56 
	$ModifyV¬
(
SymbŞ
 
p
)

58 
SymbŞ
 
»g
;

60 ià(
p
->
»g
 =ğ
NULL
)

63 
p
->
Ãedwb
 = 0;

64 
»g
 = 
p
->reg;

65 
	`SplReg
(
»g
);

67 
	`AddV¬ToReg
(
»g
, 
p
);

68 
p
->
Ãedwb
 = 1;

69 
	}
}

74 
	$AÎoÿ‹Reg
(
IRIn¡
 
š¡
, 
šdex
)

76 
SymbŞ
 
»g
;

77 
SymbŞ
 
p
;

79 
p
 = 
š¡
->
İds
[
šdex
];

82 ià(
p
->
kšd
 !ğ
SK_Temp
)

86 ià(
p
->
»g
 !ğ
NULL
)

88 
U£dRegs
 |ğ1 << 
p
->
»g
->
v®
.
i
[0];

95 ià(
šdex
 =ğ0 && 
SRC1
->
»f
 =ğ1 && SRC1->
»g
 !ğ
NULL
)

97 
»g
 = 
SRC1
->reg;

98 
»g
->
lšk
 = 
NULL
;

99 
	`AddV¬ToReg
(
»g
, 
p
);

105 
»g
 = 
	`G‘Reg
();

106 ià(
šdex
 != 0)

108 
	`Move
(
X86_MOVI4
, 
»g
, 
p
);

110 
	`AddV¬ToReg
(
»g
, 
p
);

111 
	}
}

119 
	$SaveX87Tİ
()

121 ià(
X87Tİ
 =ğ
NULL
)

124 ià(
X87Tİ
->
Ãedwb
 && X87Tİ->
»f
 > 0)

126 
	`PutASMCode
(
X86_STF4
 + 
X87TCode
 - 
F4
, &
X87Tİ
);

128 
X87Tİ
 = 
NULL
;

129 
	}
}

134 
	$Em™X87B¿nch
(
IRIn¡
 
š¡
, 
tcode
)

137 
	`SplReg
(
X86Regs
[
EAX
]);

138 
	`PutASMCode
(
X86_LDF4
 + 
tcode
 - 
F4
, &
SRC1
);

139 
	`PutASMCode
(
	`ASM_CODE
(
š¡
->
İcode
, 
tcode
), in¡->
İds
);

140 
	}
}

145 
	$Em™X87Move
(
IRIn¡
 
š¡
, 
tcode
)

148 ià(
X87Tİ
 !ğ
SRC1
)

150 
	`SaveX87Tİ
();

151 
	`PutASMCode
(
X86_LDF4
 + 
tcode
 - 
F4
, &
SRC1
);

155 ià(
DST
->
kšd
 !ğ
SK_Temp
)

157 
	`PutASMCode
(
X86_STF4
 + 
tcode
 - 
F4
, &
DST
);

158 
X87Tİ
 = 
NULL
;

162 
DST
->
Ãedwb
 = 1;

163 
X87Tİ
 = 
DST
;

164 
X87TCode
 = 
tcode
;

166 
	}
}

171 
	$Em™X87Assign
(
IRIn¡
 
š¡
, 
tcode
)

174 ià(
SRC1
 !ğ
X87Tİ
)

176 
	`SaveX87Tİ
();

177 
	`PutASMCode
(
X86_LDF4
 + 
tcode
 - 
F4
, &
SRC1
);

180 
	`PutASMCode
(
	`ASM_CODE
(
š¡
->
İcode
, 
tcode
), in¡->
İds
);

183 ià(
DST
->
kšd
 !ğ
SK_Temp
)

185 
	`PutASMCode
(
X86_STF4
 + 
tcode
 - 
F4
, 
š¡
->
İds
);

186 
X87Tİ
 = 
NULL
;

190 
DST
->
Ãedwb
 = 1;

191 
X87Tİ
 = 
DST
;

192 
X87TCode
 = 
tcode
;

194 
	}
}

199 
	$Em™MoveBlock
(
IRIn¡
 
š¡
)

201 
	`SplReg
(
X86Regs
[
EDI
]);

202 
	`SplReg
(
X86Regs
[
ESI
]);

203 
	`SplReg
(
X86Regs
[
ECX
]);

205 
SRC2
 = 
	`IÁCÚ¡ªt
(
š¡
->
ty
->
size
);

206 
	`PutASMCode
(
X86_MOVB
, 
š¡
->
İds
);

207 
	}
}

212 
	$Em™Move
(
IRIn¡
 
š¡
)

214 
tcode
 = 
	`Ty³Code
(
š¡
->
ty
);

215 
SymbŞ
 
»g
;

217 ià(
tcode
 =ğ
F4
 ||cod=ğ
F8
)

219 
	`Em™X87Move
(
š¡
, 
tcode
);

223 ià(
tcode
 =ğ
B
)

225 
	`Em™MoveBlock
(
š¡
);

229 
tcode
)

231 
I1
: 
U1
:

232 ià(
SRC1
->
kšd
 =ğ
SK_CÚ¡ªt
)

234 
	`Move
(
X86_MOVI1
, 
DST
, 
SRC1
);

238 
»g
 = 
	`G‘By‹Reg
();

239 
	`Move
(
X86_MOVI1
, 
»g
, 
SRC1
);

240 
	`Move
(
X86_MOVI1
, 
DST
, 
»g
);

244 
I2
: 
U2
:

245 ià(
SRC1
->
kšd
 =ğ
SK_CÚ¡ªt
)

247 
	`Move
(
X86_MOVI2
, 
DST
, 
SRC1
);

251 
»g
 = 
	`G‘WÜdReg
();

252 
	`Move
(
X86_MOVI2
, 
»g
, 
SRC1
);

253 
	`Move
(
X86_MOVI2
, 
DST
, 
»g
);

257 
I4
: 
U4
:

258 ià(
SRC1
->
kšd
 =ğ
SK_CÚ¡ªt
)

260 
	`Move
(
X86_MOVI4
, 
DST
, 
SRC1
);

264 
	`AÎoÿ‹Reg
(
š¡
, 1);

265 
	`AÎoÿ‹Reg
(
š¡
, 0);

266 ià(
SRC1
->
»g
 =ğ
NULL
 && 
DST
->reg == NULL)

268 
»g
 = 
	`G‘Reg
();

269 
	`Move
(
X86_MOVI4
, 
»g
, 
SRC1
);

270 
	`Move
(
X86_MOVI4
, 
DST
, 
»g
);

274 
	`Move
(
X86_MOVI4
, 
DST
, 
SRC1
);

277 
	`ModifyV¬
(
DST
);

281 
	`as£¹
(0);

283 
	}
}

288 
SymbŞ
 
	$PutInReg
(
SymbŞ
 
p
)

290 
SymbŞ
 
»g
;

292 ià(
p
->
»g
 !ğ
NULL
)

294  
p
->
»g
;

296 
»g
 = 
	`G‘Reg
();

297 
	`Move
(
X86_MOVI4
, 
»g
, 
p
);

299  
»g
;

300 
	}
}

305 
	$Em™IndœeùMove
(
IRIn¡
 
š¡
)

307 
SymbŞ
 
»g
;

311 
»g
 = 
	`PutInReg
(
DST
);

312 
š¡
->
İcode
 = 
MOV
;

313 
DST
 = 
»g
->
Ãxt
;

314 
	`Em™Move
(
š¡
);

315 
	}
}

320 
	$Em™Assign
(
IRIn¡
 
š¡
)

322 
SymbŞ
 
d¡
;

323 
code
;

324 
tcode
ğ
	`Ty³Code
(
š¡
->
ty
);

326 ià(
tcode
 =ğ
F4
 ||cod=ğ
F8
)

328 
	`Em™X87Assign
(
š¡
, 
tcode
);

332 
d¡
 = 
DST
;

333 
code
 = 
	`ASM_CODE
(
š¡
->
İcode
, 
tcode
);

334 
code
)

336 
X86_DIVI4
:

337 
X86_DIVU4
:

338 
X86_MODI4
:

339 
X86_MODU4
:

340 
X86_MULU4
:

341 ià(
SRC1
->
»g
 =ğ
X86Regs
[
EAX
])

343 
SRC1
->
Ãedwb
 = 0;

344 
	`SplReg
(
X86Regs
[
EAX
]);

348 
	`SplReg
(
X86Regs
[
EAX
]);

349 
	`Move
(
X86_MOVI4
, 
X86Regs
[
EAX
], 
SRC1
);

351 
	`SplReg
(
X86Regs
[
EDX
]);

352 
U£dRegs
 = 1 << 
EAX
 | 1 << 
EDX
;

353 ià(
SRC2
->
kšd
 =ğ
SK_CÚ¡ªt
)

355 
SymbŞ
 
»g
 = 
	`G‘Reg
();

357 
	`Move
(
X86_MOVI4
, 
»g
, 
SRC2
);

358 
SRC2
 = 
»g
;

362 
	`AÎoÿ‹Reg
(
š¡
, 2);

364 
DST
 = 
X86Regs
[
EAX
];

365 
	`PutASMCode
(
code
, 
š¡
->
İds
);

366 ià(
code
 =ğ
X86_MODI4
 || cod=ğ
X86_MODU4
)

368 
DST
 = 
X86Regs
[
EDX
];

372 
X86_LSHI4
:

373 
X86_LSHU4
:

374 
X86_RSHI4
:

375 
X86_RSHU4
:

376 
	`AÎoÿ‹Reg
(
š¡
, 1);

377 ià(
SRC2
->
kšd
 !ğ
SK_CÚ¡ªt
)

379 ià(
SRC2
->
»g
 !ğ
X86Regs
[
ECX
])

381 
	`SplReg
(
X86Regs
[
ECX
]);

382 
	`Move
(
X86_MOVI4
, 
X86Regs
[
ECX
], 
SRC2
);

384 
SRC2
 = 
X86By‹Regs
[
ECX
];

385 
U£dRegs
 = 1 << 
ECX
;

387 
put_code
;

389 
X86_NEGI4
:

390 
X86_NEGU4
:

391 
X86_BCOMI4
:

392 
X86_BCOMU4
:

393 
	`AÎoÿ‹Reg
(
š¡
, 1);

394 
put_code
;

397 
	`AÎoÿ‹Reg
(
š¡
, 1);

398 
	`AÎoÿ‹Reg
(
š¡
, 2);

400 
put_code
:

401 
	`AÎoÿ‹Reg
(
š¡
, 0);

402 ià(
DST
->
»g
 =ğ
NULL
)

404 
DST
 = 
	`G‘Reg
();

406 ià(
DST
->
»g
 !ğ
SRC1
->reg)

408 
	`Move
(
X86_MOVI4
, 
DST
, 
SRC1
);

410 
	`PutASMCode
(
code
, 
š¡
->
İds
);

414 ià(
d¡
 !ğ
DST
)

416 
	`Move
(
X86_MOVI4
, 
d¡
, 
DST
);

418 
	`ModifyV¬
(
d¡
);

419 
	}
}

421 
	$Em™Ca¡
(
IRIn¡
 
š¡
)

423 
SymbŞ
 
d¡
, 
»g
;

424 
code
;

426 
d¡
 = 
DST
;

427 
»g
 = 
NULL
;

428 
code
 = 
š¡
->
İcode
 + 
X86_EXTI1
 - 
EXTI1
;

429 
code
)

431 
X86_EXTI1
:

432 
X86_EXTI2
:

433 
X86_EXTU1
:

434 
X86_EXTU2
:

435 
	`AÎoÿ‹Reg
(
š¡
, 0);

436 ià(
DST
->
»g
 =ğ
NULL
)

438 
DST
 = 
	`G‘Reg
();

440 
	`PutASMCode
(
code
, 
š¡
->
İds
);

441 ià(
d¡
 !ğ
DST
)

443 
	`Move
(
X86_MOVI4
, 
d¡
, 
DST
);

447 
X86_TRUI1
:

448 ià(
SRC1
->
»g
 !ğ
NULL
)

450 
»g
 = 
X86By‹Regs
[
SRC1
->»g->
v®
.
i
[0]];

452 ià(
»g
 =ğ
NULL
)

454 
»g
 = 
	`G‘By‹Reg
();

455 
	`Move
(
X86_MOVI4
, 
X86Regs
[
»g
->
v®
.
i
[0]], 
SRC1
);

457 
	`Move
(
X86_MOVI1
, 
DST
, 
»g
);

460 
X86_TRUI2
:

461 ià(
SRC1
->
»g
 !ğ
NULL
)

463 
»g
 = 
X86WÜdRegs
[
SRC1
->»g->
v®
.
i
[0]];

465 ià(
»g
 =ğ
NULL
)

467 
»g
 = 
	`G‘WÜdReg
();

468 
	`Move
(
X86_MOVI4
, 
X86Regs
[
»g
->
v®
.
i
[0]], 
SRC1
);

470 
	`Move
(
X86_MOVI2
, 
DST
, 
»g
);

473 
X86_CVTI4F4
:

474 
X86_CVTI4F8
:

475 
X86_CVTU4F4
:

476 
X86_CVTU4F8
:

477 
	`as£¹
(
X87Tİ
 !ğ
DST
);

478 
	`PutASMCode
(
code
, 
š¡
->
İds
);

482 ià(
SRC1
 =ğ
X87Tİ
)

484 
	`SaveX87Tİ
();

486 ià(
code
 !ğ
X86_CVTF4
 && cod!ğ
X86_CVTF8
)

488 
	`SplReg
(
X86Regs
[
EAX
]);

489 
	`AÎoÿ‹Reg
(
š¡
, 0);

491 
	`PutASMCode
(
code
, 
š¡
->
İds
);

492 ià(
DST
->
»g
 && DST->»g !ğ
X86Regs
[
EAX
])

494 
	`Move
(
X86_MOVI4
, 
DST
, 
X86Regs
[
EAX
]);

498 
	`ModifyV¬
(
d¡
);

499 
	}
}

501 
	$Em™Inc
(
IRIn¡
 
š¡
)

503 
	`PutASMCode
(
X86_INCI1
 + 
	`Ty³Code
(
š¡
->
ty
), in¡->
İds
);

504 
	}
}

506 
	$Em™Dec
(
IRIn¡
 
š¡
)

508 
	`PutASMCode
(
X86_DECI1
 + 
	`Ty³Code
(
š¡
->
ty
), in¡->
İds
);

509 
	}
}

511 
	$Em™B¿nch
(
IRIn¡
 
š¡
)

513 
tcode
 = 
	`Ty³Code
(
š¡
->
ty
);

514 
BBlock
 
p
 = (BBlock)
DST
;

516 
DST
 = 
p
->
sym
;

517 ià(
tcode
 =ğ
F4
 ||cod=ğ
F8
)

519 
	`Em™X87B¿nch
(
š¡
, 
tcode
);

523 
	`as£¹
(
tcode
 >ğ
I4
);

525 ià(
SRC2
)

527 ià(
SRC2
->
kšd
 !ğ
SK_CÚ¡ªt
)

529 
SRC1
 = 
	`PutInReg
(SRC1);

533 
SRC1
->
»f
--;

534 ià(
SRC1
->
»g
 !ğ
NULL
)

535 
SRC1
 = SRC1->
»g
;

536 ià(
SRC2
)

538 
SRC2
->
»f
--;

539 ià(
SRC2
->
»g
 !ğ
NULL
)

540 
SRC2
 = SRC2->
»g
;

542 
	`CË¬Regs
();

543 
	`PutASMCode
(
	`ASM_CODE
(
š¡
->
İcode
, 
tcode
), in¡->
İds
);

544 
	}
}

546 
	$Em™Jump
(
IRIn¡
 
š¡
)

548 
BBlock
 
p
 = (BBlock)
DST
;

550 
DST
 = 
p
->
sym
;

551 
	`CË¬Regs
();

552 
	`PutASMCode
(
X86_JMP
, 
š¡
->
İds
);

553 
	}
}

555 
	$Em™IndœeùJump
(
IRIn¡
 
š¡
)

557 
BBlock
 *
p
;

558 
SymbŞ
 
swtch
;

559 
Ën
;

560 
SymbŞ
 
»g
;

563 
SRC1
->
»f
--;

564 
p
 = (
BBlock
 *)
DST
;

565 
»g
 = 
	`PutInReg
(
SRC1
);

567 
	`PutSŒšg
("\n");

568 
	`Segm’t
(
DATA
);

570 
	`CALLOC
(
swtch
);

571 
swtch
->
kšd
 = 
SK_V¬ŸbË
;

572 
swtch
->
ty
 = 
	`T
(
POINTER
);

573 
swtch
->
Çme
 = 
	`FÜm©Name
("swtchTabË%d", 
Sw™chTabËNum
++);

574 
swtch
->
sşass
 = 
TK_STATIC
;

575 
swtch
->
Ëv–
 = 0;

576 
	`DefšeGlob®
(
swtch
);

578 
DST
 = 
swtch
;

579 
Ën
 = 
	`¡¾’
(
DST
->
ªame
);

580 *
p
 !ğ
NULL
)

582 
	`DefšeAdd»ss
((*
p
)->
sym
);

583 
	`PutSŒšg
("\n");

584 
	`LeáAlign
(
ASMFe
, 
Ën
);

585 
	`PutSŒšg
("\t");

586 
p
++;

588 
	`PutSŒšg
("\n");

590 
	`Segm’t
(
CODE
);

592 
SRC1
 = 
»g
;

593 
	`CË¬Regs
();

594 
	`PutASMCode
(
X86_IJMP
, 
š¡
->
İds
);

595 
	}
}

597 
	$Em™R‘uº
(
IRIn¡
 
š¡
)

599 
Ty³
 
ty
 = 
š¡
->ty;

601 ià(
	`IsR—lTy³
(
ty
))

603 ià(
X87Tİ
 !ğ
DST
)

605 
	`SaveX87Tİ
();

606 
	`PutASMCode
(
X86_LDF4
 + 
X87TCode
 - 
F4
, 
š¡
->
İds
);

608 
X87Tİ
 = 
NULL
;

612 ià(
	`IsRecÜdTy³
(
ty
è&& 
	`IsNÜm®RecÜd
(ty))

614 
š¡
->
İcode
 = 
IMOV
;

615 
SRC1
 = 
DST
;

616 
DST
 = 
FSYM
->
·¿ms
;

617 
	`Em™IndœeùMove
(
š¡
);

621 
ty
->
size
)

624 
	`Move
(
X86_MOVI1
, 
X86By‹Regs
[
EAX
], 
DST
);

628 
	`Move
(
X86_MOVI2
, 
X86WÜdRegs
[
EAX
], 
DST
);

632 ià(
DST
->
»g
 !ğ
X86Regs
[
EAX
])

634 
	`Move
(
X86_MOVI4
, 
X86Regs
[
EAX
], 
DST
);

639 
	`Move
(
X86_MOVI4
, 
X86Regs
[
EAX
], 
DST
);

640 
	`Move
(
X86_MOVI4
, 
X86Regs
[
EDX
], 
	`C»©eOff£t
(
	`T
(
INT
), 
DST
, 4));

644 
	`as£¹
(0);

646 
	}
}

648 
	$PushArgum’t
(
SymbŞ
 
p
, 
Ty³
 
ty
)

650 
tcode
 = 
	`Ty³Code
(
ty
);

652 ià(
tcode
 =ğ
F4
)

654 
	`PutASMCode
(
X86_PUSHF4
, &
p
);

656 ià(
tcode
 =ğ
F8
)

658 
	`PutASMCode
(
X86_PUSHF8
, &
p
);

660 ià(
tcode
 =ğ
B
)

662 
SymbŞ
 
İds
[2];

664 
	`SplReg
(
X86Regs
[
ESI
]);

665 
	`SplReg
(
X86Regs
[
EDI
]);

666 
	`SplReg
(
X86Regs
[
ECX
]);

667 
İds
[0] = 
p
;

668 
İds
[1] = 
	`IÁCÚ¡ªt
(
ty
->
size
);

669 
İds
[2] = 
	`IÁCÚ¡ªt
(
	`ALIGN
(
ty
->
size
, 
STACK_ALIGN_SIZE
));

670 
	`PutASMCode
(
X86_PUSHB
, 
İds
);

674 
	`PutASMCode
(
X86_PUSH
, &
p
);

676 
	}
}

678 
	$Em™C®l
(
IRIn¡
 
š¡
)

680 
VeùÜ
 
¬gs
;

681 
ILArg
 
¬g
;

682 
Ty³
 
¹y
;

683 
i
, 
¡ksize
;

685 
¬gs
 = (
VeùÜ
)
SRC2
;

686 
¡ksize
 = 0;

687 
¹y
 = 
š¡
->
ty
;

689 
i
 = 
	`LEN
(
¬gs
) - 1; i >= 0; --i)

691 
¬g
 = 
	`GET_ITEM
(
¬gs
, 
i
);

692 
	`PushArgum’t
(
¬g
->
sym
,‡rg->
ty
);

693 ià(
¬g
->
sym
->
kšd
 !ğ
SK_FunùiÚ
è¬g->sym->
»f
--;

694 
¡ksize
 +ğ
	`ALIGN
(
¬g
->
ty
->
size
, 
STACK_ALIGN_SIZE
);

696 
	`SplReg
(
X86Regs
[
EAX
]);

697 
	`SplReg
(
X86Regs
[
ECX
]);

698 
	`SplReg
(
X86Regs
[
EDX
]);

699 ià(
	`IsRecÜdTy³
(
¹y
è&& 
	`IsNÜm®RecÜd
(rty))

701 
SymbŞ
 
İds
[2];

703 
İds
[0] = 
	`G‘Reg
();

704 
İds
[1] = 
DST
;

705 
	`PutASMCode
(
X86_ADDR
, 
İds
);

706 
	`PutASMCode
(
X86_PUSH
, 
İds
);

707 
¡ksize
 += 4;

708 
DST
 = 
NULL
;

711 
	`PutASMCode
(
SRC1
->
kšd
 =ğ
SK_FunùiÚ
 ? 
X86_CALL
 : 
X86_ICALL
, 
š¡
->
İds
);

713 
SymbŞ
 
p
;

714 
p
 = 
	`IÁCÚ¡ªt
(
¡ksize
);

715 
	`PutASMCode
(
X86_REDUCEF
, &
p
);

718 ià(
DST
 !ğ
NULL
)

719 
DST
->
»f
--;

720 ià(
SRC1
->
kšd
 !ğ
SK_FunùiÚ
èSRC1->
»f
--;

722 ià(
DST
 =ğ
NULL
)

725 ià(
	`IsR—lTy³
(
¹y
))

727 
	`PutASMCode
(
X86_STF4
 + (
¹y
->
ÿ‹g
 !ğ
FLOAT
), 
š¡
->
İds
);

731 
¹y
->
size
)

734 
	`Move
(
X86_MOVI1
, 
DST
, 
X86By‹Regs
[
EAX
]);

738 
	`Move
(
X86_MOVI2
, 
DST
, 
X86WÜdRegs
[
EAX
]);

742 
	`AÎoÿ‹Reg
(
š¡
, 0);

743 ià(
DST
->
»g
 !ğ
X86Regs
[
EAX
])

745 
	`Move
(
X86_MOVI4
, 
DST
, 
X86Regs
[
EAX
]);

747 
	`ModifyV¬
(
DST
);

751 
	`Move
(
X86_MOVI4
, 
DST
, 
X86Regs
[
EAX
]);

752 
	`Move
(
X86_MOVI4
, 
	`C»©eOff£t
(
	`T
(
INT
), 
DST
, 4), 
X86Regs
[
EDX
]);

756 
	`as£¹
(0);

758 
	}
}

760 
	$Em™Add»ss
(
IRIn¡
 
š¡
)

762 
SymbŞ
 
d¡
;

764 
d¡
 = 
DST
;

765 
	`AÎoÿ‹Reg
(
š¡
, 0);

766 ià(
DST
->
»g
 =ğ
NULL
)

768 
DST
 = 
	`G‘Reg
();

770 
	`PutASMCode
(
X86_ADDR
, 
š¡
->
İds
);

771 ià(
d¡
 !ğ
DST
)

773 
	`Move
(
X86_MOVI4
, 
d¡
, 
DST
);

775 
	`ModifyV¬
(
d¡
);

776 
	}
}

778 
	$Em™D”ef
(
IRIn¡
 
š¡
)

780 
SymbŞ
 
»g
;

782 
»g
 = 
	`PutInReg
(
SRC1
);

783 
š¡
->
İcode
 = 
MOV
;

784 
SRC1
 = 
»g
->
Ãxt
;

785 
	`Em™Move
(
š¡
);

786 
	`ModifyV¬
(
DST
);

788 
	}
}

790 
	$Em™CË¬
(
IRIn¡
 
š¡
)

792 
size
 = 
SRC1
->
v®
.
i
[0];

793 
SymbŞ
 
p
 = 
	`IÁCÚ¡ªt
(0);

795 
size
)

798 
	`Move
(
X86_MOVI1
, 
DST
, 
p
);

802 
	`Move
(
X86_MOVI2
, 
DST
, 
p
);

806 
	`Move
(
X86_MOVI4
, 
DST
, 
p
);

810 
	`SplReg
(
X86Regs
[
EAX
]);

811 
	`PutASMCode
(
X86_CLEAR
, 
š¡
->
İds
);

814 
	}
}

816 
	$Em™NOP
(
IRIn¡
 
š¡
)

818 
	`as£¹
(0);

819 
	}
}

821 (* 
Em™‹r
[])(
IRIn¡
 
š¡
) =

823 
	#OPCODE
(
code
, 
Çme
, 
func
è
Em™
##func,

	)

824 
	~"İcode.h
"

825 #undeà
OPCODE


826 
	}
};

828 
	$Em™IRIn¡
(
IRIn¡
 
š¡
)

830 
œš¡
 
š¡c
 = *
š¡
;

832 (* 
Em™‹r
[
š¡
->
İcode
])(&
š¡c
);

834 
	}
}

836 
	$Em™BBlock
(
BBlock
 
bb
)

838 
IRIn¡
 
š¡
 = 
bb
->
š¡h
.
Ãxt
;

840 
š¡
 !ğ&
bb
->
š¡h
)

842 
U£dRegs
 = 0;

843 
	`Em™IRIn¡
(
š¡
);

844 ià(! (
š¡
->
İcode
 >ğ
JZ
 && in¡->İcod<ğ
IJMP
) &&

845 
š¡
->
İcode
 !ğ
CALL
)

847 
DST
->
»f
--;

848 ià(
SRC1
 && SRC1->
kšd
 !ğ
SK_FunùiÚ
èSRC1->
»f
--;

849 ià(
SRC2
 && SRC2->
kšd
 !ğ
SK_FunùiÚ
èSRC2->
»f
--;

851 
š¡
 = in¡->
Ãxt
;

853 
	`CË¬Regs
();

854 
	`SaveX87Tİ
();

855 
	}
}

857 
	$LayoutF¿me
(
FunùiÚSymbŞ
 
fsym
, 
f¡P¬amPos
)

859 
SymbŞ
 
p
;

860 
off£t
;

862 
off£t
 = 
f¡P¬amPos
 * 
STACK_ALIGN_SIZE
;

863 
p
 = 
fsym
->
·¿ms
;

864 
p
)

866 
	`AsV¬
(
p
)->
off£t
 = offset;

867 
off£t
 +ğ
	`ALIGN
(
p
->
ty
->
size
, 
STACK_ALIGN_SIZE
);

868 
p
 =…->
Ãxt
;

871 
off£t
 = 0;

872 
p
 = 
fsym
->
loÿls
;

873 
p
)

875 ià(
p
->
»f
 == 0)

876 
Ãxt
;

878 
off£t
 +ğ
	`ALIGN
(
p
->
ty
->
size
, 
STACK_ALIGN_SIZE
);

879 
	`AsV¬
(
p
)->
off£t
 = -offset;

880 
Ãxt
:

881 
p
 =…->
Ãxt
;

884  
off£t
;

885 
	}
}

887 
	$Em™PrŞogue
(
¡ksize
)

893 
	`PutASMCode
(
X86_PROLOGUE
, 
NULL
);

894 ià(
¡ksize
 != 0)

896 
SymbŞ
 
sym
 = 
	`IÁCÚ¡ªt
(
¡ksize
);

897 
	`PutASMCode
(
X86_EXPANDF
, &
sym
);

899 
	}
}

901 
	$Em™Epogue
(
¡ksize
)

903 
	`PutASMCode
(
X86_EPILOGUE
, 
NULL
);

904 
	}
}

906 
	$Em™FunùiÚ
(
FunùiÚSymbŞ
 
fsym
)

908 
BBlock
 
bb
;

909 
Ty³
 
¹y
;

910 
¡ksize
;

912 
FSYM
 = 
fsym
;

913 ià(
fsym
->
sşass
 !ğ
TK_STATIC
)

915 
	`ExpÜt
((
SymbŞ
)
fsym
);

917 
	`DefšeLab–
((
SymbŞ
)
fsym
);

919 
¹y
 = 
fsym
->
ty
->
bty
;

920 ià(
	`IsRecÜdTy³
(
¹y
è&& 
	`IsNÜm®RecÜd
(rty))

922 
V¬ŸbËSymbŞ
 
p
;

924 
	`CALLOC
(
p
);

925 
p
->
kšd
 = 
SK_V¬ŸbË
;

926 
p
->
Çme
 = "recvaddr";

927 
p
->
ty
 = 
	`T
(
POINTER
);

928 
p
->
Ëv–
 = 1;

929 
p
->
sşass
 = 
TK_AUTO
;

931 
p
->
Ãxt
 = 
fsym
->
·¿ms
;

932 
fsym
->
·¿ms
 = (
SymbŞ
)
p
;

935 
¡ksize
 = 
	`LayoutF¿me
(
fsym
, 
PRESERVE_REGS
 + 1);

937 
	`Em™PrŞogue
(
¡ksize
);

939 
bb
 = 
fsym
->
’ŒyBB
;

940 
bb
 !ğ
NULL
)

942 ià(
bb
->
»f
 != 0)

944 
	`DefšeLab–
(
bb
->
sym
);

946 
	`Em™BBlock
(
bb
);

947 
bb
 = bb->
Ãxt
;

950 
	`Em™Epogue
(
¡ksize
);

951 
	`PutSŒšg
("\n");

952 
	}
}

954 
	$StÜeV¬
(
SymbŞ
 
»g
, SymbŞ 
v
)

956 
	`Move
(
X86_MOVI4
, 
v
, 
»g
);

957 
	}
}

	@ucl/x86linux.c

1 
	~"uş.h
"

2 
	~"rg‘.h
"

3 
	~"»g.h
"

4 
	~"ouut.h
"

6 
	gORG
;

7 
	gFlßtNum
;

8 *
	gASMTem¶©e
[] =

10 
	#TEMPLATE
(
code
, 
¡r
è¡r,

	)

11 
	~"x86lšux.l
"

12 #undeà
TEMPLATE


15 
	$Align
(
SymbŞ
 
p
)

17 
®ign
 = 
p
->
ty
->align;

19 ià(
ORG
 % 
®ign
 != 0)

21 
	`Pršt
(".®igÀ%d\n", 
®ign
);

22 
ORG
 = 
	`ALIGN
(ORG, 
®ign
);

24 
ORG
 +ğ
p
->
ty
->
size
;

25 
	}
}

27 * 
	$G‘AcûssName
(
SymbŞ
 
p
)

29 ià(
p
->
ªame
 !ğ
NULL
)

30  
p
->
ªame
;

32 
p
->
kšd
)

34 
SK_CÚ¡ªt
:

35 
p
->
ªame
 = 
	`FÜm©Name
("$%s",…->
Çme
);

38 
SK_SŒšg
:

39 
SK_Lab–
:

40 
p
->
ªame
 = 
	`FÜm©Name
(".%s",…->
Çme
);

43 
SK_V¬ŸbË
:

44 
SK_Temp
:

45 ià(
p
->
Ëv–
 == 0)

47 
p
->
ªame
 =…->
Çme
;

49 ià(
p
->
sşass
 =ğ
TK_STATIC
)

51 
p
->
ªame
 = 
	`FÜm©Name
("%s.%d",…->
Çme
, 
TempNum
++);

56 
p
->
ªame
 = 
	`FÜm©Name
("%d(%%ebp)", 
	`AsV¬
Õ)->
off£t
);

60 
SK_FunùiÚ
:

61 
p
->
ªame
 =…->
Çme
;

64 
SK_Off£t
:

66 
SymbŞ
 
ba£
 = 
p
->
lšk
;

67 
n
 = 
	`AsV¬
(
p
)->
off£t
;

69 ià(
ba£
->
Ëv–
 =ğ0 || ba£->
sşass
 =ğ
TK_STATIC
)

71 
p
->
ªame
 = 
	`FÜm©Name
("%s%s%d", 
	`G‘AcûssName
(
ba£
), 
n
 >= 0 ? "+" : "",‚);

75 
n
 +ğ
	`AsV¬
(
ba£
)->
off£t
;

76 
p
->
ªame
 = 
	`FÜm©Name
("%d(%%ebp)", 
n
);

82 
	`as£¹
(0);

85  
p
->
ªame
;

86 
	}
}

89 
	$S‘upRegi¡”s
()

91 
X86Regs
[
EAX
] = 
	`C»©eReg
("%eax", "(%eax)", EAX);

92 
X86Regs
[
EBX
] = 
	`C»©eReg
("%ebx", "(%ebx)", EBX);

93 
X86Regs
[
ECX
] = 
	`C»©eReg
("%ecx", "(%ecx)", ECX);

94 
X86Regs
[
EDX
] = 
	`C»©eReg
("%edx", "(%edx)", EDX);

95 
X86Regs
[
ESI
] = 
	`C»©eReg
("%esi", "(%esi)", ESI);

96 
X86Regs
[
EDI
] = 
	`C»©eReg
("%edi", "(%edi)", EDI);

98 
X86WÜdRegs
[
EAX
] = 
	`C»©eReg
("%ax", 
NULL
, EAX);

99 
X86WÜdRegs
[
EBX
] = 
	`C»©eReg
("%bx", 
NULL
, EBX);

100 
X86WÜdRegs
[
ECX
] = 
	`C»©eReg
("%cx", 
NULL
, ECX);

101 
X86WÜdRegs
[
EDX
] = 
	`C»©eReg
("%dx", 
NULL
, EDX);

102 
X86WÜdRegs
[
ESI
] = 
	`C»©eReg
("%si", 
NULL
, ESI);

103 
X86WÜdRegs
[
EDI
] = 
	`C»©eReg
("%di", 
NULL
, EDI);

105 
X86By‹Regs
[
EAX
] = 
	`C»©eReg
("%®", 
NULL
, EAX);

106 
X86By‹Regs
[
EBX
] = 
	`C»©eReg
("%bl", 
NULL
, EBX);

107 
X86By‹Regs
[
ECX
] = 
	`C»©eReg
("%ş", 
NULL
, ECX);

108 
X86By‹Regs
[
EDX
] = 
	`C»©eReg
("%dl", 
NULL
, EDX);

109 
	}
}

111 
	$PutASMCode
(
code
, 
SymbŞ
 
İds
[])

113 *
fmt
 = 
ASMTem¶©e
[
code
];

114 
i
;

116 
	`PutCh¬
('\t');

117 *
fmt
)

119 *
fmt
)

122 
	`PutSŒšg
("\n\t");

126 
fmt
++;

127 ià(*
fmt
 == '%')

129 
	`PutCh¬
('%');

133 
i
 = *
fmt
 - '0';

134 ià(
İds
[
i
]->
»g
 !ğ
NULL
)

136 
	`PutSŒšg
(
İds
[
i
]->
»g
->
Çme
);

140 
	`PutSŒšg
(
	`G‘AcûssName
(
İds
[
i
]));

146 
	`PutCh¬
(*
fmt
);

149 
fmt
++;

151 
	`PutCh¬
('\n');

152 
	}
}

154 
	$BegšProg¿m
()

156 
i
;

158 
ORG
 = 0;

159 
FlßtNum
 = 
TempNum
 = 0;

160 
i
 = 
EAX
; i <ğ
EDI
; ++i)

162 ià(
X86Regs
[
i
] !ğ
NULL
)

164 
X86Regs
[
i
]->
lšk
 = 
NULL
;

168 
	`PutSŒšg
("# Code‡uto-generated by UCC\n\n");

169 
	}
}

171 
	$Segm’t
(
£g
)

173 ià(
£g
 =ğ
DATA
)

175 
	`PutSŒšg
(".data\n\n");

177 ià(
£g
 =ğ
CODE
)

179 
	`PutSŒšg
(".text\n\n");

181 
	}
}

183 
	$ImpÜt
(
SymbŞ
 
p
)

185 
	}
}

187 
	$ExpÜt
(
SymbŞ
 
p
)

189 
	`Pršt
(".globl\t%s\n\n", 
	`G‘AcûssName
(
p
));

190 
	}
}

192 
	$DefšeSŒšg
(
SŒšg
 
¡r
, 
size
)

194 
i
 = 0;

196 ià(
¡r
->
chs
[
size
] == 0)

198 
	`PutSŒšg
(".string\t\"");

199 
size
--;

203 
	`PutSŒšg
(".ascii\t\"");

205 
i
 < 
size
)

207 ià(! 
	`i¥ršt
(
¡r
->
chs
[
i
]))

209 
	`Pršt
("\\%03o", ()
¡r
->
chs
[
i
]);

213 ià(
¡r
->
chs
[
i
] == '"')

215 
	`PutSŒšg
("\\\"");

217 ià(
¡r
->
chs
[
i
] == '\\')

219 
	`PutSŒšg
("\\\\");

223 
	`PutCh¬
(
¡r
->
chs
[
i
]);

226 
i
++;

228 
	`PutSŒšg
("\"\n");

229 
	}
}

231 
	$DefšeFlßtCÚ¡ªt
(
SymbŞ
 
p
)

233 
®ign
 = 
p
->
ty
->align;

235 
p
->
ªame
 = 
	`FÜm©Name
(".æt%d", 
FlßtNum
++);

237 
	`Align
(
p
);

238 
	`Pršt
("%s:\t", 
p
->
ªame
);

239 
	`DefšeV®ue
(
p
->
ty
,…->
v®
);

240 
	}
}

243 
	$DefšeGlob®
(
SymbŞ
 
p
)

245 
	`Align
(
p
);

246 ià(
p
->
sşass
 !ğ
TK_STATIC
)

248 
	`ExpÜt
(
p
);

250 
	`Pršt
("%s:\t", 
	`G‘AcûssName
(
p
));

251 
	}
}

253 
	$DefšeCommD©a
(
SymbŞ
 
p
)

255 
	`G‘AcûssName
(
p
);

256 ià(
p
->
sşass
 =ğ
TK_STATIC
)

258 
	`Pršt
(".lcomm\t%s,%d\n", 
p
->
ªame
,…->
ty
->
size
);

262 
	`Pršt
(".comm\t%s,%d\n", 
p
->
ªame
,…->
ty
->
size
);

264 
	}
}

266 
	$DefšeAdd»ss
(
SymbŞ
 
p
)

268 
	`Pršt
(".lÚg\t%s", 
	`G‘AcûssName
(
p
));

269 
	}
}

271 
	$DefšeV®ue
(
Ty³
 
ty
, 
v®ue
 
v®
)

273 
tcode
 = 
	`Ty³Code
(
ty
);

275 
tcode
)

277 
I1
: 
U1
:

278 
	`Pršt
(".by‹\t%d\n", 
v®
.
i
[0] & 0xff);

281 
I2
: 
U2
:

282 
	`Pršt
(".wÜd\t%d\n", 
v®
.
i
[0] & 0xffff);

285 
I4
: 
U4
:

286 
	`Pršt
(".lÚg\t%d\n", 
v®
.
i
[0]);

289 
F4
:

290 
	`Pršt
(".lÚg\t%d\n", *(*)&
v®
.
f
 );

293 
F8
:

295 *
p
 = (*)&
v®
.
d
;

296 
	`Pršt
(".lÚg\t%d\n.lÚg\t%d\n", 
p
[0],…[1]);

301 
	`as£¹
(0);

303 
	}
}

305 
	$S·û
(
size
)

307 
	`Pršt
(".¥aû\t%d\n", 
size
);

308 
	}
}

310 
	$DefšeLab–
(
SymbŞ
 
p
)

312 
	`Pršt
("%s:\n", 
	`G‘AcûssName
(
p
));

313 
	}
}

315 
	$EndProg¿m
()

317 
	`Flush
();

318 
	}
}

	@ucl/x86win32.c

1 
	~"uş.h
"

2 
	~"rg‘.h
"

3 
	~"»g.h
"

4 
	~"ouut.h
"

10 
	gORG
;

11 
	gFlßtNum
;

12 *
	gASMTem¶©e
[] =

14 
	#TEMPLATE
(
code
, 
¡r
è¡r,

	)

15 
	~"x86wš32.l
"

16 #undeà
TEMPLATE


25 
	$Align
(
SymbŞ
 
p
)

27 
®ign
 = 
p
->
ty
->align;

29 ià(
ORG
 % 
®ign
 != 0)

31 
	`Pršt
("®igÀ%d\n", 
®ign
);

32 
ORG
 = 
	`ALIGN
(ORG, 
®ign
);

34 
ORG
 +ğ
p
->
ty
->
size
;

35 
	}
}

40 * 
	$G‘AcûssName
(
SymbŞ
 
p
)

42 ià(
p
->
ªame
 !ğ
NULL
)

43  
p
->
ªame
;

45 
p
->
kšd
)

47 
SK_CÚ¡ªt
:

48 ià(
p
->
Çme
[0] == '0' &&…->name[1] == 'x')

49 
p
->
ªame
 = 
	`FÜm©Name
("0%sH", &p->
Çme
[2]);

51 
p
->
ªame
 =…->
Çme
;

54 
SK_SŒšg
:

55 
SK_IRegi¡”
:

56 
SK_Lab–
:

57 
p
->
ªame
 =…->
Çme
;

60 
SK_V¬ŸbË
:

61 
SK_Temp
:

62 ià(
p
->
Ëv–
 == 0)

64 
p
->
ªame
 = 
	`FÜm©Name
("_%s",…->
Çme
);

66 ià(
p
->
sşass
 =ğ
TK_STATIC
)

68 
p
->
ªame
 = 
	`FÜm©Name
("%s%d",…->
Çme
, 
TempNum
++);

73 
p
->
ªame
 = 
	`FÜm©Name
("(%d)[ebp]", 
	`AsV¬
Õ)->
off£t
);

77 
SK_FunùiÚ
:

78 
p
->
ªame
 = 
	`FÜm©Name
("_%s",…->
Çme
);

81 
SK_Off£t
:

83 
SymbŞ
 
ba£
 = 
p
->
lšk
;

84 
n
 = 
	`AsV¬
(
p
)->
off£t
;

86 ià(
ba£
->
Ëv–
 =ğ0 || ba£->
sşass
 =ğ
TK_STATIC
)

88 
p
->
ªame
 = 
	`FÜm©Name
("%s%s%d", 
	`G‘AcûssName
(
ba£
), 
n
 >= 0 ? "+" : "",‚);

92 
n
 +ğ
	`AsV¬
(
ba£
)->
off£t
;

93 
p
->
ªame
 = 
	`FÜm©Name
("(%d)[ebp]", 
n
);

99 
	`as£¹
(0);

102  
p
->
ªame
;

103 
	}
}

105 
	$S‘upRegi¡”s
()

107 
X86Regs
[
EAX
] = 
	`C»©eReg
("eax", "[eax]", EAX);

108 
X86Regs
[
EBX
] = 
	`C»©eReg
("ebx", "[ebx]", EBX);

109 
X86Regs
[
ECX
] = 
	`C»©eReg
("ecx", "[ecx]", ECX);

110 
X86Regs
[
EDX
] = 
	`C»©eReg
("edx", "[edx]", EDX);

111 
X86Regs
[
ESI
] = 
	`C»©eReg
("esi", "[esi]", ESI);

112 
X86Regs
[
EDI
] = 
	`C»©eReg
("edi", "[edi]", EDI);

114 
X86WÜdRegs
[
EAX
] = 
	`C»©eReg
("ax", 
NULL
, EAX);

115 
X86WÜdRegs
[
EBX
] = 
	`C»©eReg
("bx", 
NULL
, EBX);

116 
X86WÜdRegs
[
ECX
] = 
	`C»©eReg
("cx", 
NULL
, ECX);

117 
X86WÜdRegs
[
EDX
] = 
	`C»©eReg
("dx", 
NULL
, EDX);

118 
X86WÜdRegs
[
ESI
] = 
	`C»©eReg
("si", 
NULL
, ESI);

119 
X86WÜdRegs
[
EDI
] = 
	`C»©eReg
("di", 
NULL
, EDI);

121 
X86By‹Regs
[
EAX
] = 
	`C»©eReg
("®", 
NULL
, EAX);

122 
X86By‹Regs
[
EBX
] = 
	`C»©eReg
("bl", 
NULL
, EBX);

123 
X86By‹Regs
[
ECX
] = 
	`C»©eReg
("ş", 
NULL
, ECX);

124 
X86By‹Regs
[
EDX
] = 
	`C»©eReg
("dl", 
NULL
, EDX);

125 
	}
}

127 
	$PutASMCode
(
code
, 
SymbŞ
 
İds
[])

129 *
fmt
 = 
ASMTem¶©e
[
code
];

130 *
´efix
 = 
NULL
;

131 
i
;

133 
	`PutCh¬
('\t');

134 *
fmt
)

136 *
fmt
)

139 
	`PutSŒšg
("\n\t");

143 
fmt
++;

144 ià(*
fmt
 == 'b')

146 
´efix
 = "BYTE PTR ";

147 
fmt
++;

149 ià(*
fmt
 == 'w')

151 
´efix
 = "WORD PTR ";

152 
fmt
++;

154 ià(*
fmt
 == 'd')

156 
´efix
 = "DWORD PTR ";

157 
fmt
++;

160 
´efix
 = 
NULL
;

162 
i
 = *
fmt
 - '0';

163 ià(
İds
[
i
]->
»g
 !ğ
NULL
)

165 
	`PutSŒšg
(
İds
[
i
]->
»g
->
Çme
);

169 ià(
´efix
 && 
İds
[
i
]->
kšd
 !ğ
SK_CÚ¡ªt
 && opds[i]->kšd !ğ
SK_FunùiÚ
)

171 
	`PutSŒšg
(
´efix
);

173 
	`PutSŒšg
(
	`G‘AcûssName
(
İds
[
i
]));

178 
	`PutCh¬
(*
fmt
);

181 
fmt
++;

183 
	`PutCh¬
('\n');

184 
	}
}

186 
	$BegšProg¿m
()

188 
i
;

190 
ORG
 = 0;

191 
FlßtNum
 = 
TempNum
 = 0;

192 
i
 = 
EAX
; i < 
EDI
; ++i)

194 ià(
X86Regs
[
i
] !ğ
NULL
)

196 
X86Regs
[
i
]->
lšk
 = 
NULL
;

199 
	`PutSŒšg
("; Code‡uto-generated by UCC\n");

200 
	`PutSŒšg
(".486\n");

201 
	`PutSŒšg
(".MODEL FLAT\n");

202 
	`PutSŒšg
("EXTRN __fltused:NEAR32\n");

203 
	`PutSŒšg
("EXTRN __ftol:NEAR32\n");

204 
	`PutSŒšg
("EXTRN _memset:NEAR32\n\n");

205 
	}
}

207 
	$Segm’t
(
£g
)

209 ià(
£g
 =ğ
DATA
)

211 
	`PutSŒšg
(".DATA\n\n");

213 ià(
£g
 =ğ
CODE
)

215 
	`PutSŒšg
(".CODE\n\n");

217 
	}
}

219 
	$ImpÜt
(
SymbŞ
 
p
)

221 
	`Pršt
("EXTRN %s:NEAR32\n\n", 
	`G‘AcûssName
(
p
));

222 
	}
}

224 
	$ExpÜt
(
SymbŞ
 
p
)

226 
	`Pršt
("PUBLIC %s\n\n", 
	`G‘AcûssName
(
p
));

227 
	}
}

229 
	$DefšeSŒšg
(
SŒšg
 
¡r
, 
size
)

231 
i
 = 0;

233 
	`PutSŒšg
("BYTE\t");

234 
i
 < 
size
)

236 ià(! 
	`i¥ršt
(
¡r
->
chs
[
i
]))

238 
	`Pršt
("0%xH", 
¡r
->
chs
[
i
]);

239 
i
++;

243 
	`PutSŒšg
("'");

244 
i
 < 
size
 && 
	`i¥ršt
(
¡r
->
chs
[i]))

246 ià(
¡r
->
chs
[
i
] == '\'')

247 
	`PutSŒšg
("''");

249 
	`PutCh¬
(
¡r
->
chs
[
i
]);

250 
i
++;

252 
	`PutSŒšg
("'");

254 ià(
i
 < 
size
)

255 
	`PutSŒšg
(", ");

257 
	`PutSŒšg
("\n");

258 
	}
}

260 
	$DefšeFlßtCÚ¡ªt
(
SymbŞ
 
p
)

262 
®ign
 = 
p
->
ty
->align;

264 
p
->
ªame
 = 
	`FÜm©Name
("æt%d", 
FlßtNum
++);

266 
	`Align
(
p
);

267 
	`Pršt
("%s\t", 
p
->
ªame
);

268 
	`DefšeV®ue
(
p
->
ty
,…->
v®
);

269 
	}
}

271 
	$DefšeGlob®
(
SymbŞ
 
p
)

273 
	`Align
(
p
);

274 ià(
p
->
sşass
 !ğ
TK_STATIC
)

276 
	`ExpÜt
(
p
);

278 
	`Pršt
("%s\t", 
	`G‘AcûssName
(
p
));

279 
	}
}

281 
	$DefšeCommD©a
(
SymbŞ
 
p
)

283 
	`Align
(
p
);

284 
	`G‘AcûssName
(
p
);

285 ià(
p
->
sşass
 =ğ
TK_STATIC
)

287 
	`Pršt
("%s\t", 
p
->
ªame
);

288 
	`S·û
(
p
->
ty
->
size
);

292 
	`Pršt
("COMM\t%s:%d\n", 
p
->
ªame
,…->
ty
->
size
);

294 
	}
}

296 
	$DefšeAdd»ss
(
SymbŞ
 
p
)

298 
	`Pršt
("DWORD\t%s", 
	`G‘AcûssName
(
p
));

299 
	}
}

301 
	$DefšeV®ue
(
Ty³
 
ty
, 
v®ue
 
v®
)

303 
tcode
 = 
	`Ty³Code
(
ty
);

305 
tcode
)

307 
I1
: 
U1
:

308 
	`Pršt
("BYTE\t0%xH\n", 
v®
.
i
[0] & 0xff);

311 
I2
: 
U2
:

312 
	`Pršt
("WORD\t0%xH\n", 
v®
.
i
[0] & 0xffff);

315 
I4
: 
U4
:

316 
	`Pršt
("DWORD\t0%xH\n", 
v®
.
i
[0]);

319 
F4
:

320 
	`Pršt
("DWORD\t0%xH\n", *(*)&
v®
.
f
 );

323 
F8
:

325 *
p
 = (*)&
v®
.
d
;

326 
	`Pršt
("DWORD\t0%xH, 0%xH\n", 
p
[0],…[1]);

331 
	`as£¹
(0);

333 
	}
}

335 
	$S·û
(
size
)

337 
	`Pršt
("BYTE %d DUP (0)\n", 
size
);

338 
	}
}

340 
	$DefšeLab–
(
SymbŞ
 
p
)

342 
	`Pršt
("%s:\n", 
	`G‘AcûssName
(
p
));

343 
	}
}

345 
	$EndProg¿m
()

347 
	`PutSŒšg
("END\n");

348 
	`Flush
();

349 
	}
}

	@
1
.
0
66
877
driver/linux.c
driver/reg.c
driver/ucc.c
driver/ucc.h
driver/win32.c
ucl/alloc.c
ucl/alloc.h
ucl/assert.c
ucl/ast.c
ucl/ast.h
ucl/config.h
ucl/decl.c
ucl/decl.h
ucl/declchk.c
ucl/dumpast.c
ucl/emit.c
ucl/error.c
ucl/error.h
ucl/expr.c
ucl/expr.h
ucl/exprchk.c
ucl/flow.c
ucl/fold.c
ucl/gen.c
ucl/gen.h
ucl/grammer.h
ucl/input.c
ucl/input.h
ucl/keyword.h
ucl/lex.c
ucl/lex.h
ucl/linux/include/assert.h
ucl/linux/include/float.h
ucl/linux/include/limits.h
ucl/linux/include/math.h
ucl/linux/include/stdarg.h
ucl/opcode.h
ucl/opinfo.h
ucl/output.c
ucl/output.h
ucl/reg.c
ucl/reg.h
ucl/simp.c
ucl/stmt.c
ucl/stmt.h
ucl/stmtchk.c
ucl/str.c
ucl/str.h
ucl/symbol.c
ucl/symbol.h
ucl/target.h
ucl/template.h
ucl/token.h
ucl/tokenop.h
ucl/tranexpr.c
ucl/transtmt.c
ucl/type.c
ucl/type.h
ucl/ucl.c
ucl/ucl.h
ucl/uildasm.c
ucl/vector.c
ucl/vector.h
ucl/x86.c
ucl/x86linux.c
ucl/x86win32.c
